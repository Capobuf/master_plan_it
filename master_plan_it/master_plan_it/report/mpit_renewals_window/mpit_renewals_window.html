<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    {#
        MPIT Renewals Window - Report Print Format
        Dynamic template supporting print_profile, print_orientation, print_density filters.
        
        Profiles:
        - Standard: contract, title, vendor, category, next_renewal_date, days_to_renewal, auto_renew, status
        - Compact: contract, vendor, next_renewal_date, days_to_renewal, status
        - All: all columns (includes notice_days, end_date)
    #}
    {%- set profile = (filters.print_profile or "Standard")|string %}
    {%- set orientation = (filters.print_orientation or "Auto")|string %}
    {%- set density = (filters.print_density or "Normal")|string %}
    
    {# Define column profiles by fieldname #}
    {%- set profile_columns = {
        "Standard": ["contract", "title", "vendor", "category", "next_renewal_date", "days_to_renewal", "auto_renew", "status"],
        "Compact": ["contract", "vendor", "next_renewal_date", "days_to_renewal", "status"],
        "All": []
    } %}
    
    {# Filter columns based on profile #}
    {%- set selected_fieldnames = profile_columns.get(profile, []) %}
    {%- set visible_columns = [] %}
    {%- for col in columns %}
        {%- set fieldname = col.fieldname if col.fieldname else col.get("fieldname", "") %}
        {%- set is_hidden = col.get("hidden", 0) %}
        {%- if not is_hidden %}
            {%- if profile == "All" or fieldname in selected_fieldnames %}
                {%- set _ = visible_columns.append(col) %}
            {%- endif %}
        {%- endif %}
    {%- endfor %}
    
    {%- set col_count = visible_columns|length %}
    
    {# Auto orientation logic #}
    {%- set page_orientation = "portrait" %}
    {%- if orientation == "Landscape" %}
        {%- set page_orientation = "landscape" %}
    {%- elif orientation == "Auto" and col_count >= 8 %}
        {%- set page_orientation = "landscape" %}
    {%- endif %}
    
    {# Density settings #}
    {%- set font_size = "10px" %}
    {%- set cell_padding = "6px" %}
    {%- if density == "Compact" %}
        {%- set font_size = "9px" %}
        {%- set cell_padding = "4px" %}
    {%- elif density == "Ultra" %}
        {%- set font_size = "8px" %}
        {%- set cell_padding = "3px" %}
    {%- endif %}
    
    <style>
        @page { 
            size: A4 {{ page_orientation }}; 
            margin: 10mm; 
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            font-size: {{ font_size }};
            padding: 10px; 
            margin: 0;
        }
        .report-header { 
            margin-bottom: 15px; 
            border-bottom: 2px solid #333; 
            padding-bottom: 8px; 
        }
        .report-header h2 { 
            margin: 0; 
            color: #333; 
            font-size: 1.4em;
        }
        .report-filters { 
            background-color: #f8f9fa; 
            padding: 8px; 
            margin-bottom: 12px; 
            border-radius: 4px; 
            font-size: 0.9em; 
        }
        .report-filters strong { 
            color: #495057; 
        }
        .warning-banner {
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 8px 12px;
            margin-bottom: 12px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-bottom: 15px; 
            table-layout: fixed;
        }
        .table thead { 
            display: table-header-group;
            background-color: #e9ecef; 
        }
        .table th { 
            border: 1px solid #dee2e6; 
            padding: {{ cell_padding }}; 
            text-align: left; 
            font-weight: 600; 
            color: #495057; 
            vertical-align: top;
            overflow-wrap: anywhere;
            white-space: normal;
        }
        .table td { 
            border: 1px solid #dee2e6; 
            padding: {{ cell_padding }}; 
            vertical-align: top;
            overflow-wrap: anywhere;
            white-space: normal;
        }
        .table tbody tr:nth-child(even) { 
            background-color: #f8f9fa; 
        }
        .text-right { 
            text-align: right; 
        }
        .text-center {
            text-align: center;
        }
        .currency-cell {
            text-align: right;
            white-space: nowrap;
        }
        .text-danger { 
            color: #dc3545; 
            font-weight: 600;
        }
        .text-warning {
            color: #fd7e14;
            font-weight: 600;
        }
        .text-success { 
            color: #28a745; 
        }
        .badge { 
            display: inline-block; 
            padding: 2px 6px; 
            border-radius: 3px; 
            font-size: 0.85em; 
            font-weight: 500; 
        }
        .badge-expired { background-color: #dc3545; color: #fff; }
        .badge-urgent { background-color: #fd7e14; color: #fff; }
        .badge-soon { background-color: #ffc107; color: #000; }
        .badge-normal { background-color: #17a2b8; color: #fff; }
        .report-footer { 
            margin-top: 15px; 
            padding-top: 8px; 
            border-top: 1px solid #dee2e6; 
            text-align: right; 
            color: #6c757d; 
            font-size: 0.85em; 
        }
        @media print {
            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .table thead { background-color: #e9ecef !important; }
            .table tbody tr:nth-child(even) { background-color: #f8f9fa !important; }
            .badge { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        }
    </style>
</head>
<body>
    <div class="report-header">
        <h2>{{ _("Contract Renewals Window") }}</h2>
    </div>

    <div class="report-filters">
        {% if filters.days %}
            <strong>{{ _("Days Forward") }}:</strong> {{ filters.days }} &nbsp;
        {% endif %}
        {% if filters.from_date %}
            <strong>{{ _("From Date") }}:</strong> {{ frappe.utils.formatdate(filters.from_date) }} &nbsp;
        {% endif %}
        {% if filters.include_past %}
            <strong>{{ _("Include Past") }}:</strong> {{ _("Yes") }} &nbsp;
        {% endif %}
        {% if filters.auto_renew_only %}
            <strong>{{ _("Auto Renew Only") }}:</strong> {{ _("Yes") }}
        {% endif %}
    </div>

    {# Wide table warning (non-blocking) #}
    {% if col_count > 10 %}
    <div class="warning-banner">
        {{ _("Many columns detected. For better readability, consider using Compact profile, Landscape orientation with Ultra density, or export to Excel/CSV.") }}
    </div>
    {% endif %}

    <table class="table">
        <thead>
            <tr>
                {% for col in visible_columns %}
                    {% set fieldtype = col.get("fieldtype", "Data") %}
                    {% set is_numeric = fieldtype in ["Int", "Float", "Currency"] %}
                    <th class="{{ 'text-right' if is_numeric else '' }}">
                        {{ _(col.get("label", col.get("fieldname", ""))) }}
                    </th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% if data and data|length > 0 %}
                {% for row in data %}
                    <tr>
                        {% for col in visible_columns %}
                            {% set fieldname = col.get("fieldname", "") %}
                            {% set fieldtype = col.get("fieldtype", "Data") %}
                            {% set value = row.get(fieldname, "") %}
                            
                            {% if fieldname == "days_to_renewal" %}
                                {# Days to renewal with color coding #}
                                {% set days_class = "" %}
                                {% if value is not none %}
                                    {% if value < 0 %}
                                        {% set days_class = "text-danger" %}
                                    {% elif value <= 30 %}
                                        {% set days_class = "text-warning" %}
                                    {% endif %}
                                {% endif %}
                                <td class="text-right {{ days_class }}">{{ value if value is not none else "" }}</td>
                            {% elif fieldname == "status" %}
                                {# Status badge based on days_to_renewal #}
                                {% set days = row.get("days_to_renewal", 999) %}
                                {% set badge_class = "badge-normal" %}
                                {% set badge_label = _("Normal") %}
                                {% if days is not none %}
                                    {% if days < 0 %}
                                        {% set badge_class = "badge-expired" %}
                                        {% set badge_label = _("Expired") %}
                                    {% elif days <= 30 %}
                                        {% set badge_class = "badge-urgent" %}
                                        {% set badge_label = _("Urgent") %}
                                    {% elif days <= 60 %}
                                        {% set badge_class = "badge-soon" %}
                                        {% set badge_label = _("Soon") %}
                                    {% endif %}
                                {% endif %}
                                <td><span class="badge {{ badge_class }}">{{ badge_label }}</span></td>
                            {% elif fieldtype == "Currency" %}
                                <td class="currency-cell">
                                    {{ frappe.utils.fmt_money(value) if value is not none else "" }}
                                </td>
                            {% elif fieldtype == "Check" %}
                                <td class="text-center">{{ "âœ“" if value else "" }}</td>
                            {% elif fieldtype == "Date" %}
                                <td>{{ frappe.utils.formatdate(value) if value else "" }}</td>
                            {% elif fieldtype in ["Int", "Float"] %}
                                <td class="text-right">{{ value if value is not none else "" }}</td>
                            {% else %}
                                <td>{{ value if value is not none else "" }}</td>
                            {% endif %}
                        {% endfor %}
                    </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="{{ col_count }}" style="text-align: center; padding: 20px; color: #6c757d;">
                        {{ _("No renewals in this window") }}
                    </td>
                </tr>
            {% endif %}
        </tbody>
    </table>

    <div class="report-footer">
        {{ _("Generated on") }} {{ frappe.utils.now_datetime().strftime("%Y-%m-%d %H:%M") }}
        &nbsp;|&nbsp; {{ _("Profile") }}: {{ profile }} &nbsp;|&nbsp; {{ _("Orientation") }}: {{ page_orientation|capitalize }}
    </div>
</body>
</html>

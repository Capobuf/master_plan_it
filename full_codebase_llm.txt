================================================================================
 FILE: ./.gitignore
================================================================================
/data
# Environment files
.env
.env.local
.env.*.local
.envrc

# Python artifacts
*.pyc
__pycache__/
.pytest_cache/
.mypy_cache/
.coverage
coverage/
htmlcov/

# Virtual environments
.venv/
venv/

# Packaging/build
dist/
build/
*.egg-info/
pip-wheel-metadata/

# Node/npm
node_modules/
npm-debug.log*
yarn-error.log*

# OS / editors
.DS_Store
.vscode/
.idea/
.cache/

# Database / data
*.sqlite3
*.db
/data/sites/*/private/
/data/sites/*/files/
/data/logs/
/data/db/
/data/redis/

# Docker overrides
docker-compose.override.yml
docker-compose.override.yml.local


================================================================================
 FILE: ./AGENT_INSTRUCTIONS.md
================================================================================
# Agent Instructions (Master Plan IT)

These rules exist to prevent drift and avoid “terminal copy/paste chaos”.

## Non‑negotiables
- Do **not** add custom JS/CSS or any frontend build pipeline.
- Keep everything **native Frappe Desk**.
- Keep changes **idempotent** where applicable.
- Never overwrite standard fixtures or export/import standard system records.
- Do **not** build or use any custom spec-import / `sync_all` pipeline; stay native.
- Metadata lives only under `apps/master_plan_it/master_plan_it/master_plan_it/` — do not create duplicates elsewhere. In this Git repo the app root is `apps/master_plan_it/`; inside a bench it will live at `apps/master_plan_it/` after `bench get-app`.

## Development workflow (single source of truth)

For applying changes to a site, see `docs/how-to/01-apply-changes.md`.

### Location of source files
- **Metadata (source of truth):** `apps/master_plan_it/master_plan_it/master_plan_it/{doctype,report,workflow,dashboard,dashboard_chart,number_card,master_plan_it_dashboard,workspace,print_format}/`
- **Python logic:** `apps/master_plan_it/master_plan_it/doctype/*/mpit_*.py`
- **Install hooks & fixtures:** `apps/master_plan_it/master_plan_it/setup/install.py` and `apps/master_plan_it/master_plan_it/fixtures/role.json` handle bootstrap (settings/years) and ship MPIT roles.

### The correct flow (native file-first)
1) Edit exported metadata JSON directly in the canonical module folder.
2) If you use Desk for skeleton/non-owned DocTypes, immediately **Export Customizations** back into the canonical path.
3) Edit Python logic alongside metadata as needed.
4) Apply with standard Frappe commands (`bench --site <site> migrate`, `clear-cache`) when required. No custom import pipeline.

### Steps to apply changes
1) Edit metadata JSON under `master_plan_it/master_plan_it/master_plan_it/...` (or export from Desk into that path).
2) Edit Python logic in `doctype/*/mpit_*.py` if needed.
3) Apply to database with standard Frappe commands as needed (`bench --site <site> migrate`, `clear-cache`).
4) Commit the canonical metadata and code. Install hooks will create MPIT Settings + current/next year, and fixtures ship MPIT roles.

## What to change where

### Always edit these (source of truth)
- **Metadata JSON:** `master_plan_it/master_plan_it/master_plan_it/{doctype,report,workflow,dashboard,dashboard_chart,number_card,master_plan_it_dashboard,workspace,print_format}/...`
- **Python logic:** `master_plan_it/master_plan_it/doctype/*/mpit_*.py`
- **Install/bootstrap:** `master_plan_it/setup/install.py` (after_install/after_sync)
- **Fixtures:** `master_plan_it/fixtures/` (filtered exports only; roles already provided)
- **Hooks:** `master_plan_it/hooks.py`

### Forbidden paths (must not exist)
- `apps/master_plan_it/master_plan_it/doctype/`
- `apps/master_plan_it/master_plan_it/report/`
- `apps/master_plan_it/master_plan_it/workflow/`
- `apps/master_plan_it/master_plan_it/workspace/`
- `apps/master_plan_it/master_plan_it/dashboard/`
- `apps/master_plan_it/master_plan_it/dashboard_chart/`
- `apps/master_plan_it/master_plan_it/number_card/`
- `apps/master_plan_it/master_plan_it/master_plan_it_dashboard/`
- `apps/master_plan_it/master_plan_it/print_format/`

## Translations (i18n) – Native Frappe Rules

Source of truth
- Translation file lives only at `apps/master_plan_it/master_plan_it/translations/it.csv`. Do not create alternative translation sources or duplicate CSVs.
- The CSV filename must match the Frappe Language code configured in **System Settings > Language**. Default is `it.csv`; if your site uses `it-IT`, rename accordingly.

What auto-translates vs what must be explicit
- DocType JSON (labels, descriptions, select options, workflow/workspace/report labels) is auto-translatable by Frappe; no `_()` needed inside JSON.
- Code strings must be marked explicitly:
  - Python: `from frappe import _` then `_("Literal string")`
  - JS: `__("Literal string")`
  - Jinja/Print Format: `{{ _("Literal string") }}`

Literal-string rules (mirror Frappe docs)
- `_()` / `__()` take literal strings only (no variables). Use positional placeholders `{0}`, `{1}` and format after translating:
  - Python: `_("Welcome {0}.").format(name)`
  - JS: `__("Welcome {0}.", [name])`
- No concatenation or multiline translation literals; avoid trailing spaces; do not pluralize by appending “s” (write full singular/plural strings).
- Add context when the same source string has multiple meanings:
  - JS: `__("Change", null, "Coins")`
  - Python: `_("Change", context="Switch")`
  - In `it.csv` use the 3rd “context” column to disambiguate.

How to update it.csv (anti-drift)
- Use a 3-column CSV: `source_string,translated_string,context` (context empty when not needed).
- Keep one entry per unique source_string + context; quote values containing commas; keep rows deterministically sorted (e.g., by source_string then context).
- Do not translate technical identifiers (DocType names, fieldnames, module names, route paths, DB keys). Keep app/product names as-is unless the business glossary says otherwise.
- Prefer existing translations for consistency. If a core business term lacks precedent, pause and obtain a glossary decision before adding it.

Verification (manual, not run here)
- Switch a test user to Italian and confirm UI/prints/reports show translated labels/messages.
- If UI strings stay stale, clear cache/build per native bench steps for the site; no custom tooling beyond standard Frappe commands.

Italian translations — verify & troubleshoot
- Verify steps (in order): (1) Set your user language to Italian. (2) Confirm translation file exists at `apps/master_plan_it/master_plan_it/translations/it.csv`. (3) Ensure the filename matches your Frappe Language code (e.g., use `it-IT.csv` if Language code is `it-IT`). (4) Hard-refresh the browser. (5) If still stale, clear cache: `bench --site <site> clear-cache`. (6) If still stale, restart bench/web services for the site. (7) Only when you changed custom frontend JS with `__()`, build assets: `bench --site <site> build`.
- Common causes: wrong folder (not under the app package), wrong filename vs Language code, source string mismatch (spaces/punctuation), string not wrapped in `_()` / `__()` / `{{ _("...") }}`, cache not cleared or services not restarted.

## Required outputs for each task
- If you change metadata: ensure `bench migrate` is the apply step and update the relevant docs.
- Add or update an ADR if the change is an architectural decision (multi-tenant model, workflow semantics, immutability rules).
- Provide a `verify()` command/output plan: what should exist in DB after apply.

## Safety checks
- Avoid changing object/module names once created (keeps file paths stable).
- Never export fixtures without filters; ensure only MPIT objects are included.
- If unsure whether an object is “standard sync”: prefer to create it in dev mode via UI and commit its files.


================================================================================
 FILE: ./DOCS_MAP.md
================================================================================
# Documentation map

## Agent instructions
- `AGENT_INSTRUCTIONS.md` → Translations (i18n) – Native Frappe Rules + Italian verification/troubleshooting (canonical; single `translations/it.csv`)

## Tutorials
- `docs/tutorials/00-first-budget-cycle.md`

## How‑to guides
- `docs/how-to/00-bootstrap-from-scratch.md`
- `docs/how-to/01-apply-changes.md`
- `docs/how-to/02-create-new-tenant.md`
- `docs/how-to/03-import-baseline-excel.md`
- `docs/how-to/04-budget-cycle.md`
- `docs/how-to/05-amend-budget.md`
- `docs/how-to/06-manage-contracts-renewals.md`
- `docs/how-to/07-projects-multi-year.md`
- `docs/how-to/08-user-guide.md`
- `docs/how-to/09-docker-compose-notes.md`

## Reference
- `docs/reference/06-dev-workflow.md` ← authoritative workflow (native file-first; canonical path only)
- `docs/reference/01-data-model.md`
- `docs/reference/02-roles-permissions.md`
- `docs/reference/03-workflows.md`
- `docs/reference/04-reports-dashboards.md`
- `docs/reference/05-fixtures-bootstrap.md`
- `docs/reference/07-testing.md`

## Explanation
- `docs/explanation/01-architecture.md`

## ADR
- `docs/adr/0001-multi-site-per-client.md`
- `docs/adr/0002-desk-only.md`
- `docs/adr/0003-immutable-budget-amendments.md`
- `docs/adr/0004-project-allocations.md`
- `docs/adr/0005-contracts-first-class.md`
- `docs/adr/0006-no-frontend-custom-scheduler.md`


================================================================================
 FILE: ./.env
================================================================================
FRAPPE_IMAGE=frappe/erpnext
FRAPPE_TAG=v15.92.3
HOST_UID=1000
HOST_GID=1000
DB_ROOT_PASSWORD=changeme_db_root_MPIT_1
ADMIN_PASSWORD=changeme_admin_MPIT_1
SITE_NAME=budget.zeroloop.it
INSTALL_APPS=master_plan_it
RUN_MIGRATE_ON_START=1
HTTP_PORT=9798


================================================================================
 FILE: ./COHERENCE_CHECK.md
================================================================================
# Coherence and scope check (V1)

Date: 2025-12-21

This document captures the *consistency review* of the V1 design before implementation.
It is written to prevent drift and over-engineering.

## What we are building (V1)

**Master Plan IT** is a Frappe Desk app used by a vCIO and the client’s users to manage:
- Historical spend baseline (raw → clarified → validated)
- Annual budget proposal → approval (immutable baseline)
- In-year changes via amendments (delta-based)
- Actuals (consuntivi) with warnings (no blocking)
- Contracts/subscriptions with renewals visibility
- Projects with multi-year allocations

## Hard constraints

- **Desk only** (clients are System Users). No portal/Website Users.
- **Native components only**: DocType, Workflow, Reports, Dashboards, Data Import, Calendar/Kanban/List views.
- No custom JS/CSS; no asset build.
- 1 client = 1 Frappe **site** (tenant). The vCIO operates across sites.

## Forbidden Duplicate Metadata Paths

Canonical metadata lives under `apps/master_plan_it/master_plan_it/master_plan_it/`. If any of these paths exist, it is drift and must be removed:
- `apps/master_plan_it/master_plan_it/doctype/`
- `apps/master_plan_it/master_plan_it/report/`
- `apps/master_plan_it/master_plan_it/workflow/`
- `apps/master_plan_it/master_plan_it/workspace/`
- `apps/master_plan_it/master_plan_it/dashboard/`
- `apps/master_plan_it/master_plan_it/dashboard_chart/`
- `apps/master_plan_it/master_plan_it/number_card/`
- `apps/master_plan_it/master_plan_it/master_plan_it_dashboard/`
- `apps/master_plan_it/master_plan_it/print_format/`

## Linearity & no-contradictions audit

### Data separation
- Multi-site means each tenant has its own DB; cross-customer access is not supported by design.
- vCIO user accounts must exist on each site (unless an external SSO is introduced later).

### Baseline vs Contracts
- **Baseline Expense** is the “inbox” for historical charges (often messy).
- **Contract** is the curated, durable record for renewals/scadenze. Baseline can link to Contract, but not required.
This avoids conflating raw imports with governance objects.

### Budget immutability
- The **Approved budget never changes**.
- Any change after approval is a **Budget Amendment** with *delta lines* (positive/negative).
This enables two consistent comparisons:
1) Approved vs Actual (baseline start-of-year)
2) Current (Approved + Amendments) vs Actual (rolling reality)

### Projects multi-year
- Projects can span years; therefore V1 **requires per-year allocations** before a project can be approved.
This prevents ambiguous annual reporting.

### Actuals linkage
- Actual entries must always have a **Category** (minimum indispensable).
- They can additionally link to a **Contract** and/or **Project**.
- Directly linking to a child-table Budget Line is not reliable in Frappe; we keep only a soft reference in V1.

### Renewals visibility
- Renewals are driven by `MPIT Contract.next_renewal_date` (explicit, operational).
- Calendar/Kanban/List + saved filters + renewals report provide visibility with native Desk tools.
- Optional: scheduled reminders via `scheduler_events` (native backend), but not required for V1 correctness.

## Over-engineering check

Included in V1 because it is required by your stated workflow:
- Contracts with renewals
- Amendments for post-approval changes
- Project allocations per year

Deferred (V2) because it increases complexity without blocking V1:
- SSO across sites
- Automatic “copy baseline → budget” wizard in UI (V1 can use a CLI script)
- Complex contract proration/annualization rules (V1 uses explicit dates/amounts + reports)

Result: **V1 is minimal yet complete** for the described budgeting lifecycle.


================================================================================
 FILE: ./docs/adr/0003-immutable-budget-amendments.md
================================================================================
# ADR 0003: Approved budgets are immutable; changes are modeled as delta amendments

Date: 2025-12-21

## Status
Accepted

## Context
We must compare 'budget defined at start of year' vs 'actual spent' consistently over time. Allowing edits to an approved budget would destroy the baseline and make reporting ambiguous.

## Decision
Budgets are approved via workflow and submitted (docstatus=1), making them immutable. Post-approval changes are done via Budget Amendments containing delta lines (+/-).

## Consequences
- Two stable comparisons: Approved vs Actual; Current vs Actual.
- Clean audit trail of changes.
- Requires amendment workflow discipline (but avoids technical debt).



================================================================================
 FILE: ./docs/adr/0000-template.md
================================================================================
# ADR 0000: Template

Date: 2025-12-21

## Status
Template

## Context
...

## Decision
...

## Consequences
...



================================================================================
 FILE: ./docs/adr/0004-project-allocations.md
================================================================================
# ADR 0004: Projects can span years; per-year allocations are mandatory before approval

Date: 2025-12-21

## Status
Accepted

## Context
Projects may start in one year and finish in another. Annual reporting becomes ambiguous unless planned amounts are allocated per year.

## Decision
Require project allocation rows (year, planned_amount) before a project can be approved.

## Consequences
- Annual reports remain consistent.
- Slightly more data entry upfront.
- Prevents hidden debt from 'everything belongs to the start year' heuristics.



================================================================================
 FILE: ./docs/adr/0005-contracts-first-class.md
================================================================================
# ADR 0005: Contracts/Subscriptions are first-class objects for renewals visibility

Date: 2025-12-21

## Status
Accepted

## Context
Baseline imports are raw and may contain unclear/duplicated lines. Renewals/scadenze require a curated durable record to drive views and reminders.

## Decision
Introduce MPIT Contract as a dedicated DocType with explicit next_renewal_date and vendor/category linkage. Baseline expenses may link to a contract but are not required.

## Consequences
- Renewals views and reports are reliable.
- Contracts can be linked to budgets and actuals.
- Some manual curation required (but matches governance workflow).



================================================================================
 FILE: ./docs/adr/0007-money-naming-printing.md
================================================================================
# ADR 0007 — Money rules + Naming + Printing (MPIT v1, Frappe v15)

- Status: **Accepted**
- Date: 2025-12-22
- Owners: DOT / MPIT

---

## Context

Problemi riscontrati:
- `name` random (es. `ig0v0mikhb`) poco user-friendly
- assenza di normalizzazione IVA e totali net/lordo
- ricorrenze non annualizzate coerentemente
- stampe brutte e allegati PDF mostrati come “immagine rotta”
- vincolo: **no custom frontend/CSS** (ADR 0006)

---

## Decisions

### 1) Naming
- Budget `name`: `BUD-{Budget.year}-{NN}` (progressivo per anno)
- `{Budget.year}` è il campo Year del Budget (obbligatorio).
- Project `name`: `PRJ-{NNNN}` (progressivo globale)
- Le preferenze per-utente determinano `prefix` e `digits`, ma:
  - Budget deve includere sempre `{year}-` tra prefix e progressivo.

Non rinominare documenti esistenti.

### 2) Title Field (UX)
Per i DocType user-facing:
- impostare `title_field`
- impostare `show_title_field_in_link = 1`

### 3) VAT (Strict mode) su tutti gli importi Currency
- Tutti i Currency fields devono avere net/vat/gross.
- Se amount != 0:
  - vat_rate obbligatorio (0 valido)
  - se manca su riga e manca in User Preferences → blocca

Nessun default IVA tenant.

### 4) Annualizzazione
Recurrence: `Monthly, Quarterly, Annual, Custom, None`

- None = one-off
- Custom = Option A: richiede `custom_period_months` > 0
  - annual = amount * (overlap_months / custom_period_months)
- Date fuori anno (overlap = 0) → blocco salvataggio (regola A)

Normalizzare net/vat/gross prima di annualizzare.

### 5) Printing
- Doc Print Formats: Jinja + bootstrap classes, versionate come Standard (file in repo)
- Allegati: lista di file (no preview PDF come immagini)
- Report Print Formats: `{report}.html` (microtemplating), no single quotes

---

## Consequences

- Nuovi campi (net/vat/gross, annual_*, totals) sui DocType esistenti.
- Patch di backfill per dati storici (vat_rate=0, includes_vat=0).
- Report con fallback `COALESCE(new, old)`.
- Test + checklist manuale stampa.



================================================================================
 FILE: ./docs/adr/0008-print-formats-jinja-server-side.md
================================================================================
# ADR 0008 — Print formats (Jinja, server-side)

## Decision
Print formats are maintained as server-side Jinja templates checked into the canonical module folder (`apps/master_plan_it/master_plan_it/master_plan_it/print_format/`). They may be imported with `frappe.modules.import_file.import_file_by_path()` when needed, but no custom sync pipeline is used.

## Rationale
- Keep print formats versioned alongside the rest of the app metadata.
- Avoid runtime templating risks by rendering on the server.
- Rely on standard Frappe file sync (`migrate`, `clear-cache`) to apply changes; Desk edits must be exported immediately back into the canonical folder.

## Implications
- No `sync_all` / spec-import flow; file-first only.
- When adjusting formats in Desk, export them to `print_format/` and commit.
- Existing fixtures should remain minimal and filtered to MPIT records only.


================================================================================
 FILE: ./docs/adr/0001-multi-site-per-client.md
================================================================================
# ADR 0001: One client = one Frappe site (multi-site tenancy)

Date: 2025-12-21

## Status
Accepted

## Context
We need hard segregation between clients. The vCIO serves many clients, while clients must only see their own data. A single shared site with user permissions increases complexity and risk.

## Decision
Adopt a multi-site model: each client is a separate Frappe site (tenant).

## Consequences
- Data is isolated per tenant (DB separation).
- vCIO accounts must exist per site (operational overhead).
- Cross-tenant analytics requires external aggregation (out of scope V1).



================================================================================
 FILE: ./docs/adr/0006-no-frontend-custom-scheduler.md
================================================================================
# ADR 0006: No custom frontend; optional backend scheduler for reminders

Date: 2025-12-21

## Status
Accepted

## Context
The project forbids custom JS/CSS and asset builds. We still want renewal reminders.

## Decision
Use native Desk views/reports for visibility. Optionally add backend reminders via Frappe scheduler_events (daily job) to create ToDos or send emails.

## Consequences
- Core visibility works without automation.
- Reminders can be added later without violating constraints.
- Scheduling logic is backend-only and versionable.



================================================================================
 FILE: ./docs/adr/0002-desk-only.md
================================================================================
# ADR 0002: Clients use Desk (System Users), no Portal/Website Users

Date: 2025-12-21

## Status
Accepted

## Context
We require dashboards, analytics, free exploration (lists/filters), workflow approvals, and native UI without custom frontend code.

## Decision
Clients are System Users and access the app via Desk. Portal/Website Users are not used.

## Consequences
- Full native features available (reports/dashboards/workflows).
- Client UI looks like an admin app, but can be constrained by roles/workspaces.
- No custom portal pages are needed (aligns with 'no JS/CSS custom').



================================================================================
 FILE: ./docs/how-to/09-docker-compose-notes.md
================================================================================
# Docker Compose notes

- Main file: `compose.yml` (uses `Dockerfile.frappe`).
- Set `INSTALL_APPS=master_plan_it` to install the app during bootstrap.
- Mount `./apps/master_plan_it` for development; avoid mounting empty `./data/apps`.
- After bringing up services, apply app changes with `bench --site <site> migrate` and `bench --site <site> clear-cache`.
- Install hooks create MPIT Settings and MPIT Year (current + next); verify in Desk after migrate. No additional bootstrap scripts are required for baseline data.


================================================================================
 FILE: ./docs/how-to/07-projects-multi-year.md
================================================================================
# How to run multi-year projects

## Rule
Before a project can be approved, it must have at least one `MPIT Project Allocation` row.
Allocations are per-year planned amounts. La validazione blocca gli stati da `Approved` in poi se mancano allocazioni.

## Steps
1) Create `MPIT Project` (Draft).
2) Add yearly allocations (mandatory for approval):
   - 2026: 10,000
   - 2027: 5,000
3) Add quotes (optional) and milestones (optional) as child rows.
4) Approve the project (if you use a project workflow/state policy).
5) Include the project in budgets:
   - Either add budget lines that reference the project,
   - Or use a CLI helper to generate lines from allocations (optional V1.1).
6) Record actual entries linking to the project.

## Reporting
- Projects planned vs actual is computed using:
  - planned allocations per year
  - actual entries linked to the project within the year


================================================================================
 FILE: ./docs/how-to/03-import-baseline-excel.md
================================================================================
# How to import baseline expenses from Excel/CSV

## Recommended approach (V1)
Use Frappe **Data Import** for `MPIT Baseline Expense`.

### Why baseline is the import target
Baseline is intentionally the “raw inbox”. It can contain messy lines that you clarify later via comments and status changes.

## Steps
1) Prepare a spreadsheet with columns matching `MPIT Baseline Expense` fields.
2) In Desk: Data Import → select `MPIT Baseline Expense`.
3) Upload the file and run import.
4) Review imported rows; add clarifications as comments; set status accordingly.

## Notes
- Normalize vendors only when you have enough information; otherwise leave vendor blank and classify later.
- For recurring spend, create `MPIT Contract` once the baseline line is validated.



================================================================================
 FILE: ./docs/how-to/08-user-guide.md
================================================================================
# How to use Master Plan IT (MPIT) in Desk

Questa guida è pensata per utenti finali (vCIO e utenti cliente) che lavorano in **Frappe Desk**.

> Nota: la Workspace “Master Plan IT”, i ruoli MPIT e i workflow (Budget, Budget Amendment) sono provisionati tramite i file canonici del modulo + fixtures e i normali comandi Frappe (`migrate`, `clear-cache`). Nessun pipeline custom è richiesto.

---

## 1) Accesso all’interfaccia web (Docker)

Se stai usando `compose.yml`, il frontend espone Frappe su:
- `http://127.0.0.1:<HTTP_PORT>` (es. `http://127.0.0.1:9797`)

MPIT è multi‑site: il sito viene selezionato via header `Host` (o `FRAPPE_SITE_NAME_HEADER`).

### Opzione A (consigliata in locale): `hosts`
1) Aggiungi nel file hosts:
   - `127.0.0.1 budget.zeroloop.it` (sostituisci con il tuo `SITE_NAME`)
2) Apri:
   - `http://budget.zeroloop.it:9797`

### Opzione B: forzare `FRAPPE_SITE_NAME_HEADER`
Imposta in `.env`:
- `FRAPPE_SITE_NAME_HEADER=budget.zeroloop.it`

Poi riavvia:
- `docker compose up -d --force-recreate`

---

## 2) Navigazione: dove trovare MPIT

In Desk, apri:
- Workspace **“Master Plan IT”**

Da lì hai scorciatoie ai principali oggetti:
- Budgets, Budget Amendments
- Actual Entries
- Contracts, Projects
- Baseline Expenses
- Categories, Vendors
- Dashboard: **Master Plan IT Overview** (numero card e grafici pronti)

Se la workspace non appare, chiedi all’amministratore di eseguire:
- `bench --site <site> migrate`
- `bench --site <site> clear-cache`

### Ruoli richiesti
- vCIO Manager: pieno controllo, approvazioni.
- Client Editor: proposta/approvazioni tramite workflow, modifica dei dati operativi.
- Client Viewer: sola lettura.

La workspace è visibile solo agli utenti con uno dei ruoli sopra (o System Manager).

---

## 3) Setup iniziale (una tantum per tenant)

1) **MPIT Settings**
   - Imposta `currency` (obbligatoria)
   - Verifica `renewal_window_days` (default 90)

2) **MPIT Year**
   - Crea/attiva l’anno (es. 2026)

3) **MPIT Category** (albero)
   - Crea categorie “gruppo” e “foglia”
   - Suggerimento: mantieni poche foglie, stabili nel tempo

4) **MPIT Vendor**
   - Inserisci fornitori principali

---

## 4) Flussi operativi (V1)

### A) Baseline (storico spese)
Usa **Data Import** su `MPIT Baseline Expense`:
- Compila almeno: `year`, `category`, `amount`
- `status` serve per gestire: In Review → Needs Clarification → Validated

### B) Contracts / Renewals
Crea `MPIT Contract` per spese ricorrenti:
- `vendor`, `category`, `contract_kind`, `next_renewal_date` sono chiave
- Usa viste Lista/Calendario e filtri salvati per “scadenze 30/60/90gg”

### C) Budget annuale
Crea `MPIT Budget` per anno:
- Compila la tabella `lines` con righe (category/vendor/amount/descrizione)
- Il budget è “baseline” annuale; modifiche successive vanno in amendment

### D) Amendments (variazioni post‑baseline)
Crea `MPIT Budget Amendment` collegato al budget:
- Compila `lines` con `delta_amount` (positivo/negativo)

### E) Actuals (consuntivi)
Inserisci `MPIT Actual Entry`:
- `posting_date`, `category`, `amount` obbligatori
- Se utile, collega `contract` e/o `project`
- Il campo `year` viene valorizzato automaticamente dalla `posting_date` (serve che il relativo `MPIT Year` esista)

### F) Projects (multi‑year)
Inserisci `MPIT Project`:
- Aggiungi almeno una riga in `allocations` (anno + planned_amount)
- Usa `quotes` e `milestones` se utili
- Non puoi impostare stati da `Approved` in poi senza almeno un’allocazione

---

## 5) Workflow e visibilità
- Budget: Draft → Proposed → In Review → Approved (approvazione = submit). Amendment: stessa sequenza con `Rejected` aggiuntivo.
- Ruoli che possono transizionare: `Client Editor`, `vCIO Manager` (e ovviamente System Manager).
- Workspace “Master Plan IT” è visibile ai ruoli MPIT + System Manager.
- Dashboard “Master Plan IT Overview” mostra cards rinnovate (30/60/90gg, expired) e grafici Budget/Current vs Actual, Renewals by Month, Projects Planned vs Actual.

---

## 6) Colonne e viste (perché “vedo solo Category”)

Frappe salva preferenze per utente (colonne lista, filtri, vista griglia).

### Liste (List View)
Nella lista di un DocType:
- Usa **List Settings / Columns** per aggiungere o rimuovere colonne
- Salva un **filtro** come “Saved Filter” se lo usi spesso

### Tabelle interne (child table, es. Budget Lines)
Dentro al documento (es. `MPIT Budget` → tabella `lines`):
- Apri il menu della tabella (icona ingranaggio / menu) e configura le colonne della griglia

Se dopo aggiornamenti non cambia nulla, prova:
- Hard refresh del browser
- `bench --site <site> clear-cache`


================================================================================
 FILE: ./docs/how-to/00-bootstrap-from-scratch.md
================================================================================
# How-to: Bootstrap from scratch

1) Create a new site in your bench and install the app (`bench --site <site> install-app master_plan_it`).
2) Ensure canonical metadata exists under `apps/master_plan_it/master_plan_it/master_plan_it/`.
3) Apply files to the site with standard commands:
   - `bench --site <site> migrate`
   - `bench --site <site> clear-cache`
4) Export any Desk customizations back into the canonical folder immediately after making them.
5) Install hooks will create MPIT Settings and MPIT Year (current + next); verify from Desk after migrate.


================================================================================
 FILE: ./docs/how-to/05-amend-budget.md
================================================================================
# How to amend an approved budget

**Rule:** Approved budgets are immutable. All post-approval changes are amendments.

## Steps
1) Create `MPIT Budget Amendment` and link the approved `MPIT Budget`.
2) Add amendment lines with `delta_amount` (positive or negative).
3) Move through workflow states and approve (submits the amendment).
4) Reports automatically reflect:
   - Approved baseline vs actual
   - Current (baseline + amendments) vs actual

## Design note
Delta-based amendments avoid duplicating entire budgets and preserve a clean audit trail.



================================================================================
 FILE: ./docs/how-to/import/01-baseline-template.md
================================================================================
# Baseline Import Template (V1)

Obiettivo: preparare un file CSV “client-ready” per inserire le spese baseline in MPIT senza logica custom.

## Come usare il template
1. Scarica `templates/baseline_template.csv`.
2. Compila le colonne rispettando i formati indicati sotto.
3. Valida rapidamente in `bench console` (vedi sezione “Preflight rapido”) prima di inserire i dati in UI.

## Colonne e regole
- `year` (obbligatorio): nome dell’MPIT Year (es. `2025`).
- `category` (obbligatorio): nome categoria esistente.
- `vendor` (facoltativo): nome vendor; lascia vuoto se non applicabile.
- `description` (obbligatorio): testo breve della spesa.
- `recurrence_rule` (obbligatorio): `Monthly` | `Quarterly` | `Annual` | `Custom` | `None`.
- `custom_period_months` (richiesto solo se `recurrence_rule=Custom`): intero 1-12.
- `amount` (obbligatorio): importo della spesa di partenza (net o gross secondo colonna successiva).
- `amount_includes_vat` (obbligatorio): `1` se l’importo include IVA, altrimenti `0`.
- `vat_rate` (obbligatorio): percentuale IVA (es. `22`), usa `0` per esenzione.
- `period_start_date` / `period_end_date` (facoltativi): date ISO `YYYY-MM-DD`; servono per calcolare l’overlap con l’anno MPIT (Rule A blocca overlap zero).

## Esempi validi
- Mensile standard: anno 2025, Connectivity, TIM, 100 €/mese, IVA 22%, includes=1, recurrence_rule=Monthly.
- Annuale senza IVA: anno 2025, Insurance, vendor vuoto, 1200 €, includes=0, vat_rate=0, recurrence_rule=Annual.
- Custom 6 mesi: recurrence_rule=Custom, custom_period_months=6, period_start/end coerenti con l’anno.

## Preflight rapido (opzionale)
In `bench console`, puoi caricare il CSV e controllare i campi obbligatori/numerici:
```python
import csv, frappe
path = "/path/al/file/baseline_template.csv"
errors = []
with open(path) as f:
    reader = csv.DictReader(f)
    for i, row in enumerate(reader, start=2):  # header = riga 1
        if not row["year"]:
            errors.append((i, "year mancante"))
        if not row["category"]:
            errors.append((i, "category mancante"))
        if row.get("recurrence_rule") == "Custom" and not row.get("custom_period_months"):
            errors.append((i, "custom_period_months richiesto per Custom"))
        try:
            float(row["amount"])
            float(row["vat_rate"])
        except Exception:
            errors.append((i, "amount/vat_rate non numerici"))
print(errors or "OK")
```

## File template
- CSV: `templates/baseline_template.csv`


================================================================================
 FILE: ./docs/how-to/import/02-budget-template.md
================================================================================
# Budget Import Template (V1)

Obiettivo: raccogliere righe Budget pronte per l’inserimento manuale, con gli stessi campi chiave del doctype.

## Come usare il template
1. Scarica `templates/budget_template.csv`.
2. Compila le colonne seguendo le regole sotto.
3. (Opzionale) esegui il preflight rapido in `bench console` prima di inserire i dati in UI.

## Colonne e regole
- `budget` (obbligatorio): nome del Budget target (es. `BUD-2025-01`).
- `category` (obbligatorio): nome categoria.
- `vendor` (facoltativo): nome vendor.
- `description` (obbligatorio): testo breve.
- `recurrence_rule` (obbligatorio): `Monthly` | `Quarterly` | `Annual` | `Custom` | `None`.
- `custom_period_months` (richiesto solo se `recurrence_rule=Custom`): intero 1-12.
- `amount` (obbligatorio): importo della linea (net o gross in base alla colonna successiva).
- `amount_includes_vat` (obbligatorio): `1` se l’importo include IVA, `0` altrimenti.
- `vat_rate` (obbligatorio): percentuale IVA (es. `22`), `0` per esenzione.
- `period_start_date` / `period_end_date` (facoltativi): date ISO `YYYY-MM-DD`; usate per l’overlap con l’anno MPIT.
- `contract` / `project` (facoltativi): link ai rispettivi record se già esistenti.
- `is_portfolio_bucket` (facoltativo, default 0): `1` se la riga rappresenta un bucket portfolio.

## Esempi validi
- OPEX mensile: budget `BUD-2025-01`, category Connectivity, vendor TIM, 104 €/mese, includes=1, vat_rate=22, recurrence_rule=Monthly.
- CAPEX annuale senza IVA: budget `BUD-2025-02`, category Hardware, vendor vuoto, 5000 €, includes=0, vat_rate=0, recurrence_rule=Annual.
- Portfolio bucket: impostare `is_portfolio_bucket=1` per la riga dedicata al portafoglio.

## Preflight rapido (opzionale)
```python
import csv
path = "/path/al/file/budget_template.csv"
errors = []
with open(path) as f:
    reader = csv.DictReader(f)
    for i, row in enumerate(reader, start=2):
        if not row["budget"]:
            errors.append((i, "budget mancante"))
        if not row["category"]:
            errors.append((i, "category mancante"))
        if row.get("recurrence_rule") == "Custom" and not row.get("custom_period_months"):
            errors.append((i, "custom_period_months richiesto per Custom"))
        try:
            float(row["amount"])
            float(row["vat_rate"])
        except Exception:
            errors.append((i, "amount/vat_rate non numerici"))
print(errors or "OK")
```

## File template
- CSV: `templates/budget_template.csv`


================================================================================
 FILE: ./docs/how-to/import/templates/budget_template.csv
================================================================================
budget,category,vendor,description,recurrence_rule,custom_period_months,amount,amount_includes_vat,vat_rate,period_start_date,period_end_date,contract,project,is_portfolio_bucket
BUD-2025-01,Connectivity,TIM,"Connettività TIM 104/mese",Monthly,,104,1,22,2025-01-01,2025-12-31,,,"0"
BUD-2025-01,Connectivity,Dimensione,"Connettività backup 49/mese",Monthly,,49,1,22,2025-01-01,2025-12-31,,,"0"
BUD-2025-01,Portfolio,,,"Bucket portfolio",None,,0,0,,,"","",1


================================================================================
 FILE: ./docs/how-to/import/templates/baseline_template.csv
================================================================================
year,category,vendor,description,recurrence_rule,custom_period_months,amount,amount_includes_vat,vat_rate,period_start_date,period_end_date
2025,Connectivity,TIM,"Fibra FTTH HQ",Monthly,,100,1,22,2025-01-01,2025-12-31
2025,Insurance,,"Cyber insurance annuale",Annual,,1200,0,0,2025-01-01,2025-12-31


================================================================================
 FILE: ./docs/how-to/06-manage-contracts-renewals.md
================================================================================
# How to manage contracts, renewals, and expiries

## Core idea
Contracts/subscriptions are managed in `MPIT Contract`.
`next_renewal_date` is the operational date used for renewals views and alerts.

## Native visibility (no custom UI)
- List view with saved filters (e.g. renewals in 30/60/90 days)
- Calendar view using `next_renewal_date`
- Kanban view by `status`
- Report: Renewals window (today..today+N)

## Recommended fields
- vendor, category, title
- start/end dates (if applicable)
- next_renewal_date (mandatory)
- notice_days, auto_renew
- current_amount (uses the site currency from MPIT Settings)

## Optional reminders (V1.1)
Use `scheduler_events` to create daily reminders (e.g. ToDo or email) for renewals approaching.
This is backend-only and remains within native Frappe capabilities.


================================================================================
 FILE: ./docs/how-to/10-epic-e01-money-naming-printing.md
================================================================================
# Epic E01: Money naming & printing

Notes for aligning money fields and print formats using the native file-first workflow.

- Edit metadata and print formats under `apps/master_plan_it/master_plan_it/master_plan_it/` (DocTypes, print formats, controllers).
- If you tweak print formats or labels in Desk, export the changes back into the canonical folder immediately.
- Apply changes with standard Frappe commands (`bench --site <site> migrate`, `clear-cache`); no custom import/sync pipeline.
- Keep translations updated in the `translations/` CSVs alongside the app.


================================================================================
 FILE: ./docs/how-to/02-create-new-tenant.md
================================================================================
# How to create a new tenant (new client site)

**Model:** 1 client = 1 Frappe site.

## Steps
1) Create site
   - `bench new-site <client-site-name>`

2) Install the app
   - `bench --site <client-site-name> install-app master_plan_it`

3) Apply metadata and fixtures
   - `bench --site <client-site-name> migrate`

4) Provision tenant defaults (idempotent)
   - `bench --site <client-site-name> execute master_plan_it.scripts.bootstrap.run --kwargs '{"step":"tenant"}'`

## Verification
In Desk, confirm:
- Workspace “Master Plan IT” exists
- DocTypes exist (Categories, Vendors, Contracts, Budgets, Amendments, Actual Entries, Projects, Settings)
- Roles exist: vCIO Manager, Client Viewer, Client Editor



================================================================================
 FILE: ./docs/how-to/01-apply-changes.md
================================================================================
# How-to: Apply changes (native file-first)

**Source of truth:** exported metadata (JSON) and controllers (Python/JS) inside the app’s **python package folder** (the folder that contains `hooks.py`) under your bench `apps/master_plan_it/...`.  
**Rules:** stay native (no spec/import pipeline, no `sync_all`). Apply changes using standard Bench/Frappe commands.

---

## Change type → what to do

| Change type | Apply | Then |
| --- | --- | --- |
| **DocType / Workflow / Workspace / Report / Print Format JSON** (metadata) | **Recommended:** `bench --site <site> migrate`  \| **Targeted (layout-only DocType):** `bench --site <site> reload-doctype "<DocType Name>"` | `bench --site <site> clear-cache` + hard refresh (Ctrl+F5) |
| **Python code** (controllers/hooks/patch code) | If your web process does **not** autoreload, **restart** the web process. If schema/metadata also changed, run `bench --site <site> migrate`. | Hard refresh after reload/restart |
| **Frontend JS** (client scripts/custom JS assets) | `bench build` (only when JS assets change) | Restart web/socketio if needed, `bench --site <site> clear-cache`, hard refresh |
| **Translations** (`translations/it.csv`) | `bench --site <site> clear-cache` (and hard refresh) | If still stale: restart web process; if you changed JS assets, run `bench build` |
| **Fixtures** (`fixtures/*.json`, `hooks.py` fixtures list) | `bench --site <site> migrate` | `bench --site <site> clear-cache` |
| **Patches** (`patches.txt` + patch modules) | `bench --site <site> migrate` (runs patches) | `bench --site <site> clear-cache` |

DocField help text (`description`) updates are DocType JSON changes: apply with migrate or targeted `reload-doctype`, then `clear-cache` + hard refresh.

Note: Default child-table columns/ordering come from `in_list_view` flags on the child DocType. Column widths set via “Configure Columns” are typically per-user; the app can set default visibility/order only.

---

## Operator apply sequence (pick one per deployment)

- **A) Full sync (safest):**  
  `bench --site <site> migrate` → `bench --site <site> clear-cache` → hard refresh browser  
  *(Optionally add `bench --site <site> clear-website-cache` if you rely on website caching.)*

- **B) Targeted DocType reload (layout-only):**  
  `bench --site <site> reload-doctype "<DocType Name>"` → `bench --site <site> clear-cache` → hard refresh browser

---

## Improving form UX (native layout only)

- Use native Tab Break / Section Break / Column Break to organize fields; avoid custom JS/CSS for layout.
- Drive progressive disclosure with `depends_on`, `mandatory_depends_on`, and `read_only_depends_on` when a field should show or become required based on another field.
- These are DocType JSON changes: apply with migrate or targeted `reload-doctype`, then `clear-cache` + hard refresh (no extra pipelines).

---

## Workspace changes (Desk) — Apply + Verify + Debug

### Apply (standard)
- `bench --site <site> migrate`
- `bench --site <site> clear-cache`  
- Optional: `bench --site <site> clear-website-cache`
- Hard refresh Desk (Ctrl+F5)

### Verify (DB-level, reliable)
Use console for deterministic verification:

- `bench --site <site> console`
- In console:
  - `import frappe`
  - `print(frappe.db.get_value("Workspace", "Master Plan IT", ["modified", "content"]))`

Confirm:
- `modified` changed after the update
- `content` contains the expected new shortcut/block (e.g. “User Preferences”)

### Debug (when it doesn’t move)
1) **Prove you edited the canonical file path** used by the running bench/container  
   - In Docker setups, confirm the bind-mount for `/home/frappe/frappe-bench/apps/master_plan_it` points to the same host folder you edited.
2) **Check Workspace 2.0 file layout**  
   - Workspace JSON should follow the folder pattern:  
     `<app>/<module>/workspace/<workspace_id>/<workspace_id>.json`  
     where `<workspace_id>` is the folder name used in the app (do not assume it without checking).
3) **Fallback: push the file into DB using native import**  
   - `bench --site <site> import-doc <ABS_PATH_TO_WORKSPACE_JSON>`
   - Then `bench --site <site> clear-cache` (+ optional `clear-website-cache`) and hard refresh
4) **Stop before destructive actions**  
   - If import still fails, do **not** delete/recreate the Workspace automatically. Investigate paths, JSON structure, and permissions first.

---

## Troubleshooting (manual)

- Confirm you edited the **canonical** path used by the running bench/container (avoid stale duplicates).
- Confirm you are operating on the correct **site** name.
- If UI is stale:
  - hard refresh (Ctrl+F5)
  - `bench --site <site> clear-cache`
  - restart web/socketio **only if** your processes are not autoreloading changes
- In bind-mounted dev: host file edits are visible immediately in the container filesystem, but **Frappe applies them only after the apply steps above**.

---

## Decision rules (anti-drift)

- DocType/schema JSON changes → **always** `bench --site <site> migrate` (targeted reload only for layout-only DocType tweaks).
- Workspace updates → migrate → verify DB → `import-doc` fallback → verify DB again.
- Always verify DB fields (`modified` + the changed field(s), e.g. `content`) **before claiming success**.

---

## Verification example: “MPIT Budget totals to the right”

- File edited: `<bench>/apps/master_plan_it/.../doctype/mpit_budget/mpit_budget.json`
- Apply:
  - Option A: `bench --site <site> migrate` → `bench --site <site> clear-cache`
  - Option B (layout-only): `bench --site <site> reload-doctype "MPIT Budget"` → `bench --site <site> clear-cache`
- Hard refresh Desk and confirm the Totals block renders on the right.


================================================================================
 FILE: ./docs/how-to/04-budget-cycle.md
================================================================================
# How to run the annual budget cycle

## Draft
- Create a `MPIT Budget` for the target year.
- Populate budget lines from validated baseline, contracts and new proposals.

## Review
- Usa le transizioni workflow: Draft → Proposed → In Review → Approved.

## Approve
- Client Editor and vCIO Manager can approve.
- Approval submits the document and freezes it (immutable baseline).

## After approval
- Use `MPIT Budget Amendment` for any changes.
- Record actuals continuously.


================================================================================
 FILE: ./docs/EPIC-P0.md
================================================================================
# MPIT Financial Policy & Delivery Plan (EPIC / PDL) — V3.1 (Deterministic Dev Reset + Self-Verification Runbook)

Date: 2025-12-26  
Scope: **Dev-only**. Data is disposable. The agent must delete containers + bind-mounted data directories and re-create a clean site.

Audience: implementation agent with:
- container terminal access (frappe container)
- host access for `docker compose` (required for the reset step)

---

## 1) Non-negotiable: Dev Reset (NO backups, NO rename, NO archive)

### 1.1 Run on the HOST (required)
Run from the project root (where `compose.yml` lives). **Do not use `bench drop-site`** (it archives/backs up). We want a hard wipe.

```bash
docker compose down --remove-orphans -v
rm -rf ./data/db ./data/sites ./data/logs ./data/redis
docker compose up -d --build
```

Rationale:
- This project persists data via **bind mounts** under `./data/*`. Deleting containers without deleting `./data/*` will keep the DB/site data.

### 1.2 Enter the frappe container and confirm the site exists
```bash
docker compose exec -T frappe bash
cd /home/frappe/frappe-bench
ls -la sites
```

Determine the site name:
```bash
echo "$SITE_NAME"
# if empty:
ls -1 sites | grep -vE 'assets|common_site_config\.json'
```

---

## 2) Mandatory “apply cycle” after any code/JSON change

Inside the frappe container:

```bash
cd /home/frappe/frappe-bench
bench --site "$SITE_NAME" migrate
bench --site "$SITE_NAME" clear-cache


If you changed any `.js` files under `doctype/*/*.js`, run an asset build (this stack does not run `bench watch`):
```bash
bench build --app master_plan_it
```
```

`clear-cache` is a standard bench site command. citeturn1search1turn1search11

If Desk/UI still shows stale behavior after Python edits (dev server not reloading), restart services:

```bash
exit
docker compose restart frappe
```

---

## 3) VAT defaults & override policy (implementation target)

### 3.1 Source of defaults (repo reality)
Defaults are per-user in **MPIT User Preferences**:
- `default_vat_rate`
- `default_amount_includes_vat`

Used via helper in:
- `apps/master_plan_it/master_plan_it/mpit_user_prefs.py`

### 3.2 Correct semantics (must enforce)
- If a doc/row has explicit values set (`vat_rate`, `amount_includes_vat`), **do not override** them.
- Apply defaults only at **creation time**:
  - new parent doc
  - new child row in table fields
- Do not force defaults in server-side `validate()` (it breaks explicit user overrides, especially for Check fields).

---

## 4) P0 EPIC — Bugfix-first (end-to-end tasks + verification)

> Implement these before adding new features. They affect correctness of plan vs reality.

### P0-0 Remove Workflows (NOT optional)

We are in dev reset; **do NOT create migration patches** for workflow deletion.

#### Code tasks
1) Delete workflow folders from repo:
- `apps/master_plan_it/master_plan_it/master_plan_it/workflow/mpit_budget_workflow/`
- `apps/master_plan_it/master_plan_it/master_plan_it/workflow/mpit_budget_amendment_workflow/`

2) Convert workflow fields to editable “Status label”
Do NOT rename fieldnames (avoid churn). Keep `workflow_state` but change behavior:
- In `MPIT Budget` doctype JSON:
  - `label` -> "Status"
  - `read_only` -> 0
  - `default` -> "Draft"
  - ensure `in_list_view` = 1
- In `MPIT Budget Amendment` doctype JSON: same

3) Server-side invariant in controllers:
- Draft (`docstatus=0`) must not be “Approved”
- On submit (`docstatus=1`) force status “Approved”

4) Update repo checks:
- `apps/master_plan_it/master_plan_it/devtools/verify.py`: remove REQUIRED_WORKFLOWS enforcement
- `apps/master_plan_it/master_plan_it/tests/test_smoke.py`: remove workflow existence assertion

#### Apply cycle
Run migrate + clear cache (Section 2).

#### Verification (via console)
Open console: citeturn1search0turn1search1
```bash
cd /home/frappe/frappe-bench
bench --site "$SITE_NAME" console --autoreload

In console, set a deterministic user context (controllers read `frappe.session.user`):
```py
import frappe
frappe.set_user("Administrator")
```
```

In console:
```py
import frappe
frappe.db.exists("Workflow", "MPIT Budget Workflow")
frappe.db.exists("Workflow", "MPIT Budget Amendment Workflow")
# both must be False (or None)
```

---

### P0-1 Fix annualization year bounds (MPIT Year start/end)

#### Why
`MPIT Actual Entry` derives `year` based on the `MPIT Year` date range. Annualization must use the same bounds.

#### Code tasks
1) Edit `apps/master_plan_it/master_plan_it/annualization.py`
- `get_year_bounds(year)` must:
  - attempt to load `MPIT Year` doc (name is the integer year as string)
  - if `start_date`/`end_date` exist, use those bounds
  - fallback to calendar year if doc missing

2) Fix wrong attribute in `mpit_budget.py`
- Replace `self.fiscal_year` -> `self.year` in error message.

#### Verification (data + computation)
In Desk (or console), create:
- MPIT Year:
  - year=2025
  - start_date=2025-07-01
  - end_date=2026-06-30

Then create a Baseline Expense with:
- year=2025
- amount=100
- recurrence_rule="Monthly"
- period_start_date=2025-07-01
- period_end_date=2025-12-31

Expected:
- annual_net should represent only overlapped months within the year bounds (not the calendar year default).

---

### P0-2 Fix VAT defaults end-to-end (UI defaults, no server override)

#### Code tasks
1) Remove “force includes_vat=1” in controllers:
- `mpit_baseline_expense.py`
- `mpit_actual_entry.py`
- `mpit_contract.py` (field `current_amount_includes_vat`)
- `mpit_budget_amendment.py` (child lines)
- `mpit_project.py` (allocations)
(Only remove the override behavior; keep VAT split calculations.)

2) Add a whitelisted API to fetch defaults:
In `mpit_user_prefs.py` add:
```py
import frappe

@frappe.whitelist()
def get_vat_defaults(user=None):
    prefs = get_or_create(user or frappe.session.user)
    return {
        "default_vat_rate": prefs.default_vat_rate,
        "default_includes_vat": bool(prefs.default_amount_includes_vat),
    }
```

3) Client scripts: apply defaults on **new docs** and on **child-row add**
Implement in:
- `doctype/mpit_baseline_expense/mpit_baseline_expense.js`
- `doctype/mpit_actual_entry/mpit_actual_entry.js`
- `doctype/mpit_contract/mpit_contract.js`
- `doctype/mpit_budget/mpit_budget.js` (lines_add)
- `doctype/mpit_budget_amendment/mpit_budget_amendment.js` (lines_add)
- `doctype/mpit_project/mpit_project.js` (allocations_add)

#### Verification (must be done)
1) Set MPIT User Preferences:
- default_amount_includes_vat = 1
- default_vat_rate = 22

2) Create each doc type above:
- New doc defaults to includes VAT = 1 and vat_rate = 22
- Manually toggle includes VAT = 0 and Save
- Reopen: includes VAT must stay 0 (no server override)

---

### P0-3 Fix Approved Budget vs Actual (correctness)

#### Repo bug
Actuals are aggregated by `(year, category)` and then “spread” across vendor rows.

#### Code tasks
Edit:
- `.../report/mpit_approved_budget_vs_actual/mpit_approved_budget_vs_actual.py`

Rules:
- Aggregate both plan and actual by `(year, category, vendor)`
- **Behavior note:** Actual Entries with `vendor` empty will appear under a blank vendor bucket and will NOT be attributed to vendor-specific budget lines. This is intentional to avoid silent duplication.
- Join vendor with NULL-safe equality:
  - `a.vendor <=> b.vendor` citeturn2search1turn2search7
- Use annualized plan:
  - `SUM(COALESCE(bl.annual_net, bl.amount_net, bl.amount))`

#### Verification dataset (create via console)
Create doctypes with known required fields:

**MPIT Category**
- field required: `category_name`

**MPIT Vendor**
- field required: `vendor_name`

**MPIT Year**
- field required: `year` (name is usually set to year)

Use console:
```bash
bench --site "$SITE_NAME" console --autoreload

In console, set a deterministic user context (controllers read `frappe.session.user`):
```py
import frappe
frappe.set_user("Administrator")
```
```

Paste:
```py
import frappe

def ensure(doctype, name, fields):
    if frappe.db.exists(doctype, name):
        return frappe.get_doc(doctype, name)
    doc = frappe.get_doc({"doctype": doctype, "name": name, **fields})
    doc.insert(ignore_permissions=True)
    return doc

ensure("MPIT Year", "2025", {"year": 2025})
ensure("MPIT Category", "Connectivity", {"category_name": "Connectivity"})
ensure("MPIT Vendor", "TIM", {"vendor_name": "TIM"})
ensure("MPIT Vendor", "Dimensione", {"vendor_name": "Dimensione"})
frappe.db.commit()
```

Create a Budget and submit:
```py
# Ensure Administrator has a default VAT rate to satisfy strict VAT validation
prefs = frappe.get_doc({"doctype": "MPIT User Preferences", "user": "Administrator"}).insert(ignore_permissions=True) \
    if not frappe.db.exists("MPIT User Preferences", {"user": "Administrator"}) else frappe.get_doc("MPIT User Preferences", {"user": "Administrator"})
prefs.default_vat_rate = 22
prefs.default_amount_includes_vat = 0  # keep net as the source for deterministic expectations
prefs.save(ignore_permissions=True)
frappe.db.commit()

b = frappe.get_doc({
  "doctype": "MPIT Budget",
  "year": "2025",
  "title": "Approved Budget 2025",
  "lines": [
    {
      "doctype": "MPIT Budget Line",
      "category": "Connectivity",
      "vendor": "TIM",
      "recurrence_rule": "Monthly",
      "amount": 104,
      "amount_includes_vat": 0,
      "vat_rate": 22
    },
    {
      "doctype": "MPIT Budget Line",
      "category": "Connectivity",
      "vendor": "Dimensione",
      "recurrence_rule": "Monthly",
      "amount": 49,
      "amount_includes_vat": 0,
      "vat_rate": 22
    },
  ]
}).insert(ignore_permissions=True)

b.submit()
frappe.db.commit()
```

Create actuals only for TIM:
```py
for m in range(1, 13):
    frappe.get_doc({
      "doctype": "MPIT Actual Entry",
      "posting_date": f"2025-{m:02d}-01",
      # year is derived from posting_date; leaving it set is OK but not required
      "year": "2025",
      "category": "Connectivity",
      "vendor": "TIM",
      "amount": 100,               # treat as NET for deterministic math
      "amount_includes_vat": 0,
      "vat_rate": 22
    }).insert(ignore_permissions=True)

frappe.db.commit()
```

Run report function directly (python import):
```py
from master_plan_it.report.mpit_approved_budget_vs_actual import mpit_approved_budget_vs_actual as r
res = r.execute({"year": "2025"})
print(type(res), len(res))
cols = res[0]; data = res[1]
# Verify: TIM row actual == 1200, Dimensione row actual == 0, total actual == 1200 (no duplication).
```

---

### P0-4 Fix Current Budget vs Actual (correctness + sorting safety)

#### Code tasks
Edit:
- `.../report/mpit_current_budget_vs_actual/mpit_current_budget_vs_actual.py`

Rules:
- consistent key `(year, category, vendor)` across baseline/budget/amendment/actual
- use annual fields for plan
- vendor join uses `<=>`
- sorting normalizes nulls (avoid `TypeError`)

Verification:
- create one budget line with vendor empty (None) and one with vendor set
- run report execute and confirm it does not crash

---

### P0-5 Fix Budget print format (field alignment)

Edit:
- `.../print_format/mpit_budget_professional/mpit_budget_professional.html`

Replace missing fields:
- `doc.fiscal_year` -> `doc.year`
- remove `doc.approved_date` (not present)
- show “Status” as `doc.workflow_state` (now editable label) or derive from `doc.docstatus`

Verify by printing from Desk.

---

## 5) Running automated tests (agent must run them)

### 5.1 Run unit tests
Frappe testing docs: citeturn0search0turn2search2

Inside container:
```bash
cd /home/frappe/frappe-bench
bench --site "$SITE_NAME" run-tests
```

If you want to target a specific test / doctype (optional):
- examples exist for `--test` / `--doctype` usage. citeturn2search9

### 5.2 If tests are slow or fail early
- First ensure migrations are clean (Section 2).
- Then rerun tests.

---

## 6) Definition of Done (DoD) for the P0 EPIC

All must be true:

1) Dev reset performed (Section 1) and fresh site exists.
2) Workflows removed from repo + no workflow checks remain + console confirms Workflow docs absent.
3) Annualization year bounds use MPIT Year start/end.
4) VAT defaults:
   - applied on new docs/rows via JS
   - never overridden server-side if user explicitly sets 0
5) Approved Budget vs Actual report:
   - no vendor duplication
   - uses annual planned values
6) Current Budget vs Actual report:
   - no vendor duplication
   - sorting safe with NULL vendor
7) Budget print format renders without template errors.
8) `bench --site "$SITE_NAME" run-tests` completes without failures.

---
End.


================================================================================
 FILE: ./docs/tutorials/00-first-budget-cycle.md
================================================================================
# Tutorial: First budget cycle (end-to-end)

This tutorial walks through the V1 lifecycle with native Desk UI.

## 0) Preconditions
- You have a dev site (tenant) with `master_plan_it` installed
- You have user accounts for:
  - vCIO Manager
  - Client Editor
  - Client Viewer

## 1) Setup the year
- Create `MPIT Year` for the target year (e.g. 2026).
- Mark it active if needed.

## 2) Setup categories and vendors
- Create a category tree in `MPIT Category` (groups + leaf categories).
- Create vendors in `MPIT Vendor`.

## 3) Import baseline historical spend
- Use Data Import to import into `MPIT Baseline Expense`.
- Use comments on each expense to ask clarifications.
- Update `status` to `Validated` once clarified.

## 4) Create contracts/subscriptions
- For recurring items, create `MPIT Contract` records.
- Set `next_renewal_date` (operational) and `notice_days`.
- Attach contract documents where available.

## 5) Draft the annual budget
- Create `MPIT Budget` for the year.
- Add `MPIT Budget Line` entries:
  - map from baseline and contracts where appropriate
  - add your compensation as a line
  - add a “portfolio bucket” line (is_portfolio_bucket=1)

## 6) Review and approve (workflow)
- Client Editor and vCIO Manager can move workflow states.
- When approved, the Budget is submitted and becomes immutable.

## 7) Record actuals during the year
- Insert `MPIT Actual Entry` records.
- Category is mandatory.
- Link to Contract or Project when relevant.

## 8) Amendments for post-approval changes
- Create `MPIT Budget Amendment` linked to the approved Budget.
- Add delta lines (+/-).
- Approve the amendment via workflow.

## 9) Projects (multi-year)
- Create `MPIT Project`.
- Add yearly allocations (mandatory for project approval).
- Add quotes and milestones as needed.
- Link project to budget lines and/or actual entries.

## 10) Reporting & dashboards
- Use the provided reports/dashboards:
  - Approved vs Actual
  - Current vs Actual
  - Renewals window
  - Projects planned vs actual



================================================================================
 FILE: ./docs/ux/field-help-text.md
================================================================================
# Field Help Text Inventory

- App package root: `apps/master_plan_it/master_plan_it`; DocTypes live in `apps/master_plan_it/master_plan_it/master_plan_it/doctype/**/<doctype>.json`.
- Label convention: labels are predominantly English; keep DocField `description` strings in English and translate them to Italian in `translations/it.csv`.
- Translation file present: `apps/master_plan_it/master_plan_it/translations/it.csv` (3 columns: `source_string,translated_string,context`).
- Policy: do not invent business rules; base help text on fieldtype, label/fieldname, options, or confirmed controller logic. If unclear, pause and ask for wording options.
- Current state: all meaningful DocFields now have bilingual descriptions (English source + Italian translation).

## Conventions and rules

- DocField `description` renders as helper text below the field in Frappe.
- Source strings stay English in DocType JSON; add Italian translations to `apps/master_plan_it/master_plan_it/translations/it.csv` (leave context blank for DocField descriptions because Frappe does not pass context for field metadata).
- Keep copy short (1 sentence, ≤120 chars), imperative/conditional; note VAT/recurrence/units only when present in schema or controllers.
- STOP when meaning is unclear; gather wording options instead of guessing.
- Checklist: edit DocType JSON → add matching `it.csv` line → log changes/evidence in `docs/ux/field-help-text-report.md`.

## Inventory snapshots

- Before (Phase 1): 16 DocTypes, 171 meaningful fields missing description (see report for prior counts).
- After (current): 0 meaningful fields missing description across all DocTypes. Table below shows the current state.

Counts per DocType (current totals | with description | meaningful fields missing description):

- MPIT Actual Entry: 16 | 16 | 0
- MPIT Amendment Line: 12 | 12 | 0
- MPIT Baseline Expense: 24 | 24 | 0
- MPIT Budget: 14 | 9 | 0
- MPIT Budget Amendment: 7 | 6 | 0
- MPIT Budget Line: 22 | 22 | 0
- MPIT Category: 9 | 9 | 0
- MPIT Contract: 21 | 21 | 0
- MPIT Project: 12 | 9 | 0
- MPIT Project Allocation: 7 | 7 | 0
- MPIT Project Milestone: 6 | 6 | 0
- MPIT Project Quote: 10 | 10 | 0
- MPIT Settings: 3 | 3 | 0
- MPIT User Preferences: 12 | 8 | 0
- MPIT Vendor: 6 | 6 | 0
- MPIT Year: 4 | 4 | 0


================================================================================
 FILE: ./docs/ux/field-help-text-report.md
================================================================================
# Field Help Text Report

## Inventory summary
- Before: 16 DocTypes with 171 meaningful fields missing description.
- After: all meaningful fields now have descriptions with Italian translations in `apps/master_plan_it/master_plan_it/translations/it.csv`.
- Context format for translations: `DocType:<Doctype> Field:<fieldname>`.
- Stop questions: none (all meanings derived from schema and controllers).

## Per DocType updates
### MPIT Actual Entry

- posting_date: Posting date for the entry; used to derive the MPIT Year.
- year: Derived MPIT Year based on the posting date.
- category: Select the category for this entry.
- vendor: Select the vendor involved in this entry.
- contract: Select the related contract, if applicable.
- project: Select the related project, if applicable.
- budget: Select the budget this entry relates to.
- budget_line_ref: Reference to the related budget line, if applicable.
- amount: Enter the actual amount; use net or gross per the VAT setting.
- amount_includes_vat: If enabled, the amount includes VAT.
- vat_rate: VAT rate applied to the amount.
- amount_net: Calculated automatically from amount and VAT settings.
- amount_vat: Calculated automatically as the VAT portion.
- amount_gross: Calculated automatically as the gross amount.
- description: Describe the actual entry.
- status: Choose whether the entry is recorded or verified.

### MPIT Amendment Line

- category: Select the category for this change.
- vendor: Select the vendor linked to this change.
- description: Describe the change captured by this line.
- delta_amount: Enter the adjustment amount for this line.
- delta_amount_includes_vat: If enabled, the adjustment amount includes VAT.
- delta_amount_gross: Calculated automatically as the gross delta amount.
- vat_rate: VAT rate applied to the adjustment.
- delta_amount_net: Calculated automatically from delta amount and VAT settings.
- delta_amount_vat: Calculated automatically as the VAT portion of the delta.
- contract: Select the related contract, if applicable.
- project: Select the related project, if applicable.
- note: Add an internal note for this line.

### MPIT Baseline Expense

- year: Select the year this expense belongs to.
- posting_date: Date when the baseline expense is recorded.
- category: Select the expense category.
- vendor: Select the vendor for this expense.
- description: Describe the baseline expense.
- amount: Enter the expense amount; use net or gross per the VAT setting.
- amount_includes_vat: If enabled, the amount includes VAT.
- vat_rate: VAT rate applied to the amount.
- amount_net: Calculated automatically from amount and VAT settings.
- amount_vat: Calculated automatically as the VAT portion.
- amount_gross: Calculated automatically as the gross amount.
- expense_kind: Choose the expense kind (one-off, subscription, renewal, or contract).
- recurrence_rule: Choose how this expense recurs for annualization.
- custom_period_months: Number of months per cycle when using a Custom recurrence.
- period_start_date: Start date of the period used to calculate overlap with the year.
- period_end_date: End date of the period used to calculate overlap with the year.
- annual_net: Calculated automatically as the annualized net amount.
- annual_vat: Calculated automatically as the annualized VAT amount.
- annual_gross: Calculated automatically as the annualized gross amount.
- contract_start: Contract start date, if relevant.
- contract_end: Contract end date, if relevant.
- auto_renew: If enabled, the contract renews automatically.
- notice_days: Number of notice days required before renewal.
- status: Current review status of this expense.

### MPIT Budget

- year: Select the budget year.
- title: Enter a short budget title.
- workflow_state: Workflow status set by the approval process.
- lines: Add budget lines for categories, vendors, and amounts.
- total_amount_input: Calculated automatically as the sum of line amounts.
- total_amount_vat: Calculated automatically as the sum of line VAT amounts.
- total_amount_net: Calculated automatically as the sum of net amounts.
- total_amount_gross: Calculated automatically as the sum of gross amounts.
- amended_from: Reference to the original budget this document was amended from.

### MPIT Budget Amendment

- budget: Select the budget being amended.
- effective_date: Date when this amendment takes effect.
- reason: Describe why the budget is being amended.
- workflow_state: Workflow status set by the approval process.
- lines: Add amendment lines detailing the changes.
- amended_from: Reference to the original amendment this document was copied from.

### MPIT Budget Line

- category: Select the budget category.
- vendor: Select the vendor for this line.
- description: Describe this budget line.
- recurrence_rule: Choose how this amount recurs for annualization.
- custom_period_months: Number of months per cycle when using a Custom recurrence.
- period_start_date: Start date of the period used to calculate overlap with the budget year.
- period_end_date: End date of the period used to calculate overlap with the budget year.
- amount: Enter the budgeted amount; use net or gross per the VAT setting.
- amount_includes_vat: If enabled, the amount includes VAT.
- amount_gross: Calculated automatically as the gross amount.
- vat_rate: VAT rate applied to the amount.
- amount_net: Calculated automatically from amount and VAT settings.
- amount_vat: Calculated automatically as the VAT portion.
- contract: Select the related contract, if applicable.
- project: Select the related project, if applicable.
- baseline_expense: Link to the baseline expense this line is based on.
- annual_net: Calculated automatically as the annualized net amount.
- annual_vat: Calculated automatically as the annualized VAT amount.
- annual_gross: Calculated automatically as the annualized gross amount.
- cost_type: Choose whether the cost is CAPEX or OPEX.
- is_portfolio_bucket: If enabled, this line acts as a portfolio bucket.
- is_active: If enabled, the budget line is active.

### MPIT Category

- category_name: Enter the category name.
- parent_category: Select the parent category.
- is_active: If enabled, the category is active for use.
- sort_order: Enter numeric order for sorting categories.
- lft: Calculated automatically for tree positioning.
- rgt: Calculated automatically for tree positioning.
- is_group: If enabled, category can contain child categories.
- old_parent: Previous parent category captured during moves.
- parent_mpit_category: Parent category used by tree view.

### MPIT Contract

- title: Enter the contract title.
- vendor: Select the vendor for this contract.
- category: Select the category for this contract.
- contract_kind: Choose the contract type (contract, subscription, renewal, or maintenance).
- billing_cycle: Choose the billing cycle for this contract.
- start_date: Date when the contract starts.
- end_date: Date when the contract ends.
- next_renewal_date: Next renewal date for this contract.
- notice_days: Number of notice days required before renewal.
- auto_renew: If enabled, the contract renews automatically.
- current_amount: Enter the current contract amount; use net or gross per the VAT setting.
- current_amount_includes_vat: If enabled, the current amount includes VAT.
- vat_rate: VAT rate applied to the current amount.
- current_amount_net: Calculated automatically from current amount and VAT settings.
- current_amount_vat: Calculated automatically as the VAT portion.
- current_amount_gross: Calculated automatically as the gross amount.
- status: Choose the current contract status.
- owner_user: Select the contract owner.
- source_baseline_expense: Link to the baseline expense that created this contract.
- notes: Add internal notes about the contract.
- attachment: Upload the contract file.

### MPIT Project

- title: Enter the project title.
- description: Add a brief description of the project.
- status: Choose the project status; at least one allocation is required before approval or later states.
- start_date: Date when the project starts.
- end_date: Date when the project ends.
- owner_user: Select the project owner.
- allocations: Add one or more allocations with year and planned amount.
- quotes: Add vendor quotes for this project.
- milestones: Add project milestones.

### MPIT Project Allocation

- year: Select the year for this allocation.
- planned_amount: Enter the planned amount for this year.
- planned_amount_includes_vat: If enabled, the planned amount includes VAT.
- planned_amount_gross: Calculated automatically as the gross amount.
- vat_rate: VAT rate applied to the planned amount.
- planned_amount_net: Calculated automatically from planned amount and VAT settings.
- planned_amount_vat: Calculated automatically as the VAT portion.

### MPIT Project Milestone

- title: Enter the milestone title.
- status: Choose the milestone status.
- due_date: Date when the milestone is due.
- acceptance_date: Date when the milestone was accepted.
- attachment: Upload any supporting attachment.
- notes: Add notes about the milestone.

### MPIT Project Quote

- vendor: Select the vendor providing the quote.
- quote_date: Date when the quote was received.
- attachment: Upload the quote document.
- status: Choose the quote status.
- amount: Enter the quoted amount.
- amount_gross: Calculated automatically as the gross amount.
- amount_includes_vat: If enabled, the amount includes VAT.
- vat_rate: VAT rate applied to the quote amount.
- amount_net: Calculated automatically from amount and VAT settings.
- amount_vat: Calculated automatically as the VAT portion.

### MPIT Settings

- currency: Select the default currency for Master Plan IT calculations.
- renewal_window_days: Days before renewal dates treated as the renewal window.
- portfolio_warning_threshold_pct: Percentage threshold used for portfolio warnings.

### MPIT User Preferences

- user: Select the user these preferences apply to.
- default_vat_rate: Default VAT rate for new entries (leave blank for no default, 0 is valid)
- default_amount_includes_vat: If enabled, new amounts default to VAT-inclusive.
- budget_prefix: Prefix used when generating budget names.
- budget_sequence_digits: Number of digits for budget sequence numbers.
- project_prefix: Prefix used when generating project names.
- project_sequence_digits: Number of digits for project sequence numbers.
- show_attachments_in_print: If enabled, attachments are shown on print formats.

### MPIT Vendor

- vendor_name: Enter the vendor name.
- vat_id: Enter the vendor VAT ID.
- contact_email: Enter the main contact email.
- contact_phone: Enter the main contact phone number.
- notes: Add internal notes about the vendor.
- is_active: If enabled, the vendor is active for selection.

### MPIT Year

- year: Enter the year identifier (e.g. 2025).
- start_date: Date when the year period starts.
- end_date: Date when the year period ends.
- is_active: If enabled, the year is active for planning.


================================================================================
 FILE: ./docs/reference/09-naming-title.md
================================================================================
# Reference: Naming + Title Field (Frappe v15)

Questa reference definisce **come** implementare naming deterministico e UX migliore senza frontend custom.

---

## 1) Naming (ID / `name`) in Frappe

Ogni documento ha un campo `name` come chiave primaria.
I modi supportati per controllare `name` includono:
- Naming Rules
- Metodo Python `autoname(self)` nel controller del DocType
- Proprietà DocType `autoname`

Per MPIT usiamo `autoname(self)` perché è:
- deterministico
- versionabile
- indipendente dalla configurazione UI del tenant

### 1.1 Implementazione consigliata
- crea `apps/master_plan_it/master_plan_it/naming.py`
- usa `frappe.model.naming.getseries(prefix, digits)`

### 1.2 Regola Budget (chiusa)
- `name`: `BUD-{Budget.year}-{NN}`
- `Budget.year` è *obbligatorio* e viene dal campo Year del Budget (Link a MPIT Year)

### 1.3 Regola Project (chiusa)
- `name`: `PRJ-{NNNN}`

### 1.4 Preferenze per-utente sul naming (richiesto)
In `MPIT User Preferences` definisci:
- `budget_prefix`, `budget_sequence_digits`
- `project_prefix`, `project_sequence_digits`

Budget mantiene la parte `{year}-` obbligatoria; le preferenze controllano prefix e digits.

---

## 2) Title Field (UX)

### 2.1 `title_field`
Impostare nel DocType:
- `title_field = "title"` (o il campo umano)

### 2.2 `show_title_field_in_link`
Impostare:
- `show_title_field_in_link = 1`

Risultato:
- nei Link fields si vede il titolo (umano), non solo `name` (ID serie)

---

## 3) Anti-regressione
- Non rinominare documenti esistenti.
- Naming deterministico vale per nuovi documenti.
- Se un record storico ha `name` random, deve continuare a funzionare.


================================================================================
 FILE: ./docs/reference/10-money-vat-annualization.md
================================================================================
# Reference: Money Rules (VAT + Normalizzazione + Annualizzazione) — MPIT (Frappe v15)

Fonte di verità per calcoli, report e stampa.

---

## 1) Strict VAT mode (CHIUSO)

Se `amount != 0`:
- `vat_rate` è obbligatorio (0 valido)
- se manca sulla riga e manca anche in `MPIT User Preferences.default_vat_rate` → blocco salvataggio

Se `amount == 0`:
- `vat_rate` può essere vuoto (ma consigliato 0).

Nessun default IVA tenant: i default sono solo per-utente.

---

## 2) Normalizzazione net/vat/gross

Sia:
- `r = vat_rate / 100`

Caso A: input netto (`includes_vat = 0`)
- net = amount
- gross = net * (1 + r)
- vat = gross - net

Caso B: input lordo (`includes_vat = 1`)
- gross = amount
- net = gross / (1 + r)
- vat = gross - net

Arrotondamento:
- `frappe.utils.flt(value, 2)` (salvo diversa precisione decisa)

### Totali Budget (form MPIT Budget)
- Il DocType MPIT Budget espone i campi `total_amount_input`, `total_amount_net`, `total_amount_vat`, `total_amount_gross`.
- I valori sono calcolati nel controller server-side sommando le righe della tabella `lines` (MPIT Budget Line), senza JavaScript.
- Ogni somma usa `frappe.utils.flt(..., 2)` per garantire arrotondamento a 2 decimali coerente con split net/vat/gross.

---

## 3) Annualizzazione (CHIUSO)

Recurrence: `Monthly, Quarterly, Annual, Custom, None`

Overlap:
- calcolare mesi di overlap tra anno del Budget.year (MPIT Year start/end) e range riga
- se overlap = 0 → blocco salvataggio (regola A)

Regole:
- Monthly: annual = amount * overlap_months
- Quarterly: annual = amount * (overlap_months / 3)
- Annual: annual = amount * (overlap_months / 12)
- None: one-off → annual = amount (se overlap > 0)
- Custom (Option A): richiede `custom_period_months` > 0
  - annual = amount * (overlap_months / custom_period_months)

Applicazione:
- normalizzare net/vat/gross prima
- annualizzare net/vat/gross separatamente

---

## 4) Backfill (anti-regressione)

Per dati storici senza VAT:
- set `vat_rate=0`, `includes_vat=0`
- net/gross=amount, vat=0
Non si “inventa” IVA storica.
---

## 5) Dual-Mode Controller (Phase 6 Implementation) ✅

**Problema:** Transizione da campo legacy `amount` a nuovo triple `amount_net/vat/gross`.

**Soluzione:** Controller intelligente che supporta entrambi i flussi.

### 5.1 Budget Line VAT Calculation (_compute_vat_split)

```python
def _compute_vat_split(self):
    """Compute amount_net/_vat/_gross from input fields using user defaults."""
    default_vat = mpit_user_prefs.get_default_vat_rate(frappe.session.user)
    default_includes = mpit_user_prefs.get_default_includes_vat(frappe.session.user)
    
    for line in self.lines:
        # Determine source amount: prefer amount_net (new field), fallback to amount (legacy)
        if line.amount_net:
            # NEW FLOW: amount_net is source of truth
            # Apply VAT defaults if not specified
            if line.vat_rate is None and default_vat is not None:
                line.vat_rate = default_vat
            
            # Compute VAT and gross from net
            if line.vat_rate:
                vat_rate_decimal = line.vat_rate / 100.0
                line.amount_vat = line.amount_net * vat_rate_decimal
                line.amount_gross = line.amount_net + line.amount_vat
            else:
                line.amount_vat = 0.0
                line.amount_gross = line.amount_net
                
        elif line.amount:
            # LEGACY FLOW: amount is source, split based on includes_vat flag
            # Apply defaults if field is empty
            if line.vat_rate is None and default_vat is not None:
                line.vat_rate = default_vat
            if not line.amount_includes_vat and default_includes:
                line.amount_includes_vat = 1
            
            # Strict VAT validation
            final_vat_rate = tax.validate_strict_vat(
                line.amount,
                line.vat_rate,
                default_vat,
                field_label=f"Line {line.idx} Amount"
            )
            
            # Compute split
            net, vat, gross = tax.split_net_vat_gross(
                line.amount,
                final_vat_rate,
                bool(line.amount_includes_vat)
            )
            
            line.amount_net = net
            line.amount_vat = vat
            line.amount_gross = gross
```

### 5.2 Campo Legacy Hidden

In exported DocTypes (Budget Line, Baseline Expense, Actual Entry, Project Quote):
```json
{
  "fieldname": "amount",
  "fieldtype": "Currency",
  "label": "Amount",
  "read_only": 1,
  "hidden": 1
}
```

**Risultato:**
- UI mostra solo `amount_net/vat/gross` (campi moderni)
- Controller accetta entrambi i flussi
- Dati legacy continuano a funzionare (backfill già applicato)
- Nuovo codice usa `amount_net` direttamente

### 5.3 Annualization Source Fix

`_compute_lines_annualization()` usa `line.amount_net` dopo VAT split:
```python
# Calculate annualized amounts
annual_net = annualization.annualize(
    line.amount_net,  # ← Sempre popolato dal dual-mode controller
    line.recurrence_rule or "None",
    line.custom_period_months,
    overlap_months_count
)
```

**CRITICAL:** VAT split (`_compute_vat_split()`) DEVE essere chiamato PRIMA di annualization (`_compute_lines_annualization()`) nella sequenza `validate()`.

### 5.4 Report Anti-Regression Pattern

Per compatibilità con dati storici, i report usano COALESCE:
```sql
SELECT
    COALESCE(annual_net, amount) AS budget_net,
    COALESCE(amount_net, amount) AS actual_net
FROM ...
```

Questo garantisce:
- Record nuovi: usano `annual_net`/`amount_net`
- Record legacy (pre-Phase 4): usano `amount` come fallback


================================================================================
 FILE: ./docs/reference/02-roles-permissions.md
================================================================================
# Reference: Roles and permissions (V1)

## Roles
- vCIO Manager
- Client Editor
- Client Viewer

## Principles
- Client Viewer: read-only across MPIT objects + reports/dashboards.
- Client Editor: can collaborate on proposals and approve via workflow.
- vCIO Manager: full access; operational governance.
- Workspace “Master Plan IT” is restricted to these roles (plus System Manager).

## Key permission rules
- Approved Budgets are immutable (docstatus=1). Editing is blocked by Frappe.
- Amendments are used for any post-approval changes.
- Actual Entries:
  - create/write allowed for Client Editor and vCIO Manager
  - read for all

## Notes
Exact DocPerm matrices stay in DocType JSON (native Frappe). Roles are shipped as filtered fixtures only for: vCIO Manager, Client Editor, Client Viewer.
- Workspace “Master Plan IT” is restricted to: System Manager, vCIO Manager, Client Editor, Client Viewer (synced from canonical metadata).


================================================================================
 FILE: ./docs/reference/03-workflows.md
================================================================================
# Reference: Workflows (V1)

## MPIT Budget workflow
States:
- Draft (docstatus 0)
- Proposed (0)
- In Review (0)
- Approved (docstatus 1)

Roles allowed to progress:
- vCIO Manager, Client Editor

Actions:
- Propose → Proposed
- Send to Review → In Review
- Approve → Approved

Notes:
- Approved state sets docstatus=1 to enforce immutability.
- Client Viewer cannot transition states.

## MPIT Budget Amendment workflow
States:
- Draft (0)
- Proposed (0)
- In Review (0)
- Approved (docstatus 1)
- Rejected (0)

Roles allowed:
- vCIO Manager, Client Editor

Notes:
- Rejected can be resubmitted to Proposed via action “Resubmit”.
Actions:
- Propose → Proposed
- Send to Review → In Review
- Approve → Approved
- Reject → Rejected
- Resubmit → Proposed

## Optional: MPIT Project workflow/policy
V1 can use a simple `status` Select field without a formal workflow.
If you need strict approval gates, introduce a workflow later (ADR required).

Implementation note: workflows live under `apps/master_plan_it/master_plan_it/master_plan_it/workflow/`, field name `workflow_state`, and are picked up from files via standard Frappe sync/migrate.


================================================================================
 FILE: ./docs/reference/01-data-model.md
================================================================================
# Reference: Data model (V1)

Naming convention: all DocTypes are prefixed `MPIT`.

## Setup
### MPIT Settings (Single)
- currency (Link: Currency)
- renewal_window_days (Int, default 90)
- portfolio_warning_threshold_pct (Int, default 100)

All monetary fields use the single currency configured in MPIT Settings; documents do not store their own currency choice.

### MPIT Year
- year (Int, unique)
- start_date (Date)
- end_date (Date)
- is_active (Check)

## Classification
### MPIT Category (Tree DocType)
- category_name (Data)
- parent_category (Link: MPIT Category)
- is_group (Check)
- is_active (Check)
- sort_order (Int)

### MPIT Vendor
- vendor_name (Data, unique)
- vat_id (Data, optional)
- contact_email (Data, optional)
- contact_phone (Data, optional)
- notes (Text)
- is_active (Check)

## Baseline
### MPIT Baseline Expense
- year (Link: MPIT Year) [recommended mandatory]
- posting_date (Date)
- category (Link: MPIT Category) [mandatory]
- vendor (Link: MPIT Vendor) [optional]
- description (Small Text)
- amount (Currency)
- expense_kind (Select: One-off / Subscription / Annual Renewal / Contract)
- recurrence (Select: Monthly / Quarterly / Annual / Custom / None)
- contract_start (Date, optional)
- contract_end (Date, optional)
- auto_renew (Check)
- notice_days (Int)
- status (Select: In Review / Needs Clarification / Validated / Archived)

## Contracts
### MPIT Contract
- title (Data)
- vendor (Link: MPIT Vendor) [mandatory]
- category (Link: MPIT Category) [mandatory]
- contract_kind (Select: Contract / Subscription / Annual Renewal / Maintenance)
- billing_cycle (Select: Monthly / Quarterly / Annual / Other)
- start_date (Date, optional)
- end_date (Date, optional)
- next_renewal_date (Date) [mandatory]
- notice_days (Int, optional)
- auto_renew (Check)
- current_amount (Currency, optional)
- status (Select: Draft / Active / Pending Renewal / Renewed / Cancelled / Expired)
- owner_user (Link: User, optional)
- source_baseline_expense (Link: MPIT Baseline Expense, optional)
- attachments (native Attach)

## Budgeting
### MPIT Budget (Submittable)
- year (Link: MPIT Year) [mandatory]
- title (Data)
- lines (Table: MPIT Budget Line)
- total_amount_input (Currency, read-only sum of line amounts)
- total_amount_net (Currency, read-only sum of line net amounts)
- total_amount_vat (Currency, read-only sum of line VAT amounts)
- total_amount_gross (Currency, read-only sum of line gross amounts)
- workflow_state (managed by Workflow)

### MPIT Budget Line (Child Table)
- category (Link: MPIT Category) [mandatory]
- vendor (Link: MPIT Vendor, optional)
- contract (Link: MPIT Contract, optional)
- project (Link: MPIT Project, optional)
- baseline_expense (Link: MPIT Baseline Expense, optional)
- description (Small Text)
- amount (Currency)
- amount_includes_vat (Check)
- vat_rate (Percent)
- amount_net (Currency, read-only)
- amount_vat (Currency, read-only)
- amount_gross (Currency, read-only)
- cost_type (Select: CAPEX / OPEX)
- recurrence (Select) + start_date/end_date (Date)
- is_portfolio_bucket (Check)
- is_active (Check)

### MPIT Budget Amendment (Submittable)
- budget (Link: MPIT Budget) [mandatory]
- effective_date (Date)
- reason (Text)
- lines (Table: MPIT Amendment Line)
- workflow_state

### MPIT Amendment Line (Child Table)
- category (Link: MPIT Category) [mandatory]
- vendor (Link: MPIT Vendor, optional)
- contract (Link: MPIT Contract, optional)
- project (Link: MPIT Project, optional)
- description (Small Text)
- delta_amount (Currency) [mandatory]
- note (Text)

## Actuals
### MPIT Actual Entry
- posting_date (Date) [mandatory]
- year (Link: MPIT Year) [derived from posting_date]
- category (Link: MPIT Category) [mandatory]
- vendor (Link: MPIT Vendor, optional)
- contract (Link: MPIT Contract, optional)
- project (Link: MPIT Project, optional)
- amount (Currency) [mandatory]
- budget (Link: MPIT Budget, optional)
- budget_line_ref (Data/Small Text, optional)
- description (Small Text)
- status (Select: Recorded / Verified)

## Projects
### MPIT Project
- title (Data)
- description (Text)
- status (Select: Draft / Proposed / Approved / In Progress / On Hold / Completed / Cancelled)
- start_date (Date)
- end_date (Date)
- owner (Link: User)
- allocations (Table: MPIT Project Allocation) [mandatory before approval]
- quotes (Table: MPIT Project Quote) [optional]
- milestones (Table: MPIT Project Milestone) [optional]

### MPIT Project Allocation (Child Table)
- year (Link: MPIT Year) [mandatory]
- planned_amount (Currency) [mandatory]

### MPIT Project Quote (Child Table)
- vendor (Link: MPIT Vendor)
- amount (Currency)
- quote_date (Date)
- attachment (Attach)
- status (Select: Received / Accepted / Rejected)

### MPIT Project Milestone (Child Table)
- title (Data)
- due_date (Date)
- status (Select: Planned / Done / Accepted)
- acceptance_date (Date)
- notes (Text)
- attachment (Attach)


================================================================================
 FILE: ./docs/reference/10-printing-and-report-print-formats.md
================================================================================
# Reference: Printing (DocType Print Formats + Report Print Formats) — Frappe v15

This reference explains how to produce **professional, consistent PDFs** using only Frappe framework tools,
with **no custom CSS** and no frontend build.

It covers:
- DocType Print Formats (Jinja templates)
- Report Print Formats (`{report_name}.html`) (client-side microtemplating)
- How to display attachments safely (avoid “broken image” icons for PDFs)

---

## 1) DocType Print Formats (Jinja)

### 1.1 What Frappe uses
- DocType print formats use **Jinja** templating.
- You can create formats using the Print Format Builder, then add Custom HTML blocks with Jinja.
- If you set **Standard = Yes** and Developer Mode is enabled, Frappe writes a JSON file in your app for versioning.

### 1.2 MPIT policy (no custom CSS)
- Do not use the “Custom CSS” field.
- Use Bootstrap classes (`table`, `table-bordered`, `text-right`, etc.) in the HTML.

### 1.3 Deterministic “standard print format export” procedure

**Goal:** end with a version-controlled file under the app, so printing works on a fresh site.

1) Ensure developer mode is enabled:
```bash
bench --site <site> set-config developer_mode 1
bench --site <site> clear-cache
```

2) In Desk (Awesomebar):
- Type **“New Print Format”**
- Select the DocType (e.g., `MPIT Budget`)
- Name the format exactly (examples):
  - `MPIT Budget (Professional)`
  - `MPIT Budget (Professional + Attachments)`
  - `MPIT Project (Professional)`
  - `MPIT Project (Professional + Attachments)`
- Set:
  - **Standard = Yes**
  - **Custom Format = Yes**
  - **Print Format Type = Jinja**
- Paste your template HTML.

3) Save. Confirm that a JSON file appears inside the app (path depends on Frappe export rules).
   Commit that file in the repo.

4) Repeat for all required formats.

> If the JSON file is not created, verify:
> - Developer mode is enabled for the site
> - Standard = Yes on the print format
> - You restarted bench after enabling developer mode

---

## 2) Attachments in DocType print formats (avoid broken PDF icons)

### 2.1 Why PDFs break when treated as images
- PDFs are not images; embedding them with `<img>` results in broken image icons in HTML/PDF.
- MPIT policy: print a clean list of attachments (file name + link), do not embed.

### 2.2 How to list attachments in Jinja (supported functions)

Frappe exposes whitelisted functions in Jinja templates, including `frappe.get_all` and `frappe.get_url`.

Recommended snippet (list files attached to the document):

```jinja
{% set files = frappe.get_all(
    "File",
    filters={"attached_to_doctype": doc.doctype, "attached_to_name": doc.name},
    fields=["file_name", "file_url"]
) %}

{% if files %}
  <h4>Attachments</h4>
  <ul>
  {% for f in files %}
    <li>
      <a href="{{ frappe.get_url() }}{{ f.file_url }}">{{ f.file_name }}</a>
    </li>
  {% endfor %}
  </ul>
{% endif %}
```

Notes:
- This prints links that work in HTML; PDFs generated by wkhtmltopdf may not keep clickable links depending on settings.
- If you need non-clickable links, print just the `file_name`.

---

## 3) Report Print Formats (`{report_name}.html`) — not Jinja

### 3.1 What Frappe uses
Report print formats are **client-side HTML templates** and use a JS microtemplating syntax (similar to Jinja, but not the same).

**How to add one**
- Create a file named `{report_name}.html` next to the report `.py/.js/.json` files.
- Example folder structure:
  - `mpit_current_budget_vs_actual/`
    - `mpit_current_budget_vs_actual.py`
    - `mpit_current_budget_vs_actual.js`
    - `mpit_current_budget_vs_actual.json`
    - `mpit_current_budget_vs_actual.html`  ← you add this

### 3.2 Template data contract
In the template you can access:
- `data` (list of row objects; keys are slugified labels)
- `filters`
- `report` (report view object)

### 3.3 Critical rule: avoid single quotes
The report print templating engine is sensitive to single quotes in some contexts.
Prefer double quotes in HTML attributes and JS strings.

### 3.4 Minimal MPIT report print template skeleton

```html
<div class="container">
  <h3><%= __("MPIT Report") %></h3>

  <p class="text-muted">
    <%= __("Printed on") %>: <%= frappe.datetime.now_datetime() %>
  </p>

  <table class="table table-bordered table-condensed">
    <thead>
      <tr>
        <th><%= __("Label 1") %></th>
        <th class="text-right"><%= __("Amount") %></th>
      </tr>
    </thead>
    <tbody>
      <% for (var i = 0; i < data.length; i++) { %>
        <tr>
          <td><%= data[i].label_1 || "" %></td>
          <td class="text-right"><%= format_currency(data[i].amount) %></td>
        </tr>
      <% } %>
    </tbody>
  </table>
</div>
```

---

## 4) Verification checklist (printing)

After adding print formats:
1) Open one Budget and one Project in Desk → Print → select each new print format → Preview works.
2) Export to PDF → layout is readable (no broken images).
3) Open each MPIT report → Print → template is applied and table renders.

If PDF output looks different than HTML preview:
- Check Print Settings and wkhtmltopdf behavior
- Reduce “fancy” HTML; keep to tables and simple layout


================================================================================
 FILE: ./docs/reference/06-dev-workflow.md
================================================================================
# Reference: Technical dev workflow (Frappe v15)

This document defines the **native file-first** workflow for Master Plan IT.

## Source of truth

- App root in Git: `apps/master_plan_it/` (same path under a bench).
- Exported metadata lives under `apps/master_plan_it/master_plan_it/master_plan_it/` (doctype, report, workflow, dashboard, dashboard_chart, number_card, master_plan_it_dashboard, workspace, print_format).
- These files are edited directly in Git; they are the canonical inputs for Frappe. No spec-import and no `sync_all`.
- **Warning:** Do not manually create duplicate metadata folders outside the canonical module folder.
- **Translations:** Follow `AGENT_INSTRUCTIONS.md` → “Translations (i18n) – Native Frappe Rules” for marking strings and maintaining `translations/it.csv`.

## Who generates/edits files?

- Human or LLM agent edits the exported JSON + Python controllers in the canonical module folder.
- Desk/UI is read-only for day-to-day metadata changes. Allowed UI actions:
  - Initial skeleton creation when a new object is first made.
  - **Export Customizations** for non-owned DocTypes.

## Native workflow (file-first)

1. Edit the exported JSON and Python controllers under `apps/master_plan_it/master_plan_it/master_plan_it/`.
2. If you used Desk for skeleton/customizations, immediately export to files so the canonical folder stays accurate.
3. Apply changes with standard Frappe commands (`bench --site <site> migrate` / `clear-cache`) as needed. No `sync_all` or custom import pipelines.
4. Commit the canonical files; these are the sole source for deployments.
5. Install hooks handle baseline bootstrap (MPIT Settings + current/next MPIT Year); fixtures ship MPIT roles.

## Determinism rules

1) Keep metadata JSON stable and sorted; avoid renaming DocTypes/modules once created.
2) Treat Desk exports as read-through: after UI edits, ensure the canonical folder reflects the final state.
3) If an object is removed, delete its folder from the canonical path; do not leave shadow copies elsewhere.
4) In bind-mounted dev (docker compose), edits on the host appear in the container immediately; Desk reflects changes after the usual reload/migrate cycle.


================================================================================
 FILE: ./docs/reference/05-fixtures-bootstrap.md
================================================================================
# Reference: Fixtures & Bootstrap

Fixtures are standard Frappe exports filtered to Master Plan IT records only. Keep them minimal and deterministic.

## Fixture principles
- Export only MPIT-specific records; avoid unfiltered exports.
- Keep filters in fixture definitions so re-exporting stays stable.
- Do not rely on any spec/import pipeline. The source of truth is the exported files under `apps/master_plan_it/master_plan_it/master_plan_it/`.
- Avoid creating duplicate metadata paths outside the canonical module folder.

## Applying changes
- Edit canonical metadata and controllers in `apps/master_plan_it/master_plan_it/master_plan_it/`.
- Export Customizations for non-owned DocTypes if you modified them in Desk.
- Apply to a site with standard Frappe commands (`bench --site <site> migrate`, `clear-cache`) as needed.

## What ships as fixtures
- Roles are shipped as a filtered fixture (`apps/master_plan_it/master_plan_it/fixtures/role.json`) covering only: `vCIO Manager`, `Client Editor`, `Client Viewer`.
- Keep the fixture minimal (doctype, name/role_name, desk_access) so it stays stable between exports.

## Bootstrap (install hooks)
- Install hooks (`master_plan_it.setup.install.after_install/after_sync`) create the singleton MPIT Settings document and MPIT Year for the current and next calendar year.
- No devtools “bootstrap” scripts are required for baseline data; verification happens later via Desk after a normal migrate.


================================================================================
 FILE: ./docs/reference/04-reports-dashboards.md
================================================================================
# Reference: Reports and dashboards (V1)

## Reports (minimum set)
Implemented as **Script Reports** (standard):
1) **MPIT Approved Budget vs Actual** — Budgets docstatus=1 vs Actual Entries by category/year (chart included).
2) **MPIT Current Budget vs Actual** — Baseline + approved amendments vs Actual (chart included).
3) **MPIT Renewals Window** — Contracts with `next_renewal_date` in window (default 90d); supports `include_past` to show expired; chart by month.
4) **MPIT Projects Planned vs Actual** — Allocations vs Actual Entries per project/year (chart included).

### Report Print Formats (Phase 6 ✅)
Tutti i 4 report hanno HTML templates per stampa professionale:

**1. MPIT Approved Budget vs Actual**
- Path: `report/mpit_approved_budget_vs_actual/mpit_approved_budget_vs_actual.html`
- Features: 7-column table (Category, Vendor, Baseline Net/VAT/Gross, Actual, Variance)
- Color coding: red for over-budget (variance < 0), green for under-budget (variance > 0)
- Filter display: Year, Category, Vendor

**2. MPIT Current Budget vs Actual**
- Path: `report/mpit_current_budget_vs_actual/mpit_current_budget_vs_actual.html`
- Features: 9-column table (Category, Vendor, Baseline Net, Amendments Delta, Current Net, Actual, Variance)
- Amendment delta color coding: red for increases, green for decreases
- Shows full budget lifecycle: baseline → amendments → current

**3. MPIT Projects Planned vs Actual**
- Path: `report/mpit_projects_planned_vs_actual/mpit_projects_planned_vs_actual.html`
- Features: Status badges (Planning=yellow, Active=green, Completed=gray, Cancelled=red)
- Variance analysis per project
- Filter display: Year, Status, Project

**4. MPIT Renewals Window**
- Path: `report/mpit_renewals_window/mpit_renewals_window.html`
- Features: Urgency-based badges (Expired=red, Urgent≤30d=orange, Soon≤60d=yellow, Normal=blue)
- Contract renewal tracking with days to renewal, notice days, auto-renew flag
- Filter display: Days Forward, From Date, Include Past

### Styling Guidelines
- Microtemplating syntax: `<%= variable %>`, `<% if/for %>`
- Bootstrap classes: `.table`, `.badge`, `.text-right`, `.text-danger`, `.text-success`
- Embedded CSS inline (no external stylesheets)
- NO JavaScript lato client (ADR 0006 compliance)
- NO apici singoli `'` nel template (limitazione microtemplating)

## Dashboards
Dashboard **“Master Plan IT Overview”** (standard):
- Number cards: Renewals 30d / 60d / 90d, Expired Contracts (all based on MPIT Renewals Window)
- Charts: Budget vs Actual (approved), Current Budget vs Actual, Renewals by Month, Projects Planned vs Actual

## Notes
Reports should be implemented as Query Reports where possible.
If logic is non-trivial (e.g., current budget computation), prefer a Script Report (backend only).


================================================================================
 FILE: ./docs/reference/11-printing-v15.md
================================================================================
# Reference: Printing (Frappe v15)

Guidance for MPIT print formats with the native file-first workflow.

- Store print formats under `apps/master_plan_it/master_plan_it/master_plan_it/print_format/` and version them in Git.
- Prefer server-side Jinja templates; avoid client-side rendering for stability.
- After Desk edits, export the print format back into the canonical folder immediately.
- Apply changes with standard Frappe commands (`bench --site <site> migrate`, `clear-cache`); no custom `sync_all` / spec-import pipeline.
- You can import a specific print format manually with `frappe.modules.import_file.import_file_by_path()` if needed.


================================================================================
 FILE: ./docs/reference/07-testing.md
================================================================================
# Reference: Testing (server + UI)

## Server-side tests (Python)

Place tests anywhere in the app, filenames must start with `test_*.py`.

Run:
```bash
bench --site <site> run-tests --app master_plan_it
```

You can run narrower scopes too (examples):
```bash
bench --site <site> run-tests --doctype "MPIT Budget"
bench --site <site> run-tests --test "test_smoke"
```

## UI tests (native approach)

Frappe supports UI tests using **Cypress** (integration tests) and also JS tests using **QUnit**.

We keep Cypress tests inside the app folder:
- `cypress/integration/*.spec.js`

To run Cypress for this app:
```bash
cd apps/master_plan_it
yarn
yarn cypress:open
# or: yarn cypress:run
```

> Note: UI tests require a running site (`bench start`) and a known admin password for the test site.

## What we test in V1

- Smoke: user can login and open MPIT workspace/pages
- Smoke: create a Budget, move it through workflow, ensure status changes
- Regression: permissions (Client Viewer can't edit, Client Editor can)
- Regression: Actual Entry derives year from posting_date; Project cannot be approved without allocations


================================================================================
 FILE: ./docs/EPIC-POST-P0.md
================================================================================
# MPIT — Feature EPICs (Post-P0) — V1

Data: 2025-12-26  
Stato: pronta per l’agent (senza internet)

Questo file definisce le **EPIC successive** alla P0 (bugfix-first) già completata, includendo criteri di Done e test end-to-end.
Assume come decisioni già chiuse:
- **No Workflows**: solo `docstatus` + label `Status` (ex `workflow_state`) per Draft-stage.
- **Annualizzazione**: coerente con `MPIT Year.start_date/end_date`.
- **Report Budget vs Actual** corretti per `(year, category, vendor)` con join NULL-safe.
- **VAT defaults (Baseline)**: implementati **solo nel doctype script** `mpit_baseline_expense.js` (single source of truth), idempotente, senza `doctype_js` hook.

---

## 0) Convenzioni tecniche condivise (da rispettare in tutte le EPIC)

### 0.1 Apply cycle obbligatorio dopo modifiche
Nel container `frappe`:

```bash
cd /home/frappe/frappe-bench
bench --site "$SITE_NAME" migrate
bench --site "$SITE_NAME" clear-cache
bench build --app master_plan_it
```

Se la UI resta “stale” dopo cambi Python, riavvia:

```bash
exit
docker compose restart frappe
```

### 0.2 Regola “no rabbit hole JS”
- Evitare dichiarazioni top-level `const/let` per helper che potrebbero essere ricaricati.
- Usare `frappe.provide("master_plan_it.vat")` e assegnazioni idempotenti (`x = x || ...`).
- Un solo “source of truth” per la logica di default per ciascun doctype: **doctype script**.

### 0.3 VAT defaults: policy comune
- Defaults provengono da **MPIT User Preferences** (`default_vat_rate`, `default_amount_includes_vat`) via `get_vat_defaults`.
- Applicazione default **solo in UI**:
  - nuovo documento: `onload + refresh` con guard `__vat_defaults_applied`
  - nuova riga child table: handler `*_add` che applica default al row appena creato
- Backend non deve mai sovrascrivere un valore esplicito inserito dall’utente.

### 0.4 Test: livelli
- **Backend**: `bench console --autoreload` per creare docs e chiamare `execute()` dei report.
- **UI**: verifica in incognito (Desk) per default VAT e render form.
- **Automated**: `bench --site "$SITE_NAME" run-tests --app master_plan_it`.

---

## EPIC E-01 — VAT Defaults Uniform (tutti i doctypes)

### Obiettivo
Rendere coerente e prevedibile l’autocompilazione IVA su:
- MPIT Actual Entry
- MPIT Contract
- MPIT Budget (child: MPIT Budget Line)
- MPIT Budget Amendment (child lines)
- MPIT Project (child allocations)

Baseline è già risolta con doctype script; questa EPIC estende lo stesso pattern.

### Scope
- Solo UI defaulting + idempotenza, **nessun refactor** delle funzioni di split IVA.
- Rimozione di qualunque “force default” residuo nel backend (se rimasto).

### Task
1) Per ogni doctype sopra:
   - implementare pattern identico a Baseline:
     - cache promessa `mpitVatDefaultsPromise`
     - `applyVatDefaults(frm)` con guard `frm.doc.__vat_defaults_applied`
     - applicazione su `onload` e `refresh`
2) Per child tables:
   - implementare `lines_add` / `allocations_add` ecc. per settare:
     - `vat_rate` se unset
     - `amount_includes_vat` se 0/unset (solo su nuova riga)
3) Eliminare qualunque duplicazione/legacy:
   - niente `doctype_js` hook
   - niente file pubblici duplicati
4) Aggiungere un test minimo (consigliato):
   - crea doc in console con includes_vat esplicito 0 e verifica resta 0

### Verifica (DoD)
- In incognito: creando ciascun doctype, i campi IVA si autocompilano al primo load.
- Dopo aver cambiato e salvato, riaprendo il doc non viene forzato un valore diverso.
- Nessun errore JS in console.

---

## EPIC E-02 — Budget Diff (As‑Is vs Proposed)

### Obiettivo
Report che confronta **due Budget** (A e B), mostrando differenze economiche in modo leggibile (annuale + mensile equivalente), raggruppato per default su `(Category, Vendor)`.

### Output richiesto
Colonne minime:
- Category
- Vendor (può essere vuoto)
- Budget A annual_net
- Budget B annual_net
- Delta annual_net (B - A)
- Budget A monthly_eq (annual/12)
- Budget B monthly_eq
- Delta monthly_eq
- (opzionale) link ai Budget (name/title)

### Filtri
- `budget_a` (required)
- `budget_b` (required)
- (opzionale) `group_by` = `"Category+Vendor"` (default) | `"Category"`
- (opzionale) `only_changed` (checkbox): mostra solo righe con delta != 0

### Regole di calcolo
- Planned = `COALESCE(annual_net, amount_net, amount)` (fallback per dati vecchi)
- Vendor match con NULL-safe behavior:
  - se vendor è NULL su una riga, rimane nel bucket “vendor vuoto”
  - non riallocare automaticamente.

### Task
1) Creare nuovo report Script Report:
- path: `apps/master_plan_it/master_plan_it/master_plan_it/report/mpit_budget_diff/`
  - `mpit_budget_diff.py`
  - `mpit_budget_diff.json`
2) Implementare `execute(filters)`:
   - validare filtri
   - caricare righe A e B (aggregate)
   - produrre union delle chiavi e calcolare delta
   - aggiungere total row
3) (opzionale) `report_summary`:
   - Totale A, Totale B, Delta
4) (opzionale) `chart`:
   - top 10 delta per category (bar)

### Dataset di verifica (console)
- Budget A: TIM 104/mese (Connectivity)
- Budget B: Dimensione 49/mese (Connectivity)
Atteso:
- TIM: -1248 annual
- Dimensione: +588 annual
- Totale: -660 annual

### DoD
- Report produce risultati coerenti e non duplicati.
- `bench run-tests` green.
- Verifica manuale con dataset.

---

## EPIC E-03 — Monthly View (Budget vs Actual) + Cumulative

### Obiettivo
Dashboard/report mensile che mostri:
- Planned mensile (da annuale/12 per V1)
- Actual mensile
- Varianza mensile e cumulata
- Filtri per anno e mese (o range mesi)

### Filtri
- `year` (required)
- `view` = Monthly | Cumulative (default Monthly)
- (opzionale) `category`, `vendor`, `project`, `contract`
- (opzionale) `include_portfolio` (default true)

### Regole V1 (semplici, senza reinventare)
- planned_month = planned_annual / 12
- actual_month = SUM(actual entries nel mese)
- cumulative: somma 1..N

### Portfolio
- Portfolio è una Budget Line con `is_portfolio_bucket=1`
- Deve comparire:
  - come riga/bucket dedicato (o in summary)
  - evidenziando planned vs actual

### Task
1) Nuovo report:
- `report/mpit_monthly_budget_vs_actual/`
2) SQL/aggregation:
- Planned: da **Current Budget** (approved + amendments) annualized, poi /12
- Actual: group by mese e per le stesse chiavi
3) UI:
- columns con mese, planned, actual, variance
- report_summary con totals e YTD
4) Test:
- dataset con 2-3 actual entries e check varianza corretta

### DoD
- Report mensile e cumulato corretti con vendor NULL-safe.
- Nessun duplicato di actual.

---

## EPIC E-04 — Guided Import (V1: template + preflight minimo)

### Obiettivo
Ridurre tempo di inserimento iniziale (baseline/budget) usando:
- template CSV/XLSX
- una procedura guidata (anche solo doc/README) senza codice pesante

### Scope V1 (no custom importer complesso)
- Fornire template “client-ready”
- Preflight minimo:
  - campi obbligatori presenti
  - mapping category/vendor coerenti
  - validazione numeri/date base

### Deliverable
1) Un template “Baseline Import”:
   - year, category, vendor, description
   - recurrence_rule, custom_period_months
   - amount, amount_includes_vat, vat_rate
   - period_start_date, period_end_date
2) Un template “Budget Import” analogo (per righe budget)
3) Doc di istruzioni (md) con:
   - come compilare
   - esempi validi
   - errori comuni

### Task
- Aggiungere docs:
  - `docs/how-to/import/01-baseline-template.md`
  - `docs/how-to/import/02-budget-template.md`
- (Opzionale) comando di validazione via `bench console` (script) che legge CSV e segnala errori (senza import automatico).

### DoD
- Template pronti e verificabili.
- Un utente può inviare il file al cliente e reinserire rapidamente.

---

## EPIC E-05 — Contracts Renewals (vista + notifiche)

### Obiettivo
Avere una vista chiara di:
- contratti con auto-renew
- prossime scadenze / next renewal date
- notice days (se auto-renew)

### Scope V1
- Report/lista + eventuale dashboard semplice.
- Notifica: V1 può essere “report + filtro”; se implementiamo reminder automatici, farlo come step separato.

### Task
1) Report `mpit_contract_renewals`:
   - columns: vendor, title, status, auto_renew, next_renewal_date, notice_days, end_date
   - filtri: “next N days”, “auto_renew only”
2) (Opzionale) email notification: rimandare a EPIC successiva se non già presente.

### DoD
- report utilizzabile per planning meeting.

---

## EPIC E-06 — Projects: estimate → quote → actual

### Obiettivo
Gestire progetti con:
- costo stimato (budgetizzato)
- preventivi (quote)
- consuntivi (actual entries collegate al project)

### Scope V1
- Nessun workflow.
- Status label (Draft/Proposed/Approved/Done/Cancelled) + docstatus se serve per freeze.

### Task
1) Uniformare i campi “planned” e “actual” su Project:
   - planned annual / total
   - actual via query sum actual entries linkate al project
2) Report “Project financials”:
   - planned vs actual, variance
3) UI: quick summary sul form project

### DoD
- Un progetto può essere stimato e poi consuntivato senza dover “inventare” processi.

---

## EPIC E-07 — Realtime/socket.io + preload warnings (backlog tecnico)

### Obiettivo
Eliminare rumore e possibili side effect su Desk:
- timeout socket.io su `:9000`
- warning preload (non bloccanti)

### Scope
- Solo se serve: non deve bloccare lo sviluppo delle feature.

### Task (solo analisi + fix minimale)
1) Capire se in dev è necessario realtime:
   - se NO: disabilitare o configurare per non tentare connessione
2) Se SI: configurare reverse proxy per websocket / socket.io

### DoD
- Niente timeout ripetuti in console.
- Desk stabile.

---

## Sequenza consigliata (per evitare regressioni)
1) E-01 VAT Defaults Uniform  
2) E-02 Budget Diff  
3) E-03 Monthly View  
4) E-05 Contracts Renewals  
5) E-06 Projects  
6) E-04 Guided Import (doc/template)  
7) E-07 Realtime backlog

---
Fine file.


================================================================================
 FILE: ./docs/explanation/01-architecture.md
================================================================================
# Explanation: Architecture

## Tenant model
One client equals one Frappe site. This yields hard data segregation and simplifies permissions.
The vCIO works across many sites.

## Why Desk users for clients
Desk provides the full native experience: lists, forms, reports, dashboards, workflows.
Portal/Website Users would require custom pages for comparable analytics.

## Immutability model
Budgets approved at the start of the year become immutable to ensure consistent comparisons.
In-year changes are modeled as amendments with delta lines.

## Contract governance
Historical spend is imported into baseline.
Contracts/subscriptions are curated records that drive renewals and ongoing governance.

## Projects
Projects are standalone objects and can span multiple years.
To keep annual reporting consistent, per-year allocations are mandatory before approval.



================================================================================
 FILE: ./CHANGELOG.md
================================================================================
# CHANGELOG — Master Plan IT

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

> Note: starter-kit overlays, spec folders, backups, and custom preflight have been removed in the current repo. Bootstrap now relies on install hooks + fixtures; historical entries remain for context.

## [0.1.0] - 2025-12-22

### Added - EPIC MPIT-E01 (Phases 1-6)

#### Phase 1: User Preferences
- **DocType:** `MPIT User Preferences` with per-user VAT defaults, naming series, print options
- **Helper Module:** `master_plan_it/mpit_user_prefs.py` with functions:
  - `get_or_create(user)` — Get or create preferences for user
  - `get_default_vat_rate(user)` — Get default VAT rate
  - `get_default_includes_vat(user)` — Get default includes VAT flag
  - `get_budget_series(user)` — Get Budget naming series
  - `get_project_series(user)` — Get Project naming series
  - `get_show_attachments_in_print(user)` — Get attachments print preference
- **Workspace Integration:** Added "User Preferences" shortcut to Master Plan IT workspace
- **Precision:** Set VAT Rate field to `precision: 2` for consistent % display

#### Phase 2: Title Field UX
- **MPIT Budget:** Added `title_field: "title"` and `show_title_field_in_link: 1`
- **MPIT Project:** Added `title_field: "title"` and `show_title_field_in_link: 1`
- **UX Improvement:** Link fields now show human-readable titles instead of IDs

#### Phase 3: Naming Automation
- **MPIT Budget:** Implemented `autoname()` method with pattern `BUD-{YYYY}-{NN}`
  - Uses `MPIT User Preferences.budget_prefix` (default: `BUD-`)
  - Year extracted from `MPIT Budget.year` field
  - Sequential numbering per year via `frappe.utils.data.getseries()`
- **MPIT Project:** Implemented `autoname()` method with pattern `PRJ-{NNNN}`
  - Uses `MPIT User Preferences.project_prefix` (default: `PRJ-`)
  - 4-digit sequential numbering via getseries
- **Example Names:** BUD-2025-01, BUD-2025-02, PRJ-0001, PRJ-0002

#### Phase 4: Strict VAT Normalization
- **Helper Module:** `master_plan_it/tax.py` with functions:
  - `split_net_vat_gross(amount, vat_rate, includes_vat)` — Split amount into net/vat/gross
  - `validate_strict_vat(amount, vat_rate, default_vat, field_label)` — Enforce VAT required for non-zero amounts
- **DocTypes Updated (7 total):**
  - `MPIT Budget Line` — Added `vat_rate`, `amount_includes_vat`, `amount_net`, `amount_vat`, `amount_gross`
  - `MPIT Baseline Expense` — Added VAT fields
  - `MPIT Actual Entry` — Added VAT fields
  - `MPIT Contract` — Added `contract_amount_*` (net/vat/gross)
  - `MPIT Amendment Line` — Added `delta_*` (net/vat/gross)
  - `MPIT Project Allocation` — Added `planned_*` (net/vat/gross)
  - `MPIT Project Quote` — Added `amount_*` (net/vat/gross)
- **Controllers Updated (6 total):**
  - `mpit_baseline_expense.py` — `_compute_vat_split()` in validate()
  - `mpit_actual_entry.py` — `_compute_vat_split()` in validate()
  - `mpit_contract.py` — `_compute_vat_split()` in validate()
  - `mpit_budget.py` — `_compute_vat_split()` for child table lines
  - `mpit_budget_amendment.py` — `_compute_vat_split()` for child table lines
  - `mpit_project.py` — `_compute_vat_split()` for allocations and quotes
- **Data Migration:** Created patch `v0_1_0/backfill_vat_fields.py` for idempotent backfill
  - Sets `vat_rate=0`, `includes_vat=0`, `net=amount`, `vat=0`, `gross=amount` for historical records
- **Reports Updated (3 total):**
  - `mpit_approved_budget_vs_actual.py` — COALESCE pattern for anti-regression
  - `mpit_current_budget_vs_actual.py` — COALESCE pattern
  - `mpit_projects_planned_vs_actual.py` — COALESCE pattern

#### Phase 5: Annualization
- **Helper Module:** `master_plan_it/annualization.py` with functions:
  - `get_year_bounds(year)` — Get calendar year start/end dates
  - `overlap_months(period_start, period_end, year_start, year_end)` — Count complete month overlap
  - `annualize(amount_net, recurrence_rule, custom_period_months, overlap_months_count)` — Calculate annual amounts
  - `validate_recurrence_rule(recurrence_rule, custom_period_months)` — Enforce Custom requires custom_period_months
- **DocTypes Updated:**
  - `MPIT Budget Line` — Added `recurrence_rule`, `custom_period_months`, `period_start_date`, `period_end_date`, `annual_net`, `annual_vat`, `annual_gross`
  - `MPIT Baseline Expense` — Added annualization fields
- **Controllers Updated:**
  - `mpit_baseline_expense.py` — `_compute_annualization()` in validate()
  - `mpit_budget.py` — `_compute_lines_annualization()` for child table lines
- **Recurrence Rules:** Monthly, Quarterly, Annual, Custom, None
- **Rule A Enforcement:** Block save if period has zero overlap with fiscal year
- **Test Coverage:**
  - Monthly: 100 net × 12 months = 1200 annual_net ✓
  - Quarterly: 300 net × 4 quarters = 1200 annual_net ✓
  - Custom: 600 net, 2-month period × 6 periods = 1200 annual_net ✓
  - Partial overlap (Q1 only): 100 net × 3 months = 300 annual_net ✓
  - Zero overlap: Blocked with validation error ✓

#### Phase 6: Professional Printing
- **Print Formats Created (2 total):**
  - `MPIT Budget Professional` (Jinja, Standard=Yes)
    - Path: `print_format/mpit_budget_professional.{json,html}`
    - Features: header, info grid, lines table (category, vendor, net/VAT/gross, recurrence), totals
    - User preferences: conditional attachments list based on `show_attachments_in_print`
  - `MPIT Project Professional` (Jinja, Standard=Yes)
    - Path: `print_format/mpit_project_professional.{json,html}`
    - Features: header, info grid, allocations table, quotes table, totals per section
- **Report HTML Templates Created (4 total):**
  - `mpit_approved_budget_vs_actual.html` — 7-column table with variance color coding (red/green)
  - `mpit_current_budget_vs_actual.html` — 9-column table with amendment delta color coding
  - `mpit_projects_planned_vs_actual.html` — Status badges (Planning/Active/Completed/Cancelled)
  - `mpit_renewals_window.html` — Urgency badges (Expired/Urgent/Soon/Normal)
- **Styling:** Bootstrap-inspired classes, embedded CSS, no custom frontend (ADR 0006 compliance)
- **Import:** Print Formats imported via `import_file_by_path()`, report templates auto-detected
- **Test Script:** `devtools/test_print.py` for automated testing of print formats

### Changed

#### Dual-Mode Controller (Phase 6)
- **MPIT Budget Controller:** `_compute_vat_split()` now supports dual mode:
  - **New flow:** If `amount_net` present → source of truth (direct calculation)
  - **Legacy flow:** If only `amount` present → split via `tax.split_net_vat_gross()`
- **Field Migration:** `amount` field marked as `hidden: 1, read_only: 1, label: "Amount (Legacy)"` in:
  - `mpit_budget_line.json`
  - `mpit_baseline_expense.json`
  - `mpit_actual_entry.json`
  - `mpit_project_quote.json` (already without reqd/in_list_view)
- **Controller Fix:** `_compute_lines_annualization()` changed from `self.fiscal_year` to `self.year`

### Documentation

#### New Documents
- **ADR 0008:** Print Formats Server-Side con Jinja (No Custom Frontend)
- **CHANGELOG.md:** This file

#### Updated Documents
- **README.md:** Added EPIC E01 completion summary, version bump to 0.1
- **docs/how-to/10-epic-e01-money-naming-printing.md:** 
  - Added Phase 6 completion section with implementation details
  - Added test results and file structure
  - Added compliance notes with ADR 0006
- **docs/reference/11-printing-v15.md:**
  - Added Section 3: Implementazione MPIT (Dec 2025)
  - Documented Jinja template structure for print formats
  - Documented microtemplating patterns for report HTML
  - Added import/sync procedures
  - Added styling guidelines and allowed Bootstrap classes
  - Added testing strategy
- **docs/reference/10-money-vat-annualization.md:**
  - Added Section 5: Dual-Mode Controller (Phase 6 Implementation)
  - Documented dual-flow VAT calculation logic
  - Documented legacy field migration
  - Documented report anti-regression COALESCE pattern
- **docs/reference/04-reports-dashboards.md:**
  - Added Report Print Formats section
  - Documented all 4 report HTML templates with features
  - Added styling guidelines

### Technical Details

#### File Structure Created
```
apps/master_plan_it/master_plan_it/
├── mpit_user_prefs.py (Phase 1)
├── tax.py (Phase 4)
├── annualization.py (Phase 5)
├── devtools/
│   └── test_print.py (Phase 6)
├── spec/doctypes/
│   └── mpit_user_preferences.json (Phase 1)
├── patches/
│   └── v0_1_0/
│       └── backfill_vat_fields.py (Phase 4)
└── master_plan_it/
    ├── print_format/
    │   ├── mpit_budget_professional.json (Phase 6)
    │   ├── mpit_budget_professional.html (Phase 6)
    │   ├── mpit_project_professional.json (Phase 6)
    │   └── mpit_project_professional.html (Phase 6)
    └── report/
        ├── mpit_approved_budget_vs_actual/
        │   └── mpit_approved_budget_vs_actual.html (Phase 6)
        ├── mpit_current_budget_vs_actual/
        │   └── mpit_current_budget_vs_actual.html (Phase 6)
        ├── mpit_projects_planned_vs_actual/
        │   └── mpit_projects_planned_vs_actual.html (Phase 6)
        └── mpit_renewals_window/
            └── mpit_renewals_window.html (Phase 6)
```

#### Database Schema Changes
- **35+ fields added** across 7 DocTypes for VAT normalization
- **12+ fields added** for annualization (recurrence, annual amounts)
- **1 DocType added:** MPIT User Preferences
- **All migrations idempotent** via `bench migrate`

#### Test Results (Final)
```bash
# Verify checks
master_plan_it.devtools.verify.run: ALL PASSED
- 0 missing doctypes
- 0 missing roles
- 0 missing workflows
- 0 missing reports
- 0 workspace issues

# Unit tests
bench run-tests --app master_plan_it: 2/2 PASSED

# Integration test (Budget creation)
Budget: BUD-2025-04
  Line 1 (Monthly 1000 net, 22% VAT):
    annual_net: 12000.0 (1000 × 12) ✓
    annual_vat: 2640.0 (12000 × 0.22) ✓
    annual_gross: 14640.0 ✓
  Line 2 (Quarterly 500 net, 22% VAT):
    annual_net: 2000.0 (500 × 4) ✓
    annual_vat: 440.0 (2000 × 0.22) ✓
    annual_gross: 2440.0 ✓
```

### Compliance

- ✅ **ADR 0002 (Desk-Only):** All features Desk-native, no portal
- ✅ **ADR 0006 (No Custom Frontend):** Server-side rendering only, no custom JS/CSS
- ✅ **ADR 0008 (Print Formats Jinja):** All print formats versionable in git
- ✅ **Zero Drift:** All metadata in filesystem, deterministic sync
- ✅ **Idempotency:** standard migrate/clear-cache + bootstrap steps are all idempotent

### Known Issues
None. All features fully implemented and tested.

---

## [0.0.1] - 2025-12-21

### Added
- Initial V1 blueprint
- Core DocTypes: Budget, Project, Actual Entry, Contract, Vendor, Category, Year
- Workflows: Budget Workflow, Budget Amendment Workflow
- Reports: 4 Script Reports (Approved vs Actual, Current vs Actual, Projects Planned vs Actual, Renewals Window)
- Dashboard: Master Plan IT Overview
- Bootstrap helpers: `devtools/bootstrap.py`, `devtools/verify.py` (baseline handled by install hooks in current repo)
- Documentation: Diátaxis structure (tutorials, how-to, reference, explanation)
- ADRs: 0001-0007 (architecture decisions)

### Infrastructure
- Docker Compose setup (frappe, nginx, mariadb, redis)
- Development entrypoint: `mpit-entrypoint.sh`
- Git versionable metadata: all DocTypes, Workflows, Reports in filesystem

---

[0.1.0]: https://github.com/YOUR_ORG/master-plan-it/compare/v0.0.1...v0.1.0
[0.0.1]: https://github.com/YOUR_ORG/master-plan-it/releases/tag/v0.0.1


================================================================================
 FILE: ./README.md
================================================================================
# Master Plan IT

Frappe Desk app (v15) for budgeting, contracts, and projects. This repo follows a **native file-first workflow**.

- **App root (this repo):** `apps/master_plan_it/` (the same path inside a bench after `bench get-app`)
- **Canonical metadata and controllers:** `apps/master_plan_it/master_plan_it/master_plan_it/`
- **Apply changes:** edit canonical files, then run standard Frappe commands (`bench --site <site> migrate`, `clear-cache`) so the site picks them up.
- **Desk policy:** Desk is read-only for day-to-day metadata; use it only for initial skeletons and Export Customizations for non-owned DocTypes.
- **Install hooks:** create MPIT Settings and MPIT Year (current + next); fixtures ship MPIT roles only.
- **Fixtures:** keep fixtures minimal and filtered to MPIT records only (see `docs/reference/05-fixtures-bootstrap.md`).
- **More docs:** `docs/reference/06-dev-workflow.md` is the authoritative workflow guide (native file-first, no spec/sync pipeline).


================================================================================
 FILE: ./example.env
================================================================================
# Copy this to .env and fill real secrets. Do NOT commit your real .env

FRAPPE_IMAGE=frappe/erpnext
FRAPPE_TAG=v15.92.3

# Usa l'UID/GID del tuo utente locale (es: 1000/1000) per evitare problemi di permessi nei bind mount
HOST_UID=1000
HOST_GID=1000

# Replace the placeholders below with secure values in your local .env
DB_ROOT_PASSWORD=changeme
ADMIN_PASSWORD=changeme

# Per semplicità: usa il dominio come site name (es: cliente1.tuodominio.it)
SITE_NAME=your.site.example

# Vuoto = solo Frappe; se vuoi anche ERPNext: INSTALL_APPS=erpnext
# Includi sempre master_plan_it per installare l'app durante la creazione del sito.
INSTALL_APPS=master_plan_it

HTTP_PORT=9797


================================================================================
 FILE: ./compose.yml
================================================================================
name: master_plan_it

services:
  db:
    image: mariadb:11
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --skip-character-set-client-handshake
      - --skip-innodb-read-only-compressed
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
    volumes:
      - ./data/db:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mariadb-admin ping -h 127.0.0.1 -p${DB_ROOT_PASSWORD} || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 30
    restart: unless-stopped

  redis:
    image: redis:6.2-alpine
    volumes:
      - ./data/redis:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 30
    restart: unless-stopped

  # Un solo container che fa: config bench + new-site (se manca) + avvia web/socketio/schedule/worker via Procfile
  frappe:
    build:
      context: .
      dockerfile: Dockerfile.frappe
      args:
        FRAPPE_IMAGE: ${FRAPPE_IMAGE}
        FRAPPE_TAG: ${FRAPPE_TAG}
    image: master_plan_it-frappe:local
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    user: "${HOST_UID:-1000}:${HOST_GID:-1000}"
    environment:
      SITE_NAME: ${SITE_NAME}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}
      DB_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}

      # se vuoi forzare migrate ad ogni start (di default NO)
      RUN_MIGRATE_ON_START: ${RUN_MIGRATE_ON_START:-0}

      # usati da socketio.js / worker
      FRAPPE_REDIS_CACHE: redis://redis:6379
      FRAPPE_REDIS_QUEUE: redis://redis:6379
      FRAPPE_REDIS_SOCKETIO: redis://redis:6379
      INSTALL_APPS: ${INSTALL_APPS}

    command: ["bash", "-lc", "/home/frappe/frappe-bench/config/mpit-entrypoint.sh"]
    volumes:
      - ./data/sites:/home/frappe/frappe-bench/sites
      - ./data/logs:/home/frappe/frappe-bench/logs

      # IMPORTANTISSIMO: NON montare tutta ./data/apps vuota (ti sovrascrive frappe/erpnext).
      # In dev, monta SOLO la tua app:
      - ./apps/master_plan_it:/home/frappe/frappe-bench/apps/master_plan_it
      - ./config/mpit-entrypoint.sh:/home/frappe/frappe-bench/config/mpit-entrypoint.sh:ro
      - ./config/mpit.Procfile:/home/frappe/frappe-bench/config/mpit.Procfile:ro
    restart: unless-stopped

  # Reverse proxy interno (comodo se hai un proxy esterno che punta qui)
  frontend:
    image: master_plan_it-frappe:local
    command: ["nginx-entrypoint.sh"]
    container_name: frappe-web
    user: "${HOST_UID:-1000}:${HOST_GID:-1000}"
    environment:
      BACKEND: frappe:8000
      SOCKETIO: frappe:9000
      FRAPPE_SITE_NAME_HEADER: ${FRAPPE_SITE_NAME_HEADER:-$$host}
      PROXY_READ_TIMEOUT: 120
      CLIENT_MAX_BODY_SIZE: 50m
    depends_on:
      - frappe
    networks:
      - proxy
      - default
    ports:
      - "127.0.0.1:${HTTP_PORT}:8080"
    volumes:
      - ./data/sites:/home/frappe/frappe-bench/sites
      - ./data/logs:/home/frappe/frappe-bench/logs
    restart: unless-stopped

networks:
  proxy:
    external: true


================================================================================
 FILE: ./apps/master_plan_it/requirements.txt
================================================================================
frappe>=15.0.0


================================================================================
 FILE: ./apps/master_plan_it/.gitignore
================================================================================
# Byte-compiled / caches
*.pyc
__pycache__/
.pytest_cache/
.mypy_cache/

# Swap files
*.swp
*.swo

# Node / build
node_modules/
dist/
*.egg-info/

# Environment
.env
.env.local
.env.*.local
.venv/
venv/

# IDEs / OS
.DS_Store
.vscode/
.idea/

# Cypress artifacts (keep tests, ignore generated media)
cypress/videos/
cypress/screenshots/

# Frappe local data
data/
private/
sites/

# Coverage
.coverage
coverage/


================================================================================
 FILE: ./apps/master_plan_it/MANIFEST.in
================================================================================
recursive-include master_plan_it *.py
recursive-include master_plan_it *.json
recursive-include master_plan_it *.md
recursive-include master_plan_it *.txt
recursive-include master_plan_it *.csv
recursive-include master_plan_it *.html
recursive-include master_plan_it *.js
recursive-include master_plan_it *.css
recursive-include master_plan_it *.xml
recursive-include master_plan_it *.svg
recursive-include master_plan_it *.png
recursive-include master_plan_it *.gif
recursive-include master_plan_it *.ico
recursive-include cypress *.js
recursive-exclude * __pycache__*
recursive-exclude * *.pyc


================================================================================
 FILE: ./apps/master_plan_it/README.md
================================================================================
# Master Plan IT — App Notes

- Frappe Desk app (multi-tenant: 1 site = 1 client). No custom JS/CSS or build pipeline.
- **App root:** this folder in Git; inside a bench the app lives at `apps/master_plan_it/`.
- **Source of truth:** exported metadata + controllers under `apps/master_plan_it/master_plan_it/master_plan_it/`.
- **Apply changes:** edit the canonical files, then run standard Frappe commands (`bench --site <site> migrate`, `clear-cache`) so the site picks up file changes.
- **Desk policy:** treat Desk as read-only for day-to-day schema/metadata. Use Desk only for initial skeleton creation or to export customizations for non-owned DocTypes.
- **Install hooks + fixtures:** hooks create MPIT Settings and MPIT Year (current + next); fixtures ship only MPIT roles.
- **Docs:** see `docs/reference/06-dev-workflow.md` for the authoritative workflow and `docs/reference/05-fixtures-bootstrap.md` for fixture rules (native file-first, no spec-import).


================================================================================
 FILE: ./apps/master_plan_it/license.txt
================================================================================
MIT License

Copyright (c) 2025 Master Plan IT

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.


================================================================================
 FILE: ./apps/master_plan_it/cypress/integration/mpit_smoke.spec.js
================================================================================
// MPIT UI smoke test (Cypress)
// Intention: ensure login works and Desk loads.
//
// Run:
//   cd apps/master_plan_it
//   yarn
//   yarn cypress:open
//
describe('MPIT smoke', () => {
  it('loads login page', () => {
    cy.visit('/login');
    cy.contains('Login');
  });
});


================================================================================
 FILE: ./apps/master_plan_it/pyproject.toml
================================================================================
[build-system]
requires = ["setuptools>=65"]
build-backend = "setuptools.build_meta"

[tool.black]
line-length = 100


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/tests/__init__.py
================================================================================


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/tests/test_vat_flag.py
================================================================================
import unittest
import frappe
from master_plan_it import tax


class TestVatFlag(unittest.TestCase):
    def test_split_from_gross(self):
        # 1220 gross at 22% => net 1000, vat 220
        net, vat, gross = tax.split_net_vat_gross(1220, 22, True)
        self.assertAlmostEqual(net, 1000.0, places=2)
        self.assertAlmostEqual(vat, 220.0, places=2)
        self.assertAlmostEqual(gross, 1220.0, places=2)

    def test_split_from_net(self):
        # 1000 net at 22% => gross 1220
        net, vat, gross = tax.split_net_vat_gross(1000, 22, False)
        self.assertAlmostEqual(net, 1000.0, places=2)
        self.assertAlmostEqual(vat, 220.0, places=2)
        self.assertAlmostEqual(gross, 1220.0, places=2)


if __name__ == '__main__':
    unittest.main()


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/tests/test_translations.py
================================================================================
# -*- coding: utf-8 -*-
"""Tests to verify workspace/UI labels are translated in Italian when translations exist.

These tests insert Translation records (language=it) for a small set of workspace labels,
clear the translation cache and assert that `frappe._` returns the expected Italian text.
"""

import frappe
from frappe.tests.utils import FrappeTestCase

class TestTranslations(FrappeTestCase):
	def setUp(self):
		# Ensure tests run as Administrator so we can insert Translation records
		frappe.set_user("Administrator")

	def test_workspace_labels_translate(self):
		translations = {
			"Setup": "Impostazioni",
			"Setup & Planning": "Impostazioni e pianificazione",
			"Categories": "Categorie",
			"Vendors": "Fornitori",
			"Contracts": "Contratti",
			"Expired Contracts": "Contratti scaduti",
			"Quick Actions": "Azioni rapide",
			"Quick Links": "Collegamenti rapidi",
			"Your Shortcuts": "I tuoi collegamenti",
			"More": "Altro",
		}

		# Insert Translation records if missing
		for src, tr in translations.items():
			exists = frappe.db.exists("Translation", {"language": "it", "source_text": src})
			if not exists:
				frappe.get_doc({
					"doctype": "Translation",
					"language": "it",
					"source_text": src,
					"translated_text": tr,
				}).insert(ignore_permissions=True)

		# Clear translation cache and assert translations are used
		frappe.translate.clear_cache()
		frappe.local.lang = "it"
		for src, tr in translations.items():
			self.assertEqual(frappe._(src), tr)


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/tests/test_no_forbidden_metadata_paths.py
================================================================================
from pathlib import Path


def test_no_forbidden_metadata_paths():
    repo_root = Path(__file__).resolve().parents[4]
    forbidden = [
        repo_root / "apps/master_plan_it/master_plan_it/doctype",
        repo_root / "apps/master_plan_it/master_plan_it/report",
        repo_root / "apps/master_plan_it/master_plan_it/workflow",
        repo_root / "apps/master_plan_it/master_plan_it/workspace",
        repo_root / "apps/master_plan_it/master_plan_it/dashboard",
        repo_root / "apps/master_plan_it/master_plan_it/dashboard_chart",
        repo_root / "apps/master_plan_it/master_plan_it/number_card",
        repo_root / "apps/master_plan_it/master_plan_it/master_plan_it_dashboard",
        repo_root / "apps/master_plan_it/master_plan_it/print_format",
    ]

    for path in forbidden:
        assert not path.exists(), f"Forbidden metadata path exists: {path}"


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/tests/test_translation_sync.py
================================================================================
from pathlib import Path

import frappe


def test_translation_file_exists():
    app_path = Path(frappe.get_app_path("master_plan_it"))
    candidates = [
        app_path.parent / "translations" / "it.csv",
        app_path / "translations" / "it.csv",
        app_path.parent / "master_plan_it" / "translations" / "it.csv",
    ]

    assert any(path.exists() for path in candidates), "Expected at least one translation CSV (it.csv) in translations/"


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/tests/test_smoke.py
================================================================================
# -*- coding: utf-8 -*-
"""MPIT smoke tests

Intention:
- Fail loudly if core MPIT DocTypes are missing after install/sync.

Run:
  bench --site <site> run-tests --app master_plan_it
"""

import frappe


def test_required_doctypes_exist():
    required = [
        "MPIT Vendor",
        "MPIT Category",
        "MPIT Contract",
        "MPIT Baseline Expense",
        "MPIT Budget",
        "MPIT Budget Line",
        "MPIT Actual Entry",
        "MPIT Project",
    ]
    missing = [dt for dt in required if not frappe.db.exists("DocType", dt)]
    assert not missing, f"Missing MPIT DocTypes: {missing}. Run migrate / update the site so Frappe syncs app files."


def test_roles_exist():
    roles = ["vCIO Manager", "Client Editor", "Client Viewer"]

    missing_roles = [r for r in roles if not frappe.db.exists("Role", r)]

    assert not missing_roles, f"Missing MPIT Roles: {missing_roles}. Run migrate / update the site so Frappe syncs app files."


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/modules.txt
================================================================================
Master Plan IT


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/fixtures/role.json
================================================================================
[
 {
  "doctype": "Role",
  "name": "vCIO Manager",
  "role_name": "vCIO Manager",
  "desk_access": 1
 },
 {
  "doctype": "Role",
  "name": "Client Editor",
  "role_name": "Client Editor",
  "desk_access": 1
 },
 {
  "doctype": "Role",
  "name": "Client Viewer",
  "role_name": "Client Viewer",
  "desk_access": 1
 }
]


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/setup/__init__.py
================================================================================
# Setup package for Master Plan IT


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/setup/install.py
================================================================================
"""Install hooks for Master Plan IT.

These hooks are intentionally minimal and idempotent. They ensure the app
has its single settings record and baseline years without requiring
external scripts.
"""

from __future__ import annotations

import datetime

import frappe


def _ensure_settings() -> None:
	"""Create the singleton MPIT Settings if missing."""
	if frappe.db.exists("MPIT Settings", "MPIT Settings"):
		return
	doc = frappe.get_doc({"doctype": "MPIT Settings"})
	doc.insert(ignore_permissions=True)


def _ensure_year(year: int) -> None:
	"""Create a deterministic MPIT Year document if missing."""
	name = str(year)
	if frappe.db.exists("MPIT Year", name) or frappe.db.exists("MPIT Year", {"year": year}):
		return
	doc = frappe.get_doc({"doctype": "MPIT Year", "year": year})
	doc.name = name
	doc.insert(ignore_permissions=True)


def _bootstrap_basics() -> None:
	"""Bootstrap minimal records required by existing code."""
	_ensure_settings()

	today = datetime.date.today()
	_ensure_year(today.year)
	_ensure_year(today.year + 1)


def after_install() -> None:
	_bootstrap_basics()


def after_sync() -> None:
	_bootstrap_basics()


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/hooks.py
================================================================================
# -*- coding: utf-8 -*-
"""master_plan_it hooks

This file declares hooks used by Frappe.
Keep changes minimal and deterministic.
"""
from . import __version__ as app_version

app_name = "master_plan_it"
app_title = "Master Plan IT"
app_publisher = "DOT"
app_description = "vCIO multi-tenant budgeting & actuals management (MPIT)."
app_email = "n/a"
app_license = "MIT"

after_install = "master_plan_it.setup.install.after_install"
after_sync = "master_plan_it.setup.install.after_sync"

fixtures = [
    {"dt": "Role", "filters": [["name", "in", ["vCIO Manager", "Client Editor", "Client Viewer"]]]},
]


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/__init__.py
================================================================================
__version__ = "0.1.0"

# Master Plan IT (MPIT) app package


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/devtools/bootstrap.py
================================================================================
# -*- coding: utf-8 -*-
"""MPIT DevTools: bootstrap (tenant defaults)

Install hooks already provision MPIT Settings and MPIT Year (current + next). This helper
remains available if you need to re-apply roles/workspace in an existing site.

ENTRYPOINT
- bench --site <site> execute master_plan_it.devtools.bootstrap.run --kwargs '{"step":"tenant"}'

This is intentionally minimal and idempotent.
"""

from __future__ import annotations

import datetime
from typing import Dict, List

import frappe

WORKSPACE_NAME = "Master Plan IT"
MPIT_ROLES = ["vCIO Manager", "Client Editor", "Client Viewer"]


def _ensure_roles() -> None:
    for role in MPIT_ROLES:
        if frappe.db.exists("Role", role):
            continue
        doc = frappe.get_doc({"doctype": "Role", "role_name": role, "desk_access": 1})
        doc.insert(ignore_permissions=True)


def _ensure_settings() -> None:
    if frappe.db.exists("MPIT Settings", "MPIT Settings"):
        return
    doc = frappe.get_doc({"doctype": "MPIT Settings"})
    doc.insert(ignore_permissions=True)


def _ensure_year(year: int) -> None:
    # We name MPIT Year by the year number to be deterministic.
    if frappe.db.exists("MPIT Year", str(year)):
        return
    doc = frappe.get_doc({"doctype": "MPIT Year", "year": year})
    doc.name = str(year)
    doc.insert(ignore_permissions=True)


def _ensure_workspace() -> None:
    """Create/update Desk workspace for MPIT (restricted to MPIT roles)."""
    shortcuts = [
        {"label": "Budgets", "link_to": "MPIT Budget", "type": "DocType"},
        {"label": "Budget Amendments", "link_to": "MPIT Budget Amendment", "type": "DocType"},
        {"label": "Actual Entries", "link_to": "MPIT Actual Entry", "type": "DocType"},
        {"label": "Contracts", "link_to": "MPIT Contract", "type": "DocType"},
        {"label": "Projects", "link_to": "MPIT Project", "type": "DocType"},
        {"label": "Baseline Expenses", "link_to": "MPIT Baseline Expense", "type": "DocType"},
        {"label": "Categories", "link_to": "MPIT Category", "type": "DocType"},
        {"label": "Vendors", "link_to": "MPIT Vendor", "type": "DocType"},
    ]
    content_blocks = [
        {"type": "header", "data": {"text": "Master Plan IT", "level": 4, "col": 12}},
    ]
    for sc in shortcuts:
        content_blocks.append({"type": "shortcut", "data": {"shortcut_name": sc["label"], "col": 3}})

    workspace_roles = [{"role": r} for r in MPIT_ROLES + ["System Manager"]]

    if frappe.db.exists("Workspace", WORKSPACE_NAME):
        doc = frappe.get_doc("Workspace", WORKSPACE_NAME)
        dirty = False
        if doc.public:
            doc.public = 0
            dirty = True
        existing_roles = {r.role for r in doc.get("roles", [])}
        desired_roles = {r["role"] for r in workspace_roles}
        if existing_roles != desired_roles:
            doc.roles = []
            for r in workspace_roles:
                doc.append("roles", r)
            dirty = True
        if dirty:
            doc.save(ignore_permissions=True)
        return

    doc = frappe.get_doc({
        "doctype": "Workspace",
        "name": WORKSPACE_NAME,
        "label": WORKSPACE_NAME,
        "title": WORKSPACE_NAME,
        "module": WORKSPACE_NAME,
        "public": 0,
        "is_hidden": 0,
        "content": frappe.as_json(content_blocks),
        "shortcuts": shortcuts,
        "roles": workspace_roles,
    })
    doc.insert(ignore_permissions=True)


def run(step: str = "tenant") -> Dict[str, List[str]]:
    out: List[str] = []
    if step in ("tenant", "all"):
        _ensure_roles()
        out.append("roles_ok")

        _ensure_settings()
        out.append("settings_ok")

        now = datetime.date.today()
        _ensure_year(now.year)
        _ensure_year(now.year + 1)
        out.append("years_ok")

        _ensure_workspace()
        out.append("workspace_ok")

    frappe.db.commit()
    return {"done": out}


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/devtools/test_print.py
================================================================================
#!/usr/bin/env python3
"""Test script for print formats in MPIT Phase 6."""
from pathlib import Path

import frappe
from frappe.modules.import_file import import_file_by_path

def setup_fixtures():
    """Create necessary fixtures."""
    # Create Category
    if not frappe.db.exists("MPIT Category", "Hardware"):
        c1 = frappe.get_doc({"doctype": "MPIT Category", "category_name": "Hardware"})
        c1.insert()
    
    if not frappe.db.exists("MPIT Category", "Software"):
        c2 = frappe.get_doc({"doctype": "MPIT Category", "category_name": "Software"})
        c2.insert()

    # Create Vendor
    if not frappe.db.exists("MPIT Vendor", "Acme Corp"):
        v1 = frappe.get_doc({"doctype": "MPIT Vendor", "vendor_name": "Acme Corp"})
        v1.insert()
    
    if not frappe.db.exists("MPIT Vendor", "Tech Inc"):
        v2 = frappe.get_doc({"doctype": "MPIT Vendor", "vendor_name": "Tech Inc"})
        v2.insert()

    frappe.db.commit()
    print("✓ Fixtures created")

def import_print_formats():
    """Import print formats from JSON specs."""
    app_path = Path(frappe.get_app_path("master_plan_it")) / "master_plan_it"
    budget_pf = app_path / "print_format" / "mpit_budget_professional.json"
    project_pf = app_path / "print_format" / "mpit_project_professional.json"

    if budget_pf.exists():
        import_file_by_path(str(budget_pf))
        print(f"✓ Imported Budget print format from {budget_pf}")
    else:
        print(f"✗ Budget PF not found: {budget_pf}")
    
    if project_pf.exists():
        import_file_by_path(str(project_pf))
        print(f"✓ Imported Project print format from {project_pf}")
    else:
        print(f"✗ Project PF not found: {project_pf}")

    frappe.db.commit()

def create_test_budget():
    """Create test Budget with VAT and recurrence."""
    from master_plan_it.mpit_user_prefs import get_or_create
    
    # Ensure user prefs exist
    prefs = get_or_create("Administrator")
    frappe.db.commit()
    
    # Create Year if not exists
    if not frappe.db.exists("MPIT Year", "2025"):
        y = frappe.get_doc({"doctype": "MPIT Year", "year_name": "2025"})
        y.insert()
        frappe.db.commit()
        print("✓ Created Year: 2025")
    
    # Create Budget
    b = frappe.get_doc({
        "doctype": "MPIT Budget",
        "year": "2025",
        "title": "Test Budget 2025",
        "lines": [
            {
                "category": "Hardware",
                "vendor": "Acme Corp",
                "description": "Server upgrade",
                "amount_net": 1000,
                "vat_rate": 22,
                "includes_vat": 0,
                "recurrence_rule": "Monthly"
            },
            {
                "category": "Software",
                "vendor": "Tech Inc",
                "description": "License renewal",
                "amount_net": 500,
                "vat_rate": 22,
                "includes_vat": 0,
                "recurrence_rule": "Quarterly"
            }
        ]
    })
    b.insert()
    frappe.db.commit()
    
    print(f"\n✓ Created Budget: {b.name}")
    print(f"  Title: {b.title}")
    print(f"  Line 1 Annual Net: {b.lines[0].annual_net} (Monthly 1000×12)")
    print(f"  Line 1 Annual VAT: {b.lines[0].annual_vat}")
    print(f"  Line 1 Annual Gross: {b.lines[0].annual_gross}")
    print(f"  Line 2 Annual Net: {b.lines[1].annual_net} (Quarterly 500×4)")
    print(f"  Line 2 Annual VAT: {b.lines[1].annual_vat}")
    print(f"  Line 2 Annual Gross: {b.lines[1].annual_gross}")
    
    return b.name

def verify_print_formats():
    """Check available print formats."""
    budget_pf = frappe.get_all("Print Format", filters={"doc_type": "MPIT Budget"}, fields=["name", "standard", "html"])
    project_pf = frappe.get_all("Print Format", filters={"doc_type": "MPIT Project"}, fields=["name", "standard", "html"])
    
    print(f"\nPrint Formats for MPIT Budget ({len(budget_pf)} found):")
    for pf in budget_pf:
        has_html = "YES" if pf.html else "NO"
        print(f"  - {pf.name} (standard={pf.standard}, html={has_html})")
    
    print(f"\nPrint Formats for MPIT Project ({len(project_pf)} found):")
    for pf in project_pf:
        has_html = "YES" if pf.html else "NO"
        print(f"  - {pf.name} (standard={pf.standard}, html={has_html})")

def run():
    """Run all tests (entry point for bench execute)."""
    print("=" * 60)
    print("MPIT Phase 6 - Print Format Testing")
    print("=" * 60)
    
    setup_fixtures()
    import_print_formats()
    verify_print_formats()
    budget_name = create_test_budget()
    
    print("\n" + "=" * 60)
    print("✓ All tests completed successfully")
    print(f"✓ Test Budget created: {budget_name}")
    print("=" * 60)


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/devtools/__init__.py
================================================================================
# MPIT devtools package


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/devtools/verify.py
================================================================================
# -*- coding: utf-8 -*-
"""MPIT DevTools: verify (deterministic checks)

ENTRYPOINT
- bench --site <site> execute master_plan_it.devtools.verify.run
"""

from __future__ import annotations

from typing import Dict, List

import frappe


REQUIRED_DOCTYPES = [
    "MPIT Settings",
    "MPIT Year",
    "MPIT Vendor",
    "MPIT Category",
    "MPIT Contract",
    "MPIT Baseline Expense",
    "MPIT Budget",
    "MPIT Budget Line",
    "MPIT Budget Amendment",
    "MPIT Amendment Line",
    "MPIT Actual Entry",
    "MPIT Project",
    "MPIT Project Allocation",
    "MPIT Project Quote",
    "MPIT Project Milestone",
]
REQUIRED_ROLES = ["vCIO Manager", "Client Editor", "Client Viewer"]
WORKSPACE_NAME = "Master Plan IT"
REQUIRED_REPORTS = [
    "MPIT Approved Budget vs Actual",
    "MPIT Current Budget vs Actual",
    "MPIT Renewals Window",
    "MPIT Projects Planned vs Actual",
]
REQUIRED_DASHBOARD = "Master Plan IT Overview"
REQUIRED_DASHBOARD_CHARTS = [
    "MPIT Budget vs Actual (Approved)",
    "MPIT Current Budget vs Actual",
    "MPIT Renewals by Month",
    "MPIT Projects Planned vs Actual",
]
REQUIRED_NUMBER_CARDS = [
    "Renewals 30d",
    "Renewals 60d",
    "Renewals 90d",
    "Expired Contracts",
]


def run() -> Dict[str, List[str]]:
    missing_doctypes = [dt for dt in REQUIRED_DOCTYPES if not frappe.db.exists("DocType", dt)]
    missing_roles = [r for r in REQUIRED_ROLES if not frappe.db.exists("Role", r)]
    missing_reports = [r for r in REQUIRED_REPORTS if not frappe.db.exists("Report", r)]
    missing_dashboard_charts = [c for c in REQUIRED_DASHBOARD_CHARTS if not frappe.db.exists("Dashboard Chart", c)]
    missing_number_cards = [c for c in REQUIRED_NUMBER_CARDS if not frappe.db.exists("Number Card", c)]

    workspace_missing = not frappe.db.exists("Workspace", WORKSPACE_NAME)
    workspace_public = None
    workspace_roles_missing: List[str] = []
    if not workspace_missing:
        ws = frappe.get_doc("Workspace", WORKSPACE_NAME)
        workspace_public = bool(ws.public)
        desired_roles = set(REQUIRED_ROLES + ["System Manager"])
        current_roles = {r.role for r in ws.get("roles", [])}
        workspace_roles_missing = sorted(desired_roles - current_roles)

    ok: List[str] = []
    dashboard_missing = not frappe.db.exists("Dashboard", REQUIRED_DASHBOARD)

    if not any([
        missing_doctypes,
        missing_roles,
        missing_reports,
        missing_dashboard_charts,
        missing_number_cards,
        workspace_missing,
        workspace_public,
        workspace_roles_missing,
        dashboard_missing,
    ]):
        ok.append("all_required_entities_present")

    return {
        "missing_doctypes": missing_doctypes,
        "missing_roles": missing_roles,
        "missing_reports": missing_reports,
        "missing_dashboard_charts": missing_dashboard_charts,
        "missing_number_cards": missing_number_cards,
        "workspace_missing": workspace_missing,
        "workspace_public": workspace_public,
        "workspace_roles_missing": workspace_roles_missing,
        "dashboard_missing": dashboard_missing,
        "ok": ok,
    }


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/config/__init__.py
================================================================================
# Config package for Master Plan IT


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/config/desktop.py
================================================================================
from frappe import _


def get_data():
    return [
        {
            "module_name": "Master Plan IT",
            "color": "blue",
            "icon": "octicon octicon-graph",
            "type": "module",
            "label": _("Master Plan IT"),
        }
    ]


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/tax.py
================================================================================
# Copyright (c) 2025, DOT and contributors
# For license information, please see license.txt

"""
Tax/VAT calculation helpers for MPIT.

Provides strict VAT normalization with 2-decimal precision.
All Currency fields must be split into net/vat/gross components.
"""

from __future__ import annotations

import frappe
from frappe.utils import flt


def split_net_vat_gross(
	amount: float,
	vat_rate_pct: float | None,
	includes_vat: bool,
	precision: int = 2
) -> tuple[float, float, float]:
	"""
	Split an amount into net, vat, and gross components.
	
	Args:
		amount: The input amount (can be net or gross depending on includes_vat)
		vat_rate_pct: VAT rate as percentage (e.g., 22.0 for 22%). Can be None if amount is 0.
		includes_vat: True if amount includes VAT (gross), False if amount is net
		precision: Decimal precision for rounding (default: 2)
	
	Returns:
		tuple: (net, vat, gross) all rounded to specified precision
	
	Examples:
		>>> split_net_vat_gross(100.0, 22.0, False, 2)
		(100.0, 22.0, 122.0)  # Input is net
		
		>>> split_net_vat_gross(122.0, 22.0, True, 2)
		(100.0, 22.0, 122.0)  # Input is gross
		
		>>> split_net_vat_gross(0.0, None, False, 2)
		(0.0, 0.0, 0.0)  # Zero amount
	"""
	# Handle zero amount
	if not amount or flt(amount, precision) == 0:
		return (0.0, 0.0, 0.0)
	
	# VAT rate is required for non-zero amounts (will be validated in controller)
	if vat_rate_pct is None:
		# This will be caught by strict VAT validation in validate()
		# For calculation purposes, treat as 0
		vat_rate_pct = 0.0
	
	# Convert percentage to decimal
	vat_rate = flt(vat_rate_pct, precision) / 100.0
	
	if includes_vat:
		# Input is gross, extract net and vat
		gross = flt(amount, precision)
		net = flt(gross / (1 + vat_rate), precision)
		vat = flt(gross - net, precision)
	else:
		# Input is net, calculate gross and vat
		net = flt(amount, precision)
		gross = flt(net * (1 + vat_rate), precision)
		vat = flt(gross - net, precision)
	
	return (net, vat, gross)


def validate_strict_vat(
	amount: float,
	vat_rate: float | None,
	default_vat_rate: float | None,
	field_label: str = "Amount"
) -> float:
	"""
	Validate strict VAT rules and return the VAT rate to use.
	
	Strict VAT mode rules:
	- If amount != 0: vat_rate is REQUIRED (either on row or from user prefs)
	- If amount == 0: vat_rate can be None (will default to 0)
	- 0 is a valid VAT rate (zero-rated items)
	
	Args:
		amount: The amount being validated
		vat_rate: VAT rate from the row/document (can be None)
		default_vat_rate: Default VAT rate from user preferences (can be None)
		field_label: Label for error messages
	
	Returns:
		float: The VAT rate to use (guaranteed not None)
	
	Raises:
		frappe.ValidationError: If strict VAT rules are violated
	"""
	# If amount is zero, VAT rate is optional (default to 0)
	if not amount or flt(amount, 2) == 0:
		if vat_rate is not None:
			return flt(vat_rate, 2)
		if default_vat_rate is not None:
			return flt(default_vat_rate, 2)
		return 0.0
	
	# Amount is non-zero: VAT rate is REQUIRED
	# Priority: row vat_rate > user default > ERROR
	if vat_rate is not None:
		return flt(vat_rate, 2)
	
	if default_vat_rate is not None:
		return flt(default_vat_rate, 2)
	
	# No VAT rate found: BLOCK save
	frappe.throw(
		frappe._(
			"{0} is non-zero but no VAT rate is specified. Please set a VAT rate on this row or configure a default VAT rate in your User Preferences."
		).format(field_label)
	)


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/mpit_user_prefs.py
================================================================================
# Copyright (c) 2025, DOT and contributors
# For license information, please see license.txt

"""
Helper for MPIT User Preferences (per-user defaults for VAT, naming, print).

Provides idempotent get_or_create and typed getters for user preferences.
"""

from __future__ import annotations

import frappe
from frappe import _
from frappe.model.document import Document


def get_or_create(user: str | None = None) -> Document:
	"""
	Get or create MPIT User Preferences for the given user.
	
	Args:
		user: User email. If None, uses frappe.session.user.
	
	Returns:
		Document: MPIT User Preferences document (may be unsaved if just created).
	"""
	if not user:
		user = frappe.session.user
	
	# Try to get existing
	prefs_name = frappe.db.get_value("MPIT User Preferences", {"user": user}, "name")
	if prefs_name:
		return frappe.get_doc("MPIT User Preferences", prefs_name)
	
	# Create new with defaults
	prefs = frappe.new_doc("MPIT User Preferences")
	prefs.user = user
	prefs.insert(ignore_permissions=True)
	frappe.db.commit()
	
	return prefs


def get_default_vat_rate(user: str | None = None) -> float | None:
	"""
	Get default VAT rate for user (returns None if not set, 0 is valid).
	
	Args:
		user: User email. If None, uses frappe.session.user.
	
	Returns:
		float | None: VAT rate percentage or None.
	"""
	prefs = get_or_create(user)
	return prefs.default_vat_rate if prefs.default_vat_rate is not None else None


def get_default_includes_vat(user: str | None = None) -> bool:
	"""
	Get default "amount includes VAT" setting for user.
	
	Args:
		user: User email. If None, uses frappe.session.user.
	
	Returns:
		bool: True if amounts should include VAT by default.
	"""
	prefs = get_or_create(user)
	return bool(prefs.default_amount_includes_vat)


def get_budget_series(user: str | None = None, year: str | None = None) -> tuple[str, int, str]:
	"""
	Get Budget naming series components for user.
	
	Budget name format: {prefix}{year}-{NNNN...}
	where {year} is the Budget.year field value (MPIT Year name).
	
	Args:
		user: User email. If None, uses frappe.session.user.
		year: Year name (e.g., "2025"). Required for Budget naming.
	
	Returns:
		tuple: (prefix, digits, middle) where middle is "{year}-"
	"""
	prefs = get_or_create(user)
	prefix = prefs.budget_prefix or "BUD-"
	digits = prefs.budget_sequence_digits or 2
	
	if not year:
		frappe.throw(_("Budget naming requires year parameter (Budget.year field)"))
	
	# Budget must include year in the name: BUD-2025-01
	middle = f"{year}-"
	
	return prefix, digits, middle


def get_project_series(user: str | None = None) -> tuple[str, int]:
	"""
	Get Project naming series components for user.
	
	Project name format: {prefix}{NNNN...}
	
	Args:
		user: User email. If None, uses frappe.session.user.
	
	Returns:
		tuple: (prefix, digits)
	"""
	prefs = get_or_create(user)
	prefix = prefs.project_prefix or "PRJ-"
	digits = prefs.project_sequence_digits or 4
	
	return prefix, digits


def get_show_attachments_in_print(user: str | None = None) -> bool:
	"""
	Get user preference for showing attachments in print formats.
	
	Args:
		user: User email. If None, uses frappe.session.user.
	
	Returns:
		bool: True if attachments should be shown in prints.
	"""
	prefs = get_or_create(user)
	return bool(prefs.show_attachments_in_print)


@frappe.whitelist()
def get_vat_defaults(user: str | None = None) -> dict:
	"""
	Return VAT defaults for the given user (falls back to session user).
	"""
	prefs = get_or_create(user or frappe.session.user)
	return {
		"default_vat_rate": prefs.default_vat_rate,
		"default_includes_vat": bool(prefs.default_amount_includes_vat),
	}


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/annualization.py
================================================================================
# Copyright (c) 2025, DOT and contributors
# For license information, please see license.txt

"""
Annualization helpers for MPIT.

Handles temporal calculations for budget lines and baseline expenses
with different recurrence patterns (Monthly, Quarterly, Annual, Custom, None).

Rule A: If a budget line/expense has ZERO overlap with the fiscal year,
        the system MUST block save with a validation error.
"""

from __future__ import annotations

import datetime
from typing import Literal

import frappe
from frappe.utils import flt, getdate


RecurrenceRule = Literal["Monthly", "Quarterly", "Annual", "Custom", "None"]


def get_year_bounds(year: int | str) -> tuple[datetime.date, datetime.date]:
	"""
	Get the start and end dates for a fiscal year.
	
	Args:
		year: Fiscal year (int or string, e.g., 2025)
	
	Returns:
		tuple: (year_start, year_end) as datetime.date objects
	
	Example:
		>>> get_year_bounds(2025)
		(datetime.date(2025, 1, 1), datetime.date(2025, 12, 31))
	"""
	year_int = int(year)
	calendar_start = datetime.date(year_int, 1, 1)
	calendar_end = datetime.date(year_int, 12, 31)

	if frappe.db.exists("MPIT Year", str(year_int)):
		year_doc = frappe.get_doc("MPIT Year", str(year_int))
		if year_doc.start_date and year_doc.end_date:
			return (getdate(year_doc.start_date), getdate(year_doc.end_date))

	return (calendar_start, calendar_end)


def overlap_months(
	period_start: datetime.date | str,
	period_end: datetime.date | str,
	year_start: datetime.date,
	year_end: datetime.date
) -> int:
	"""
	Calculate number of complete months of overlap between a period and a fiscal year.
	
	Uses conservative counting: only full calendar months count.
	If period starts mid-month or ends mid-month, those partial months are excluded.
	
	Args:
		period_start: Start date of the period
		period_end: End date of the period
		year_start: Start date of the fiscal year
		year_end: End date of the fiscal year
	
	Returns:
		int: Number of complete overlapping months (0 to 12)
	
	Examples:
		>>> # Full year overlap
		>>> overlap_months(date(2025,1,1), date(2025,12,31), date(2025,1,1), date(2025,12,31))
		12
		
		>>> # Q1 overlap (Jan-Mar)
		>>> overlap_months(date(2025,1,1), date(2025,3,31), date(2025,1,1), date(2025,12,31))
		3
		
		>>> # Partial month (mid-Feb to mid-Mar) - conservative counting
		>>> overlap_months(date(2025,2,15), date(2025,3,15), date(2025,1,1), date(2025,12,31))
		0  # No complete months
		
		>>> # No overlap
		>>> overlap_months(date(2024,1,1), date(2024,12,31), date(2025,1,1), date(2025,12,31))
		0
	"""
	period_start = getdate(period_start)
	period_end = getdate(period_end)
	
	# Find the actual overlap window
	overlap_start = max(period_start, year_start)
	overlap_end = min(period_end, year_end)
	
	# No overlap if start > end
	if overlap_start > overlap_end:
		return 0
	
	# Count complete months in overlap window
	# A complete month requires: start on day 1, end on last day of month
	months = 0
	current = overlap_start
	
	while current <= overlap_end:
		# Check if this is the start of a complete month
		month_start = datetime.date(current.year, current.month, 1)
		
		# Calculate last day of this month
		if current.month == 12:
			month_end = datetime.date(current.year, 12, 31)
		else:
			next_month = datetime.date(current.year, current.month + 1, 1)
			month_end = next_month - datetime.timedelta(days=1)
		
		# Check if the entire month is within the overlap window
		if month_start >= overlap_start and month_end <= overlap_end:
			months += 1
		
		# Move to next month
		if current.month == 12:
			current = datetime.date(current.year + 1, 1, 1)
		else:
			current = datetime.date(current.year, current.month + 1, 1)
	
	return months


def annualize(
	amount_net: float,
	recurrence_rule: RecurrenceRule,
	custom_period_months: int | None,
	overlap_months_count: int,
	precision: int = 2
) -> float:
	"""
	Calculate annualized amount based on recurrence rule and overlap.
	
	Args:
		amount_net: The net amount for the period
		recurrence_rule: "Monthly", "Quarterly", "Annual", "Custom", or "None"
		custom_period_months: Number of months for Custom rule (required if rule is Custom)
		overlap_months_count: Number of months of overlap with fiscal year
		precision: Decimal precision (default: 2)
	
	Returns:
		float: Annualized net amount
	
	Raises:
		frappe.ValidationError: If custom_period_months is required but missing
	
	Examples:
		>>> # Monthly: 100/month × 12 months overlap = 1200
		>>> annualize(100, "Monthly", None, 12)
		1200.0
		
		>>> # Quarterly: 300/quarter × 4 quarters (12 months) = 1200
		>>> annualize(300, "Quarterly", None, 12)
		1200.0
		
		>>> # Annual: 1200/year, full overlap = 1200
		>>> annualize(1200, "Annual", None, 12)
		1200.0
		
		>>> # Custom 6-month period: 600/6mo × 2 periods (12 months) = 1200
		>>> annualize(600, "Custom", 6, 12)
		1200.0
		
		>>> # Partial overlap: Monthly 100 × 3 months Q1 only = 300
		>>> annualize(100, "Monthly", None, 3)
		300.0
		
		>>> # None: amount is already annual, just return it
		>>> annualize(1200, "None", None, 12)
		1200.0
	"""
	if overlap_months_count == 0:
		# Rule A enforcement happens in controller validate()
		return 0.0
	
	if recurrence_rule == "None":
		# Amount is already annual (no recurrence)
		return flt(amount_net, precision)
	
	if recurrence_rule == "Monthly":
		# amount_net is per-month, multiply by overlap months
		return flt(amount_net * overlap_months_count, precision)
	
	if recurrence_rule == "Quarterly":
		# amount_net is per-quarter (3 months)
		# Calculate number of complete quarters in overlap
		quarters = overlap_months_count / 3.0
		return flt(amount_net * quarters, precision)
	
	if recurrence_rule == "Annual":
		# amount_net is per-year (12 months)
		# Pro-rate based on overlap
		return flt(amount_net * (overlap_months_count / 12.0), precision)
	
	if recurrence_rule == "Custom":
		if not custom_period_months:
			frappe.throw(
				frappe._("Custom recurrence rule requires custom_period_months to be specified")
			)
		
		# amount_net is per custom period
		# Calculate how many custom periods fit in overlap
		periods = overlap_months_count / float(custom_period_months)
		return flt(amount_net * periods, precision)
	
	# Unknown recurrence rule - treat as None
	return flt(amount_net, precision)


def validate_recurrence_rule(
	recurrence_rule: RecurrenceRule | None,
	custom_period_months: int | None
) -> None:
	"""
	Validate recurrence rule and custom_period_months consistency.
	
	Args:
		recurrence_rule: The recurrence rule value
		custom_period_months: The custom period months value
	
	Raises:
		frappe.ValidationError: If validation fails
	"""
	if recurrence_rule == "Custom" and not custom_period_months:
		frappe.throw(
			frappe._("Custom recurrence rule requires custom_period_months to be specified")
		)
	
	if recurrence_rule != "Custom" and custom_period_months:
		frappe.msgprint(
			frappe._("custom_period_months is only used when recurrence_rule is 'Custom' - value will be ignored"),
			indicator="orange",
			alert=True
		)
	
	if custom_period_months and (custom_period_months < 1 or custom_period_months > 12):
		frappe.throw(
			frappe._("custom_period_months must be between 1 and 12")
		)


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/report/mpit_current_budget_vs_actual/mpit_current_budget_vs_actual.html
================================================================================
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; }
        .report-header { margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 10px; }
        .report-header h2 { margin: 0; color: #333; }
        .report-filters { background-color: #f8f9fa; padding: 10px; margin-bottom: 15px; border-radius: 4px; font-size: 0.9em; }
        .report-filters strong { color: #495057; }
        .table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 0.9em; }
        .table thead { background-color: #e9ecef; }
        .table th { border: 1px solid #dee2e6; padding: 10px; text-align: left; font-weight: 600; color: #495057; }
        .table td { border: 1px solid #dee2e6; padding: 8px; }
        .table tbody tr:nth-child(even) { background-color: #f8f9fa; }
        .table tbody tr:hover { background-color: #e9ecef; }
        .text-right { text-align: right; }
        .text-danger { color: #dc3545; }
        .text-success { color: #28a745; }
        .report-footer { margin-top: 20px; padding-top: 10px; border-top: 1px solid #dee2e6; text-align: right; color: #6c757d; font-size: 0.85em; }
    </style>
</head>
<body>
    <div class="report-header">
        <h2><%= __("Current Budget vs Actual") %></h2>
    </div>

    <div class="report-filters">
        <% if (filters.year) { %>
            <strong><%= __("Year") %>:</strong> <%= filters.year %> &nbsp;
        <% } %>
        <% if (filters.category) { %>
            <strong><%= __("Category") %>:</strong> <%= filters.category %> &nbsp;
        <% } %>
        <% if (filters.vendor) { %>
            <strong><%= __("Vendor") %>:</strong> <%= filters.vendor %> &nbsp;
        <% } %>
        <% if (filters.budget) { %>
            <strong><%= __("Budget") %>:</strong> <%= filters.budget %>
        <% } %>
    </div>

    <table class="table">
        <thead>
            <tr>
                <th><%= __("Budget") %></th>
                <th><%= __("Year") %></th>
                <th><%= __("Category") %></th>
                <th><%= __("Vendor") %></th>
                <th class="text-right"><%= __("Baseline") %></th>
                <th class="text-right"><%= __("Amendments") %></th>
                <th class="text-right"><%= __("Current Budget") %></th>
                <th class="text-right"><%= __("Actual") %></th>
                <th class="text-right"><%= __("Variance") %></th>
            </tr>
        </thead>
        <tbody>
            <% if (data && data.length > 0) { %>
                <% for(var i = 0; i < data.length; i++) { %>
                    <% var row = data[i]; %>
                    <tr>
                        <td><%= row.budget %></td>
                        <td><%= row.year %></td>
                        <td><%= row.category %></td>
                        <td><%= row.vendor || "" %></td>
                        <td class="text-right"><%= format_currency(row.baseline_amount) %></td>
                        <td class="text-right <%= row.amendment_delta >= 0 ? "" : "text-danger" %>">
                            <%= format_currency(row.amendment_delta) %>
                        </td>
                        <td class="text-right"><%= format_currency(row.current_budget) %></td>
                        <td class="text-right"><%= format_currency(row.actual_amount) %></td>
                        <td class="text-right <%= row.variance < 0 ? "text-success" : "text-danger" %>">
                            <%= format_currency(row.variance) %>
                        </td>
                    </tr>
                <% } %>
            <% } else { %>
                <tr>
                    <td colspan="9" style="text-align: center; padding: 20px; color: #6c757d;"><%= __("No data available") %></td>
                </tr>
            <% } %>
        </tbody>
    </table>

    <div class="report-footer">
        <%= __("Generated on") %> <%= new Date().toLocaleDateString() %> <%= __("at") %> <%= new Date().toLocaleTimeString() %>
    </div>
</body>
</html>


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/report/mpit_current_budget_vs_actual/mpit_current_budget_vs_actual.js
================================================================================
// Copyright (c) 2025, DOT and contributors
// For license information, please see license.txt

frappe.query_reports["MPIT Current Budget vs Actual"] = {
	"filters": [

	]
};


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/report/mpit_current_budget_vs_actual/mpit_current_budget_vs_actual.py
================================================================================
from __future__ import annotations

import frappe
from frappe import _


def execute(filters=None):
	if isinstance(filters, str):
		filters = frappe.parse_json(filters)
	filters = frappe._dict(filters or {})
	rows = _get_data(filters)

	columns = [
		_("Budget") + ":Link/MPIT Budget:180",
		_("Year") + ":Link/MPIT Year:80",
		_("Category") + ":Link/MPIT Category:180",
		_("Vendor") + ":Link/MPIT Vendor:150",
		_("Baseline Amount") + ":Currency:140",
		_("Amendments Delta") + ":Currency:140",
		_("Current Budget") + ":Currency:140",
		_("Actual Amount") + ":Currency:140",
		_("Variance (Actual - Current)") + ":Currency:170",
	]

	chart = _build_chart(rows)

	return columns, rows, None, chart


def _get_data(filters) -> list[dict]:
	params = {}
	conditions = ["b.docstatus = 1"]
	if filters.get("year"):
		conditions.append("b.year = %(year)s")
		params["year"] = filters.year
	if filters.get("budget"):
		conditions.append("b.name = %(budget)s")
		params["budget"] = filters.budget
	if filters.get("category"):
		conditions.append("bl.category = %(category)s")
		params["category"] = filters.category
	if filters.get("vendor"):
		conditions.append("bl.vendor = %(vendor)s")
		params["vendor"] = filters.vendor

	where = " AND ".join(conditions)

	base_rows = frappe.db.sql(
		f"""
		SELECT
			b.name AS budget,
			b.year AS year,
			bl.category AS category,
			bl.vendor AS vendor,
			SUM(COALESCE(bl.annual_net, bl.amount_net, bl.amount)) AS baseline_amount
		FROM `tabMPIT Budget` b
		JOIN `tabMPIT Budget Line` bl ON bl.parent = b.name
		WHERE {where}
		GROUP BY b.name, b.year, bl.category, bl.vendor
		""",
		params,
		as_dict=True,
	)

	amend_conditions = ["ba.docstatus = 1"]
	if filters.get("budget"):
		amend_conditions.append("ba.budget = %(budget)s")
	if filters.get("category"):
		amend_conditions.append("al.category = %(category)s")
	if filters.get("vendor"):
		amend_conditions.append("al.vendor = %(vendor)s")
	if filters.get("year"):
		amend_conditions.append("b.year = %(year)s")

	amend_where = " AND ".join(amend_conditions)

	amend_rows = frappe.db.sql(
		f"""
		SELECT
			ba.budget AS budget,
			b.year AS year,
			al.category AS category,
			al.vendor AS vendor,
			SUM(COALESCE(al.delta_amount_net, al.delta_amount)) AS amendment_delta
		FROM `tabMPIT Budget Amendment` ba
		JOIN `tabMPIT Budget` b ON b.name = ba.budget
		JOIN `tabMPIT Amendment Line` al ON al.parent = ba.name
		WHERE {amend_where}
		GROUP BY ba.budget, b.year, al.category, al.vendor
		""",
		params,
		as_dict=True,
	)

	actual_conditions = ["1=1"]
	if filters.get("year"):
		actual_conditions.append("year = %(year)s")
	if filters.get("category"):
		actual_conditions.append("category = %(category)s")
	if filters.get("vendor"):
		actual_conditions.append("vendor = %(vendor)s")

	actual_where = " AND ".join(actual_conditions)

	actual_rows = frappe.db.sql(
		f"""
		SELECT year, category, vendor, SUM(COALESCE(amount_net, amount)) AS actual_amount
		FROM `tabMPIT Actual Entry`
		WHERE {actual_where}
		GROUP BY year, category, vendor
		""",
		as_dict=True,
	)

	base_map = {(r["budget"], r["year"], r["category"], r.get("vendor")): r for r in base_rows}
	amend_map = {(r["budget"], r["year"], r["category"], r.get("vendor")): r for r in amend_rows}
	actual_map = {(r["year"], r["category"], r.get("vendor")): r["actual_amount"] for r in actual_rows}

	keys = set(base_map.keys()) | set(amend_map.keys())
	result: list[dict] = []
	for key in sorted(
		keys,
		key=lambda k: (str(k[1] or ""), str(k[2] or ""), str(k[3] or ""), str(k[0] or "")),
	):
		budget, year, category, vendor = key
		base = base_map.get(key, {})
		amend = amend_map.get(key, {})
		baseline_amount = float(base.get("baseline_amount") or 0)
		amendment_delta = float(amend.get("amendment_delta") or 0)
		current_budget = baseline_amount + amendment_delta
		actual_amount = float(actual_map.get((year, category, vendor), 0) or 0)
		variance = actual_amount - current_budget
		result.append({
			"budget": budget,
			"year": year,
			"category": category,
			"vendor": vendor,
			"baseline_amount": baseline_amount,
			"amendment_delta": amendment_delta,
			"current_budget": current_budget,
			"actual_amount": actual_amount,
			"variance": variance,
		})

	return result


def _build_chart(rows: list[dict]) -> dict | None:
	if not rows:
		return None

	current_totals = {}
	actual_totals = {}
	for r in rows:
		current_totals[r["budget"]] = current_totals.get(r["budget"], 0) + float(r.get("current_budget") or 0)
		actual_totals[r["budget"]] = actual_totals.get(r["budget"], 0) + float(r.get("actual_amount") or 0)

	labels = sorted(current_totals.keys())
	return {
		"data": {
			"labels": labels,
			"datasets": [
				{"name": _("Current Budget"), "values": [current_totals.get(b, 0) for b in labels]},
				{"name": _("Actual"), "values": [actual_totals.get(b, 0) for b in labels]},
			],
		},
		"type": "bar",
		"axis_options": {"x_axis_mode": "tick", "y_axis_mode": "tick"},
	}


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/report/mpit_current_budget_vs_actual/__init__.py
================================================================================


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/report/mpit_current_budget_vs_actual/mpit_current_budget_vs_actual.json
================================================================================
{
 "add_total_row": 1,
 "add_translate_data": 0,
 "columns": [],
 "creation": "2025-12-21 19:25:35.030892",
 "disabled": 0,
 "docstatus": 0,
 "doctype": "Report",
 "filters": [],
 "idx": 0,
 "is_standard": "Yes",
 "letter_head": null,
 "modified": "2025-12-24 20:00:51.422557",
 "modified_by": "Administrator",
 "module": "Master Plan IT",
 "name": "MPIT Current Budget vs Actual",
 "owner": "Administrator",
 "prepared_report": 0,
 "ref_doctype": "MPIT Budget",
 "report_name": "MPIT Current Budget vs Actual",
 "report_type": "Script Report",
 "roles": [
  {
   "role": "System Manager"
  },
  {
   "role": "vCIO Manager"
  },
  {
   "role": "Client Editor"
  },
  {
   "role": "Client Viewer"
  }
 ],
 "timeout": 0
}

================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/report/mpit_projects_planned_vs_actual/mpit_projects_planned_vs_actual.js
================================================================================
// Copyright (c) 2025, DOT and contributors
// For license information, please see license.txt

frappe.query_reports["MPIT Projects Planned vs Actual"] = {
	"filters": [

	]
};


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/report/mpit_projects_planned_vs_actual/mpit_projects_planned_vs_actual.html
================================================================================
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; }
        .report-header { margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 10px; }
        .report-header h2 { margin: 0; color: #333; }
        .report-filters { background-color: #f8f9fa; padding: 10px; margin-bottom: 15px; border-radius: 4px; font-size: 0.9em; }
        .report-filters strong { color: #495057; }
        .table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 0.9em; }
        .table thead { background-color: #e9ecef; }
        .table th { border: 1px solid #dee2e6; padding: 10px; text-align: left; font-weight: 600; color: #495057; }
        .table td { border: 1px solid #dee2e6; padding: 8px; }
        .table tbody tr:nth-child(even) { background-color: #f8f9fa; }
        .table tbody tr:hover { background-color: #e9ecef; }
        .text-right { text-align: right; }
        .text-danger { color: #dc3545; }
        .text-success { color: #28a745; }
        .badge { display: inline-block; padding: 3px 8px; border-radius: 3px; font-size: 0.85em; font-weight: 500; }
        .badge-planning { background-color: #ffc107; color: #000; }
        .badge-active { background-color: #28a745; color: #fff; }
        .badge-completed { background-color: #6c757d; color: #fff; }
        .badge-cancelled { background-color: #dc3545; color: #fff; }
        .report-footer { margin-top: 20px; padding-top: 10px; border-top: 1px solid #dee2e6; text-align: right; color: #6c757d; font-size: 0.85em; }
    </style>
</head>
<body>
    <div class="report-header">
        <h2><%= __("Projects: Planned vs Actual") %></h2>
    </div>

    <div class="report-filters">
        <% if (filters.project) { %>
            <strong><%= __("Project") %>:</strong> <%= filters.project %> &nbsp;
        <% } %>
        <% if (filters.year) { %>
            <strong><%= __("Year") %>:</strong> <%= filters.year %>
        <% } %>
    </div>

    <table class="table">
        <thead>
            <tr>
                <th><%= __("Project") %></th>
                <th><%= __("Status") %></th>
                <th><%= __("Year") %></th>
                <th class="text-right"><%= __("Planned Amount") %></th>
                <th class="text-right"><%= __("Actual Amount") %></th>
                <th class="text-right"><%= __("Variance") %></th>
            </tr>
        </thead>
        <tbody>
            <% if (data && data.length > 0) { %>
                <% for(var i = 0; i < data.length; i++) { %>
                    <% var row = data[i]; %>
                    <% 
                        var statusClass = "";
                        var statusLabel = row.status;
                        if (row.status === "Planning") statusClass = "badge-planning";
                        else if (row.status === "Active") statusClass = "badge-active";
                        else if (row.status === "Completed") statusClass = "badge-completed";
                        else if (row.status === "Cancelled") statusClass = "badge-cancelled";
                        if (row.status === "Planning") statusLabel = __("Planning");
                        else if (row.status === "Active") statusLabel = __("Active");
                        else if (row.status === "Completed") statusLabel = __("Completed");
                        else if (row.status === "Cancelled") statusLabel = __("Cancelled");
                    %>
                    <tr>
                        <td><%= row.project %></td>
                        <td><span class="badge <%= statusClass %>"><%= statusLabel %></span></td>
                        <td><%= row.year %></td>
                        <td class="text-right"><%= format_currency(row.planned_amount) %></td>
                        <td class="text-right"><%= format_currency(row.actual_amount) %></td>
                        <td class="text-right <%= row.variance < 0 ? "text-success" : "text-danger" %>">
                            <%= format_currency(row.variance) %>
                        </td>
                    </tr>
                <% } %>
            <% } else { %>
                <tr>
                    <td colspan="6" style="text-align: center; padding: 20px; color: #6c757d;"><%= __("No data available") %></td>
                </tr>
            <% } %>
        </tbody>
    </table>

    <div class="report-footer">
        <%= __("Generated on") %> <%= new Date().toLocaleDateString() %> <%= __("at") %> <%= new Date().toLocaleTimeString() %>
    </div>
</body>
</html>


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/report/mpit_projects_planned_vs_actual/__init__.py
================================================================================


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/report/mpit_projects_planned_vs_actual/mpit_projects_planned_vs_actual.json
================================================================================
{
 "add_total_row": 1,
 "add_translate_data": 0,
 "columns": [],
 "creation": "2025-12-21 19:25:35.062873",
 "disabled": 0,
 "docstatus": 0,
 "doctype": "Report",
 "filters": [],
 "idx": 0,
 "is_standard": "Yes",
 "letter_head": null,
 "modified": "2025-12-24 20:00:51.525958",
 "modified_by": "Administrator",
 "module": "Master Plan IT",
 "name": "MPIT Projects Planned vs Actual",
 "owner": "Administrator",
 "prepared_report": 0,
 "ref_doctype": "MPIT Project",
 "report_name": "MPIT Projects Planned vs Actual",
 "report_type": "Script Report",
 "roles": [
  {
   "role": "System Manager"
  },
  {
   "role": "vCIO Manager"
  },
  {
   "role": "Client Editor"
  },
  {
   "role": "Client Viewer"
  }
 ],
 "timeout": 0
}

================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/report/mpit_projects_planned_vs_actual/mpit_projects_planned_vs_actual.py
================================================================================
from __future__ import annotations

import frappe
from frappe import _


def execute(filters=None):
	if isinstance(filters, str):
		filters = frappe.parse_json(filters)
	filters = frappe._dict(filters or {})
	rows = _get_data(filters)

	columns = [
		{"label": _("Project"), "fieldname": "project", "fieldtype": "Link", "options": "MPIT Project", "width": 200},
		{"label": _("Status"), "fieldname": "status", "fieldtype": "Data", "width": 120},
		{"label": _("Year"), "fieldname": "year", "fieldtype": "Link", "options": "MPIT Year", "width": 80},
		{"label": _("Planned (Net)"), "fieldname": "planned_amount", "fieldtype": "Currency", "width": 140},
		{"label": _("Quoted (Net)"), "fieldname": "quoted_amount", "fieldtype": "Currency", "width": 140},
		{"label": _("Expected (Net)"), "fieldname": "expected_amount", "fieldtype": "Currency", "width": 140},
		{"label": _("Actual (Net)"), "fieldname": "actual_amount", "fieldtype": "Currency", "width": 140},
		{"label": _("Variance vs Expected"), "fieldname": "variance_expected", "fieldtype": "Currency", "width": 170},
		{"label": _("Variance vs Planned"), "fieldname": "variance_planned", "fieldtype": "Currency", "width": 170},
	]

	chart = _build_chart(rows)

	return columns, rows, None, chart


def _get_data(filters) -> list[dict]:
	params = {}
	conditions = ["1=1"]
	if filters.get("project"):
		conditions.append("p.name = %(project)s")
		params["project"] = filters.project
	if filters.get("year"):
		conditions.append("alloc.year = %(year)s")
		params["year"] = filters.year

	where = " AND ".join(conditions)

	allocations = frappe.db.sql(
		f"""
		SELECT
			p.name AS project,
			p.status AS status,
			alloc.year AS year,
			SUM(COALESCE(alloc.planned_amount_net, alloc.planned_amount)) AS planned_amount
		FROM `tabMPIT Project` p
		JOIN `tabMPIT Project Allocation` alloc ON alloc.parent = p.name
		WHERE {where}
		GROUP BY p.name, p.status, alloc.year
		""",
		params,
		as_dict=True,
	)

	quotes = frappe.db.sql(
		"""
		SELECT parent AS project, SUM(COALESCE(amount_net, amount)) AS quoted_amount
		FROM `tabMPIT Project Quote`
		GROUP BY parent
		""",
		as_dict=True,
	)

	actuals = frappe.db.sql(
		"""
		SELECT project, year, SUM(COALESCE(amount_net, amount)) AS actual_amount
		FROM `tabMPIT Actual Entry`
		WHERE project IS NOT NULL
		GROUP BY project, year
		""",
		as_dict=True,
	)

	quotes_map = {r["project"]: r.get("quoted_amount") or 0 for r in quotes}
	actual_map = {(r["project"], r["year"]): r["actual_amount"] for r in actuals}

	rows: list[dict] = []
	for r in allocations:
		actual_amount = float(actual_map.get((r["project"], r["year"]), 0))
		planned = float(r.get("planned_amount") or 0)
		quoted = float(quotes_map.get(r["project"], 0) or 0)
		expected = quoted if quoted > 0 else planned
		variance_expected = actual_amount - expected
		variance_planned = actual_amount - planned
		rows.append({
			"project": r["project"],
			"status": r["status"],
			"year": r["year"],
			"planned_amount": planned,
			"quoted_amount": quoted,
			"expected_amount": expected,
			"actual_amount": actual_amount,
			"variance_expected": variance_expected,
			"variance_planned": variance_planned,
		})

	return rows


def _build_chart(rows: list[dict]) -> dict | None:
	if not rows:
		return None

	expected_totals = {}
	actual_totals = {}
	for r in rows:
		expected_totals[r["project"]] = expected_totals.get(r["project"], 0) + float(r.get("expected_amount") or 0)
		actual_totals[r["project"]] = actual_totals.get(r["project"], 0) + float(r.get("actual_amount") or 0)

	labels = sorted(expected_totals.keys())
	return {
		"data": {
			"labels": labels,
			"datasets": [
				{"name": _("Expected"), "values": [expected_totals.get(p, 0) for p in labels]},
				{"name": _("Actual"), "values": [actual_totals.get(p, 0) for p in labels]},
			],
		},
		"type": "bar",
		"axis_options": {"x_axis_mode": "tick", "y_axis_mode": "tick"},
	}


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/report/mpit_budget_diff/__init__.py
================================================================================
# This file ensures the report package is discoverable.


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/report/mpit_budget_diff/mpit_budget_diff.json
================================================================================
{
 "add_total_row": 0,
 "add_translate_data": 0,
 "columns": [],
 "creation": "2025-12-26 00:00:00.000000",
 "disabled": 0,
 "docstatus": 0,
 "doctype": "Report",
 "filters": [
  {
   "fieldname": "budget_a",
   "label": "Budget A",
   "fieldtype": "Link",
   "options": "MPIT Budget",
   "reqd": 1
  },
  {
   "fieldname": "budget_b",
   "label": "Budget B",
   "fieldtype": "Link",
   "options": "MPIT Budget",
   "reqd": 1
  },
  {
   "fieldname": "group_by",
   "label": "Group By",
   "fieldtype": "Select",
   "options": "Category+Vendor\nCategory",
   "default": "Category+Vendor"
  },
  {
   "fieldname": "only_changed",
   "label": "Only Changed",
   "fieldtype": "Check",
   "default": "1"
  }
 ],
 "idx": 0,
 "is_standard": "Yes",
 "letter_head": null,
 "modified": "2025-12-26 00:00:00.000000",
 "modified_by": "Administrator",
 "module": "Master Plan IT",
 "name": "MPIT Budget Diff",
 "owner": "Administrator",
 "prepared_report": 0,
 "ref_doctype": "MPIT Budget",
 "report_name": "MPIT Budget Diff",
 "report_type": "Script Report",
 "roles": [
  {
   "role": "System Manager"
  },
  {
   "role": "vCIO Manager"
  },
  {
   "role": "Client Editor"
  },
  {
   "role": "Client Viewer"
  }
 ],
 "timeout": 0
}


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/report/mpit_budget_diff/mpit_budget_diff.py
================================================================================
from __future__ import annotations

import frappe
from frappe import _


def execute(filters=None):
	if isinstance(filters, str):
		filters = frappe.parse_json(filters)
	filters = frappe._dict(filters or {})

	_validate_filters(filters)
	group_by = (filters.get("group_by") or "Category+Vendor").strip()
	only_changed = frappe.utils.cint(filters.get("only_changed", 1))

	budget_a = filters.budget_a
	budget_b = filters.budget_b

	data = _build_rows(budget_a, budget_b, group_by, only_changed)
	columns = _build_columns()
	summary = _build_summary(data)

	return columns, data, None, None, summary


def _validate_filters(filters) -> None:
	if not filters.get("budget_a"):
		frappe.throw(_("budget_a is required"))
	if not filters.get("budget_b"):
		frappe.throw(_("budget_b is required"))
	if filters.budget_a == filters.budget_b:
		frappe.throw(_("budget_a and budget_b must be different budgets"))
	if filters.get("group_by") and filters.get("group_by") not in {"Category+Vendor", "Category"}:
		frappe.throw(_("group_by must be either 'Category+Vendor' or 'Category'"))


def _build_columns() -> list[dict]:
	return [
		{"label": _("Category"), "fieldname": "category", "fieldtype": "Link", "options": "MPIT Category", "width": 200},
		{"label": _("Vendor"), "fieldname": "vendor", "fieldtype": "Link", "options": "MPIT Vendor", "width": 180},
		{"label": _("Budget A Annual Net"), "fieldname": "budget_a_annual_net", "fieldtype": "Currency", "width": 140},
		{"label": _("Budget B Annual Net"), "fieldname": "budget_b_annual_net", "fieldtype": "Currency", "width": 140},
		{"label": _("Delta Annual (B - A)"), "fieldname": "delta_annual", "fieldtype": "Currency", "width": 150},
		{"label": _("Budget A Monthly Eq"), "fieldname": "budget_a_monthly_eq", "fieldtype": "Currency", "width": 140},
		{"label": _("Budget B Monthly Eq"), "fieldname": "budget_b_monthly_eq", "fieldtype": "Currency", "width": 140},
		{"label": _("Delta Monthly Eq"), "fieldname": "delta_monthly", "fieldtype": "Currency", "width": 130},
	]


def _load_budget_totals(budget: str, group_by: str) -> dict:
	fields = [
		"category",
		"SUM(COALESCE(annual_net, amount_net, amount)) AS planned",
	]
	group_fields = ["category"]
	if group_by == "Category+Vendor":
		fields.insert(1, "vendor")
		group_fields.append("vendor")

	rows = frappe.db.sql(
		f"""
		SELECT {", ".join(fields)}
		FROM `tabMPIT Budget Line`
		WHERE parent = %(budget)s
		GROUP BY {", ".join(group_fields)}
		""",
		{"budget": budget},
		as_dict=True,
	)

	result = {}
	for row in rows:
		key = (row.get("category"), row.get("vendor") if group_by == "Category+Vendor" else None)
		result[key] = float(row.get("planned") or 0)
	return result


def _build_rows(budget_a: str, budget_b: str, group_by: str, only_changed: int) -> list[dict]:
	a_map = _load_budget_totals(budget_a, group_by)
	b_map = _load_budget_totals(budget_b, group_by)
	keys = set(a_map.keys()) | set(b_map.keys())

	rows: list[dict] = []
	total_a = total_b = 0.0

	for key in sorted(keys, key=lambda k: (str(k[0] or ""), str(k[1] or ""))):
		category, vendor = key
		planned_a = float(a_map.get(key, 0) or 0)
		planned_b = float(b_map.get(key, 0) or 0)
		delta_annual = planned_b - planned_a

		if only_changed and abs(delta_annual) < 0.0001:
			continue

		monthly_a = planned_a / 12.0
		monthly_b = planned_b / 12.0
		delta_monthly = monthly_b - monthly_a

		rows.append({
			"category": category,
			"vendor": vendor,
			"budget_a_annual_net": planned_a,
			"budget_b_annual_net": planned_b,
			"delta_annual": delta_annual,
			"budget_a_monthly_eq": monthly_a,
			"budget_b_monthly_eq": monthly_b,
			"delta_monthly": delta_monthly,
		})

		total_a += planned_a
		total_b += planned_b

	if rows:
		delta_total = total_b - total_a
		rows.append({
			"category": _("Total"),
			"vendor": "",
			"budget_a_annual_net": total_a,
			"budget_b_annual_net": total_b,
			"delta_annual": delta_total,
			"budget_a_monthly_eq": total_a / 12.0,
			"budget_b_monthly_eq": total_b / 12.0,
			"delta_monthly": delta_total / 12.0,
			"is_total_row": 1,
		})

	return rows


def _build_summary(rows: list[dict]) -> list[dict]:
	if not rows:
		return []

	totals = [r for r in rows if r.get("is_total_row")]
	if not totals:
		return []

	total = totals[0]
	return [
		{
			"label": _("Budget A"),
			"value": frappe.utils.fmt_money(total.get("budget_a_annual_net", 0)),
			"indicator": "blue",
		},
		{
			"label": _("Budget B"),
			"value": frappe.utils.fmt_money(total.get("budget_b_annual_net", 0)),
			"indicator": "blue",
		},
		{
			"label": _("Delta (B - A)"),
			"value": frappe.utils.fmt_money(total.get("delta_annual", 0)),
			"indicator": "green" if (total.get("delta_annual", 0) or 0) >= 0 else "red",
		},
	]


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/report/__init__.py
================================================================================


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/report/mpit_monthly_budget_vs_actual/mpit_monthly_budget_vs_actual.json
================================================================================
{
 "add_total_row": 0,
 "add_translate_data": 0,
 "columns": [],
 "creation": "2025-12-26 00:00:00.000000",
 "disabled": 0,
 "docstatus": 0,
 "doctype": "Report",
 "filters": [
  {
   "fieldname": "year",
   "label": "Year",
   "fieldtype": "Link",
   "options": "MPIT Year",
   "reqd": 1
  },
  {
   "fieldname": "from_month",
   "label": "From Month",
   "fieldtype": "Int",
   "default": "1"
  },
  {
   "fieldname": "to_month",
   "label": "To Month",
   "fieldtype": "Int",
   "default": "12"
  },
  {
   "fieldname": "category",
   "label": "Category",
   "fieldtype": "Link",
   "options": "MPIT Category"
  },
  {
   "fieldname": "vendor",
   "label": "Vendor",
   "fieldtype": "Link",
   "options": "MPIT Vendor"
  },
  {
   "fieldname": "project",
   "label": "Project",
   "fieldtype": "Link",
   "options": "MPIT Project"
  },
  {
   "fieldname": "contract",
   "label": "Contract",
   "fieldtype": "Link",
   "options": "MPIT Contract"
  },
  {
   "fieldname": "include_portfolio",
   "label": "Include Portfolio",
   "fieldtype": "Check",
   "default": "1"
  }
 ],
 "idx": 0,
 "is_standard": "Yes",
 "letter_head": null,
 "modified": "2025-12-26 00:00:00.000000",
 "modified_by": "Administrator",
 "module": "Master Plan IT",
 "name": "MPIT Monthly Budget vs Actual",
 "owner": "Administrator",
 "prepared_report": 0,
 "ref_doctype": "MPIT Budget",
 "report_name": "MPIT Monthly Budget vs Actual",
 "report_type": "Script Report",
 "roles": [
  {
   "role": "System Manager"
  },
  {
   "role": "vCIO Manager"
  },
  {
   "role": "Client Editor"
  },
  {
   "role": "Client Viewer"
  }
 ],
 "timeout": 0
}


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/report/mpit_monthly_budget_vs_actual/__init__.py
================================================================================
# Report package marker.


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/report/mpit_monthly_budget_vs_actual/mpit_monthly_budget_vs_actual.py
================================================================================
from __future__ import annotations

import frappe
from frappe import _


def execute(filters=None):
	if isinstance(filters, str):
		filters = frappe.parse_json(filters)
	filters = frappe._dict(filters or {})

	_validate_filters(filters)
	year = int(filters.year)
	include_portfolio = frappe.utils.cint(filters.get("include_portfolio", 1))
	from_month, to_month = _month_range(filters)

	portfolio_categories = _get_portfolio_categories(year) if not include_portfolio else set()
	planned_annual = _get_planned_annual_total(filters, portfolio_categories)
	actual_by_month = _get_actuals_by_month(filters, portfolio_categories)

	rows = []
	planned_cum = actual_cum = 0.0
	variance_cum = 0.0
	planned_month = planned_annual / 12.0

	for month in range(from_month, to_month + 1):
		actual_month = float(actual_by_month.get(month, 0) or 0)
		variance = actual_month - planned_month

		planned_cum += planned_month
		actual_cum += actual_month
		variance_cum = actual_cum - planned_cum

		rows.append({
			"month": f"{year}-{month:02d}",
			"planned": planned_month,
			"actual": actual_month,
			"variance": variance,
			"planned_cumulative": planned_cum,
			"actual_cumulative": actual_cum,
			"variance_cumulative": variance_cum,
		})

	columns = _build_columns()
	summary = _build_summary(planned_cum, actual_cum, variance_cum)

	return columns, rows, None, None, summary


def _validate_filters(filters) -> None:
	if not filters.get("year"):
		frappe.throw(_("year is required"))


def _month_range(filters) -> tuple[int, int]:
	from_month = int(filters.get("from_month") or 1)
	to_month = int(filters.get("to_month") or 12)
	from_month = max(1, min(12, from_month))
	to_month = max(1, min(12, to_month))
	if from_month > to_month:
		from_month, to_month = to_month, from_month
	return from_month, to_month


def _build_columns() -> list[str]:
	return [
		{"label": _("Month"), "fieldname": "month", "fieldtype": "Data", "width": 90},
		{"label": _("Planned"), "fieldname": "planned", "fieldtype": "Currency", "width": 120},
		{"label": _("Actual"), "fieldname": "actual", "fieldtype": "Currency", "width": 120},
		{"label": _("Variance"), "fieldname": "variance", "fieldtype": "Currency", "width": 120},
		{"label": _("Planned Cumulative"), "fieldname": "planned_cumulative", "fieldtype": "Currency", "width": 140},
		{"label": _("Actual Cumulative"), "fieldname": "actual_cumulative", "fieldtype": "Currency", "width": 140},
		{"label": _("Variance Cumulative"), "fieldname": "variance_cumulative", "fieldtype": "Currency", "width": 150},
	]


def _get_planned_annual_total(filters, portfolio_categories: set[str]) -> float:
	params = {"year": filters.year}
	conditions = ["b.docstatus = 1", "b.year = %(year)s"]
	line_filters = []

	if filters.get("category"):
		line_filters.append("bl.category = %(category)s")
		params["category"] = filters.category
	if filters.get("vendor"):
		line_filters.append("bl.vendor = %(vendor)s")
		params["vendor"] = filters.vendor
	if filters.get("project"):
		line_filters.append("bl.project = %(project)s")
		params["project"] = filters.project
	if filters.get("contract"):
		line_filters.append("bl.contract = %(contract)s")
		params["contract"] = filters.contract
	if portfolio_categories:
		line_filters.append("bl.category NOT IN %(portfolio)s")
		params["portfolio"] = tuple(portfolio_categories)

	where = " AND ".join(conditions + line_filters)

	base_rows = frappe.db.sql(
		f"""
		SELECT SUM(COALESCE(bl.annual_net, bl.amount_net, bl.amount)) AS planned
		FROM `tabMPIT Budget` b
		JOIN `tabMPIT Budget Line` bl ON bl.parent = b.name
		WHERE {where}
		""",
		params,
		as_dict=True,
	)
	base_total = float(base_rows[0]["planned"] or 0) if base_rows else 0.0

	amend_conditions = ["ba.docstatus = 1", "b.year = %(year)s"]
	if filters.get("category"):
		amend_conditions.append("al.category = %(category)s")
	if filters.get("vendor"):
		amend_conditions.append("al.vendor = %(vendor)s")
	if filters.get("project"):
		amend_conditions.append("al.project = %(project)s")
	if filters.get("contract"):
		amend_conditions.append("al.contract = %(contract)s")
	if portfolio_categories:
		amend_conditions.append("al.category NOT IN %(portfolio)s")

	amend_where = " AND ".join(amend_conditions)

	amend_rows = frappe.db.sql(
		f"""
		SELECT SUM(COALESCE(al.delta_amount_net, al.delta_amount)) AS delta_planned
		FROM `tabMPIT Budget Amendment` ba
		JOIN `tabMPIT Budget` b ON b.name = ba.budget
		JOIN `tabMPIT Amendment Line` al ON al.parent = ba.name
		WHERE {amend_where}
		""",
		params,
		as_dict=True,
	)
	amend_total = float(amend_rows[0]["delta_planned"] or 0) if amend_rows else 0.0

	return base_total + amend_total


def _get_actuals_by_month(filters, portfolio_categories: set[str]) -> dict[int, float]:
	params = {"year": filters.year}
	conditions = ["year = %(year)s"]

	if filters.get("category"):
		conditions.append("category = %(category)s")
		params["category"] = filters.category
	if filters.get("vendor"):
		conditions.append("vendor = %(vendor)s")
		params["vendor"] = filters.vendor
	if filters.get("project"):
		conditions.append("project = %(project)s")
		params["project"] = filters.project
	if filters.get("contract"):
		conditions.append("contract = %(contract)s")
		params["contract"] = filters.contract
	if portfolio_categories:
		conditions.append("category NOT IN %(portfolio)s")
		params["portfolio"] = tuple(portfolio_categories)

	where = " AND ".join(conditions)

	rows = frappe.db.sql(
		f"""
		SELECT MONTH(posting_date) AS month, SUM(COALESCE(amount_net, amount)) AS actual
		FROM `tabMPIT Actual Entry`
		WHERE {where}
		GROUP BY MONTH(posting_date)
		""",
		params,
		as_dict=True,
	)

	return {int(r["month"]): float(r["actual"] or 0) for r in rows}


def _get_portfolio_categories(year: int) -> set[str]:
	rows = frappe.db.sql(
		"""
		SELECT DISTINCT bl.category
		FROM `tabMPIT Budget` b
		JOIN `tabMPIT Budget Line` bl ON bl.parent = b.name
		WHERE b.docstatus = 1
		  AND b.year = %(year)s
		  AND COALESCE(bl.is_portfolio_bucket, 0) = 1
		""",
		{"year": year},
	)
	return {r[0] for r in rows if r and r[0]}


def _build_summary(planned_cum: float, actual_cum: float, variance_cum: float) -> list[dict]:
	return [
		{
			"label": _("Planned"),
			"value": frappe.utils.fmt_money(planned_cum),
			"indicator": "blue",
		},
		{
			"label": _("Actual"),
			"value": frappe.utils.fmt_money(actual_cum),
			"indicator": "blue",
		},
		{
			"label": _("Variance (Actual - Planned)"),
			"value": frappe.utils.fmt_money(variance_cum),
			"indicator": "green" if (variance_cum or 0) >= 0 else "red",
		},
	]


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/report/mpit_approved_budget_vs_actual/mpit_approved_budget_vs_actual.json
================================================================================
{
 "add_total_row": 1,
 "add_translate_data": 0,
 "columns": [],
 "creation": "2025-12-21 19:25:34.991923",
 "disabled": 0,
 "docstatus": 0,
 "doctype": "Report",
 "filters": [],
 "idx": 0,
 "is_standard": "Yes",
 "letter_head": null,
 "modified": "2025-12-24 20:00:51.255638",
 "modified_by": "Administrator",
 "module": "Master Plan IT",
 "name": "MPIT Approved Budget vs Actual",
 "owner": "Administrator",
 "prepared_report": 0,
 "ref_doctype": "MPIT Budget",
 "report_name": "MPIT Approved Budget vs Actual",
 "report_type": "Script Report",
 "roles": [
  {
   "role": "System Manager"
  },
  {
   "role": "vCIO Manager"
  },
  {
   "role": "Client Editor"
  },
  {
   "role": "Client Viewer"
  }
 ],
 "timeout": 0
}

================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/report/mpit_approved_budget_vs_actual/__init__.py
================================================================================


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/report/mpit_approved_budget_vs_actual/mpit_approved_budget_vs_actual.py
================================================================================
from __future__ import annotations

import frappe
from frappe import _


def execute(filters=None):
	if isinstance(filters, str):
		filters = frappe.parse_json(filters)
	filters = frappe._dict(filters or {})
	rows = _get_data(filters)

	columns = [
		_("Budget") + ":Link/MPIT Budget:180",
		_("Year") + ":Link/MPIT Year:80",
		_("Category") + ":Link/MPIT Category:180",
		_("Vendor") + ":Link/MPIT Vendor:150",
		_("Budget Amount") + ":Currency:140",
		_("Actual Amount") + ":Currency:140",
		_("Variance (Actual - Budget)") + ":Currency:160",
	]

	chart = _build_chart(rows)

	return columns, rows, None, chart


def _get_data(filters) -> list[dict]:
	conditions = ["b.docstatus = 1"]
	params = {}
	if filters.get("year"):
		conditions.append("b.year = %(year)s")
		params["year"] = filters.year
	if filters.get("category"):
		conditions.append("bl.category = %(category)s")
		params["category"] = filters.category
	if filters.get("vendor"):
		conditions.append("bl.vendor = %(vendor)s")
		params["vendor"] = filters.vendor
	if filters.get("budget"):
		conditions.append("b.name = %(budget)s")
		params["budget"] = filters.budget

	where = " AND ".join(conditions)

	return frappe.db.sql(
		f"""
		WITH actuals AS (
			SELECT category, year, vendor, SUM(COALESCE(amount_net, amount)) AS actual_amount
			FROM `tabMPIT Actual Entry`
			GROUP BY category, year, vendor
		)
		SELECT
			b.name AS budget,
			b.year AS year,
			bl.category AS category,
			bl.vendor AS vendor,
			SUM(COALESCE(bl.annual_net, bl.amount_net, bl.amount)) AS budget_amount,
			COALESCE(a.actual_amount, 0) AS actual_amount,
			COALESCE(a.actual_amount, 0) - SUM(COALESCE(bl.annual_net, bl.amount_net, bl.amount)) AS variance
		FROM `tabMPIT Budget` b
		JOIN `tabMPIT Budget Line` bl ON bl.parent = b.name
		LEFT JOIN actuals a ON a.category = bl.category AND a.year = b.year AND a.vendor <=> bl.vendor
		WHERE {where}
		GROUP BY b.name, b.year, bl.category, bl.vendor, a.actual_amount
		ORDER BY b.year, b.name, bl.category, bl.vendor
		""",
		params,
		as_dict=True,
	)


def _build_chart(rows: list[dict]) -> dict | None:
	if not rows:
		return None

	budget_totals = {}
	actual_totals = {}
	for r in rows:
		budget_totals[r["budget"]] = budget_totals.get(r["budget"], 0) + float(r.get("budget_amount") or 0)
		actual_totals[r["budget"]] = actual_totals.get(r["budget"], 0) + float(r.get("actual_amount") or 0)

	labels = sorted(budget_totals.keys())
	return {
		"data": {
			"labels": labels,
			"datasets": [
				{"name": _("Budget"), "values": [budget_totals.get(b, 0) for b in labels]},
				{"name": _("Actual"), "values": [actual_totals.get(b, 0) for b in labels]},
			],
		},
		"type": "bar",
		"axis_options": {"x_axis_mode": "tick", "y_axis_mode": "tick"},
	}


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/report/mpit_approved_budget_vs_actual/mpit_approved_budget_vs_actual.html
================================================================================
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; }
        .report-header { margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 10px; }
        .report-header h2 { margin: 0; color: #333; }
        .report-filters { background-color: #f8f9fa; padding: 10px; margin-bottom: 15px; border-radius: 4px; font-size: 0.9em; }
        .report-filters strong { color: #495057; }
        .table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 0.9em; }
        .table thead { background-color: #e9ecef; }
        .table th { border: 1px solid #dee2e6; padding: 10px; text-align: left; font-weight: 600; color: #495057; }
        .table td { border: 1px solid #dee2e6; padding: 8px; }
        .table tbody tr:nth-child(even) { background-color: #f8f9fa; }
        .table tbody tr:hover { background-color: #e9ecef; }
        .text-right { text-align: right; }
        .text-danger { color: #dc3545; }
        .text-success { color: #28a745; }
        .report-footer { margin-top: 20px; padding-top: 10px; border-top: 1px solid #dee2e6; text-align: right; color: #6c757d; font-size: 0.85em; }
    </style>
</head>
<body>
    <div class="report-header">
        <h2><%= __("Approved Budget vs Actual") %></h2>
    </div>

    <div class="report-filters">
        <% if (filters.year) { %>
            <strong><%= __("Year") %>:</strong> <%= filters.year %> &nbsp;
        <% } %>
        <% if (filters.category) { %>
            <strong><%= __("Category") %>:</strong> <%= filters.category %> &nbsp;
        <% } %>
        <% if (filters.vendor) { %>
            <strong><%= __("Vendor") %>:</strong> <%= filters.vendor %> &nbsp;
        <% } %>
        <% if (filters.budget) { %>
            <strong><%= __("Budget") %>:</strong> <%= filters.budget %>
        <% } %>
    </div>

    <table class="table">
        <thead>
            <tr>
                <th><%= __("Budget") %></th>
                <th><%= __("Year") %></th>
                <th><%= __("Category") %></th>
                <th><%= __("Vendor") %></th>
                <th class="text-right"><%= __("Budget Amount") %></th>
                <th class="text-right"><%= __("Actual Amount") %></th>
                <th class="text-right"><%= __("Variance") %></th>
            </tr>
        </thead>
        <tbody>
            <% if (data && data.length > 0) { %>
                <% for(var i = 0; i < data.length; i++) { %>
                    <% var row = data[i]; %>
                    <tr>
                        <td><%= row.budget %></td>
                        <td><%= row.year %></td>
                        <td><%= row.category %></td>
                        <td><%= row.vendor || "" %></td>
                        <td class="text-right"><%= format_currency(row.budget_amount) %></td>
                        <td class="text-right"><%= format_currency(row.actual_amount) %></td>
                        <td class="text-right <%= row.variance < 0 ? "text-success" : "text-danger" %>">
                            <%= format_currency(row.variance) %>
                        </td>
                    </tr>
                <% } %>
            <% } else { %>
                <tr>
                    <td colspan="7" style="text-align: center; padding: 20px; color: #6c757d;"><%= __("No data available") %></td>
                </tr>
            <% } %>
        </tbody>
    </table>

    <div class="report-footer">
        <%= __("Generated on") %> <%= new Date().toLocaleDateString() %> <%= __("at") %> <%= new Date().toLocaleTimeString() %>
    </div>
</body>
</html>


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/report/mpit_approved_budget_vs_actual/mpit_approved_budget_vs_actual.js
================================================================================
// Copyright (c) 2025, DOT and contributors
// For license information, please see license.txt

frappe.query_reports["MPIT Approved Budget vs Actual"] = {
	"filters": [

	]
};


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/report/mpit_renewals_window/mpit_renewals_window.html
================================================================================
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; }
        .report-header { margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 10px; }
        .report-header h2 { margin: 0; color: #333; }
        .report-filters { background-color: #f8f9fa; padding: 10px; margin-bottom: 15px; border-radius: 4px; font-size: 0.9em; }
        .report-filters strong { color: #495057; }
        .table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 0.9em; }
        .table thead { background-color: #e9ecef; }
        .table th { border: 1px solid #dee2e6; padding: 10px; text-align: left; font-weight: 600; color: #495057; }
        .table td { border: 1px solid #dee2e6; padding: 8px; }
        .table tbody tr:nth-child(even) { background-color: #f8f9fa; }
        .table tbody tr:hover { background-color: #e9ecef; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .text-danger { color: #dc3545; font-weight: 600; }
        .text-warning { color: #ffc107; font-weight: 600; }
        .text-info { color: #17a2b8; }
        .badge { display: inline-block; padding: 3px 8px; border-radius: 3px; font-size: 0.85em; font-weight: 500; }
        .badge-expired { background-color: #dc3545; color: #fff; }
        .badge-urgent { background-color: #fd7e14; color: #fff; }
        .badge-soon { background-color: #ffc107; color: #000; }
        .badge-normal { background-color: #17a2b8; color: #fff; }
        .report-footer { margin-top: 20px; padding-top: 10px; border-top: 1px solid #dee2e6; text-align: right; color: #6c757d; font-size: 0.85em; }
    </style>
</head>
<body>
    <div class="report-header">
        <h2><%= __("Contract Renewals Window") %></h2>
    </div>

    <div class="report-filters">
        <% if (filters.days) { %>
            <strong><%= __("Days Forward") %>:</strong> <%= filters.days %> &nbsp;
        <% } %>
        <% if (filters.from_date) { %>
            <strong><%= __("From Date") %>:</strong> <%= frappe.format(filters.from_date, {fieldtype: "Date"}) %> &nbsp;
        <% } %>
        <% if (filters.include_past) { %>
            <strong><%= __("Include Past") %>:</strong> <%= __("Yes") %>
        <% } %>
    </div>

    <table class="table">
        <thead>
            <tr>
                <th><%= __("Contract") %></th>
                <th><%= __("Vendor") %></th>
                <th><%= __("Category") %></th>
                <th class="text-center"><%= __("Next Renewal") %></th>
                <th class="text-right"><%= __("Days to Renewal") %></th>
                <th class="text-right"><%= __("Notice Days") %></th>
                <th class="text-center"><%= __("Auto Renew") %></th>
                <th><%= __("Status") %></th>
            </tr>
        </thead>
        <tbody>
            <% if (data && data.length > 0) { %>
                <% for(var i = 0; i < data.length; i++) { %>
                    <% var row = data[i]; %>
                    <% 
                        var daysClass = "";
                        var daysLabel = "";
                        if (row.days_to_renewal < 0) {
                            daysClass = "badge-expired";
                            daysLabel = __("Expired");
                        } else if (row.days_to_renewal <= 30) {
                            daysClass = "badge-urgent";
                            daysLabel = __("Urgent");
                        } else if (row.days_to_renewal <= 60) {
                            daysClass = "badge-soon";
                            daysLabel = __("Soon");
                        } else {
                            daysClass = "badge-normal";
                            daysLabel = __("Normal");
                        }
                    %>
                    <tr>
                        <td><%= row.contract %></td>
                        <td><%= row.vendor %></td>
                        <td><%= row.category %></td>
                        <td class="text-center"><%= frappe.format(row.next_renewal_date, {fieldtype: "Date"}) %></td>
                        <td class="text-right <%= row.days_to_renewal < 0 ? "text-danger" : "" %>">
                            <%= row.days_to_renewal %>
                        </td>
                        <td class="text-right"><%= row.notice_days || 0 %></td>
                        <td class="text-center"><%= row.auto_renew ? "✓" : "" %></td>
                        <td><span class="badge <%= daysClass %>"><%= daysLabel %></span></td>
                    </tr>
                <% } %>
            <% } else { %>
                <tr>
                    <td colspan="8" style="text-align: center; padding: 20px; color: #6c757d;"><%= __("No renewals in this window") %></td>
                </tr>
            <% } %>
        </tbody>
    </table>

    <div class="report-footer">
        <%= __("Generated on") %> <%= new Date().toLocaleDateString() %> <%= __("at") %> <%= new Date().toLocaleTimeString() %>
    </div>
</body>
</html>


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/report/mpit_renewals_window/mpit_renewals_window.json
================================================================================
{
 "add_total_row": 0,
 "add_translate_data": 0,
 "columns": [],
 "creation": "2025-12-21 19:25:35.093017",
 "disabled": 0,
 "docstatus": 0,
 "doctype": "Report",
 "filters": [
  {
   "fieldname": "days",
   "label": "Next N Days",
   "fieldtype": "Int",
   "default": "60"
  },
  {
   "fieldname": "from_date",
   "label": "From Date",
   "fieldtype": "Date"
  },
  {
   "fieldname": "include_past",
   "label": "Include Past",
   "fieldtype": "Check",
   "default": "0"
  },
  {
   "fieldname": "auto_renew_only",
   "label": "Auto Renew Only",
   "fieldtype": "Check",
   "default": "0"
  }
 ],
 "idx": 0,
 "is_standard": "Yes",
 "letter_head": null,
 "modified": "2025-12-24 20:00:51.660104",
 "modified_by": "Administrator",
 "module": "Master Plan IT",
 "name": "MPIT Renewals Window",
 "owner": "Administrator",
 "prepared_report": 0,
 "ref_doctype": "MPIT Contract",
 "report_name": "MPIT Renewals Window",
 "report_type": "Script Report",
 "roles": [
  {
   "role": "System Manager"
  },
  {
   "role": "vCIO Manager"
  },
  {
   "role": "Client Editor"
  },
  {
   "role": "Client Viewer"
  }
 ],
 "timeout": 0
}


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/report/mpit_renewals_window/__init__.py
================================================================================


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/report/mpit_renewals_window/mpit_renewals_window.js
================================================================================
// Copyright (c) 2025, DOT and contributors
// For license information, please see license.txt

frappe.query_reports["MPIT Renewals Window"] = {
	"filters": [

	]
};


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/report/mpit_renewals_window/mpit_renewals_window.py
================================================================================
from __future__ import annotations

import collections
import datetime

import frappe
from frappe import _
from frappe.utils import add_days, cint, getdate, nowdate


def execute(filters=None):
	if isinstance(filters, str):
		filters = frappe.parse_json(filters)
	filters = frappe._dict(filters or {})
	rows, summary = _get_data(filters)

	columns = [
		_("Contract") + ":Link/MPIT Contract:160",
		_("Title") + ":Data:180",
		_("Vendor") + ":Link/MPIT Vendor:150",
		_("Category") + ":Link/MPIT Category:150",
		_("Next Renewal Date") + ":Date:120",
		_("Days to Renewal") + ":Int:110",
		_("Notice Days") + ":Int:100",
		_("Auto Renew") + ":Check:90",
		_("Status") + ":Data:100",
		_("End Date") + ":Date:110",
		_("Count") + ":Int:60",
		_("Expired Count") + ":Int:80",
	]

	chart = _build_chart(rows)

	return columns, rows, None, chart, summary


def _get_data(filters):
	days = cint(filters.get("days") or 90)
	include_past = cint(filters.get("include_past") or 0)
	auto_renew_only = cint(filters.get("auto_renew_only") or 0)
	start_date = getdate(filters.get("from_date") or nowdate())
	end_date = add_days(start_date, days)

	rows = []
	expired_count = 0

	where = ["next_renewal_date IS NOT NULL"]
	if auto_renew_only:
		where.append("COALESCE(auto_renew, 0) = 1")

	contracts = frappe.db.sql(
		f"""
		SELECT
			name,
			title,
			vendor,
			category,
			next_renewal_date,
			notice_days,
			auto_renew,
			status,
			end_date
		FROM `tabMPIT Contract`
		WHERE {" AND ".join(where)}
		""",
		as_dict=True,
	)

	for c in contracts:
		nrd = getdate(c.next_renewal_date)
		is_expired = 1 if nrd < start_date else 0

		# Skip records outside the forward window
		if nrd > end_date:
			continue
		# Skip expired if caller does not want them
		if is_expired and not include_past:
			continue

		days_to = (nrd - start_date).days
		if is_expired:
			expired_count += 1

		rows.append({
			"contract": c.name,
			"title": c.title or c.name,
			"vendor": c.vendor,
			"category": c.category,
			"next_renewal_date": c.next_renewal_date,
			"days_to_renewal": days_to,
			"notice_days": c.notice_days,
			"auto_renew": c.auto_renew,
			"status": c.status,
			"end_date": c.end_date,
			"count": 1,
			"expired_count": is_expired,
		})

	summary = [
		{"label": _("Upcoming (<= {0} days)").format(days), "value": len(rows) - expired_count, "indicator": "green"},
		{"label": _("Expired"), "value": expired_count, "indicator": "red"},
	]

	return rows, summary


def _build_chart(rows: list[dict]) -> dict | None:
	if not rows:
		return None

	buckets: dict[str, int] = collections.Counter()
	for r in rows:
		if not r.get("next_renewal_date"):
			continue
		month = getdate(r["next_renewal_date"]).strftime("%Y-%m")
		buckets[month] += 1

	labels = sorted(buckets.keys())
	return {
		"data": {
			"labels": labels,
			"datasets": [
				{"name": _("Renewals"), "values": [buckets.get(m, 0) for m in labels]},
			],
		},
		"type": "bar",
		"axis_options": {"x_axis_mode": "tick", "y_axis_mode": "tick"},
	}


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/print_format/mpit_budget_professional/mpit_budget_professional.json
================================================================================
{
  "align_labels_right": 0,
  "creation": "2025-01-01 00:00:00",
  "custom_format": 1,
  "default_print_language": "en",
  "disabled": 0,
  "doc_type": "MPIT Budget",
  "docstatus": 0,
  "doctype": "Print Format",
  "font_size": 10,
  "line_breaks": 0,
  "margin_bottom": 15.0,
  "margin_left": 15.0,
  "margin_right": 15.0,
  "margin_top": 15.0,
  "modified": "2025-01-01 00:00:00",
  "modified_by": "Administrator",
  "module": "Master Plan IT",
  "name": "MPIT Budget Professional",
  "owner": "Administrator",
  "print_format_builder": 0,
  "print_format_builder_beta": 0,
  "print_format_type": "Jinja",
  "raw_printing": 0,
  "show_section_headings": 0,
  "standard": "Yes"
}


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/print_format/mpit_budget_professional/mpit_budget_professional.html
================================================================================
{# MPIT Budget Professional Print Format #}
{% set user_prefs = frappe.get_doc("MPIT User Preferences", frappe.session.user) if frappe.db.exists("MPIT User Preferences", frappe.session.user) else None %}
{% set show_attachments = user_prefs.show_attachments_in_print if user_prefs else 0 %}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; font-size: 10pt; }
        .header { margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 10px; }
        .header h1 { margin: 0; font-size: 24pt; }
        .header .subtitle { color: #666; font-size: 11pt; margin-top: 5px; }
        .info-grid { display: table; width: 100%; margin-bottom: 20px; }
        .info-row { display: table-row; }
        .info-label { display: table-cell; width: 150px; font-weight: bold; padding: 5px 10px 5px 0; }
        .info-value { display: table-cell; padding: 5px 0; }
        .lines-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .lines-table th { background-color: #f0f0f0; border: 1px solid #ccc; padding: 8px; text-align: left; font-weight: bold; }
        .lines-table td { border: 1px solid #ccc; padding: 8px; }
        .lines-table tr:nth-child(even) { background-color: #fafafa; }
        .amount-col { text-align: right; }
        .totals { margin-top: 20px; float: right; width: 300px; }
        .totals table { width: 100%; }
        .totals td { padding: 5px; }
        .totals .total-label { font-weight: bold; text-align: right; }
        .totals .total-amount { text-align: right; font-weight: bold; }
        .totals .grand-total { border-top: 2px solid #333; font-size: 12pt; }
        .attachments { clear: both; margin-top: 40px; page-break-before: auto; }
        .attachments h3 { border-bottom: 1px solid #ccc; padding-bottom: 5px; }
        .attachments ul { list-style: none; padding: 0; }
        .attachments li { padding: 5px 0; }
        .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ccc; text-align: center; color: #666; font-size: 9pt; }
    </style>
</head>
<body>
    <div class="header">
        <h1>{{ _("Budget") }} {{ doc.name }}</h1>
        <div class="subtitle">{{ doc.title or "" }}</div>
    </div>

    <div class="info-grid">
        <div class="info-row">
            <div class="info-label">{{ _("Fiscal Year") }}:</div>
            <div class="info-value">{{ doc.year }}</div>
        </div>
        <div class="info-row">
            <div class="info-label">{{ _("Status") }}:</div>
            <div class="info-value">
                {% set status_label = doc.workflow_state or ("Draft" if doc.docstatus == 0 else "Approved" if doc.docstatus == 1 else "Cancelled") %}
                {{ status_label }}
            </div>
        </div>
    </div>

    <h3>{{ _("Budget Lines") }}</h3>
    <table class="lines-table">
        <thead>
            <tr>
                <th style="width: 5%;">#</th>
                <th style="width: 20%;">{{ _("Category") }}</th>
                <th style="width: 15%;">{{ _("Vendor") }}</th>
                <th style="width: 25%;">{{ _("Description") }}</th>
                <th class="amount-col" style="width: 10%;">{{ _("Net Amount") }}</th>
                <th class="amount-col" style="width: 8%;">{{ _("VAT %") }}</th>
                <th class="amount-col" style="width: 10%;">{{ _("Gross Amount") }}</th>
                <th class="amount-col" style="width: 7%;">{{ _("Recurrence") }}</th>
            </tr>
        </thead>
        <tbody>
            {% for line in doc.lines %}
            <tr>
                <td>{{ line.idx }}</td>
                <td>{{ line.category }}</td>
                <td>{{ line.vendor or "" }}</td>
                <td>{{ line.description or "" }}</td>
                <td class="amount-col">{{ frappe.format(line.amount_net, {"fieldtype": "Currency"}) }}</td>
                <td class="amount-col">{{ frappe.format(line.vat_rate, {"fieldtype": "Percent"}) if line.vat_rate else "0%" }}</td>
                <td class="amount-col">{{ frappe.format(line.amount_gross, {"fieldtype": "Currency"}) }}</td>
                <td>{{ line.recurrence_rule or _("None") }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="totals">
        <table>
            <tr>
                <td class="total-label">{{ _("Total Net") }}:</td>
                <td class="total-amount">{{ frappe.format(doc.lines | sum(attribute='amount_net'), {"fieldtype": "Currency"}) }}</td>
            </tr>
            <tr>
                <td class="total-label">{{ _("Total VAT") }}:</td>
                <td class="total-amount">{{ frappe.format(doc.lines | sum(attribute='amount_vat'), {"fieldtype": "Currency"}) }}</td>
            </tr>
            <tr class="grand-total">
                <td class="total-label">{{ _("Total Gross") }}:</td>
                <td class="total-amount">{{ frappe.format(doc.lines | sum(attribute='amount_gross'), {"fieldtype": "Currency"}) }}</td>
            </tr>
        </table>
    </div>

    {% if show_attachments %}
    {% set attachments = frappe.get_all("File", filters={"attached_to_doctype": doc.doctype, "attached_to_name": doc.name}, fields=["file_name", "file_url"]) %}
    {% if attachments %}
    <div class="attachments">
        <h3>{{ _("Attachments") }}</h3>
        <ul>
            {% for attachment in attachments %}
            <li>{{ attachment.file_name }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}
    {% endif %}

    <div class="footer">
        <p>{{ _("Printed on") }} {{ frappe.utils.now_datetime().strftime("%Y-%m-%d %H:%M") }} {{ _("by") }} {{ frappe.session.user }}</p>
    </div>
</body>
</html>


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/print_format/mpit_project_professional/mpit_project_professional.json
================================================================================
{
  "align_labels_right": 0,
  "creation": "2025-01-01 00:00:00",
  "custom_format": 1,
  "default_print_language": "en",
  "disabled": 0,
  "doc_type": "MPIT Project",
  "docstatus": 0,
  "doctype": "Print Format",
  "font_size": 10,
  "line_breaks": 0,
  "margin_bottom": 15.0,
  "margin_left": 15.0,
  "margin_right": 15.0,
  "margin_top": 15.0,
  "modified": "2025-01-01 00:00:00",
  "modified_by": "Administrator",
  "module": "Master Plan IT",
  "name": "MPIT Project Professional",
  "owner": "Administrator",
  "print_format_builder": 0,
  "print_format_builder_beta": 0,
  "print_format_type": "Jinja",
  "raw_printing": 0,
  "show_section_headings": 0,
  "standard": "Yes"
}


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/print_format/mpit_project_professional/mpit_project_professional.html
================================================================================
{# MPIT Project Professional Print Format #}
{% set user_prefs = frappe.get_doc("MPIT User Preferences", frappe.session.user) if frappe.db.exists("MPIT User Preferences", frappe.session.user) else None %}
{% set show_attachments = user_prefs.show_attachments_in_print if user_prefs else 0 %}
{% set status_map = {
    "Draft": _("Draft"),
    "Proposed": _("Proposed"),
    "Approved": _("Approved"),
    "In Progress": _("In Progress"),
    "On Hold": _("On Hold"),
    "Completed": _("Completed"),
    "Cancelled": _("Cancelled"),
} %}
{% set status_label = status_map.get(doc.status, doc.status) %}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; font-size: 10pt; }
        .header { margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 10px; }
        .header h1 { margin: 0; font-size: 24pt; }
        .header .subtitle { color: #666; font-size: 11pt; margin-top: 5px; }
        .info-grid { display: table; width: 100%; margin-bottom: 20px; }
        .info-row { display: table-row; }
        .info-label { display: table-cell; width: 150px; font-weight: bold; padding: 5px 10px 5px 0; }
        .info-value { display: table-cell; padding: 5px 0; }
        .section-heading { font-size: 14pt; font-weight: bold; margin-top: 25px; margin-bottom: 10px; border-bottom: 1px solid #999; }
        .table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .table th { background-color: #f0f0f0; border: 1px solid #ccc; padding: 8px; text-align: left; font-weight: bold; }
        .table td { border: 1px solid #ccc; padding: 8px; }
        .table tr:nth-child(even) { background-color: #fafafa; }
        .amount-col { text-align: right; }
        .totals { margin-top: 10px; float: right; width: 250px; }
        .totals table { width: 100%; }
        .totals td { padding: 5px; }
        .totals .total-label { font-weight: bold; text-align: right; }
        .totals .total-amount { text-align: right; font-weight: bold; }
        .totals .grand-total { border-top: 2px solid #333; font-size: 11pt; }
        .attachments { clear: both; margin-top: 40px; page-break-before: auto; }
        .attachments h3 { border-bottom: 1px solid #ccc; padding-bottom: 5px; }
        .attachments ul { list-style: none; padding: 0; }
        .attachments li { padding: 5px 0; }
        .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ccc; text-align: center; color: #666; font-size: 9pt; }
    </style>
</head>
<body>
    <div class="header">
        <h1>{{ _("Project") }} {{ doc.name }}</h1>
        <div class="subtitle">{{ doc.title or "" }}</div>
    </div>

    <div class="info-grid">
        <div class="info-row">
            <div class="info-label">{{ _("Status") }}:</div>
            <div class="info-value">{{ status_label }}</div>
        </div>
        {% if doc.start_date %}
        <div class="info-row">
            <div class="info-label">{{ _("Start Date") }}:</div>
            <div class="info-value">{{ frappe.format(doc.start_date, {"fieldtype": "Date"}) }}</div>
        </div>
        {% endif %}
        {% if doc.end_date %}
        <div class="info-row">
            <div class="info-label">{{ _("End Date") }}:</div>
            <div class="info-value">{{ frappe.format(doc.end_date, {"fieldtype": "Date"}) }}</div>
        </div>
        {% endif %}
        {% if doc.description %}
        <div class="info-row">
            <div class="info-label">{{ _("Description") }}:</div>
            <div class="info-value">{{ doc.description }}</div>
        </div>
        {% endif %}
    </div>

    {% if doc.allocations %}
    <h3 class="section-heading">{{ _("Budget Allocations") }}</h3>
    <table class="table">
        <thead>
            <tr>
                <th style="width: 5%;">#</th>
                <th style="width: 15%;">{{ _("Year") }}</th>
                <th style="width: 20%;">{{ _("Budget") }}</th>
                <th class="amount-col" style="width: 15%;">{{ _("Planned Net") }}</th>
                <th class="amount-col" style="width: 10%;">{{ _("VAT %") }}</th>
                <th class="amount-col" style="width: 15%;">{{ _("Planned Gross") }}</th>
                <th style="width: 20%;">{{ _("Notes") }}</th>
            </tr>
        </thead>
        <tbody>
            {% for alloc in doc.allocations %}
            <tr>
                <td>{{ alloc.idx }}</td>
                <td>{{ alloc.year }}</td>
                <td>{{ alloc.budget or "" }}</td>
                <td class="amount-col">{{ frappe.format(alloc.planned_amount_net, {"fieldtype": "Currency"}) }}</td>
                <td class="amount-col">{{ frappe.format(alloc.vat_rate, {"fieldtype": "Percent"}) if alloc.vat_rate else "0%" }}</td>
                <td class="amount-col">{{ frappe.format(alloc.planned_amount_gross, {"fieldtype": "Currency"}) }}</td>
                <td>{{ alloc.notes or "" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="totals">
        <table>
            <tr>
                <td class="total-label">{{ _("Total Planned Net") }}:</td>
                <td class="total-amount">{{ frappe.format(doc.allocations | sum(attribute='planned_amount_net'), {"fieldtype": "Currency"}) }}</td>
            </tr>
            <tr>
                <td class="total-label">{{ _("Total VAT") }}:</td>
                <td class="total-amount">{{ frappe.format(doc.allocations | sum(attribute='planned_amount_vat'), {"fieldtype": "Currency"}) }}</td>
            </tr>
            <tr class="grand-total">
                <td class="total-label">{{ _("Total Gross") }}:</td>
                <td class="total-amount">{{ frappe.format(doc.allocations | sum(attribute='planned_amount_gross'), {"fieldtype": "Currency"}) }}</td>
            </tr>
        </table>
    </div>
    {% endif %}

    {% if doc.quotes %}
    <h3 class="section-heading" style="clear: both;">{{ _("Vendor Quotes") }}</h3>
    <table class="table">
        <thead>
            <tr>
                <th style="width: 5%;">#</th>
                <th style="width: 20%;">{{ _("Vendor") }}</th>
                <th style="width: 15%;">{{ _("Quote Date") }}</th>
                <th class="amount-col" style="width: 15%;">{{ _("Net Amount") }}</th>
                <th class="amount-col" style="width: 10%;">{{ _("VAT %") }}</th>
                <th class="amount-col" style="width: 15%;">{{ _("Gross Amount") }}</th>
                <th style="width: 20%;">{{ _("Notes") }}</th>
            </tr>
        </thead>
        <tbody>
            {% for quote in doc.quotes %}
            <tr>
                <td>{{ quote.idx }}</td>
                <td>{{ quote.vendor }}</td>
                <td>{{ frappe.format(quote.quote_date, {"fieldtype": "Date"}) if quote.quote_date else "" }}</td>
                <td class="amount-col">{{ frappe.format(quote.amount_net, {"fieldtype": "Currency"}) }}</td>
                <td class="amount-col">{{ frappe.format(quote.vat_rate, {"fieldtype": "Percent"}) if quote.vat_rate else "0%" }}</td>
                <td class="amount-col">{{ frappe.format(quote.amount_gross, {"fieldtype": "Currency"}) }}</td>
                <td>{{ quote.notes or "" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="totals">
        <table>
            <tr class="grand-total">
                <td class="total-label">{{ _("Total Quotes Gross") }}:</td>
                <td class="total-amount">{{ frappe.format(doc.quotes | sum(attribute='amount_gross'), {"fieldtype": "Currency"}) }}</td>
            </tr>
        </table>
    </div>
    {% endif %}

    {% if show_attachments %}
    {% set attachments = frappe.get_all("File", filters={"attached_to_doctype": doc.doctype, "attached_to_name": doc.name}, fields=["file_name", "file_url"]) %}
    {% if attachments %}
    <div class="attachments" style="clear: both;">
        <h3>{{ _("Attachments") }}</h3>
        <ul>
            {% for attachment in attachments %}
            <li>{{ attachment.file_name }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}
    {% endif %}

    <div class="footer">
        <p>{{ _("Printed on") }} {{ frappe.utils.now_datetime().strftime("%Y-%m-%d %H:%M") }} {{ _("by") }} {{ frappe.session.user }}</p>
    </div>
</body>
</html>


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/master_plan_it_dashboard/master_plan_it_overview/master_plan_it_overview.json
================================================================================
{
 "cards": [
  {
   "card": "Renewals 30d",
   "width": "Half"
  },
  {
   "card": "Renewals 60d",
   "width": "Half"
  },
  {
   "card": "Renewals 90d",
   "width": "Half"
  },
  {
   "card": "Expired Contracts",
   "width": "Half"
  }
 ],
 "charts": [
  {
   "chart": "MPIT Current Budget vs Actual",
   "width": "Half"
  },
  {
   "chart": "MPIT Budget vs Actual (Approved)",
   "width": "Half"
  },
  {
   "chart": "MPIT Projects Planned vs Actual",
   "width": "Half"
  },
  {
   "chart": "MPIT Renewals by Month",
   "width": "Half"
  }
 ],
 "creation": "2025-12-24 20:00:26.109603",
 "dashboard_name": "Master Plan IT Overview",
 "docstatus": 0,
 "doctype": "Dashboard",
 "idx": 0,
 "is_default": 0,
 "is_standard": 1,
 "modified": "2025-12-24 20:00:26.109603",
 "modified_by": "Administrator",
 "module": "Master Plan IT",
 "name": "Master Plan IT Overview",
 "owner": "Administrator"
}


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/__init__.py
================================================================================


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/dashboard_chart/mpit_current_budget_vs_actual/__init__.py
================================================================================


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/dashboard_chart/mpit_current_budget_vs_actual/mpit_current_budget_vs_actual.json
================================================================================
{
 "chart_name": "MPIT Current Budget vs Actual",
 "chart_type": "Report",
 "creation": "2025-12-21 19:25:35.300409",
 "currency": "EUR",
 "docstatus": 0,
 "doctype": "Dashboard Chart",
 "filters_json": "{}",
 "group_by_type": "Count",
 "idx": 0,
 "is_public": 0,
 "is_standard": 1,
 "modified": "2025-12-22 20:53:26.756441",
 "modified_by": "Administrator",
 "module": "Master Plan IT",
 "name": "MPIT Current Budget vs Actual",
 "number_of_groups": 0,
 "owner": "Administrator",
 "report_name": "MPIT Current Budget vs Actual",
 "roles": [],
 "show_values_over_chart": 0,
 "time_interval": "Yearly",
 "timeseries": 0,
 "timespan": "Last Year",
 "type": "Line",
 "use_report_chart": 1,
 "y_axis": []
}

================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/dashboard_chart/mpit_projects_planned_vs_actual/__init__.py
================================================================================


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/dashboard_chart/mpit_projects_planned_vs_actual/mpit_projects_planned_vs_actual.json
================================================================================
{
 "chart_name": "MPIT Projects Planned vs Actual",
 "chart_type": "Report",
 "creation": "2025-12-24 20:00:26.430915",
 "currency": "EUR",
 "docstatus": 0,
 "doctype": "Dashboard Chart",
 "filters_json": "{}",
 "group_by_type": "Count",
 "idx": 0,
 "is_public": 0,
 "is_standard": 1,
 "modified": "2025-12-24 20:00:26.663537",
 "modified_by": "Administrator",
 "module": "Master Plan IT",
 "name": "MPIT Projects Planned vs Actual",
 "number_of_groups": 0,
 "owner": "Administrator",
 "report_name": "MPIT Projects Planned vs Actual",
 "roles": [],
 "show_values_over_chart": 0,
 "time_interval": "Yearly",
 "timeseries": 0,
 "timespan": "Last Year",
 "type": "Line",
 "use_report_chart": 1,
 "y_axis": []
}

================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/dashboard_chart/mpit_renewals_by_month/mpit_renewals_by_month.json
================================================================================
{
 "chart_name": "MPIT Renewals by Month",
 "chart_type": "Report",
 "creation": "2025-12-21 19:25:35.339908",
 "currency": "EUR",
 "docstatus": 0,
 "doctype": "Dashboard Chart",
 "filters_json": "{\"days\": 120}",
 "group_by_type": "Count",
 "idx": 0,
 "is_public": 0,
 "is_standard": 1,
 "modified": "2025-12-22 20:53:26.843285",
 "modified_by": "Administrator",
 "module": "Master Plan IT",
 "name": "MPIT Renewals by Month",
 "number_of_groups": 0,
 "owner": "Administrator",
 "report_name": "MPIT Renewals Window",
 "roles": [],
 "show_values_over_chart": 0,
 "time_interval": "Yearly",
 "timeseries": 0,
 "timespan": "Last Year",
 "type": "Line",
 "use_report_chart": 1,
 "y_axis": []
}

================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/dashboard_chart/mpit_renewals_by_month/__init__.py
================================================================================


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/dashboard_chart/__init__.py
================================================================================


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/dashboard_chart/mpit_budget_vs_actual_(approved)/__init__.py
================================================================================


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/dashboard_chart/mpit_budget_vs_actual_(approved)/mpit_budget_vs_actual_(approved).json
================================================================================
{
 "chart_name": "MPIT Budget vs Actual (Approved)",
 "chart_type": "Report",
 "creation": "2025-12-21 19:25:35.283257",
 "currency": "EUR",
 "docstatus": 0,
 "doctype": "Dashboard Chart",
 "filters_json": "{}",
 "group_by_type": "Count",
 "idx": 0,
 "is_public": 0,
 "is_standard": 1,
 "modified": "2025-12-22 20:53:26.711425",
 "modified_by": "Administrator",
 "module": "Master Plan IT",
 "name": "MPIT Budget vs Actual (Approved)",
 "number_of_groups": 0,
 "owner": "Administrator",
 "report_name": "MPIT Approved Budget vs Actual",
 "roles": [],
 "show_values_over_chart": 0,
 "time_interval": "Yearly",
 "timeseries": 0,
 "timespan": "Last Year",
 "type": "Line",
 "use_report_chart": 1,
 "y_axis": []
}

================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/number_card/renewals_90d/__init__.py
================================================================================


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/number_card/renewals_90d/renewals_90d.json
================================================================================
{
 "creation": "2025-12-21 19:25:35.215633",
 "currency": "EUR",
 "docstatus": 0,
 "doctype": "Number Card",
 "filters_json": "{\"days\": 90}",
 "function": "Sum",
 "idx": 0,
 "is_public": 0,
 "is_standard": 1,
 "label": "Renewals 90d",
 "modified": "2025-12-22 20:53:26.660332",
 "modified_by": "Administrator",
 "module": "Master Plan IT",
 "name": "Renewals 90d",
 "owner": "Administrator",
 "report_field": "count",
 "report_function": "Sum",
 "report_name": "MPIT Renewals Window",
 "show_full_number": 0,
 "show_percentage_stats": 0,
 "stats_time_interval": "Daily",
 "type": "Report"
}

================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/number_card/__init__.py
================================================================================


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/number_card/renewals_30d/__init__.py
================================================================================


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/number_card/renewals_30d/renewals_30d.json
================================================================================
{
 "creation": "2025-12-21 19:25:35.149010",
 "currency": "EUR",
 "docstatus": 0,
 "doctype": "Number Card",
 "filters_json": "{\"days\": 30}",
 "function": "Sum",
 "idx": 0,
 "is_public": 0,
 "is_standard": 1,
 "label": "Renewals 30d",
 "modified": "2025-12-22 20:53:26.606754",
 "modified_by": "Administrator",
 "module": "Master Plan IT",
 "name": "Renewals 30d",
 "owner": "Administrator",
 "report_field": "count",
 "report_function": "Sum",
 "report_name": "MPIT Renewals Window",
 "show_full_number": 0,
 "show_percentage_stats": 0,
 "stats_time_interval": "Daily",
 "type": "Report"
}

================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/number_card/renewals_60d/__init__.py
================================================================================


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/number_card/renewals_60d/renewals_60d.json
================================================================================
{
 "creation": "2025-12-21 19:25:35.178466",
 "currency": "EUR",
 "docstatus": 0,
 "doctype": "Number Card",
 "filters_json": "{\"days\": 60}",
 "function": "Sum",
 "idx": 0,
 "is_public": 0,
 "is_standard": 1,
 "label": "Renewals 60d",
 "modified": "2025-12-22 20:53:26.627362",
 "modified_by": "Administrator",
 "module": "Master Plan IT",
 "name": "Renewals 60d",
 "owner": "Administrator",
 "report_field": "count",
 "report_function": "Sum",
 "report_name": "MPIT Renewals Window",
 "show_full_number": 0,
 "show_percentage_stats": 0,
 "stats_time_interval": "Daily",
 "type": "Report"
}

================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/number_card/expired_contracts/__init__.py
================================================================================


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/number_card/expired_contracts/expired_contracts.json
================================================================================
{
 "creation": "2025-12-21 19:25:35.134837",
 "currency": "EUR",
 "docstatus": 0,
 "doctype": "Number Card",
 "filters_json": "{\"include_past\": 1}",
 "function": "Sum",
 "idx": 0,
 "is_public": 0,
 "is_standard": 1,
 "label": "Expired Contracts",
 "modified": "2025-12-22 20:53:26.583881",
 "modified_by": "Administrator",
 "module": "Master Plan IT",
 "name": "Expired Contracts",
 "owner": "Administrator",
 "report_field": "expired_count",
 "report_function": "Sum",
 "report_name": "MPIT Renewals Window",
 "show_full_number": 0,
 "show_percentage_stats": 0,
 "stats_time_interval": "Daily",
 "type": "Report"
}

================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/dashboard/__init__.py
================================================================================


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/dashboard/master_plan_it_overview/master_plan_it_overview.json
================================================================================
{
 "cards": [
  {
   "card": "Renewals 30d",
   "width": "Half"
  },
  {
   "card": "Renewals 60d",
   "width": "Half"
  },
  {
   "card": "Renewals 90d",
   "width": "Half"
  },
  {
   "card": "Expired Contracts",
   "width": "Half"
  }
 ],
 "charts": [
  {
   "chart": "MPIT Current Budget vs Actual",
   "width": "Half"
  },
  {
   "chart": "MPIT Budget vs Actual (Approved)",
   "width": "Half"
  },
  {
   "chart": "MPIT Projects Planned vs Actual",
   "width": "Half"
  },
  {
   "chart": "MPIT Renewals by Month",
   "width": "Half"
  }
 ],
 "creation": "2025-12-24 20:00:26.295380",
 "dashboard_name": "Master Plan IT Overview",
 "docstatus": 0,
 "doctype": "Dashboard",
 "idx": 0,
 "is_default": 0,
 "is_standard": 1,
 "modified": "2025-12-24 20:00:26.629107",
 "modified_by": "Administrator",
 "module": "Master Plan IT",
 "name": "Master Plan IT Overview",
 "owner": "Administrator"
}


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/dashboard/master_plan_it_overview/__init__.py
================================================================================


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/workflow/__init__.py
================================================================================


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/workspace/master_plan_it/master_plan_it.json
================================================================================
[
 {
  "charts": [
   {
    "chart_name": "MPIT Current Budget vs Actual",
    "label": "MPIT Current Budget vs Actual",
    "parent": "Master Plan IT",
    "parentfield": "charts",
    "parenttype": "Workspace"
   },
   {
    "chart_name": "MPIT Projects Planned vs Actual",
    "label": "MPIT Projects Planned vs Actual",
    "parent": "Master Plan IT",
    "parentfield": "charts",
    "parenttype": "Workspace"
   },
   {
    "chart_name": "MPIT Budget vs Actual (Approved)",
    "label": "MPIT Budget vs Actual (Approved)",
    "parent": "Master Plan IT",
    "parentfield": "charts",
    "parenttype": "Workspace"
   },
   {
    "chart_name": "MPIT Renewals by Month",
    "label": "MPIT Renewals by Month",
    "parent": "Master Plan IT",
    "parentfield": "charts",
    "parenttype": "Workspace"
   }
  ],
  "content": "[{\"type\": \"header\",\"data\": {\"text\": \"<span class=\\\"h4\\\">Master Plan IT</span>\",\"col\": 12}},{\"type\": \"header\",\"data\": {\"text\": \"<span class=\\\"text-muted\\\">Gestione budget, progetti, contratti e fornitori</span>\",\"col\": 12}},{\"type\": \"spacer\",\"data\": {\"col\": 12}},{\"type\": \"header\",\"data\": {\"text\": \"Quick Actions\",\"col\": 12}},{\"type\": \"shortcut\",\"data\": {\"shortcut_name\": \"Overview Dashboard\",\"col\": 3}},{\"type\": \"shortcut\",\"data\": {\"shortcut_name\": \"Budgets\",\"col\": 3}},{\"type\": \"shortcut\",\"data\": {\"shortcut_name\": \"Actual Entries\",\"col\": 3}},{\"type\": \"shortcut\",\"data\": {\"shortcut_name\": \"Budget Amendments\",\"col\": 3}},{\"type\": \"shortcut\",\"data\": {\"shortcut_name\": \"Projects\",\"col\": 3}},{\"type\": \"spacer\",\"data\": {\"col\": 12}},{\"type\": \"header\",\"data\": {\"text\": \"Setup & Planning\",\"col\": 12}},{\"type\": \"card\",\"data\": {\"card_name\": \"Setup\",\"col\": 6}},{\"type\": \"card\",\"data\": {\"card_name\": \"Planning\",\"col\": 6}},{\"type\": \"spacer\",\"data\": {\"col\": 12}},{\"type\": \"header\",\"data\": {\"text\": \"Insights\",\"col\": 12}},{\"type\": \"chart\",\"data\": {\"chart_name\": \"MPIT Current Budget vs Actual\",\"col\": 6}},{\"type\": \"chart\",\"data\": {\"chart_name\": \"MPIT Projects Planned vs Actual\",\"col\": 6}},{\"type\": \"chart\",\"data\": {\"chart_name\": \"MPIT Budget vs Actual (Approved)\",\"col\": 6}},{\"type\": \"chart\",\"data\": {\"chart_name\": \"MPIT Renewals by Month\",\"col\": 6}},{\"type\": \"spacer\",\"data\": {\"col\": 12}},{\"type\": \"header\",\"data\": {\"text\": \"More\",\"col\": 12}},{\"type\": \"shortcut\",\"data\": {\"shortcut_name\": \"Contracts\",\"col\": 3}},{\"type\": \"shortcut\",\"data\": {\"shortcut_name\": \"Vendors\",\"col\": 3}},{\"type\": \"shortcut\",\"data\": {\"shortcut_name\": \"Categories\",\"col\": 3}},{\"type\": \"shortcut\",\"data\": {\"shortcut_name\": \"Baseline Expense\",\"col\": 3}},{\"type\": \"shortcut\",\"data\": {\"shortcut_name\": \"User Preferences\",\"col\": 3}}]",
  "custom_blocks": [],
  "docstatus": 0,
  "doctype": "Workspace",
  "for_user": null,
  "hide_custom": 0,
  "icon": null,
  "indicator_color": "green",
  "is_hidden": 0,
  "label": "Master Plan IT",
  "links": [
   {
    "dependencies": null,
    "description": null,
    "hidden": 0,
    "icon": null,
    "is_query_report": 0,
    "label": "Setup",
    "link_count": 0,
    "link_to": null,
    "link_type": "DocType",
    "onboard": 0,
    "only_for": null,
    "parent": "Master Plan IT",
    "parentfield": "links",
    "parenttype": "Workspace",
    "report_ref_doctype": null,
    "type": "Card Break"
   },
   {
    "dependencies": "",
    "description": null,
    "hidden": 0,
    "icon": null,
    "is_query_report": 0,
    "label": "Categories",
    "link_count": 0,
    "link_to": "MPIT Category",
    "link_type": "DocType",
    "onboard": 0,
    "only_for": null,
    "parent": "Master Plan IT",
    "parentfield": "links",
    "parenttype": "Workspace",
    "report_ref_doctype": null,
    "type": "Link"
   },
   {
    "dependencies": "",
    "description": null,
    "hidden": 0,
    "icon": null,
    "is_query_report": 0,
    "label": "Vendors",
    "link_count": 0,
    "link_to": "MPIT Vendor",
    "link_type": "DocType",
    "onboard": 0,
    "only_for": null,
    "parent": "Master Plan IT",
    "parentfield": "links",
    "parenttype": "Workspace",
    "report_ref_doctype": null,
    "type": "Link"
   },
   {
    "dependencies": "",
    "description": null,
    "hidden": 0,
    "icon": null,
    "is_query_report": 0,
    "label": "Contracts",
    "link_count": 0,
    "link_to": "MPIT Contract",
    "link_type": "DocType",
    "onboard": 0,
    "only_for": null,
    "parent": "Master Plan IT",
    "parentfield": "links",
    "parenttype": "Workspace",
    "report_ref_doctype": null,
    "type": "Link"
   },
   {
    "dependencies": "",
    "description": null,
    "hidden": 0,
    "icon": null,
    "is_query_report": 0,
    "label": "User Preferences",
    "link_count": 0,
    "link_to": "MPIT User Preferences",
    "link_type": "DocType",
    "onboard": 0,
    "only_for": null,
    "parent": "Master Plan IT",
    "parentfield": "links",
    "parenttype": "Workspace",
    "report_ref_doctype": null,
    "type": "Link"
   },
   {
    "dependencies": null,
    "description": null,
    "hidden": 0,
    "icon": null,
    "is_query_report": 0,
    "label": "Planning",
    "link_count": 0,
    "link_to": null,
    "link_type": "DocType",
    "onboard": 0,
    "only_for": null,
    "parent": "Master Plan IT",
    "parentfield": "links",
    "parenttype": "Workspace",
    "report_ref_doctype": null,
    "type": "Card Break"
   },
   {
    "dependencies": "",
    "description": null,
    "hidden": 0,
    "icon": null,
    "is_query_report": 0,
    "label": "Budgets",
    "link_count": 0,
    "link_to": "MPIT Budget",
    "link_type": "DocType",
    "onboard": 0,
    "only_for": null,
    "parent": "Master Plan IT",
    "parentfield": "links",
    "parenttype": "Workspace",
    "report_ref_doctype": null,
    "type": "Link"
   },
   {
    "dependencies": "",
    "description": null,
    "hidden": 0,
    "icon": null,
    "is_query_report": 0,
    "label": "Projects",
    "link_count": 0,
    "link_to": "MPIT Project",
    "link_type": "DocType",
    "onboard": 0,
    "only_for": null,
    "parent": "Master Plan IT",
    "parentfield": "links",
    "parenttype": "Workspace",
    "report_ref_doctype": null,
    "type": "Link"
   },
   {
    "dependencies": "",
    "description": null,
    "hidden": 0,
    "icon": null,
    "is_query_report": 0,
    "label": "Actual Entries",
    "link_count": 0,
    "link_to": "MPIT Actual Entry",
    "link_type": "DocType",
    "onboard": 0,
    "only_for": null,
    "parent": "Master Plan IT",
    "parentfield": "links",
    "parenttype": "Workspace",
    "report_ref_doctype": null,
    "type": "Link"
   },
   {
    "dependencies": "",
    "description": null,
    "hidden": 0,
    "icon": null,
    "is_query_report": 0,
    "label": "Budget Amendments",
    "link_count": 0,
    "link_to": "MPIT Budget Amendment",
    "link_type": "DocType",
    "onboard": 0,
    "only_for": null,
    "parent": "Master Plan IT",
    "parentfield": "links",
    "parenttype": "Workspace",
    "report_ref_doctype": null,
    "type": "Link"
   },
   {
    "dependencies": "",
    "description": null,
    "hidden": 0,
    "icon": null,
    "is_query_report": 0,
    "label": "Baseline Expense",
    "link_count": 0,
    "link_to": "MPIT Baseline Expense",
    "link_type": "DocType",
    "onboard": 0,
    "only_for": null,
    "parent": "Master Plan IT",
    "parentfield": "links",
    "parenttype": "Workspace",
    "report_ref_doctype": null,
    "type": "Link"
   }
  ],
  "modified": "2025-12-22 12:42:17.589769",
  "module": "Master Plan IT",
  "name": "Master Plan IT",
  "number_cards": [],
  "parent_page": null,
  "public": 1,
  "quick_lists": [],
  "restrict_to_domain": null,
  "roles": [
   {
    "parent": "Master Plan IT",
    "parentfield": "roles",
    "parenttype": "Workspace",
    "role": "vCIO Manager"
   },
   {
    "parent": "Master Plan IT",
    "parentfield": "roles",
    "parenttype": "Workspace",
    "role": "Client Editor"
   },
   {
    "parent": "Master Plan IT",
    "parentfield": "roles",
    "parenttype": "Workspace",
    "role": "Client Viewer"
   },
   {
    "parent": "Master Plan IT",
    "parentfield": "roles",
    "parenttype": "Workspace",
    "role": "System Manager"
   }
  ],
  "sequence_id": 0.0,
  "shortcuts": [
   {
    "color": "Grey",
    "doc_view": "",
    "format": null,
    "icon": "dashboard",
    "kanban_board": null,
    "label": "Overview Dashboard",
    "link_to": null,
    "parent": "Master Plan IT",
    "parentfield": "shortcuts",
    "parenttype": "Workspace",
    "report_ref_doctype": null,
    "restrict_to_domain": null,
    "stats_filter": null,
    "type": "URL",
    "url": "/app/dashboard-view/Master%20Plan%20IT%20Overview"
   },
   {
    "color": null,
    "doc_view": "",
    "format": null,
    "icon": null,
    "kanban_board": null,
    "label": "Budgets",
    "link_to": "MPIT Budget",
    "parent": "Master Plan IT",
    "parentfield": "shortcuts",
    "parenttype": "Workspace",
    "report_ref_doctype": null,
    "restrict_to_domain": null,
    "stats_filter": null,
    "type": "DocType",
    "url": null
   },
   {
    "color": null,
    "doc_view": "",
    "format": null,
    "icon": null,
    "kanban_board": null,
    "label": "Actual Entries",
    "link_to": "MPIT Actual Entry",
    "parent": "Master Plan IT",
    "parentfield": "shortcuts",
    "parenttype": "Workspace",
    "report_ref_doctype": null,
    "restrict_to_domain": null,
    "stats_filter": null,
    "type": "DocType",
    "url": null
   },
   {
    "color": null,
    "doc_view": "",
    "format": null,
    "icon": null,
    "kanban_board": null,
    "label": "Budget Amendments",
    "link_to": "MPIT Budget Amendment",
    "parent": "Master Plan IT",
    "parentfield": "shortcuts",
    "parenttype": "Workspace",
    "report_ref_doctype": null,
    "restrict_to_domain": null,
    "stats_filter": null,
    "type": "DocType",
    "url": null
   },
   {
    "color": null,
    "doc_view": "",
    "format": null,
    "icon": null,
    "kanban_board": null,
    "label": "Projects",
    "link_to": "MPIT Project",
    "parent": "Master Plan IT",
    "parentfield": "shortcuts",
    "parenttype": "Workspace",
    "report_ref_doctype": null,
    "restrict_to_domain": null,
    "stats_filter": null,
    "type": "DocType",
    "url": null
   },
   {
    "color": null,
    "doc_view": "",
    "format": null,
    "icon": null,
    "kanban_board": null,
    "label": "Contracts",
    "link_to": "MPIT Contract",
    "parent": "Master Plan IT",
    "parentfield": "shortcuts",
    "parenttype": "Workspace",
    "report_ref_doctype": null,
    "restrict_to_domain": null,
    "stats_filter": null,
    "type": "DocType",
    "url": null
   },
   {
    "color": null,
    "doc_view": "",
    "format": null,
    "icon": null,
    "kanban_board": null,
    "label": "Vendors",
    "link_to": "MPIT Vendor",
    "parent": "Master Plan IT",
    "parentfield": "shortcuts",
    "parenttype": "Workspace",
    "report_ref_doctype": null,
    "restrict_to_domain": null,
    "stats_filter": null,
    "type": "DocType",
    "url": null
   },
   {
    "color": null,
    "doc_view": "",
    "format": null,
    "icon": null,
    "kanban_board": null,
    "label": "Categories",
    "link_to": "MPIT Category",
    "parent": "Master Plan IT",
    "parentfield": "shortcuts",
    "parenttype": "Workspace",
    "report_ref_doctype": null,
    "restrict_to_domain": null,
    "stats_filter": null,
    "type": "DocType",
    "url": null
   },
   {
    "color": null,
    "doc_view": "",
    "format": null,
    "icon": null,
    "kanban_board": null,
    "label": "Baseline Expense",
    "link_to": "MPIT Baseline Expense",
    "parent": "Master Plan IT",
    "parentfield": "shortcuts",
    "parenttype": "Workspace",
    "report_ref_doctype": null,
    "restrict_to_domain": null,
    "stats_filter": null,
    "type": "DocType",
    "url": null
   },
   {
    "color": null,
    "doc_view": "",
    "format": null,
    "icon": null,
    "kanban_board": null,
    "label": "User Preferences",
    "link_to": "MPIT User Preferences",
    "parent": "Master Plan IT",
    "parentfield": "shortcuts",
    "parenttype": "Workspace",
    "report_ref_doctype": null,
    "restrict_to_domain": null,
    "stats_filter": null,
    "type": "DocType",
    "url": null
   }
  ],
  "title": "Master Plan IT"
 }
]

================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_year/mpit_year.js
================================================================================
// Copyright (c) 2025, DOT and contributors
// For license information, please see license.txt

// frappe.ui.form.on("MPIT Year", {
// 	refresh(frm) {

// 	},
// });


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_year/mpit_year.py
================================================================================
# Copyright (c) 2025, DOT and contributors
# For license information, please see license.txt

# import frappe
from frappe.model.document import Document


class MPITYear(Document):
	pass


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_year/test_mpit_year.py
================================================================================
# Copyright (c) 2025, DOT and Contributors
# See license.txt

# import frappe
from frappe.tests.utils import FrappeTestCase


class TestMPITYear(FrappeTestCase):
	pass


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_year/__init__.py
================================================================================


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_year/mpit_year.json
================================================================================
{
 "actions": [],
 "allow_import": 1,
 "allow_rename": 1,
 "autoname": "field:year",
 "creation": "2025-12-21 22:34:31.297099",
 "doctype": "DocType",
 "editable_grid": 1,
 "engine": "InnoDB",
 "field_order": [
  "year",
  "start_date",
  "end_date",
  "is_active"
 ],
 "fields": [
  {
   "fieldname": "year",
   "fieldtype": "Int",
   "description": "Enter the year identifier (e.g. 2025).",
   "in_list_view": 1,
   "label": "Year",
   "reqd": 1,
   "unique": 1
  },
  {
   "fieldname": "start_date",
   "fieldtype": "Date",
   "description": "Date when the year period starts.",
   "label": "Start Date"
  },
  {
   "fieldname": "end_date",
   "fieldtype": "Date",
   "description": "Date when the year period ends.",
   "label": "End Date"
  },
  {
   "default": "1",
   "fieldname": "is_active",
   "fieldtype": "Check",
   "description": "If enabled, the year is active for planning.",
   "label": "Is Active"
  }
 ],
 "grid_page_length": 50,
 "index_web_pages_for_search": 1,
 "links": [],
 "modified": "2025-12-24 20:00:42.279120",
 "modified_by": "Administrator",
 "module": "Master Plan IT",
 "name": "MPIT Year",
 "owner": "Administrator",
 "permissions": [
  {
   "create": 1,
   "delete": 1,
   "email": 1,
   "import": 1,
   "export": 1,
   "print": 1,
   "read": 1,
   "report": 1,
   "role": "System Manager",
   "share": 1,
   "write": 1
  },
  {
   "create": 1,
   "delete": 1,
   "email": 1,
   "import": 1,
   "export": 1,
   "print": 1,
   "read": 1,
   "report": 1,
   "role": "vCIO Manager",
   "share": 1,
   "write": 1
  },
  {
   "email": 1,
   "export": 1,
   "print": 1,
   "read": 1,
   "report": 1,
   "role": "Client Editor",
   "share": 1
  },
  {
   "email": 1,
   "export": 1,
   "print": 1,
   "read": 1,
   "report": 1,
   "role": "Client Viewer",
   "share": 1
  }
 ],
 "row_format": "Dynamic",
 "rows_threshold_for_grid_search": 20,
 "sort_field": "modified",
 "sort_order": "DESC",
 "states": [],
 "title_field": "year",
 "track_changes": 1
}


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_baseline_expense/mpit_baseline_expense.py
================================================================================
# Copyright (c) 2025, DOT and contributors
# For license information, please see license.txt

from __future__ import annotations

import frappe
from frappe.model.document import Document
from master_plan_it import annualization, mpit_user_prefs, tax


class MPITBaselineExpense(Document):
	def validate(self):
		self._compute_vat_split()
		self._compute_annualization()
	
	def _compute_vat_split(self):
		"""Compute net/vat/gross for amount field with strict VAT validation."""
		# Get user default VAT rate
		default_vat = mpit_user_prefs.get_default_vat_rate(frappe.session.user)
		
		# Apply default if field is empty
		if self.vat_rate is None and default_vat is not None:
			self.vat_rate = default_vat
		
		# Strict VAT validation
		final_vat_rate = tax.validate_strict_vat(
			self.amount,
			self.vat_rate,
			default_vat,
			field_label=frappe._("Amount")
		)
		
		# Compute split
		net, vat, gross = tax.split_net_vat_gross(
			self.amount,
			final_vat_rate,
			bool(self.amount_includes_vat)
		)
		
		self.amount_net = net
		self.amount_vat = vat
		self.amount_gross = gross
	
	def _compute_annualization(self):
		"""Compute annual amounts based on recurrence rule and overlap with fiscal year."""
		# Validate recurrence rule consistency
		annualization.validate_recurrence_rule(
			self.recurrence_rule,
			self.custom_period_months
		)
		
		# Get fiscal year bounds
		year_start, year_end = annualization.get_year_bounds(self.year)
		
		# Calculate overlap months
		if self.period_start_date and self.period_end_date:
			overlap_months_count = annualization.overlap_months(
				self.period_start_date,
				self.period_end_date,
				year_start,
				year_end
			)
		else:
			# No period specified: treat as full year overlap
			overlap_months_count = 12
		
		# Rule A: Block save if zero overlap
		if self.period_start_date and self.period_end_date and overlap_months_count == 0:
			frappe.throw(
				frappe._(
					"Baseline Expense period ({0} to {1}) has zero overlap with fiscal year {2}. Cannot save baseline expense with no temporal overlap."
				).format(self.period_start_date, self.period_end_date, self.year)
			)
		
		# Calculate annualized amounts
		annual_net = annualization.annualize(
			self.amount_net,
			self.recurrence_rule or "None",
			self.custom_period_months,
			overlap_months_count
		)
		
		# Annual VAT and gross
		if self.vat_rate and annual_net:
			vat_rate_decimal = self.vat_rate / 100.0
			annual_vat = annual_net * vat_rate_decimal
			annual_gross = annual_net + annual_vat
		else:
			annual_vat = 0.0
			annual_gross = annual_net
		
		self.annual_net = annual_net
		self.annual_vat = annual_vat
		self.annual_gross = annual_gross


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_baseline_expense/mpit_baseline_expense.js
================================================================================
frappe.provide("master_plan_it.baseline_vat");

// Idempotent helpers (avoid duplicate declarations if script reloads)
if (!master_plan_it.baseline_vat.fetchDefaults) {
	master_plan_it.baseline_vat.fetchDefaults = () => {
		if (!master_plan_it.baseline_vat._promise) {
			master_plan_it.baseline_vat._promise = frappe
				.call({ method: "master_plan_it.mpit_user_prefs.get_vat_defaults" })
				.then((r) => r.message || {});
		}
		return master_plan_it.baseline_vat._promise;
	};
}

const applyVatDefaultsToBaseline = async (frm) => {
	// Apply only for new docs and only once per form load
	if (!frm.is_new() || frm.doc.__vat_defaults_applied) {
		return;
	}

	const defaults = await master_plan_it.baseline_vat.fetchDefaults();
	const updates = {};

	const includesUnset =
		frm.doc.amount_includes_vat === undefined ||
		frm.doc.amount_includes_vat === null;
	if (
		defaults.default_includes_vat !== undefined &&
		defaults.default_includes_vat !== null &&
		includesUnset
	) {
		updates.amount_includes_vat = defaults.default_includes_vat ? 1 : 0;
	}

	const vatUnset =
		frm.doc.vat_rate === undefined ||
		frm.doc.vat_rate === null ||
		frm.doc.vat_rate === "";
	if ((defaults.default_vat_rate || defaults.default_vat_rate === 0) && vatUnset) {
		updates.vat_rate = defaults.default_vat_rate;
	}

	if (Object.keys(updates).length) {
		await frm.set_value(updates);
	}

	frm.doc.__vat_defaults_applied = true;
};

frappe.ui.form.on("MPIT Baseline Expense", {
	async onload(frm) {
		await applyVatDefaultsToBaseline(frm);
	},
	async refresh(frm) {
		await applyVatDefaultsToBaseline(frm);
	},
});


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_baseline_expense/__init__.py
================================================================================


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_baseline_expense/test_mpit_baseline_expense.py
================================================================================
# Copyright (c) 2025, DOT and Contributors
# See license.txt

# import frappe
from frappe.tests.utils import FrappeTestCase


class TestMPITBaselineExpense(FrappeTestCase):
	pass


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_baseline_expense/mpit_baseline_expense.json
================================================================================
{
 "actions": [],
 "allow_import": 1,
 "allow_rename": 1,
 "creation": "2025-12-21 22:34:31.628128",
 "doctype": "DocType",
 "editable_grid": 1,
 "engine": "InnoDB",
 "field_order": [
  "section_base",
  "year",
  "posting_date",
  "column_break_base",
  "status",
  "expense_kind",
  "section_details",
  "category",
  "vendor",
  "description",
  "section_amounts",
  "amount",
  "amount_includes_vat",
  "vat_rate",
  "amount_col_break",
  "amount_net",
  "amount_vat",
  "amount_gross",
  "section_recurrence",
  "recurrence_rule",
  "custom_period_months",
  "recurrence_column_break",
  "period_start_date",
  "period_end_date",
  "section_contract",
  "contract_start",
  "contract_end",
  "contract_column_break",
  "auto_renew",
  "notice_days",
  "section_annualization",
  "annual_net",
  "annual_vat",
  "annual_gross"
 ],
 "fields": [
  {
   "fieldname": "section_base",
   "fieldtype": "Section Break",
   "label": "Base"
  },
  {
   "fieldname": "year",
   "fieldtype": "Link",
   "description": "Select the year this expense belongs to.",
   "in_list_view": 1,
   "label": "Year",
   "options": "MPIT Year",
   "reqd": 1
  },
  {
   "default": "Today",
   "fieldname": "posting_date",
   "fieldtype": "Date",
   "description": "Date when the baseline expense is recorded.",
   "in_list_view": 1,
   "label": "Posting Date"
  },
  {
   "fieldname": "column_break_base",
   "fieldtype": "Column Break"
  },
  {
   "default": "In Review",
   "fieldname": "status",
   "fieldtype": "Select",
   "description": "Current review status of this expense.",
   "in_list_view": 1,
   "label": "Status",
   "options": "In Review\nNeeds Clarification\nValidated\nArchived"
  },
  {
   "fieldname": "expense_kind",
   "fieldtype": "Select",
   "description": "Choose the expense kind (one-off, subscription, renewal, or contract).",
   "label": "Expense Kind",
   "options": "One-off\nSubscription\nAnnual Renewal\nContract"
  },
  {
   "fieldname": "section_details",
   "fieldtype": "Section Break",
   "label": "Dettagli"
  },
  {
   "fieldname": "category",
   "fieldtype": "Link",
   "description": "Select the expense category.",
   "in_list_view": 1,
   "label": "Category",
   "options": "MPIT Category",
   "reqd": 1
  },
  {
   "fieldname": "vendor",
   "fieldtype": "Link",
   "description": "Select the vendor for this expense.",
   "in_list_view": 1,
   "label": "Vendor",
   "options": "MPIT Vendor"
  },
  {
   "fieldname": "description",
   "fieldtype": "Small Text",
   "description": "Describe the baseline expense.",
   "label": "Description"
  },
  {
   "fieldname": "section_amounts",
   "fieldtype": "Section Break",
   "label": "Importo & IVA"
  },
  {
   "fieldname": "amount",
   "fieldtype": "Currency",
   "description": "Enter the expense amount; use net or gross per the VAT setting.",
   "in_list_view": 1,
   "label": "Amount",
   "reqd": 1
  },
  {
   "default": "0",
   "fieldname": "amount_includes_vat",
   "fieldtype": "Check",
   "description": "If enabled, the amount includes VAT.",
   "label": "Amount Includes VAT"
  },
  {
   "fieldname": "vat_rate",
   "fieldtype": "Percent",
   "description": "VAT rate applied to the amount.",
   "label": "VAT Rate",
   "precision": "2"
  },
  {
   "fieldname": "amount_col_break",
   "fieldtype": "Column Break"
  },
  {
   "fieldname": "amount_net",
   "fieldtype": "Currency",
   "description": "Calculated automatically from amount and VAT settings.",
   "label": "Net Amount",
   "read_only": 1
  },
  {
   "fieldname": "amount_vat",
   "fieldtype": "Currency",
   "description": "Calculated automatically as the VAT portion.",
   "label": "VAT Amount",
   "read_only": 1
  },
  {
   "fieldname": "amount_gross",
   "fieldtype": "Currency",
   "description": "Calculated automatically as the gross amount.",
   "label": "Gross Amount",
   "read_only": 1
  },
  {
   "collapsible": 1,
   "depends_on": "eval:doc.expense_kind && doc.expense_kind!=\"One-off\"",
   "fieldname": "section_recurrence",
   "fieldtype": "Section Break",
   "label": "Ricorrenza"
  },
  {
   "default": "None",
   "fieldname": "recurrence_rule",
   "fieldtype": "Select",
   "description": "Choose how this expense recurs for annualization.",
   "label": "Recurrence Rule",
   "options": "Monthly\nQuarterly\nAnnual\nCustom\nNone"
  },
  {
   "depends_on": "eval:doc.recurrence_rule=='Custom'",
   "fieldname": "custom_period_months",
   "fieldtype": "Int",
   "description": "Number of months per cycle when using a Custom recurrence.",
   "label": "Custom Period (Months)"
  },
  {
   "fieldname": "recurrence_column_break",
   "fieldtype": "Column Break"
  },
  {
   "fieldname": "period_start_date",
   "fieldtype": "Date",
   "description": "Start date of the period used to calculate overlap with the year.",
   "label": "Period Start Date",
   "depends_on": "eval:doc.recurrence_rule && doc.recurrence_rule!=\"None\""
  },
  {
   "fieldname": "period_end_date",
   "fieldtype": "Date",
   "description": "End date of the period used to calculate overlap with the year.",
   "label": "Period End Date",
   "depends_on": "eval:doc.recurrence_rule && doc.recurrence_rule!=\"None\""
  },
  {
   "collapsible": 1,
   "depends_on": "eval:['Subscription','Annual Renewal','Contract'].includes(doc.expense_kind)",
   "fieldname": "section_contract",
   "fieldtype": "Section Break",
   "label": "Contratto"
  },
  {
   "fieldname": "contract_start",
   "fieldtype": "Date",
   "description": "Contract start date, if relevant.",
   "label": "Contract Start"
  },
  {
   "fieldname": "contract_end",
   "fieldtype": "Date",
   "description": "Contract end date, if relevant.",
   "label": "Contract End"
  },
  {
   "fieldname": "contract_column_break",
   "fieldtype": "Column Break"
  },
  {
   "default": "0",
   "fieldname": "auto_renew",
   "fieldtype": "Check",
   "description": "If enabled, the contract renews automatically.",
   "label": "Auto Renew"
  },
  {
   "fieldname": "notice_days",
   "fieldtype": "Int",
   "description": "Number of notice days required before renewal.",
   "label": "Notice Days",
   "depends_on": "eval:doc.auto_renew"
  },
  {
   "collapsible": 1,
   "fieldname": "section_annualization",
   "fieldtype": "Section Break",
   "label": "Annualizzazione"
  },
  {
   "fieldname": "annual_net",
   "fieldtype": "Currency",
   "description": "Calculated automatically as the annualized net amount.",
   "label": "Annual Net Amount",
   "read_only": 1
  },
  {
   "fieldname": "annual_vat",
   "fieldtype": "Currency",
   "description": "Calculated automatically as the annualized VAT amount.",
   "label": "Annual VAT Amount",
   "read_only": 1
  },
  {
   "fieldname": "annual_gross",
   "fieldtype": "Currency",
   "description": "Calculated automatically as the annualized gross amount.",
   "label": "Annual Gross Amount",
   "read_only": 1
  }
 ],
 "grid_page_length": 50,
 "index_web_pages_for_search": 1,
 "links": [],
 "modified": "2025-12-24 20:00:43.044988",
 "modified_by": "Administrator",
 "module": "Master Plan IT",
 "name": "MPIT Baseline Expense",
 "owner": "Administrator",
 "permissions": [
  {
   "create": 1,
   "delete": 1,
   "email": 1,
   "import": 1,
   "export": 1,
   "print": 1,
   "read": 1,
   "report": 1,
   "role": "System Manager",
   "share": 1,
   "write": 1
  },
  {
   "create": 1,
   "delete": 1,
   "email": 1,
   "import": 1,
   "export": 1,
   "print": 1,
   "read": 1,
   "report": 1,
   "role": "vCIO Manager",
   "share": 1,
   "write": 1
  },
  {
   "create": 1,
   "delete": 1,
   "email": 1,
   "import": 1,
   "export": 1,
   "print": 1,
   "read": 1,
   "report": 1,
   "role": "Client Editor",
   "share": 1,
   "write": 1
  },
  {
   "email": 1,
   "export": 1,
   "print": 1,
   "read": 1,
   "report": 1,
   "role": "Client Viewer",
   "share": 1
  }
 ],
 "row_format": "Dynamic",
 "rows_threshold_for_grid_search": 20,
 "sort_field": "modified",
 "sort_order": "DESC",
 "states": [],
 "track_changes": 1
}


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_project_allocation/mpit_project_allocation.json
================================================================================
{
 "actions": [],
 "allow_rename": 1,
 "creation": "2025-12-21 22:34:32.443897",
 "doctype": "DocType",
 "editable_grid": 1,
 "engine": "InnoDB",
 "field_order": [
  "year",
  "planned_amount",
  "planned_amount_includes_vat",
  "planned_amount_gross",
  "vat_rate",
  "planned_amount_net",
  "planned_amount_vat"
 ],
 "fields": [
  {
   "fieldname": "year",
   "fieldtype": "Link",
   "description": "Select the year for this allocation.",
   "in_list_view": 1,
   "columns": 2,
   "label": "Year",
   "options": "MPIT Year",
   "reqd": 1
  },
  {
   "fieldname": "planned_amount",
   "fieldtype": "Currency",
   "description": "Enter the planned amount for this year.",
   "in_list_view": 1,
   "columns": 2,
   "label": "Planned Amount",
   "reqd": 1
  },
  {
   "default": "0",
   "fieldname": "planned_amount_includes_vat",
   "fieldtype": "Check",
   "description": "If enabled, the planned amount includes VAT.",
   "in_list_view": 1,
   "columns": 1,
   "label": "Planned Amount Includes VAT"
  },
  {
   "fieldname": "vat_rate",
   "fieldtype": "Percent",
   "description": "VAT rate applied to the planned amount.",
   "label": "VAT Rate",
   "precision": "2"
  },
  {
   "fieldname": "planned_amount_net",
   "fieldtype": "Currency",
   "description": "Calculated automatically from planned amount and VAT settings.",
   "label": "Net Planned Amount",
   "read_only": 1
  },
  {
   "fieldname": "planned_amount_vat",
   "fieldtype": "Currency",
   "description": "Calculated automatically as the VAT portion.",
   "label": "VAT Planned Amount",
   "read_only": 1
  },
  {
   "fieldname": "planned_amount_gross",
   "fieldtype": "Currency",
   "description": "Calculated automatically as the gross amount.",
   "in_list_view": 1,
   "columns": 2,
   "label": "Gross Planned Amount",
   "read_only": 1
  }
 ],
 "grid_page_length": 50,
 "index_web_pages_for_search": 1,
 "istable": 1,
 "links": [],
 "modified": "2025-12-24 20:00:44.541276",
 "modified_by": "Administrator",
 "module": "Master Plan IT",
 "name": "MPIT Project Allocation",
 "owner": "Administrator",
 "permissions": [],
 "row_format": "Dynamic",
 "rows_threshold_for_grid_search": 20,
 "sort_field": "modified",
 "sort_order": "DESC",
 "states": [],
 "track_changes": 1
}


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_project_allocation/__init__.py
================================================================================


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_project_allocation/mpit_project_allocation.py
================================================================================
# Copyright (c) 2025, DOT and contributors
# For license information, please see license.txt

# import frappe
from frappe.model.document import Document


class MPITProjectAllocation(Document):
	pass


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_contract/mpit_contract.json
================================================================================
{
 "actions": [],
 "allow_import": 1,
 "allow_rename": 1,
 "autoname": "field:title",
 "creation": "2025-12-21 22:34:32.098018",
 "doctype": "DocType",
 "editable_grid": 1,
 "engine": "InnoDB",
 "field_order": [
  "tb_overview",
  "sb_overview_main",
  "title",
  "vendor",
  "category",
  "contract_kind",
  "cb_overview_right",
  "auto_renew",
  "status",
  "owner_user",
  "tb_billing",
  "billing_cycle",
  "current_amount",
  "current_amount_includes_vat",
  "vat_rate",
  "current_amount_net",
  "current_amount_vat",
  "current_amount_gross",
  "tb_renewal",
  "start_date",
  "end_date",
  "next_renewal_date",
  "notice_days",
  "tb_notes",
  "notes",
  "attachment",
  "tb_admin",
  "source_baseline_expense"
 ],
 "fields": [
  {
   "fieldname": "tb_overview",
   "fieldtype": "Tab Break",
   "label": "Overview"
  },
  {
   "fieldname": "sb_overview_main",
   "fieldtype": "Section Break"
  },
  {
   "fieldname": "title",
   "fieldtype": "Data",
   "description": "Enter the contract title.",
   "in_list_view": 1,
   "label": "Title",
   "reqd": 1,
   "unique": 1
  },
  {
   "fieldname": "vendor",
   "fieldtype": "Link",
   "description": "Select the vendor for this contract.",
   "in_list_view": 1,
   "label": "Vendor",
   "options": "MPIT Vendor",
   "reqd": 1
  },
  {
   "fieldname": "category",
   "fieldtype": "Link",
   "description": "Select the category for this contract.",
   "in_list_view": 1,
   "label": "Category",
   "options": "MPIT Category",
   "reqd": 1
  },
  {
   "fieldname": "contract_kind",
   "fieldtype": "Select",
   "description": "Choose the contract type (contract, subscription, renewal, or maintenance).",
   "label": "Contract Kind",
   "options": "Contract\nSubscription\nAnnual Renewal\nMaintenance",
   "reqd": 1
  },
  {
   "fieldname": "cb_overview_right",
   "fieldtype": "Column Break"
  },
  {
   "default": "1",
   "fieldname": "auto_renew",
   "fieldtype": "Check",
   "description": "If enabled, the contract renews automatically.",
   "label": "Auto Renew"
  },
  {
   "default": "Active",
   "fieldname": "status",
   "fieldtype": "Select",
   "description": "Choose the current contract status.",
   "in_list_view": 1,
   "label": "Status",
   "options": "Draft\nActive\nPending Renewal\nRenewed\nCancelled\nExpired"
  },
  {
   "fieldname": "owner_user",
   "fieldtype": "Link",
   "description": "Select the contract owner.",
   "label": "Owner User",
   "options": "User"
  },
  {
   "fieldname": "tb_billing",
   "fieldtype": "Tab Break",
   "label": "Billing"
  },
  {
   "fieldname": "billing_cycle",
   "fieldtype": "Select",
   "description": "Choose the billing cycle for this contract.",
   "label": "Billing Cycle",
   "options": "Monthly\nQuarterly\nAnnual\nOther"
  },
  {
   "fieldname": "current_amount",
   "fieldtype": "Currency",
   "description": "Enter the current contract amount; use net or gross per the VAT setting.",
   "label": "Current Amount"
  },
  {
   "default": "0",
   "fieldname": "current_amount_includes_vat",
   "fieldtype": "Check",
   "description": "If enabled, the current amount includes VAT.",
   "label": "Current Amount Includes VAT"
  },
  {
   "fieldname": "vat_rate",
   "fieldtype": "Percent",
   "description": "VAT rate applied to the current amount.",
   "label": "VAT Rate",
   "depends_on": "eval:doc.current_amount_includes_vat || doc.current_amount",
   "precision": "2"
  },
  {
   "fieldname": "current_amount_net",
   "fieldtype": "Currency",
   "description": "Calculated automatically from current amount and VAT settings.",
   "label": "Net Amount",
   "read_only": 1
  },
  {
   "fieldname": "current_amount_vat",
   "fieldtype": "Currency",
   "description": "Calculated automatically as the VAT portion.",
   "label": "VAT Amount",
   "read_only": 1
  },
  {
   "fieldname": "current_amount_gross",
   "fieldtype": "Currency",
   "description": "Calculated automatically as the gross amount.",
   "label": "Gross Amount",
   "read_only": 1
  },
  {
   "fieldname": "tb_renewal",
   "fieldtype": "Tab Break",
   "label": "Renewal & Dates"
  },
  {
   "fieldname": "start_date",
   "fieldtype": "Date",
   "description": "Date when the contract starts.",
   "label": "Start Date"
  },
  {
   "fieldname": "end_date",
   "fieldtype": "Date",
   "description": "Date when the contract ends.",
   "label": "End Date"
  },
  {
   "fieldname": "next_renewal_date",
   "fieldtype": "Date",
   "description": "Next renewal date for this contract.",
   "in_list_view": 1,
   "label": "Next Renewal Date",
   "depends_on": "eval:doc.auto_renew",
   "mandatory_depends_on": "eval:doc.auto_renew"
  },
  {
   "fieldname": "notice_days",
   "fieldtype": "Int",
   "description": "Number of notice days required before renewal.",
   "label": "Notice Days",
   "depends_on": "eval:doc.auto_renew"
  },
  {
   "fieldname": "tb_notes",
   "fieldtype": "Tab Break",
   "label": "Notes"
  },
  {
   "fieldname": "notes",
   "fieldtype": "Small Text",
   "description": "Add internal notes about the contract.",
   "label": "Notes"
  },
  {
   "fieldname": "attachment",
   "fieldtype": "Attach",
   "description": "Upload the contract file.",
   "label": "Attachment"
  },
  {
   "fieldname": "tb_admin",
   "fieldtype": "Tab Break",
   "label": "Admin"
  },
  {
   "fieldname": "source_baseline_expense",
   "fieldtype": "Link",
   "description": "Link to the baseline expense that created this contract.",
   "label": "Source Baseline Expense",
   "options": "MPIT Baseline Expense"
  }
 ],
 "grid_page_length": 50,
 "index_web_pages_for_search": 1,
 "links": [],
 "modified": "2025-12-24 20:00:43.898411",
 "modified_by": "Administrator",
 "module": "Master Plan IT",
 "name": "MPIT Contract",
 "owner": "Administrator",
 "permissions": [
  {
   "create": 1,
   "delete": 1,
   "email": 1,
   "import": 1,
   "export": 1,
   "print": 1,
   "read": 1,
   "report": 1,
   "role": "System Manager",
   "share": 1,
   "write": 1
  },
  {
   "create": 1,
   "delete": 1,
   "email": 1,
   "import": 1,
   "export": 1,
   "print": 1,
   "read": 1,
   "report": 1,
   "role": "vCIO Manager",
   "share": 1,
   "write": 1
  },
  {
   "create": 1,
   "delete": 1,
   "email": 1,
   "export": 1,
   "print": 1,
   "read": 1,
   "report": 1,
   "role": "Client Editor",
   "share": 1,
   "write": 1
  },
  {
   "email": 1,
   "export": 1,
   "print": 1,
   "read": 1,
   "report": 1,
   "role": "Client Viewer",
   "share": 1
  }
 ],
 "row_format": "Dynamic",
 "rows_threshold_for_grid_search": 20,
 "sort_field": "modified",
 "sort_order": "DESC",
 "states": [],
 "title_field": "title",
 "track_changes": 1
}


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_contract/test_mpit_contract.py
================================================================================
# Copyright (c) 2025, DOT and Contributors
# See license.txt

# import frappe
from frappe.tests.utils import FrappeTestCase


class TestMPITContract(FrappeTestCase):
	pass


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_contract/__init__.py
================================================================================


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_contract/mpit_contract.js
================================================================================
// Copyright (c) 2025, DOT and contributors
// For license information, please see license.txt

frappe.provide("master_plan_it.vat");

master_plan_it.vat.defaults_promise =
	master_plan_it.vat.defaults_promise ||
	frappe.call({ method: "master_plan_it.mpit_user_prefs.get_vat_defaults" }).then((r) => r.message || {});

master_plan_it.vat.apply_defaults_for_contract =
	master_plan_it.vat.apply_defaults_for_contract ||
	async function (frm) {
		if (!frm.is_new() || frm.doc.__vat_defaults_applied) {
			return;
		}

		const defaults = await master_plan_it.vat.defaults_promise;
		const updates = {};

		if (defaults.default_includes_vat !== undefined && defaults.default_includes_vat !== null) {
			updates.current_amount_includes_vat = defaults.default_includes_vat ? 1 : 0;
		}

		if (
			(defaults.default_vat_rate || defaults.default_vat_rate === 0) &&
			(frm.doc.vat_rate === undefined || frm.doc.vat_rate === null || frm.doc.vat_rate === "")
		) {
			updates.vat_rate = defaults.default_vat_rate;
		}

		if (Object.keys(updates).length) {
			await frm.set_value(updates);
		}

		frm.doc.__vat_defaults_applied = true;
	};

frappe.ui.form.on("MPIT Contract", {
	async onload(frm) {
		await master_plan_it.vat.apply_defaults_for_contract(frm);
	},
	async refresh(frm) {
		await master_plan_it.vat.apply_defaults_for_contract(frm);
	},
});


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_contract/mpit_contract.py
================================================================================
# Copyright (c) 2025, DOT and contributors
# For license information, please see license.txt

from __future__ import annotations

import frappe
from frappe.model.document import Document
from master_plan_it import mpit_user_prefs, tax


class MPITContract(Document):
	def validate(self):
		self._compute_vat_split()
	
	def _compute_vat_split(self):
		"""Compute net/vat/gross for current_amount field with strict VAT validation."""
		# Get user default VAT rate
		default_vat = mpit_user_prefs.get_default_vat_rate(frappe.session.user)
		
		# Apply default if field is empty
		if self.vat_rate is None and default_vat is not None:
			self.vat_rate = default_vat
		
		# Strict VAT validation
		final_vat_rate = tax.validate_strict_vat(
			self.current_amount,
			self.vat_rate,
			default_vat,
			field_label=frappe._("Current Amount")
		)
		
		# Compute split
		net, vat, gross = tax.split_net_vat_gross(
			self.current_amount,
			final_vat_rate,
			bool(self.current_amount_includes_vat)
		)
		
		self.current_amount_net = net
		self.current_amount_vat = vat
		self.current_amount_gross = gross


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_amendment_line/mpit_amendment_line.json
================================================================================
{
 "actions": [],
 "allow_rename": 1,
 "creation": "2025-12-21 22:34:52.404250",
 "doctype": "DocType",
 "editable_grid": 1,
 "engine": "InnoDB",
 "field_order": [
  "category",
  "vendor",
  "description",
  "delta_amount",
  "delta_amount_includes_vat",
  "delta_amount_gross",
  "vat_rate",
  "delta_amount_net",
  "delta_amount_vat",
  "contract",
  "project",
  "note"
 ],
 "fields": [
  {
   "fieldname": "category",
   "fieldtype": "Link",
   "description": "Select the category for this change.",
   "in_list_view": 1,
   "columns": 2,
   "label": "Category",
   "options": "MPIT Category",
   "reqd": 1
  },
  {
   "fieldname": "vendor",
   "fieldtype": "Link",
   "description": "Select the vendor linked to this change.",
   "in_list_view": 1,
   "columns": 1,
   "label": "Vendor",
   "options": "MPIT Vendor"
  },
  {
   "fieldname": "contract",
   "fieldtype": "Link",
   "description": "Select the related contract, if applicable.",
   "in_list_view": 0,
   "label": "Contract",
   "options": "MPIT Contract"
  },
  {
   "fieldname": "project",
   "fieldtype": "Link",
   "description": "Select the related project, if applicable.",
   "in_list_view": 0,
   "label": "Project",
   "options": "MPIT Project"
  },
  {
   "fieldname": "description",
   "fieldtype": "Small Text",
   "description": "Describe the change captured by this line.",
   "in_list_view": 1,
   "columns": 3,
   "label": "Description"
  },
  {
   "fieldname": "delta_amount",
   "fieldtype": "Currency",
   "description": "Enter the adjustment amount for this line.",
   "in_list_view": 1,
   "columns": 1,
   "label": "Delta Amount",
   "reqd": 1
  },
  {
   "fieldname": "note",
   "fieldtype": "Small Text",
   "description": "Add an internal note for this line.",
   "label": "Note"
  },
  {
   "default": "0",
   "fieldname": "delta_amount_includes_vat",
   "fieldtype": "Check",
   "description": "If enabled, the adjustment amount includes VAT.",
   "in_list_view": 1,
   "columns": 1,
   "label": "VAT Included?"
  },
  {
   "fieldname": "vat_rate",
   "fieldtype": "Percent",
   "description": "VAT rate applied to the adjustment.",
   "label": "VAT Rate",
   "precision": "2"
  },
  {
   "fieldname": "delta_amount_net",
   "fieldtype": "Currency",
   "description": "Calculated automatically from delta amount and VAT settings.",
   "label": "Net Delta Amount",
   "read_only": 1
  },
  {
   "fieldname": "delta_amount_vat",
   "fieldtype": "Currency",
   "description": "Calculated automatically as the VAT portion of the delta.",
   "label": "VAT Delta Amount",
   "read_only": 1
  },
  {
   "fieldname": "delta_amount_gross",
   "fieldtype": "Currency",
   "description": "Calculated automatically as the gross delta amount.",
   "in_list_view": 1,
   "columns": 1,
   "label": "Gross Delta Amount",
   "read_only": 1
  }
 ],
 "grid_page_length": 50,
 "index_web_pages_for_search": 1,
 "istable": 1,
 "links": [],
 "modified": "2025-12-24 20:00:45.752106",
 "modified_by": "Administrator",
 "module": "Master Plan IT",
 "name": "MPIT Amendment Line",
 "owner": "Administrator",
 "permissions": [],
 "row_format": "Dynamic",
 "rows_threshold_for_grid_search": 20,
 "sort_field": "modified",
 "sort_order": "DESC",
 "states": [],
 "track_changes": 1
}


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_amendment_line/mpit_amendment_line.py
================================================================================
# Copyright (c) 2025, DOT and contributors
# For license information, please see license.txt

# import frappe
from frappe.model.document import Document


class MPITAmendmentLine(Document):
	pass


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_amendment_line/__init__.py
================================================================================


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_project_quote/mpit_project_quote.py
================================================================================
# Copyright (c) 2025, DOT and contributors
# For license information, please see license.txt

# import frappe
from frappe.model.document import Document


class MPITProjectQuote(Document):
	pass


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_project_quote/__init__.py
================================================================================


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_project_quote/mpit_project_quote.json
================================================================================
{
 "actions": [],
 "allow_rename": 1,
 "creation": "2025-12-21 22:34:30.814174",
 "doctype": "DocType",
 "editable_grid": 1,
 "engine": "InnoDB",
 "field_order": [
  "vendor",
  "quote_date",
  "attachment",
  "status",
  "amount",
  "amount_gross",
  "amount_includes_vat",
  "vat_rate",
  "amount_net",
  "amount_vat"
 ],
 "fields": [
  {
   "fieldname": "vendor",
   "fieldtype": "Link",
   "description": "Select the vendor providing the quote.",
   "in_list_view": 1,
   "columns": 2,
   "label": "Vendor",
   "options": "MPIT Vendor"
  },
  {
   "fieldname": "amount",
   "fieldtype": "Currency",
   "description": "Enter the quoted amount.",
   "in_list_view": 1,
   "columns": 1,
   "label": "Amount"
  },
  {
   "fieldname": "quote_date",
   "fieldtype": "Date",
   "description": "Date when the quote was received.",
   "in_list_view": 1,
   "columns": 2,
   "label": "Quote Date"
  },
  {
   "fieldname": "attachment",
   "fieldtype": "Attach",
   "description": "Upload the quote document.",
   "in_list_view": 1,
   "columns": 2,
   "label": "Attachment"
  },
  {
   "default": "Received",
   "fieldname": "status",
   "fieldtype": "Select",
   "description": "Choose the quote status.",
   "in_list_view": 1,
   "columns": 1,
   "label": "Status",
   "options": "Received\nAccepted\nRejected"
  },
  {
   "default": "0",
   "fieldname": "amount_includes_vat",
   "fieldtype": "Check",
   "description": "If enabled, the amount includes VAT.",
   "label": "Amount Includes VAT"
  },
  {
   "fieldname": "vat_rate",
   "fieldtype": "Percent",
   "description": "VAT rate applied to the quote amount.",
   "label": "VAT Rate",
   "precision": "2"
  },
  {
   "fieldname": "amount_net",
   "fieldtype": "Currency",
   "description": "Calculated automatically from amount and VAT settings.",
   "label": "Net Amount",
   "read_only": 1
  },
  {
   "fieldname": "amount_vat",
   "fieldtype": "Currency",
   "description": "Calculated automatically as the VAT portion.",
   "label": "VAT Amount",
   "read_only": 1
  },
  {
   "fieldname": "amount_gross",
   "fieldtype": "Currency",
   "description": "Calculated automatically as the gross amount.",
   "in_list_view": 1,
   "columns": 1,
   "label": "Gross Amount",
   "read_only": 1
  }
 ],
 "grid_page_length": 50,
 "index_web_pages_for_search": 1,
 "istable": 1,
 "links": [],
 "modified": "2025-12-24 20:00:41.593152",
 "modified_by": "Administrator",
 "module": "Master Plan IT",
 "name": "MPIT Project Quote",
 "owner": "Administrator",
 "permissions": [],
 "row_format": "Dynamic",
 "rows_threshold_for_grid_search": 20,
 "sort_field": "modified",
 "sort_order": "DESC",
 "states": [],
 "track_changes": 1
}


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_user_preferences/mpit_user_preferences.py
================================================================================
# Copyright (c) 2025, DOT and contributors
# For license information, please see license.txt

# import frappe
from frappe.model.document import Document


class MPITUserPreferences(Document):
	pass


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_user_preferences/mpit_user_preferences.js
================================================================================
// Copyright (c) 2025, DOT and contributors
// For license information, please see license.txt

// frappe.ui.form.on("MPIT User Preferences", {
// 	refresh(frm) {

// 	},
// });


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_user_preferences/__init__.py
================================================================================


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_user_preferences/test_mpit_user_preferences.py
================================================================================
# Copyright (c) 2025, DOT and Contributors
# See license.txt

# import frappe
from frappe.tests.utils import FrappeTestCase


class TestMPITUserPreferences(FrappeTestCase):
	pass


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_user_preferences/mpit_user_preferences.json
================================================================================
{
 "actions": [],
 "allow_rename": 1,
 "autoname": "field:user",
 "creation": "2025-12-22 12:29:01.266910",
 "doctype": "DocType",
 "editable_grid": 1,
 "engine": "InnoDB",
 "field_order": [
  "user",
  "vat_section",
  "default_vat_rate",
  "default_amount_includes_vat",
  "naming_section",
  "budget_prefix",
  "budget_sequence_digits",
  "column_break_naming",
  "project_prefix",
  "project_sequence_digits",
  "print_section",
  "show_attachments_in_print"
 ],
 "fields": [
  {
   "fieldname": "user",
   "fieldtype": "Link",
   "description": "Select the user these preferences apply to.",
   "in_list_view": 1,
   "label": "User",
   "options": "User",
   "reqd": 1,
   "unique": 1
  },
  {
   "fieldname": "vat_section",
   "fieldtype": "Section Break",
   "label": "VAT Defaults"
  },
  {
   "description": "Default VAT rate for new entries (leave blank for no default, 0 is valid)",
   "fieldname": "default_vat_rate",
   "fieldtype": "Percent",
   "label": "Default VAT Rate",
   "precision": "2"
  },
  {
   "default": "0",
   "fieldname": "default_amount_includes_vat",
   "fieldtype": "Check",
   "description": "If enabled, new amounts default to VAT-inclusive.",
   "label": "Default Amount Includes VAT"
  },
  {
   "fieldname": "naming_section",
   "fieldtype": "Section Break",
   "label": "Naming Preferences"
  },
  {
   "default": "BUD-",
   "fieldname": "budget_prefix",
   "fieldtype": "Data",
   "description": "Prefix used when generating budget names.",
   "label": "Budget Prefix"
  },
  {
   "default": "2",
   "fieldname": "budget_sequence_digits",
   "fieldtype": "Int",
   "description": "Number of digits for budget sequence numbers.",
   "label": "Budget Sequence Digits"
  },
  {
   "fieldname": "column_break_naming",
   "fieldtype": "Column Break"
  },
  {
   "default": "PRJ-",
   "fieldname": "project_prefix",
   "fieldtype": "Data",
   "description": "Prefix used when generating project names.",
   "label": "Project Prefix"
  },
  {
   "default": "4",
   "fieldname": "project_sequence_digits",
   "fieldtype": "Int",
   "description": "Number of digits for project sequence numbers.",
   "label": "Project Sequence Digits"
  },
  {
   "fieldname": "print_section",
   "fieldtype": "Section Break",
   "label": "Print Preferences"
  },
  {
   "default": "0",
   "fieldname": "show_attachments_in_print",
   "fieldtype": "Check",
   "description": "If enabled, attachments are shown on print formats.",
   "label": "Show Attachments in Print"
  }
 ],
 "grid_page_length": 50,
 "index_web_pages_for_search": 1,
 "links": [],
 "modified": "2025-12-24 20:00:40.132896",
 "modified_by": "Administrator",
 "module": "Master Plan IT",
 "name": "MPIT User Preferences",
 "owner": "Administrator",
 "permissions": [
  {
   "create": 1,
   "delete": 1,
   "email": 1,
   "export": 1,
   "print": 1,
   "read": 1,
   "report": 1,
   "role": "System Manager",
   "share": 1,
   "write": 1
  },
  {
   "create": 1,
   "delete": 1,
   "email": 1,
   "export": 1,
   "if_owner": 1,
   "print": 1,
   "read": 1,
   "report": 1,
   "role": "vCIO Manager",
   "share": 1,
   "write": 1
  },
  {
   "create": 1,
   "delete": 1,
   "email": 1,
   "export": 1,
   "if_owner": 1,
   "print": 1,
   "read": 1,
   "report": 1,
   "role": "Client Editor",
   "share": 1,
   "write": 1
  },
  {
   "create": 1,
   "delete": 1,
   "email": 1,
   "export": 1,
   "if_owner": 1,
   "print": 1,
   "read": 1,
   "report": 1,
   "role": "Client Viewer",
   "share": 1
  }
 ],
 "row_format": "Dynamic",
 "rows_threshold_for_grid_search": 20,
 "sort_field": "modified",
 "sort_order": "DESC",
 "states": [],
 "title_field": "user",
 "track_changes": 1
}


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_budget/mpit_budget.json
================================================================================
{
 "actions": [],
 "allow_import": 1,
 "allow_rename": 1,
 "creation": "2025-12-21 22:34:53.002565",
 "doctype": "DocType",
 "editable_grid": 1,
 "engine": "InnoDB",
 "field_order": [
  "tab_overview",
  "year",
  "title",
  "overview_col_break",
  "workflow_state",
  "tab_lines",
  "lines",
  "tab_totals",
  "total_amount_input",
  "total_amount_vat",
  "totals_col_break_1",
  "total_amount_net",
  "total_amount_gross",
  "tab_admin",
  "amended_from"
 ],
"fields": [
  {
   "fieldname": "tab_overview",
   "fieldtype": "Section Break",
   "label": "Overview"
  },
  {
   "fieldname": "year",
   "fieldtype": "Link",
   "description": "Select the budget year.",
   "in_list_view": 1,
   "label": "Year",
   "options": "MPIT Year",
   "reqd": 1
  },
  {
   "fieldname": "title",
   "fieldtype": "Data",
   "description": "Enter a short budget title.",
   "in_list_view": 1,
   "label": "Title"
  },
  {
   "fieldname": "overview_col_break",
   "fieldtype": "Column Break"
  },
  {
   "allow_on_submit": 1,
   "fieldname": "workflow_state",
   "fieldtype": "Select",
   "default": "Draft",
   "description": "Editable status label for the budget.",
   "in_list_view": 1,
   "label": "Status",
   "options": "Draft\nProposed\nIn Review\nApproved",
   "read_only": 0
  },
  {
   "fieldname": "tab_lines",
   "fieldtype": "Section Break",
   "label": "Lines"
  },
  {
   "fieldname": "lines",
   "fieldtype": "Table",
   "description": "Add budget lines for categories, vendors, and amounts.",
   "label": "Lines",
   "options": "MPIT Budget Line"
  },
  {
   "fieldname": "tab_totals",
   "fieldtype": "Section Break",
   "label": "Totals"
  },
  {
   "fieldname": "total_amount_input",
   "fieldtype": "Currency",
   "description": "Calculated automatically as the sum of line amounts.",
   "label": "Total Amount Input",
   "read_only": 1
  },
  {
   "fieldname": "total_amount_vat",
   "fieldtype": "Currency",
   "description": "Calculated automatically as the sum of line VAT amounts.",
   "label": "Total VAT Amount",
   "read_only": 1
  },
  {
   "fieldname": "totals_col_break_1",
   "fieldtype": "Column Break"
  },
  {
   "fieldname": "total_amount_net",
   "fieldtype": "Currency",
   "description": "Calculated automatically as the sum of net amounts.",
   "label": "Total Net Amount",
   "read_only": 1
  },
  {
   "fieldname": "total_amount_gross",
   "fieldtype": "Currency",
   "description": "Calculated automatically as the sum of gross amounts.",
   "label": "Total Gross Amount",
   "read_only": 1
  },
  {
   "fieldname": "tab_admin",
   "collapsible": 1,
   "fieldtype": "Section Break",
   "label": "Admin"
  },
  {
   "fieldname": "amended_from",
   "fieldtype": "Link",
   "description": "Reference to the original budget this document was amended from.",
   "label": "Amended From",
   "no_copy": 1,
   "options": "MPIT Budget",
   "print_hide": 1,
   "read_only": 1,
   "search_index": 1
  }
 ],
 "grid_page_length": 50,
 "index_web_pages_for_search": 1,
 "is_submittable": 1,
 "links": [],
 "modified": "2025-12-24 20:00:47.368441",
 "modified_by": "Administrator",
 "module": "Master Plan IT",
 "name": "MPIT Budget",
 "owner": "Administrator",
 "permissions": [
  {
   "cancel": 1,
   "create": 1,
   "delete": 1,
   "email": 1,
   "import": 1,
   "export": 1,
   "print": 1,
   "read": 1,
   "report": 1,
   "role": "System Manager",
   "share": 1,
   "submit": 1,
   "write": 1
  },
  {
   "cancel": 1,
   "create": 1,
   "delete": 1,
   "email": 1,
   "import": 1,
   "export": 1,
   "print": 1,
   "read": 1,
   "report": 1,
   "role": "vCIO Manager",
   "share": 1,
   "submit": 1,
   "write": 1
  },
  {
   "create": 1,
   "delete": 1,
   "email": 1,
   "export": 1,
   "print": 1,
   "read": 1,
   "report": 1,
   "role": "Client Editor",
   "share": 1,
   "submit": 1,
   "write": 1
  },
  {
   "email": 1,
   "export": 1,
   "print": 1,
   "read": 1,
   "report": 1,
   "role": "Client Viewer",
   "share": 1
  }
 ],
 "row_format": "Dynamic",
 "rows_threshold_for_grid_search": 20,
 "sort_field": "modified",
 "sort_order": "DESC",
 "states": [],
 "title_field": "title",
 "track_changes": 1
}


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_budget/test_mpit_budget.py
================================================================================
# Copyright (c) 2025, DOT and Contributors
# See license.txt

import frappe
from frappe.tests.utils import FrappeTestCase
from frappe.utils import flt


class TestMPITBudget(FrappeTestCase):
	def setUp(self):
		super().setUp()
		self.year = self._ensure_year(2099)
		self.category = self._ensure_category("Totals Test Category")

	def _ensure_year(self, year_value: int):
		if not frappe.db.exists("MPIT Year", year_value):
			doc = frappe.get_doc({
				"doctype": "MPIT Year",
				"year": year_value,
				"start_date": f"{year_value}-01-01",
				"end_date": f"{year_value}-12-31"
			})
			doc.insert(ignore_if_duplicate=True)
		return frappe.get_doc("MPIT Year", year_value)

	def _ensure_category(self, category_name: str):
		if not frappe.db.exists("MPIT Category", category_name):
			doc = frappe.get_doc({
				"doctype": "MPIT Category",
				"category_name": category_name,
				"is_group": 0
			})
			doc.insert(ignore_if_duplicate=True)
		return frappe.get_doc("MPIT Category", category_name)

	def test_totals_aggregated_from_lines(self):
		budget = frappe.get_doc({
			"doctype": "MPIT Budget",
			"year": self.year.name,
			"title": "Totals Test",
			"lines": [
				{
					"doctype": "MPIT Budget Line",
					"category": self.category.name,
					"amount": 100,
					"amount_includes_vat": 0,
					"vat_rate": 10,
					"recurrence_rule": "None"
				},
				{
					"doctype": "MPIT Budget Line",
					"category": self.category.name,
					"amount": 200,
					"amount_includes_vat": 0,
					"vat_rate": 5,
					"recurrence_rule": "None"
				}
			]
		})
		budget.insert()
		budget.reload()

		self.assertEqual(budget.total_amount_input, flt(300, 2))
		self.assertEqual(budget.total_amount_net, flt(300, 2))
		self.assertEqual(budget.total_amount_vat, flt(20, 2))
		self.assertEqual(budget.total_amount_gross, flt(320, 2))

	def test_totals_update_when_line_saved_individually(self):
		budget = frappe.get_doc({
			"doctype": "MPIT Budget",
			"year": self.year.name,
			"title": "Totals Child Save",
			"lines": [
				{
					"doctype": "MPIT Budget Line",
					"category": self.category.name,
					"amount": 100,
					"amount_includes_vat": 0,
					"vat_rate": 10,
					"recurrence_rule": "None"
				},
				{
					"doctype": "MPIT Budget Line",
					"category": self.category.name,
					"amount": 200,
					"amount_includes_vat": 0,
					"vat_rate": 5,
					"recurrence_rule": "None"
				}
			]
		})
		budget.insert()
		budget.reload()

		line = frappe.get_doc("MPIT Budget Line", budget.lines[0].name)
		line.amount = 150
		line.amount_net = 150
		line.amount_vat = 15
		line.amount_gross = 165
		line.save()

		updated_budget = frappe.get_doc("MPIT Budget", budget.name)
		self.assertEqual(updated_budget.total_amount_input, flt(350, 2))
		self.assertEqual(updated_budget.total_amount_net, flt(350, 2))
		self.assertEqual(updated_budget.total_amount_vat, flt(25, 2))
		self.assertEqual(updated_budget.total_amount_gross, flt(375, 2))


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_budget/__init__.py
================================================================================


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_budget/mpit_budget.py
================================================================================
# Copyright (c) 2025, DOT and contributors
# For license information, please see license.txt

from __future__ import annotations

import frappe
from frappe import _
from frappe.model.document import Document
from frappe.model.naming import getseries
from frappe.utils import flt
from master_plan_it import annualization, mpit_user_prefs, tax


class MPITBudget(Document):
	def autoname(self):
		"""Generate name: BUD-{year}-{NN} based on Budget.year and user preferences."""
		from master_plan_it import mpit_user_prefs
		
		# Budget.year is mandatory for naming
		if not self.year:
			frappe.throw(_("Year is required to generate Budget name"))
		
		# Get user preferences for prefix and digits
		prefix, digits, middle = mpit_user_prefs.get_budget_series(user=frappe.session.user, year=self.year)
		
		# Generate name: BUD-2025-01, BUD-2025-02, etc.
		# getseries returns only the number part, we need to add prefix + middle
		series_key = f"{prefix}{middle}.####"
		sequence = getseries(series_key, digits)
		self.name = f"{prefix}{middle}{sequence}"
	
	def validate(self):
		self._enforce_status_invariants()
		self._compute_lines_vat_split()
		self._compute_lines_annualization()
		self._compute_totals()
	
	def _compute_lines_vat_split(self):
		"""Compute net/vat/gross for all Budget Lines with strict VAT validation."""
		# Get user defaults once
		default_vat = mpit_user_prefs.get_default_vat_rate(frappe.session.user)
		
		for line in self.lines:
			# Skip if no amount is provided
			if not line.amount:
				# Clear calculated fields if no amount
				line.amount_net = 0.0
				line.amount_vat = 0.0
				line.amount_gross = 0.0
				continue
			
			# Use 'amount' as source and calculate net/vat/gross
			# Apply VAT rate default if not specified
			if line.vat_rate is None and default_vat is not None:
				line.vat_rate = default_vat
			
			# Strict VAT validation
			final_vat_rate = tax.validate_strict_vat(
				line.amount,
				line.vat_rate,
				default_vat,
				field_label=_("Line {0} Amount").format(line.idx)
			)
			
			# Compute split
			net, vat, gross = tax.split_net_vat_gross(
				line.amount,
				final_vat_rate,
				bool(line.amount_includes_vat)
			)
			
			line.amount_net = net
			line.amount_vat = vat
			line.amount_gross = gross
	
	def _compute_lines_annualization(self):
		"""Compute annual amounts for all Budget Lines based on recurrence rules."""
		# Get fiscal year bounds from year field
		year_start, year_end = annualization.get_year_bounds(self.year)
		
		for line in self.lines:
			# Validate recurrence rule consistency
			annualization.validate_recurrence_rule(
				line.recurrence_rule,
				line.custom_period_months
			)
			
			# Calculate overlap months
			if line.period_start_date and line.period_end_date:
				overlap_months_count = annualization.overlap_months(
					line.period_start_date,
					line.period_end_date,
					year_start,
					year_end
				)
			else:
				# No period specified: treat as full year overlap
				overlap_months_count = 12
			
			# Rule A: Block save if zero overlap
			if line.period_start_date and line.period_end_date and overlap_months_count == 0:
				frappe.throw(
					frappe._(
						"Line {0}: Period ({1} to {2}) has zero overlap with fiscal year {3}. Cannot save budget line with no temporal overlap."
					).format(line.idx, line.period_start_date, line.period_end_date, self.year)
				)
			
			# Calculate annualized amounts
			annual_net = annualization.annualize(
				line.amount_net,
				line.recurrence_rule or "None",
				line.custom_period_months,
				overlap_months_count
			)
			
			# Annual VAT and gross
			if line.vat_rate and annual_net:
				vat_rate_decimal = line.vat_rate / 100.0
				annual_vat = annual_net * vat_rate_decimal
				annual_gross = annual_net + annual_vat
			else:
				annual_vat = 0.0
				annual_gross = annual_net
			
			line.annual_net = annual_net
			line.annual_vat = annual_vat
			line.annual_gross = annual_gross

	def _enforce_status_invariants(self) -> None:
		"""Keep workflow_state aligned with docstatus now that it is an editable status label."""
		if not self.workflow_state:
			self.workflow_state = "Draft"

		if self.docstatus == 0 and self.workflow_state == "Approved":
			frappe.throw(_("Draft Budget cannot be set to Approved. Submit the document to approve it."))

		if self.docstatus == 1 and self.workflow_state != "Approved":
			self.workflow_state = "Approved"

	def on_submit(self):
		# Ensure submitted budgets always reflect Approved status
		if self.workflow_state != "Approved":
			self.workflow_state = "Approved"
			self.db_set("workflow_state", "Approved")

	def _compute_totals(self):
		total_input = 0.0
		total_net = 0.0
		total_vat = 0.0
		total_gross = 0.0

		for line in (self.lines or []):
			total_input += flt(getattr(line, "amount", 0) or 0, 2)
			total_net += flt(getattr(line, "amount_net", 0) or 0, 2)
			total_vat += flt(getattr(line, "amount_vat", 0) or 0, 2)
			total_gross += flt(getattr(line, "amount_gross", 0) or 0, 2)

		self.total_amount_input = flt(total_input, 2)
		self.total_amount_net = flt(total_net, 2)
		self.total_amount_vat = flt(total_vat, 2)
		self.total_amount_gross = flt(total_gross, 2)


def update_budget_totals(budget_name: str) -> None:
	"""Recompute and persist totals for an existing budget without client scripts."""
	if not budget_name:
		return

	budget = frappe.get_doc("MPIT Budget", budget_name)
	budget._compute_totals()

	totals = {
		"total_amount_input": flt(budget.total_amount_input, 2),
		"total_amount_net": flt(budget.total_amount_net, 2),
		"total_amount_vat": flt(budget.total_amount_vat, 2),
		"total_amount_gross": flt(budget.total_amount_gross, 2),
	}

	frappe.db.set_value("MPIT Budget", budget_name, totals)


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_budget/mpit_budget.js
================================================================================
// Copyright (c) 2025, DOT and contributors
// For license information, please see license.txt

frappe.provide("master_plan_it.vat");

master_plan_it.vat.defaults_promise =
	master_plan_it.vat.defaults_promise ||
	frappe.call({ method: "master_plan_it.mpit_user_prefs.get_vat_defaults" }).then((r) => r.message || {});

master_plan_it.vat.apply_defaults_for_budget_line =
	master_plan_it.vat.apply_defaults_for_budget_line ||
	async function (cdt, cdn) {
		const row = frappe.get_doc(cdt, cdn);
		if (!row || row.__islocal === false || row.__vat_defaults_applied) {
			return;
		}

		const defaults = await master_plan_it.vat.defaults_promise;
		const updates = {};

		if (defaults.default_includes_vat !== undefined && defaults.default_includes_vat !== null) {
			updates.amount_includes_vat = defaults.default_includes_vat ? 1 : 0;
		}

		if (
			(defaults.default_vat_rate || defaults.default_vat_rate === 0) &&
			(row.vat_rate === undefined || row.vat_rate === null || row.vat_rate === "")
		) {
			updates.vat_rate = defaults.default_vat_rate;
		}

		if (Object.keys(updates).length) {
			frappe.model.set_value(cdt, cdn, updates);
		}

		row.__vat_defaults_applied = true;
	};

frappe.ui.form.on("MPIT Budget", {
	async lines_add(_frm, cdt, cdn) {
		await master_plan_it.vat.apply_defaults_for_budget_line(cdt, cdn);
	},
});


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_settings/mpit_settings.js
================================================================================
// Copyright (c) 2025, DOT and contributors
// For license information, please see license.txt

// frappe.ui.form.on("MPIT Settings", {
// 	refresh(frm) {

// 	},
// });


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_settings/__init__.py
================================================================================


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_settings/mpit_settings.json
================================================================================
{
 "actions": [],
 "allow_rename": 1,
 "creation": "2025-12-21 22:34:30.283252",
 "doctype": "DocType",
 "editable_grid": 1,
 "engine": "InnoDB",
 "field_order": [
  "currency",
  "renewal_window_days",
  "portfolio_warning_threshold_pct"
 ],
 "fields": [
  {
   "fieldname": "currency",
   "fieldtype": "Link",
   "description": "Select the default currency for Master Plan IT calculations.",
   "in_list_view": 1,
   "label": "Currency",
   "options": "Currency",
   "reqd": 1
  },
  {
   "default": "90",
   "fieldname": "renewal_window_days",
   "fieldtype": "Int",
   "description": "Days before renewal dates treated as the renewal window.",
   "label": "Renewal Window Days"
  },
  {
   "default": "100",
   "fieldname": "portfolio_warning_threshold_pct",
   "fieldtype": "Int",
   "description": "Percentage threshold used for portfolio warnings.",
   "label": "Portfolio Warning Threshold %"
  }
 ],
 "grid_page_length": 50,
 "index_web_pages_for_search": 1,
 "issingle": 1,
 "links": [],
 "modified": "2025-12-24 20:00:39.432578",
 "modified_by": "Administrator",
 "module": "Master Plan IT",
 "name": "MPIT Settings",
 "owner": "Administrator",
 "permissions": [
  {
   "create": 1,
   "delete": 1,
   "email": 1,
   "print": 1,
   "read": 1,
   "role": "System Manager",
   "share": 1,
   "write": 1
  },
  {
   "create": 1,
   "delete": 1,
   "email": 1,
   "print": 1,
   "read": 1,
   "role": "vCIO Manager",
   "share": 1,
   "write": 1
  },
  {
   "email": 1,
   "print": 1,
   "read": 1,
   "role": "Client Editor",
   "share": 1
  }
 ],
 "row_format": "Dynamic",
 "rows_threshold_for_grid_search": 20,
 "sort_field": "modified",
 "sort_order": "DESC",
 "states": [],
 "track_changes": 1
}


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_settings/mpit_settings.py
================================================================================
# Copyright (c) 2025, DOT and contributors
# For license information, please see license.txt

# import frappe
from frappe.model.document import Document


class MPITSettings(Document):
	pass


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_settings/test_mpit_settings.py
================================================================================
# Copyright (c) 2025, DOT and Contributors
# See license.txt

# import frappe
from frappe.tests.utils import FrappeTestCase


class TestMPITSettings(FrappeTestCase):
	pass


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/__init__.py
================================================================================


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_category/mpit_category.json
================================================================================
{
 "actions": [],
 "allow_import": 1,
 "allow_rename": 1,
 "autoname": "field:category_name",
 "creation": "2025-12-21 22:27:05.441358",
 "doctype": "DocType",
 "editable_grid": 1,
 "engine": "InnoDB",
 "field_order": [
  "category_name",
  "parent_category",
  "is_active",
  "sort_order",
  "lft",
  "rgt",
  "is_group",
  "old_parent",
  "parent_mpit_category"
 ],
 "fields": [
  {
   "fieldname": "category_name",
   "fieldtype": "Data",
   "description": "Enter the category name.",
   "in_list_view": 1,
   "label": "Category Name",
   "reqd": 1,
   "unique": 1
  },
  {
   "fieldname": "parent_category",
   "fieldtype": "Link",
   "description": "Select the parent category.",
   "label": "Parent Category",
   "options": "MPIT Category"
  },
  {
   "default": "1",
   "fieldname": "is_active",
   "fieldtype": "Check",
   "description": "If enabled, the category is active for use.",
   "label": "Is Active"
  },
  {
   "fieldname": "sort_order",
   "fieldtype": "Int",
   "description": "Enter numeric order for sorting categories.",
   "label": "Sort Order"
  },
  {
   "fieldname": "lft",
   "fieldtype": "Int",
   "description": "Calculated automatically for tree positioning.",
   "hidden": 1,
   "label": "Left",
   "no_copy": 1,
   "read_only": 1
  },
  {
   "fieldname": "rgt",
   "fieldtype": "Int",
   "description": "Calculated automatically for tree positioning.",
   "hidden": 1,
   "label": "Right",
   "no_copy": 1,
   "read_only": 1
  },
  {
   "default": "0",
   "fieldname": "is_group",
   "fieldtype": "Check",
   "description": "If enabled, category can contain child categories.",
   "label": "Is Group"
  },
  {
   "fieldname": "old_parent",
   "fieldtype": "Link",
   "description": "Previous parent category captured during moves.",
   "label": "Old Parent",
   "options": "MPIT Category"
  },
  {
   "fieldname": "parent_mpit_category",
   "fieldtype": "Link",
   "description": "Parent category used by tree view.",
   "ignore_user_permissions": 1,
   "label": "Parent MPIT Category",
   "options": "MPIT Category"
  }
 ],
 "grid_page_length": 50,
 "index_web_pages_for_search": 1,
 "is_tree": 1,
 "links": [],
 "modified": "2025-12-24 20:00:37.728627",
 "modified_by": "Administrator",
 "module": "Master Plan IT",
 "name": "MPIT Category",
 "nsm_parent_field": "parent_category",
 "owner": "Administrator",
 "permissions": [
  {
   "create": 1,
   "delete": 1,
   "email": 1,
   "import": 1,
   "export": 1,
   "print": 1,
   "read": 1,
   "report": 1,
   "role": "System Manager",
   "share": 1,
   "write": 1
  },
  {
   "create": 1,
   "delete": 1,
   "email": 1,
   "import": 1,
   "export": 1,
   "print": 1,
   "read": 1,
   "report": 1,
   "role": "vCIO Manager",
   "share": 1,
   "write": 1
  },
  {
   "email": 1,
   "export": 1,
   "print": 1,
   "read": 1,
   "report": 1,
   "role": "Client Editor",
   "share": 1
  },
  {
   "email": 1,
   "export": 1,
   "print": 1,
   "read": 1,
   "report": 1,
   "role": "Client Viewer",
   "share": 1
  }
 ],
 "row_format": "Dynamic",
 "rows_threshold_for_grid_search": 20,
 "sort_field": "modified",
 "sort_order": "DESC",
 "states": [],
 "title_field": "category_name",
 "track_changes": 1
}


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_category/mpit_category.py
================================================================================
# Copyright (c) 2025, DOT and contributors
# For license information, please see license.txt

# import frappe
from frappe.utils.nestedset import NestedSet


class MPITCategory(NestedSet):
	pass


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_category/__init__.py
================================================================================


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_category/mpit_category.js
================================================================================
// Copyright (c) 2025, DOT and contributors
// For license information, please see license.txt

// frappe.ui.form.on("MPIT Category", {
// 	refresh(frm) {

// 	},
// });


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_category/test_mpit_category.py
================================================================================
# Copyright (c) 2025, DOT and Contributors
# See license.txt

# import frappe
from frappe.tests.utils import FrappeTestCase


class TestMPITCategory(FrappeTestCase):
	pass


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_actual_entry/test_mpit_actual_entry.py
================================================================================
# Copyright (c) 2025, DOT and Contributors
# See license.txt

import frappe
from frappe.tests.utils import FrappeTestCase


class TestMPITActualEntry(FrappeTestCase):
	def setUp(self):
		# Ensure supporting records exist for tests
		if not frappe.db.exists("MPIT Year", "2030"):
			frappe.get_doc({"doctype": "MPIT Year", "year": 2030, "start_date": "2030-01-01", "end_date": "2030-12-31"}).insert()
		if not frappe.db.exists("MPIT Category", "Test Category"):
			frappe.get_doc({"doctype": "MPIT Category", "category_name": "Test Category", "is_active": 1}).insert()

	def test_year_is_derived_from_posting_date(self):
		doc = frappe.get_doc({
			"doctype": "MPIT Actual Entry",
			"posting_date": "2030-05-10",
			"category": "Test Category",
			"amount": 123.45,
			"vat_rate": 0,
		})
		doc.insert()
		self.assertEqual(doc.year, "2030")


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_actual_entry/mpit_actual_entry.json
================================================================================
{
 "actions": [],
 "allow_import": 1,
 "allow_rename": 1,
 "creation": "2025-12-21 22:34:53.313023",
 "doctype": "DocType",
 "editable_grid": 1,
 "engine": "InnoDB",
 "field_order": [
  "tab_overview",
  "posting_date",
  "year",
  "status",
  "description",
  "tab_amounts",
  "amount",
  "amount_includes_vat",
  "vat_rate",
  "amount_net",
  "amount_vat",
  "amount_gross",
  "tab_links",
  "category",
  "vendor",
  "contract",
  "project",
  "budget",
  "budget_line_ref"
 ],
 "fields": [
  {
   "fieldname": "tab_overview",
   "fieldtype": "Tab Break",
   "label": "Overview"
  },
  {
   "fieldname": "posting_date",
   "fieldtype": "Date",
   "description": "Posting date for the entry; used to derive the MPIT Year.",
   "in_list_view": 1,
   "label": "Posting Date",
   "reqd": 1
  },
  {
   "fieldname": "year",
   "fieldtype": "Link",
   "description": "Derived MPIT Year based on the posting date.",
   "in_list_view": 1,
   "label": "Year",
   "options": "MPIT Year",
   "read_only": 1,
   "reqd": 1
  },
  {
   "default": "Recorded",
   "fieldname": "status",
   "fieldtype": "Select",
   "description": "Choose whether the entry is recorded or verified.",
   "in_list_view": 1,
   "label": "Status",
   "options": "Recorded\nVerified"
  },
  {
   "fieldname": "description",
   "fieldtype": "Small Text",
   "description": "Describe the actual entry.",
   "label": "Description"
  },
  {
   "fieldname": "tab_amounts",
   "fieldtype": "Tab Break",
   "label": "Amounts & VAT"
  },
  {
   "fieldname": "amount",
   "fieldtype": "Currency",
   "description": "Enter the actual amount; use net or gross per the VAT setting.",
   "in_list_view": 1,
   "label": "Amount"
  },
  {
   "default": "0",
   "fieldname": "amount_includes_vat",
   "fieldtype": "Check",
   "description": "If enabled, the amount includes VAT.",
   "label": "Amount Includes VAT"
  },
  {
   "fieldname": "vat_rate",
   "fieldtype": "Percent",
   "description": "VAT rate applied to the amount.",
   "label": "VAT Rate",
   "precision": "2"
  },
  {
   "fieldname": "amount_net",
   "fieldtype": "Currency",
   "description": "Calculated automatically from amount and VAT settings.",
   "label": "Net Amount",
   "read_only": 1
  },
  {
   "fieldname": "amount_vat",
   "fieldtype": "Currency",
   "description": "Calculated automatically as the VAT portion.",
   "label": "VAT Amount",
   "read_only": 1
  },
  {
   "fieldname": "amount_gross",
   "fieldtype": "Currency",
   "description": "Calculated automatically as the gross amount.",
   "label": "Gross Amount",
   "read_only": 1
  },
  {
   "fieldname": "tab_links",
   "fieldtype": "Tab Break",
   "label": "Links & Context"
  },
  {
   "fieldname": "category",
   "fieldtype": "Link",
   "description": "Select the category for this entry.",
   "in_list_view": 1,
   "label": "Category",
   "options": "MPIT Category",
   "reqd": 1
  },
  {
   "fieldname": "vendor",
   "fieldtype": "Link",
   "description": "Select the vendor involved in this entry.",
   "in_list_view": 1,
   "label": "Vendor",
   "options": "MPIT Vendor"
  },
  {
   "fieldname": "contract",
   "fieldtype": "Link",
   "description": "Select the related contract, if applicable.",
   "label": "Contract",
   "options": "MPIT Contract"
  },
  {
   "fieldname": "project",
   "fieldtype": "Link",
   "description": "Select the related project, if applicable.",
   "label": "Project",
   "options": "MPIT Project"
  },
  {
   "fieldname": "budget",
   "fieldtype": "Link",
   "description": "Select the budget this entry relates to.",
   "label": "Budget",
   "options": "MPIT Budget"
  },
  {
   "fieldname": "budget_line_ref",
   "fieldtype": "Data",
   "description": "Reference to the related budget line, if applicable.",
   "label": "Budget Line Ref"
  }
 ],
 "grid_page_length": 50,
 "index_web_pages_for_search": 1,
 "links": [],
 "modified": "2025-12-24 20:00:48.972730",
 "modified_by": "Administrator",
 "module": "Master Plan IT",
 "name": "MPIT Actual Entry",
 "owner": "Administrator",
 "permissions": [
  {
   "create": 1,
   "delete": 1,
   "email": 1,
   "import": 1,
   "export": 1,
   "print": 1,
   "read": 1,
   "report": 1,
   "role": "System Manager",
   "share": 1,
   "write": 1
  },
  {
   "create": 1,
   "delete": 1,
   "email": 1,
   "import": 1,
   "export": 1,
   "print": 1,
   "read": 1,
   "report": 1,
   "role": "vCIO Manager",
   "share": 1,
   "write": 1
  },
  {
   "create": 1,
   "email": 1,
   "export": 1,
   "print": 1,
   "import": 1,
   "read": 1,
   "report": 1,
   "role": "Client Editor",
   "share": 1,
   "write": 1
  },
  {
   "email": 1,
   "export": 1,
   "print": 1,
   "read": 1,
   "report": 1,
   "role": "Client Viewer",
   "share": 1
  }
 ],
 "row_format": "Dynamic",
 "rows_threshold_for_grid_search": 20,
 "sort_field": "modified",
 "sort_order": "DESC",
 "states": [],
 "track_changes": 1
}


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_actual_entry/__init__.py
================================================================================


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_actual_entry/mpit_actual_entry.py
================================================================================
# Copyright (c) 2025, DOT and contributors
# For license information, please see license.txt

from __future__ import annotations

import frappe
from frappe import _
from frappe.model.document import Document
from frappe.utils import getdate
from master_plan_it import mpit_user_prefs, tax


class MPITActualEntry(Document):
	def validate(self):
		self._set_year_from_posting_date()
		self._compute_vat_split()
	
	def _compute_vat_split(self):
		"""Compute net/vat/gross for amount field with strict VAT validation."""
		# Get user default VAT rate
		default_vat = mpit_user_prefs.get_default_vat_rate(frappe.session.user)
		
		# Apply default if field is empty
		if self.vat_rate is None and default_vat is not None:
			self.vat_rate = default_vat
		
		# Strict VAT validation
		final_vat_rate = tax.validate_strict_vat(
			self.amount,
			self.vat_rate,
			default_vat,
			field_label=_("Amount")
		)
		
		# Compute split
		net, vat, gross = tax.split_net_vat_gross(
			self.amount,
			final_vat_rate,
			bool(self.amount_includes_vat)
		)
		
		self.amount_net = net
		self.amount_vat = vat
		self.amount_gross = gross

	def _set_year_from_posting_date(self) -> None:
		"""Derive MPIT Year from posting_date (idempotent)."""
		if not self.posting_date:
			frappe.throw(_("Posting Date is required to derive MPIT Year."))

		posting = getdate(self.posting_date)
		year_name = self._lookup_year_for_date(posting)

		if not year_name:
			frappe.throw(
				_("No MPIT Year covers posting date {0}. Create year {1} or set start/end dates that include the date.")
				.format(posting.isoformat(), posting.year)
			)

		# Always override to keep data consistent with the posting date.
		self.year = year_name

	def _lookup_year_for_date(self, posting_date) -> str | None:
		"""Find the MPIT Year covering a date, preferring date ranges then exact year name."""
		res = frappe.db.sql(
			"""
			SELECT name
			FROM `tabMPIT Year`
			WHERE (start_date IS NULL OR start_date <= %(date)s)
			  AND (end_date IS NULL OR end_date >= %(date)s)
			ORDER BY start_date DESC, name DESC
			LIMIT 1
			""",
			{"date": posting_date},
		)
		if res:
			return res[0][0]

		# Fallback to exact year match (name or field)
		for candidate in (str(posting_date.year), posting_date.year):
			found = frappe.db.exists("MPIT Year", candidate) or frappe.db.exists("MPIT Year", {"year": posting_date.year})
			if found:
				return found if isinstance(found, str) else str(found)

		return None


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_actual_entry/mpit_actual_entry.js
================================================================================
// Copyright (c) 2025, DOT and contributors
// For license information, please see license.txt

frappe.provide("master_plan_it.vat");

master_plan_it.vat.defaults_promise =
	master_plan_it.vat.defaults_promise ||
	frappe.call({ method: "master_plan_it.mpit_user_prefs.get_vat_defaults" }).then((r) => r.message || {});

master_plan_it.vat.apply_defaults_for_actual =
	master_plan_it.vat.apply_defaults_for_actual ||
	async function (frm) {
		if (!frm.is_new() || frm.doc.__vat_defaults_applied) {
			return;
		}

		const defaults = await master_plan_it.vat.defaults_promise;
		const updates = {};

		if (defaults.default_includes_vat !== undefined && defaults.default_includes_vat !== null) {
			updates.amount_includes_vat = defaults.default_includes_vat ? 1 : 0;
		}

		if (
			(defaults.default_vat_rate || defaults.default_vat_rate === 0) &&
			(frm.doc.vat_rate === undefined || frm.doc.vat_rate === null || frm.doc.vat_rate === "")
		) {
			updates.vat_rate = defaults.default_vat_rate;
		}

		if (Object.keys(updates).length) {
			await frm.set_value(updates);
		}

		frm.doc.__vat_defaults_applied = true;
	};

frappe.ui.form.on("MPIT Actual Entry", {
	async onload(frm) {
		await master_plan_it.vat.apply_defaults_for_actual(frm);
	},
	async refresh(frm) {
		await master_plan_it.vat.apply_defaults_for_actual(frm);
	},
});


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_budget_line/mpit_budget_line.py
================================================================================
# Copyright (c) 2025, DOT and contributors
# For license information, please see license.txt

from frappe.model.document import Document
from ..mpit_budget.mpit_budget import update_budget_totals


class MPITBudgetLine(Document):
	def after_insert(self):
		self._update_parent_totals()

	def on_update(self):
		self._update_parent_totals()

	def on_trash(self):
		self._update_parent_totals()

	def _update_parent_totals(self):
		if self.parent and getattr(self, "parenttype", None) == "MPIT Budget":
			update_budget_totals(self.parent)


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_budget_line/__init__.py
================================================================================


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_budget_line/mpit_budget_line.json
================================================================================
{
 "actions": [],
 "allow_import": 1,
 "allow_rename": 1,
 "creation": "2025-12-21 22:34:52.676437",
 "doctype": "DocType",
 "editable_grid": 1,
 "engine": "InnoDB",
 "field_order": [
  "category",
  "vendor",
  "description",
  "recurrence_rule",
  "custom_period_months",
  "period_start_date",
  "period_end_date",
  "amount",
  "amount_includes_vat",
  "amount_gross",
  "vat_rate",
  "amount_net",
  "amount_vat",
  "contract",
  "project",
  "baseline_expense",
  "annual_net",
  "annual_vat",
  "annual_gross",
  "cost_type",
  "is_portfolio_bucket",
  "is_active"
 ],
 "fields": [
  {
   "fieldname": "category",
   "fieldtype": "Link",
   "description": "Select the budget category.",
   "in_list_view": 1,
   "columns": 2,
   "label": "Category",
   "options": "MPIT Category",
   "reqd": 1
  },
  {
   "fieldname": "vendor",
   "fieldtype": "Link",
   "description": "Select the vendor for this line.",
   "in_list_view": 1,
   "columns": 1,
   "label": "Vendor",
   "options": "MPIT Vendor"
  },
  {
   "fieldname": "contract",
   "fieldtype": "Link",
   "description": "Select the related contract, if applicable.",
   "in_list_view": 0,
   "label": "Contract",
   "options": "MPIT Contract"
  },
  {
   "fieldname": "project",
   "fieldtype": "Link",
   "description": "Select the related project, if applicable.",
   "in_list_view": 0,
   "label": "Project",
   "options": "MPIT Project"
  },
  {
   "fieldname": "baseline_expense",
   "fieldtype": "Link",
   "description": "Link to the baseline expense this line is based on.",
   "label": "Baseline Expense",
   "options": "MPIT Baseline Expense"
  },
  {
   "fieldname": "description",
   "fieldtype": "Small Text",
   "description": "Describe this budget line.",
   "in_list_view": 1,
   "columns": 3,
   "label": "Description"
  },
  {
   "fieldname": "amount",
   "fieldtype": "Currency",
   "description": "Enter the budgeted amount; use net or gross per the VAT setting.",
   "in_list_view": 1,
   "columns": 1,
   "label": "Amount"
  },
  {
   "default": "OPEX",
   "fieldname": "cost_type",
   "fieldtype": "Select",
   "description": "Choose whether the cost is CAPEX or OPEX.",
   "label": "Cost Type",
   "options": "CAPEX\nOPEX"
  },
  {
   "default": "0",
   "fieldname": "is_portfolio_bucket",
   "fieldtype": "Check",
   "description": "If enabled, this line acts as a portfolio bucket.",
   "label": "Is Portfolio Bucket"
  },
  {
   "default": "1",
   "fieldname": "is_active",
   "fieldtype": "Check",
   "description": "If enabled, the budget line is active.",
   "label": "Is Active"
  },
  {
   "default": "0",
   "fieldname": "amount_includes_vat",
   "fieldtype": "Check",
   "description": "If enabled, the amount includes VAT.",
   "in_list_view": 1,
   "columns": 1,
   "label": "VAT Included?"
  },
  {
   "fieldname": "vat_rate",
   "fieldtype": "Percent",
   "description": "VAT rate applied to the amount.",
   "label": "VAT Rate",
   "precision": "2"
  },
  {
   "fieldname": "amount_net",
   "fieldtype": "Currency",
   "description": "Calculated automatically from amount and VAT settings.",
   "label": "Net Amount",
   "read_only": 1
  },
  {
   "fieldname": "amount_vat",
   "fieldtype": "Currency",
   "description": "Calculated automatically as the VAT portion.",
   "label": "VAT Amount",
   "read_only": 1
  },
  {
   "fieldname": "amount_gross",
   "fieldtype": "Currency",
   "description": "Calculated automatically as the gross amount.",
   "in_list_view": 1,
   "columns": 1,
   "label": "Gross Amount",
   "read_only": 1
  },
  {
   "default": "None",
   "fieldname": "recurrence_rule",
   "fieldtype": "Select",
   "description": "Choose how this amount recurs for annualization.",
   "in_list_view": 1,
   "columns": 1,
   "label": "Recurrence Rule",
   "options": "Monthly\nQuarterly\nAnnual\nCustom\nNone"
  },
  {
   "depends_on": "eval:doc.recurrence_rule=='Custom'",
   "fieldname": "custom_period_months",
   "fieldtype": "Int",
   "description": "Number of months per cycle when using a Custom recurrence.",
   "label": "Custom Period (Months)"
  },
  {
   "fieldname": "period_start_date",
   "fieldtype": "Date",
   "description": "Start date of the period used to calculate overlap with the budget year.",
   "label": "Period Start Date"
  },
  {
   "fieldname": "period_end_date",
   "fieldtype": "Date",
   "description": "End date of the period used to calculate overlap with the budget year.",
   "label": "Period End Date"
  },
  {
   "fieldname": "annual_net",
   "fieldtype": "Currency",
   "description": "Calculated automatically as the annualized net amount.",
   "label": "Annual Net Amount",
   "read_only": 1
  },
  {
   "fieldname": "annual_vat",
   "fieldtype": "Currency",
   "description": "Calculated automatically as the annualized VAT amount.",
   "label": "Annual VAT Amount",
   "read_only": 1
  },
  {
   "fieldname": "annual_gross",
   "fieldtype": "Currency",
   "description": "Calculated automatically as the annualized gross amount.",
   "label": "Annual Gross Amount",
   "read_only": 1
  }
 ],
 "grid_page_length": 50,
 "index_web_pages_for_search": 1,
 "istable": 1,
 "links": [],
 "modified": "2025-12-24 20:00:46.539881",
 "modified_by": "Administrator",
 "module": "Master Plan IT",
 "name": "MPIT Budget Line",
 "owner": "Administrator",
 "permissions": [],
 "row_format": "Dynamic",
 "rows_threshold_for_grid_search": 20,
 "sort_field": "modified",
 "sort_order": "DESC",
 "states": [],
 "track_changes": 1
}


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_vendor/test_mpit_vendor.py
================================================================================
# Copyright (c) 2025, DOT and Contributors
# See license.txt

# import frappe
from frappe.tests.utils import FrappeTestCase


class TestMPITVendor(FrappeTestCase):
	pass


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_vendor/mpit_vendor.py
================================================================================
# Copyright (c) 2025, DOT and contributors
# For license information, please see license.txt

# import frappe
from frappe.model.document import Document


class MPITVendor(Document):
	pass


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_vendor/mpit_vendor.js
================================================================================
// Copyright (c) 2025, DOT and contributors
// For license information, please see license.txt

// frappe.ui.form.on("MPIT Vendor", {
// 	refresh(frm) {

// 	},
// });


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_vendor/__init__.py
================================================================================


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_vendor/mpit_vendor.json
================================================================================
{
 "actions": [],
 "allow_import": 1,
 "allow_rename": 1,
 "autoname": "field:vendor_name",
 "creation": "2025-12-21 22:34:30.512825",
 "doctype": "DocType",
 "editable_grid": 1,
 "engine": "InnoDB",
 "field_order": [
  "vendor_name",
  "vat_id",
  "contact_email",
  "contact_phone",
  "notes",
  "is_active"
 ],
 "fields": [
  {
   "fieldname": "vendor_name",
   "fieldtype": "Data",
   "description": "Enter the vendor name.",
   "in_list_view": 1,
   "label": "Vendor Name",
   "reqd": 1,
   "unique": 1
  },
  {
   "fieldname": "vat_id",
   "fieldtype": "Data",
   "description": "Enter the vendor VAT ID.",
   "label": "VAT ID"
  },
  {
   "fieldname": "contact_email",
   "fieldtype": "Data",
   "description": "Enter the main contact email.",
   "label": "Contact Email"
  },
  {
   "fieldname": "contact_phone",
   "fieldtype": "Data",
   "description": "Enter the main contact phone number.",
   "label": "Contact Phone"
  },
  {
   "fieldname": "notes",
   "fieldtype": "Small Text",
   "description": "Add internal notes about the vendor.",
   "label": "Notes"
  },
  {
   "default": "1",
   "fieldname": "is_active",
   "fieldtype": "Check",
   "description": "If enabled, the vendor is active for selection.",
   "label": "Is Active"
  }
 ],
 "grid_page_length": 50,
 "index_web_pages_for_search": 1,
 "links": [],
 "modified": "2025-12-24 20:00:40.721094",
 "modified_by": "Administrator",
 "module": "Master Plan IT",
 "name": "MPIT Vendor",
 "owner": "Administrator",
 "permissions": [
  {
   "create": 1,
   "delete": 1,
   "email": 1,
   "import": 1,
   "export": 1,
   "print": 1,
   "read": 1,
   "report": 1,
   "role": "System Manager",
   "share": 1,
   "write": 1
  },
  {
   "create": 1,
   "delete": 1,
   "email": 1,
   "import": 1,
   "export": 1,
   "print": 1,
   "read": 1,
   "report": 1,
   "role": "vCIO Manager",
   "share": 1,
   "write": 1
  },
  {
   "create": 1,
   "delete": 1,
   "email": 1,
   "export": 1,
   "print": 1,
   "read": 1,
   "report": 1,
   "role": "Client Editor",
   "share": 1,
   "write": 1
  },
  {
   "email": 1,
   "export": 1,
   "print": 1,
   "read": 1,
   "report": 1,
   "role": "Client Viewer",
   "share": 1
  }
 ],
 "quick_entry": 1,
 "row_format": "Dynamic",
 "rows_threshold_for_grid_search": 20,
 "sort_field": "modified",
 "sort_order": "DESC",
 "states": [],
 "title_field": "vendor_name",
 "track_changes": 1
}


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_project/mpit_project.json
================================================================================
{
 "actions": [],
 "allow_import": 1,
 "allow_rename": 1,
 "creation": "2025-12-21 22:34:51.970208",
 "doctype": "DocType",
 "editable_grid": 1,
 "engine": "InnoDB",
 "field_order": [
  "tab_overview",
  "title",
  "status",
  "owner_user",
  "start_date",
  "end_date",
  "description",
  "tab_financial",
  "financial_summary",
  "planned_total_net",
  "quoted_total_net",
  "expected_total_net",
  "tab_allocations",
  "alloc_section",
  "allocations",
  "tab_quotes",
  "quotes_section",
  "quotes",
  "tab_milestones",
  "milestones_section",
  "milestones"
 ],
 "fields": [
  {
   "fieldname": "tab_overview",
   "fieldtype": "Tab Break",
   "label": "Overview"
  },
  {
   "fieldname": "title",
   "fieldtype": "Data",
   "description": "Enter the project title.",
   "in_list_view": 1,
   "label": "Title",
   "reqd": 1
  },
  {
   "default": "Draft",
   "fieldname": "status",
   "fieldtype": "Select",
   "description": "Choose the project status; at least one allocation is required before approval or later states.",
   "in_list_view": 1,
   "label": "Status",
   "options": "Draft\nProposed\nApproved\nIn Progress\nOn Hold\nCompleted\nCancelled"
  },
  {
   "fieldname": "owner_user",
   "fieldtype": "Link",
   "description": "Select the project owner.",
   "label": "Owner",
   "options": "User"
  },
  {
   "fieldname": "start_date",
   "fieldtype": "Date",
   "description": "Date when the project starts.",
   "label": "Start Date"
  },
  {
   "fieldname": "end_date",
   "fieldtype": "Date",
   "description": "Date when the project ends.",
   "label": "End Date"
  },
  {
   "fieldname": "description",
   "fieldtype": "Small Text",
   "description": "Add a brief description of the project.",
   "label": "Description"
  },
  {
   "fieldname": "tab_financial",
   "fieldtype": "Tab Break",
   "label": "Financials"
  },
  {
   "fieldname": "financial_summary",
   "fieldtype": "HTML",
   "label": "Financial Summary",
   "read_only": 1
  },
  {
   "fieldname": "planned_total_net",
   "fieldtype": "Currency",
   "description": "Total planned net from allocations.",
   "label": "Planned Total (Net)",
   "read_only": 1
  },
  {
   "fieldname": "quoted_total_net",
   "fieldtype": "Currency",
   "description": "Total quoted net amount.",
   "label": "Quoted Total (Net)",
   "read_only": 1
  },
  {
   "fieldname": "expected_total_net",
   "fieldtype": "Currency",
   "description": "Expected total (quoted if present, otherwise planned).",
   "label": "Expected Total (Net)",
   "read_only": 1
  },
  {
   "fieldname": "tab_allocations",
   "fieldtype": "Tab Break",
   "label": "Allocations"
  },
  {
   "fieldname": "alloc_section",
   "fieldtype": "Section Break",
   "label": "Allocations"
  },
  {
   "fieldname": "allocations",
   "fieldtype": "Table",
   "description": "Add one or more allocations with year and planned amount.",
   "label": "Allocations",
   "options": "MPIT Project Allocation"
  },
  {
   "fieldname": "tab_quotes",
   "fieldtype": "Tab Break",
   "label": "Quotes"
  },
  {
   "fieldname": "quotes_section",
   "fieldtype": "Section Break",
   "label": "Quotes"
  },
  {
   "fieldname": "quotes",
   "fieldtype": "Table",
   "description": "Add vendor quotes for this project.",
   "label": "Quotes",
   "options": "MPIT Project Quote"
  },
  {
   "fieldname": "tab_milestones",
   "fieldtype": "Tab Break",
   "label": "Milestones"
  },
  {
   "fieldname": "milestones_section",
   "fieldtype": "Section Break",
   "label": "Milestones"
  },
  {
   "fieldname": "milestones",
   "fieldtype": "Table",
   "description": "Add project milestones.",
   "label": "Milestones",
   "options": "MPIT Project Milestone"
  }
 ],
 "grid_page_length": 50,
 "index_web_pages_for_search": 1,
 "links": [],
 "modified": "2025-12-24 20:00:45.088553",
 "modified_by": "Administrator",
 "module": "Master Plan IT",
 "name": "MPIT Project",
 "owner": "Administrator",
 "permissions": [
  {
   "create": 1,
   "delete": 1,
   "email": 1,
   "import": 1,
   "export": 1,
   "print": 1,
   "read": 1,
   "report": 1,
   "role": "System Manager",
   "share": 1,
   "write": 1
  },
  {
   "create": 1,
   "delete": 1,
   "email": 1,
   "import": 1,
   "export": 1,
   "print": 1,
   "read": 1,
   "report": 1,
   "role": "vCIO Manager",
   "share": 1,
   "write": 1
  },
  {
   "create": 1,
   "email": 1,
   "export": 1,
   "print": 1,
   "read": 1,
   "report": 1,
   "role": "Client Editor",
   "share": 1,
   "write": 1
  },
  {
   "email": 1,
   "export": 1,
   "print": 1,
   "read": 1,
   "report": 1,
   "role": "Client Viewer",
   "share": 1
  }
 ],
 "row_format": "Dynamic",
 "rows_threshold_for_grid_search": 20,
 "sort_field": "modified",
 "sort_order": "DESC",
 "states": [],
 "title_field": "title",
 "track_changes": 1
}


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_project/__init__.py
================================================================================


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_project/test_mpit_project.py
================================================================================
# Copyright (c) 2025, DOT and Contributors
# See license.txt

import frappe
from frappe.tests.utils import FrappeTestCase


class TestMPITProject(FrappeTestCase):
	def setUp(self):
		if not frappe.db.exists("MPIT Year", "2031"):
			frappe.get_doc({"doctype": "MPIT Year", "year": 2031, "start_date": "2031-01-01", "end_date": "2031-12-31"}).insert()

	def test_requires_allocation_before_approval(self):
		doc = frappe.get_doc({
			"doctype": "MPIT Project",
			"title": "Test Project",
			"status": "Approved",
		})
		with self.assertRaises(frappe.ValidationError):
			doc.insert()

		doc.append("allocations", {"year": "2031", "planned_amount": 1000})
		doc.insert()  # should now succeed


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_project/mpit_project.py
================================================================================
# Copyright (c) 2025, DOT and contributors
# For license information, please see license.txt

from __future__ import annotations

import frappe
from frappe import _
from frappe.model.document import Document
from frappe.model.naming import getseries
from frappe.utils import flt
from master_plan_it import mpit_user_prefs, tax


class MPITProject(Document):
	def autoname(self):
		"""Generate name: PRJ-{NNNN} based on user preferences."""
		from master_plan_it import mpit_user_prefs
		
		# Get user preferences for prefix and digits
		prefix, digits = mpit_user_prefs.get_project_series(user=frappe.session.user)
		
		# Generate name: PRJ-0001, PRJ-0002, etc.
		# getseries returns only the number part, we need to add prefix
		series_key = f"{prefix}.####"
		sequence = getseries(series_key, digits)
		self.name = f"{prefix}{sequence}"
	
	def validate(self):
		self._require_allocations_for_approval()
		self._compute_allocations_vat_split()
		self._compute_quotes_vat_split()
		self._compute_project_totals()
	
	def _compute_allocations_vat_split(self):
		"""Compute net/vat/gross for all Project Allocations with strict VAT validation."""
		default_vat = mpit_user_prefs.get_default_vat_rate(frappe.session.user)
		
		for alloc in self.allocations:
			if alloc.vat_rate is None and default_vat is not None:
				alloc.vat_rate = default_vat
			
			final_vat_rate = tax.validate_strict_vat(
				alloc.planned_amount,
				alloc.vat_rate,
				default_vat,
				field_label=_("Allocation {0} Planned Amount").format(alloc.idx)
			)
			
			net, vat, gross = tax.split_net_vat_gross(
				alloc.planned_amount,
				final_vat_rate,
				bool(alloc.planned_amount_includes_vat)
			)
			
			alloc.planned_amount_net = net
			alloc.planned_amount_vat = vat
			alloc.planned_amount_gross = gross
	
	def _compute_quotes_vat_split(self):
		"""Compute net/vat/gross for all Project Quotes with strict VAT validation."""
		default_vat = mpit_user_prefs.get_default_vat_rate(frappe.session.user)
		
		for quote in self.quotes:
			if quote.vat_rate is None and default_vat is not None:
				quote.vat_rate = default_vat
			
			final_vat_rate = tax.validate_strict_vat(
				quote.amount,
				quote.vat_rate,
				default_vat,
				field_label=_("Quote {0} Amount").format(quote.idx)
			)
			
			net, vat, gross = tax.split_net_vat_gross(
				quote.amount,
				final_vat_rate,
				bool(quote.amount_includes_vat)
			)
			
			quote.amount_net = net
			quote.amount_vat = vat
			quote.amount_gross = gross

	def _compute_project_totals(self) -> None:
		"""Persist planned/quoted/expected totals based on child tables (net amounts)."""
		planned_total = 0.0
		for alloc in (self.allocations or []):
			planned_total += flt(getattr(alloc, "planned_amount_net", None) or alloc.planned_amount or 0)

		quoted_total = 0.0
		for quote in (self.quotes or []):
			quoted_total += flt(getattr(quote, "amount_net", None) or quote.amount or 0)

		expected_total = quoted_total if quoted_total > 0 else planned_total

		self.planned_total_net = flt(planned_total, 2)
		self.quoted_total_net = flt(quoted_total, 2)
		self.expected_total_net = flt(expected_total, 2)

	def _require_allocations_for_approval(self) -> None:
		"""Ensure at least one allocation exists before approval or later states."""
		required_for_status = {"Approved", "In Progress", "On Hold", "Completed", "Cancelled"}
		if self.status in required_for_status and not self.allocations:
			frappe.throw(
				_("Add at least one Allocation (year + planned amount) before moving a project to status {0}.").format(
					self.status
				)
			)


@frappe.whitelist()
def get_project_actuals_totals(project: str) -> dict:
	"""Return actual totals for a project (net) without persisting on the Project doc."""
	if not project:
		return {"actual_total_net": 0.0}

	row = frappe.db.sql(
		"""
		SELECT SUM(COALESCE(amount_net, amount)) AS actual_total
		FROM `tabMPIT Actual Entry`
		WHERE project = %(project)s
		""",
		{"project": project},
	)
	actual_total = flt(row[0][0] or 0) if row else 0.0
	return {"actual_total_net": actual_total}


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_project/mpit_project.js
================================================================================
// Copyright (c) 2025, DOT and contributors
// For license information, please see license.txt

frappe.provide("master_plan_it.vat");
frappe.provide("master_plan_it.project");

master_plan_it.vat.defaults_promise =
	master_plan_it.vat.defaults_promise ||
	frappe.call({ method: "master_plan_it.mpit_user_prefs.get_vat_defaults" }).then((r) => r.message || {});

master_plan_it.vat.apply_defaults_for_project_allocation =
	master_plan_it.vat.apply_defaults_for_project_allocation ||
	async function (cdt, cdn) {
		const row = frappe.get_doc(cdt, cdn);
		if (!row || row.__islocal === false || row.__vat_defaults_applied) {
			return;
		}

		const defaults = await master_plan_it.vat.defaults_promise;
		const updates = {};

		if (defaults.default_includes_vat !== undefined && defaults.default_includes_vat !== null) {
			updates.planned_amount_includes_vat = defaults.default_includes_vat ? 1 : 0;
		}

		if (
			(defaults.default_vat_rate || defaults.default_vat_rate === 0) &&
			(row.vat_rate === undefined || row.vat_rate === null || row.vat_rate === "")
		) {
			updates.vat_rate = defaults.default_vat_rate;
		}

		if (Object.keys(updates).length) {
			frappe.model.set_value(cdt, cdn, updates);
		}

		row.__vat_defaults_applied = true;
	};

	frappe.ui.form.on("MPIT Project", {
		async allocations_add(_frm, cdt, cdn) {
			await master_plan_it.vat.apply_defaults_for_project_allocation(cdt, cdn);
		},
		async refresh(frm) {
			await master_plan_it.project.render_financial_summary(frm);
		},
	});

master_plan_it.project.render_financial_summary =
	master_plan_it.project.render_financial_summary ||
	async function (frm) {
		const summary_field = frm.fields_dict && frm.fields_dict.financial_summary;
		if (!summary_field || !summary_field.$wrapper) {
			return;
		}

		const planned = frm.doc.planned_total_net || 0;
		const quoted = frm.doc.quoted_total_net || 0;
		const expected = frm.doc.expected_total_net || planned;

		let actual = 0;
		if (frm.doc.name) {
			const res = await frappe.call({
				method: "master_plan_it.master_plan_it.doctype.mpit_project.mpit_project.get_project_actuals_totals",
				args: { project: frm.doc.name },
			});
			actual = (res.message && res.message.actual_total_net) || 0;
		}

		const variance_expected = actual - expected;
		const variance_planned = actual - planned;

		const format_currency = (value) => frappe.format(value || 0, { fieldtype: "Currency" });
		const html = `
			<div class="mpit-project-summary">
				<table class="table table-bordered" style="margin-bottom: 0">
					<thead>
						<tr>
							<th>${__("Planned")}</th>
							<th>${__("Quoted")}</th>
							<th>${__("Expected")}</th>
							<th>${__("Actual")}</th>
							<th>${__("Variance vs Expected")}</th>
							<th>${__("Variance vs Planned")}</th>
						</tr>
					</thead>
					<tbody>
						<tr>
							<td>${format_currency(planned)}</td>
							<td>${format_currency(quoted)}</td>
							<td>${format_currency(expected)}</td>
							<td>${format_currency(actual)}</td>
							<td class="${variance_expected < 0 ? "text-danger" : "text-success"}">${format_currency(variance_expected)}</td>
							<td class="${variance_planned < 0 ? "text-danger" : "text-success"}">${format_currency(variance_planned)}</td>
						</tr>
					</tbody>
				</table>
			</div>
		`;

		summary_field.$wrapper.html(html);
	};


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_project_milestone/mpit_project_milestone.json
================================================================================
{
 "actions": [],
 "allow_rename": 1,
 "creation": "2025-12-21 22:34:29.884438",
 "doctype": "DocType",
 "editable_grid": 1,
 "engine": "InnoDB",
 "field_order": [
  "title",
  "status",
  "due_date",
  "acceptance_date",
  "attachment",
  "notes"
 ],
 "fields": [
  {
   "fieldname": "title",
   "fieldtype": "Data",
   "description": "Enter the milestone title.",
   "in_list_view": 1,
   "columns": 2,
   "label": "Title",
   "reqd": 1
  },
  {
   "fieldname": "due_date",
   "fieldtype": "Date",
   "description": "Date when the milestone is due.",
   "in_list_view": 1,
   "columns": 1,
   "label": "Due Date"
  },
  {
   "default": "Planned",
   "fieldname": "status",
   "fieldtype": "Select",
   "description": "Choose the milestone status.",
   "in_list_view": 1,
   "columns": 1,
   "label": "Status",
   "options": "Planned\nDone\nAccepted"
  },
  {
   "fieldname": "acceptance_date",
   "fieldtype": "Date",
   "description": "Date when the milestone was accepted.",
   "in_list_view": 1,
   "columns": 1,
   "label": "Acceptance Date"
  },
  {
   "fieldname": "notes",
   "fieldtype": "Small Text",
   "description": "Add notes about the milestone.",
   "in_list_view": 1,
   "columns": 3,
   "label": "Notes"
  },
  {
   "fieldname": "attachment",
   "fieldtype": "Attach",
   "description": "Upload any supporting attachment.",
   "in_list_view": 1,
   "columns": 2,
   "label": "Attachment"
  }
 ],
 "grid_page_length": 50,
 "index_web_pages_for_search": 1,
 "istable": 1,
 "links": [],
 "modified": "2025-12-24 20:00:38.695541",
 "modified_by": "Administrator",
 "module": "Master Plan IT",
 "name": "MPIT Project Milestone",
 "owner": "Administrator",
 "permissions": [],
 "row_format": "Dynamic",
 "rows_threshold_for_grid_search": 20,
 "sort_field": "modified",
 "sort_order": "DESC",
 "states": [],
 "track_changes": 1
}


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_project_milestone/__init__.py
================================================================================


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_project_milestone/mpit_project_milestone.py
================================================================================
# Copyright (c) 2025, DOT and contributors
# For license information, please see license.txt

# import frappe
from frappe.model.document import Document


class MPITProjectMilestone(Document):
	pass


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_budget_amendment/mpit_budget_amendment.py
================================================================================
# Copyright (c) 2025, DOT and contributors
# For license information, please see license.txt

import frappe
from frappe import _
from frappe.model.document import Document
from master_plan_it import mpit_user_prefs, tax


class MPITBudgetAmendment(Document):
	def validate(self):
		self._enforce_status_invariants()
		self._compute_lines_vat_split()
	
	def _compute_lines_vat_split(self):
		"""Compute net/vat/gross for all Amendment Lines with strict VAT validation."""
		default_vat = mpit_user_prefs.get_default_vat_rate(frappe.session.user)
		
		for line in self.lines:
			if line.vat_rate is None and default_vat is not None:
				line.vat_rate = default_vat
			
			final_vat_rate = tax.validate_strict_vat(
				line.delta_amount,
				line.vat_rate,
				default_vat,
				field_label=frappe._("Line {0} Delta Amount").format(line.idx)
			)
			
			net, vat, gross = tax.split_net_vat_gross(
				line.delta_amount,
				final_vat_rate,
				bool(line.delta_amount_includes_vat)
			)
			
			line.delta_amount_net = net
			line.delta_amount_vat = vat
			line.delta_amount_gross = gross

	def _enforce_status_invariants(self) -> None:
		"""Keep workflow_state aligned with docstatus now that it is an editable status label."""
		if not self.workflow_state:
			self.workflow_state = "Draft"

		if self.docstatus == 0 and self.workflow_state == "Approved":
			frappe.throw(_("Draft Budget Amendment cannot be set to Approved. Submit the document to approve it."))

		if self.docstatus == 1 and self.workflow_state != "Approved":
			self.workflow_state = "Approved"

	def on_submit(self):
		# Ensure submitted amendments always reflect Approved status
		if self.workflow_state != "Approved":
			self.workflow_state = "Approved"
			self.db_set("workflow_state", "Approved")


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_budget_amendment/test_mpit_budget_amendment.py
================================================================================
# Copyright (c) 2025, DOT and Contributors
# See license.txt

# import frappe
from frappe.tests.utils import FrappeTestCase


class TestMPITBudgetAmendment(FrappeTestCase):
	pass


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_budget_amendment/__init__.py
================================================================================


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_budget_amendment/mpit_budget_amendment.js
================================================================================
// Copyright (c) 2025, DOT and contributors
// For license information, please see license.txt

frappe.provide("master_plan_it.vat");

master_plan_it.vat.defaults_promise =
	master_plan_it.vat.defaults_promise ||
	frappe.call({ method: "master_plan_it.mpit_user_prefs.get_vat_defaults" }).then((r) => r.message || {});

master_plan_it.vat.apply_defaults_for_amendment_line =
	master_plan_it.vat.apply_defaults_for_amendment_line ||
	async function (cdt, cdn) {
		const row = frappe.get_doc(cdt, cdn);
		if (!row || row.__islocal === false || row.__vat_defaults_applied) {
			return;
		}

		const defaults = await master_plan_it.vat.defaults_promise;
		const updates = {};

		if (defaults.default_includes_vat !== undefined && defaults.default_includes_vat !== null) {
			updates.delta_amount_includes_vat = defaults.default_includes_vat ? 1 : 0;
		}

		if (
			(defaults.default_vat_rate || defaults.default_vat_rate === 0) &&
			(row.vat_rate === undefined || row.vat_rate === null || row.vat_rate === "")
		) {
			updates.vat_rate = defaults.default_vat_rate;
		}

		if (Object.keys(updates).length) {
			frappe.model.set_value(cdt, cdn, updates);
		}

		row.__vat_defaults_applied = true;
	};

frappe.ui.form.on("MPIT Budget Amendment", {
	async lines_add(_frm, cdt, cdn) {
		await master_plan_it.vat.apply_defaults_for_amendment_line(cdt, cdn);
	},
});


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/master_plan_it/doctype/mpit_budget_amendment/mpit_budget_amendment.json
================================================================================
{
 "actions": [],
 "allow_import": 1,
 "allow_rename": 1,
 "creation": "2025-12-21 22:34:53.603929",
 "doctype": "DocType",
 "editable_grid": 1,
 "engine": "InnoDB",
 "field_order": [
  "tab_overview",
  "budget",
  "effective_date",
  "workflow_state",
  "reason",
  "tab_lines",
  "lines_section",
  "lines",
  "tab_admin",
  "amended_from"
 ],
 "fields": [
  {
   "fieldname": "tab_overview",
   "fieldtype": "Tab Break",
   "label": "Overview"
  },
  {
   "fieldname": "budget",
   "fieldtype": "Link",
   "description": "Select the budget being amended.",
   "in_list_view": 1,
   "label": "Budget",
   "options": "MPIT Budget",
   "reqd": 1
  },
  {
   "fieldname": "effective_date",
   "fieldtype": "Date",
   "description": "Date when this amendment takes effect.",
   "in_list_view": 1,
   "label": "Effective Date"
  },
  {
   "allow_on_submit": 1,
   "fieldname": "workflow_state",
   "fieldtype": "Select",
   "default": "Draft",
   "description": "Editable status label for the amendment.",
   "in_list_view": 1,
   "label": "Status",
   "options": "Draft\nProposed\nIn Review\nApproved\nRejected",
   "read_only": 0
  },
  {
   "fieldname": "reason",
   "fieldtype": "Small Text",
   "description": "Describe why the budget is being amended.",
   "label": "Reason"
  },
  {
   "fieldname": "tab_lines",
   "fieldtype": "Tab Break",
   "label": "Lines"
  },
  {
   "fieldname": "lines_section",
   "fieldtype": "Section Break",
   "label": "Lines"
  },
  {
   "fieldname": "lines",
   "fieldtype": "Table",
   "description": "Add amendment lines detailing the changes.",
   "label": "Lines",
   "options": "MPIT Amendment Line"
  },
  {
   "fieldname": "tab_admin",
   "fieldtype": "Tab Break",
   "label": "Admin"
  },
  {
   "fieldname": "amended_from",
   "fieldtype": "Link",
   "description": "Reference to the original amendment this document was copied from.",
   "label": "Amended From",
   "no_copy": 1,
   "options": "MPIT Budget Amendment",
   "print_hide": 1,
   "read_only": 1,
   "search_index": 1
  }
 ],
 "grid_page_length": 50,
 "index_web_pages_for_search": 1,
 "is_submittable": 1,
 "links": [],
 "modified": "2025-12-24 20:00:50.239668",
 "modified_by": "Administrator",
 "module": "Master Plan IT",
 "name": "MPIT Budget Amendment",
 "owner": "Administrator",
 "permissions": [
  {
   "cancel": 1,
   "create": 1,
   "delete": 1,
   "email": 1,
   "import": 1,
   "export": 1,
   "print": 1,
   "read": 1,
   "report": 1,
   "role": "System Manager",
   "share": 1,
   "submit": 1,
   "write": 1
  },
  {
   "cancel": 1,
   "create": 1,
   "delete": 1,
   "email": 1,
   "import": 1,
   "export": 1,
   "print": 1,
   "read": 1,
   "report": 1,
   "role": "vCIO Manager",
   "share": 1,
   "submit": 1,
   "write": 1
  },
  {
   "create": 1,
   "delete": 1,
   "email": 1,
   "export": 1,
   "print": 1,
   "read": 1,
   "report": 1,
   "role": "Client Editor",
   "share": 1,
   "submit": 1,
   "write": 1
  },
  {
   "email": 1,
   "export": 1,
   "print": 1,
   "read": 1,
   "report": 1,
   "role": "Client Viewer",
   "share": 1
  }
 ],
 "row_format": "Dynamic",
 "rows_threshold_for_grid_search": 20,
 "sort_field": "modified",
 "sort_order": "DESC",
 "states": [],
 "track_changes": 1
}


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/translations/it.csv
================================================================================
source_string,translated_string,context
Overview,Panoramica,
Billing,Fatturazione,
Renewal & Dates,Rinnovo e Date,
Admin,Amministrazione,
Acceptance Date,Data di accettazione,
Accepted,Accettato,
Active,Attivo,
Actual,Effettivo,
Actual Amount,Importo effettivo,
Actual Entries,Registrazioni consuntive,
Add at least one Allocation (year + planned amount) before moving a project to status {0}.,Aggiungi almeno un'Allocazione (anno + importo previsto) prima di cambiare lo stato del progetto in {0}.,
Allocation {0} Planned Amount,Importo previsto allocazione {0},
Allocations,Allocazioni,
Amended From,Modificato da,
Amendments,Variazioni,
Amendments Delta,Delta variazioni,
Amount,Importo,
Amount Includes VAT,Importo IVA inclusa,
Annual,Annuale,
Annual Gross Amount,Importo lordo annuale,
Annual Net Amount,Importo netto annuale,
Annual Renewal,Rinnovo annuale,
Annual VAT Amount,IVA annuale,
Approve,Approva,
Approved,Approvato,
Approved Budget vs Actual,Budget approvato vs Effettivo,
Approved Date,Data approvazione,
Archived,Archiviato,
Attachment,Allegato,
Attachments,Allegati,
Auto Renew,Rinnovo automatico,
Baseline,Baseline,
Baseline Amount,Importo baseline,
Baseline Expense,Spesa baseline,
Baseline Expense period ({0} to {1}) has zero overlap with fiscal year {2}. Cannot save baseline expense with no temporal overlap.,Il periodo della spesa baseline ({0} - {1}) non si sovrappone con l'anno fiscale {2}. Impossibile salvare la spesa baseline senza sovrapposizione temporale.,
Billing Cycle,Ciclo di fatturazione,
Budget,Budget,
Budget Allocations,Allocazioni budget,
Budget Amendments,Variazioni budget,
Budget Amount,Importo budget,
Budget Line Ref,Rif. riga budget,
Budget Lines,Righe budget,
Budget Prefix,Prefisso budget,
Budget Sequence Digits,Cifre sequenza budget,
Budget naming requires year parameter (Budget.year field),La nomenclatura del budget richiede il parametro anno (campo Budget.year),
Budgets,Budget,
CAPEX,CAPEX,
Cancelled,Annullato,
Categories,Categorie,
Category,Categoria,
Category Name,Nome categoria,
Client Editor,Client Editor,
Completed,Completato,
Contact Email,Email contatto,
Contact Phone,Telefono contatto,
Contract,Contratto,
Contract End,Fine contratto,
Contract Kind,Tipo contratto,
Contract Renewals Window,Finestra rinnovi contratto,
Contract Start,Inizio contratto,
Contracts,Contratti,
Cost Type,Tipo costo,
Count,Conteggio,
Currency,Valuta,
Current Amount,Importo attuale,
Current Amount Includes VAT,Importo attuale IVA inclusa,
Current Budget,Budget corrente,
Current Budget vs Actual,Budget corrente vs Effettivo,
Custom,Personalizzato,
Custom Period (Months),Periodo personalizzato (mesi),
Custom recurrence rule requires custom_period_months to be specified,La regola di ricorrenza personalizzata richiede che sia specificato custom_period_months,
Days Forward,Giorni in avanti,
Days to Renewal,Giorni al rinnovo,
Default Amount Includes VAT,Importo predefinito IVA inclusa,
Default VAT Rate,Aliquota IVA predefinita,
Delta Amount,Importo delta,
Delta Amount Includes VAT,Importo delta IVA inclusa,
Description,Descrizione,
Done,Completato,
Draft,Bozza,
Due Date,Data scadenza,
Effective Date,Data di effetto,
End Date,Data fine,
Expense Kind,Tipo di spesa,
Expired,Scaduto,
Excel,Excel,
Expired Contracts,Contratti scaduti,
Expired Count,Numero scaduti,
Fiscal Year,Anno fiscale,
From Date,Data iniziale,
Generated on,Generato il,
Gross Amount,Importo lordo,
Gross Delta Amount,Importo lordo delta,
Gross Planned Amount,Importo lordo previsto,
In Progress,In corso,
In Review,In revisione,
Insights,Approfondimenti,
Include Past,Includi passati,
Is Active,Attivo,
Is Group,È gruppo,
Is Portfolio Bucket,Bucket di portafoglio,
Last Year,Anno precedente,
Left,Sinistra,
Line {0} Amount,Importo riga {0},
Line {0} Delta Amount,Importo delta riga {0},
Line {0}: Period ({1} to {2}) has zero overlap with fiscal year {3}. Cannot save budget line with no temporal overlap.,Riga {0}: Il periodo ({1} - {2}) non si sovrappone con l'anno fiscale {3}. Impossibile salvare la riga di budget senza sovrapposizione temporale.,
Lines,Righe,
MPIT Approved Budget vs Actual,MPIT Budget approvato vs Effettivo,
MPIT Budget,MPIT Budget,
MPIT Budget Amendment,MPIT Budget Amendment,
MPIT Budget Amendment Workflow,MPIT Budget Amendment Workflow,
MPIT Budget Professional,MPIT Budget Professionale,
MPIT Budget Workflow,MPIT Budget Workflow,
MPIT Budget vs Actual (Approved),MPIT Budget vs Effettivo (Approvato),
MPIT Current Budget vs Actual,MPIT Budget corrente vs Effettivo,
MPIT Project,Progetto MPIT,
MPIT Project Professional,Progetto MPIT Professionale,
MPIT Projects Planned vs Actual,Progetti MPIT: Previsto vs Effettivo,
MPIT Renewals Window,Finestra rinnovi MPIT,
MPIT Renewals by Month,Rinnovi MPIT per mese,
MPIT User Preferences,Preferenze utente MPIT,
Maintenance,Manutenzione,
Master Plan IT,Master Plan IT,
Master Plan IT Overview,Panoramica Master Plan IT,
Milestones,Milestone,
Monthly,Mensile,
More,Altri moduli,
N/A,N/D,
Naming Preferences,Preferenze di nomenclatura,
Needs Clarification,Richiede chiarimenti,
Net Amount,Importo netto,
Net Delta Amount,Importo netto delta,
Net Planned Amount,Importo netto previsto,
Next Renewal,Prossimo rinnovo,
Next Renewal Date,Prossima data di rinnovo,
No MPIT Year covers posting date {0}. Create year {1} or set start/end dates that include the date.,Nessun Anno MPIT copre la data {0}. Crea l'anno {1} o imposta date di inizio/fine che includano la data.,
No data available,Nessun dato disponibile,
No renewals in this window,Nessun rinnovo in questa finestra,
None,Nessuna,
Normal,Normale,
Note,Nota,
Notes,Note,
Notice Days,Giorni di preavviso,
OPEX,OPEX,
Old Parent,Vecchio genitore,
On Hold,In sospeso,
One-off,Una tantum,
Other,Altro,
Owner,Proprietario,
Owner User,Utente proprietario,
Parent Category,Categoria padre,
Parent MPIT Category,Categoria MPIT padre,
Pending Renewal,In attesa di rinnovo,
Period End Date,Data fine periodo,
Period Start Date,Data inizio periodo,
Planned,Previsto,
Planned Amount,Importo previsto,
Planned Amount Includes VAT,Importo previsto IVA inclusa,
Planned Gross,Lordo previsto,
Planned Net,Netto previsto,
Planning,Pianificazione,
Portfolio Warning Threshold %,Soglia di avviso portafoglio %,
Posting Date,Data di registrazione,
Posting Date is required to derive MPIT Year.,La data di registrazione è obbligatoria per ricavare l'anno MPIT.,
Print Preferences,Preferenze di stampa,
Printed on,Stampato il,
Project,Progetto,
Project Prefix,Prefisso progetto,
Project Sequence Digits,Cifre sequenza progetto,
Projects,Progetti,
Projects: Planned vs Actual,Progetti: Previsto vs Effettivo,
Quick Actions,Azioni rapide,
Propose,Proponi,
Proposed,Proposto,
Quarterly,Trimestrale,
Quote Date,Data preventivo,
Quote {0} Amount,Importo preventivo {0},
Quotes,Preventivi,
Reason,Motivazione,
Received,Ricevuto,
Recorded,Registrato,
Recurrence,Ricorrenza,
Recurrence Rule,Regola di ricorrenza,
Reject,Rifiuta,
Rejected,Respinto,
Renewal Window Days,Giorni finestra rinnovo,
Renewals,Rinnovi,
Renewals 30d,Rinnovi 30g,
Renewals 60d,Rinnovi 60g,
Renewals 90d,Rinnovi 90g,
Renewed,Rinnovato,
Resubmit,Reinvia,
Right,Destra,
Send to Review,Invia in revisione,
Setup & Planning,Configurazione e pianificazione,
Setup,Impostazioni,
Show Attachments in Print,Mostra allegati in stampa,
Soon,Presto,
Sort Order,Ordinamento,
Source Baseline Expense,Spesa baseline di origine,
Start Date,Data inizio,
Status,Stato,
Subscription,Abbonamento,
Title,Titolo,
Total Amount Input,Somma importi inseriti,
Total Gross,Totale lordo,
Total Gross Amount,Importo lordo totale,
Total Net,Totale netto,
Total Net Amount,Importo netto totale,
Total Planned Net,Totale netto previsto,
Total Quotes Gross,Totale lordo preventivi,
Total VAT,Totale IVA,
Total VAT Amount,Importo totale IVA,
Totals,Totali,
Upcoming (<= {0} days),In scadenza (≤ {0} giorni),
Urgent,Urgente,
User,Utente,
User Preferences,Preferenze utente,
VAT %,% IVA,
VAT Amount,Importo IVA,
VAT Defaults,Impostazioni IVA predefinite,
VAT Delta Amount,Importo IVA delta,
VAT ID,Partita IVA,
VAT Included?,IVA Inclusa?,
VAT Planned Amount,Importo IVA previsto,
VAT Rate,Aliquota IVA,
Validated,Validato,
Variance,Scostamento,
Variance (Actual - Budget),Scostamento (Effettivo - Budget),
Variance (Actual - Current),Scostamento (Effettivo - Corrente),
Variance (Actual - Planned),Scostamento (Effettivo - Previsto),
Vendor,Fornitore,
Vendor Name,Nome fornitore,
Vendor Quotes,Preventivi fornitori,
Vendors,Fornitori,
Verified,Verificato,
Workflow State,Stato workflow,
Year,Anno,
Year is required to generate Budget name,Anno obbligatorio per generare il nome del budget,
Yearly,Annuale,
Yes,Sì,
at,alle,
by,da,
custom_period_months must be between 1 and 12,custom_period_months deve essere tra 1 e 12,
vCIO Manager,vCIO Manager,
{0} is non-zero but no VAT rate is specified. Please set a VAT rate on this row or configure a default VAT rate in your User Preferences.,{0} è diverso da zero ma non è stata specificata alcuna aliquota IVA. Imposta un'aliquota IVA su questa riga o configura un'aliquota IVA predefinita nelle tue Preferenze utente.,
Enter the year identifier (e.g. 2025).,Inserisci l'identificativo dell'anno (es. 2025).,
Date when the year period starts.,Data di inizio del periodo annuale.,
Date when the year period ends.,Data di fine del periodo annuale.,
Enter the category name.,Inserisci il nome della categoria.,
Select the parent category.,Seleziona la categoria padre.,
Enter numeric order for sorting categories.,Inserisci l'ordinamento numerico delle categorie.,
Calculated automatically for tree positioning.,Calcolato automaticamente per la posizione nell'albero.,
Previous parent category captured during moves.,Categoria padre precedente registrata durante gli spostamenti.,
Parent category used by tree view.,Categoria padre usata dalla vista ad albero.,
Enter the vendor name.,Inserisci il nome del fornitore.,
Enter the vendor VAT ID.,Inserisci la partita IVA del fornitore.,
Enter the main contact email.,Inserisci l'e-mail di contatto principale.,
Enter the main contact phone number.,Inserisci il numero di telefono di contatto.,
Add internal notes about the vendor.,Aggiungi note interne sul fornitore.,
Select the default currency for Master Plan IT calculations.,Seleziona la valuta predefinita per i calcoli di Master Plan IT.,
Days before renewal dates treated as the renewal window.,Giorni prima delle date di rinnovo considerati nella finestra di rinnovo.,
Percentage threshold used for portfolio warnings.,Soglia percentuale utilizzata per gli avvisi di portafoglio.,
Enter the milestone title.,Inserisci il titolo della milestone.,
Date when the milestone is due.,Data di scadenza della milestone.,
Choose the milestone status.,Seleziona lo stato della milestone.,
Date when the milestone was accepted.,Data in cui la milestone è stata accettata.,
Add notes about the milestone.,Aggiungi note sulla milestone.,
Upload any supporting attachment.,Carica eventuali allegati di supporto.,
Select the year for this allocation.,Seleziona l'anno per questa allocazione.,
Enter the planned amount for this year.,Inserisci l'importo previsto per questo anno.,
VAT rate applied to the planned amount.,Aliquota IVA applicata all'importo previsto.,
Calculated automatically from planned amount and VAT settings.,Calcolato automaticamente dall'importo previsto e dalle impostazioni IVA.,
Select the vendor providing the quote.,Seleziona il fornitore che ha inviato il preventivo.,
Enter the quoted amount.,Inserisci l'importo preventivato.,
Date when the quote was received.,Data in cui è stato ricevuto il preventivo.,
Upload the quote document.,Carica il documento del preventivo.,
Choose the quote status.,Seleziona lo stato del preventivo.,
VAT rate applied to the quote amount.,Aliquota IVA applicata all'importo preventivato.,
Enter the project title.,Inserisci il titolo del progetto.,
Add a brief description of the project.,Aggiungi una breve descrizione del progetto.,
Choose the project status; at least one allocation is required before approval or later states.,Seleziona lo stato del progetto; è necessaria almeno un'allocazione prima degli stati approvati o successivi.,
Date when the project starts.,Data di inizio del progetto.,
Date when the project ends.,Data di fine del progetto.,
Select the project owner.,Seleziona il responsabile del progetto.,
Add one or more allocations with year and planned amount.,Aggiungi una o più allocazioni con anno e importo previsto.,
Add vendor quotes for this project.,Aggiungi i preventivi dei fornitori per il progetto.,
Add project milestones.,Aggiungi le milestone del progetto.,
Select the user these preferences apply to.,Seleziona l'utente a cui si applicano queste preferenze.,
Prefix used when generating budget names.,Prefisso usato durante la generazione dei nomi dei budget.,
Number of digits for budget sequence numbers.,Numero di cifre per la numerazione dei budget.,
Prefix used when generating project names.,Prefisso usato durante la generazione dei nomi dei progetti.,
Number of digits for project sequence numbers.,Numero di cifre per la numerazione dei progetti.,
Select the budget being amended.,Seleziona il budget oggetto dell'emendamento.,
Date when this amendment takes effect.,Data in cui questo emendamento entra in vigore.,
Describe why the budget is being amended.,Descrivi perché il budget viene emendato.,
Add amendment lines detailing the changes.,Aggiungi le righe di emendamento con le modifiche.,
Reference to the original amendment this document was copied from.,Riferimento all'emendamento originale da cui è stato copiato questo documento.,
Select the category for this change.,Seleziona la categoria per questa modifica.,
Select the vendor linked to this change.,Seleziona il fornitore collegato a questa modifica.,
Describe the change captured by this line.,Descrivi la modifica apportata da questa riga.,
Enter the adjustment amount for this line.,Inserisci l'importo di variazione per questa riga.,
Add an internal note for this line.,Aggiungi una nota interna per questa riga.,
VAT rate applied to the adjustment.,Aliquota IVA applicata all'importo di variazione.,
Calculated automatically from delta amount and VAT settings.,Calcolato automaticamente dall'importo di variazione e dalle impostazioni IVA.,
Calculated automatically as the VAT portion of the delta.,Calcolato automaticamente come quota IVA della variazione.,
Calculated automatically as the gross delta amount.,Calcolato automaticamente come importo lordo della variazione.,
Select the budget year.,Seleziona l'anno del budget.,
Enter a short budget title.,Inserisci un titolo breve per il budget.,
Workflow status set by the approval process.,Stato del workflow impostato dal processo di approvazione.,
Calculated automatically as the sum of line amounts.,Calcolato automaticamente come somma degli importi delle righe.,
Calculated automatically as the sum of line VAT amounts.,Calcolato automaticamente come somma degli importi IVA delle righe.,
Calculated automatically as the sum of net amounts.,Calcolato automaticamente come somma degli importi netti.,
Calculated automatically as the sum of gross amounts.,Calcolato automaticamente come somma degli importi lordi.,
Reference to the original budget this document was amended from.,Riferimento al budget originale da cui questo documento è stato emendato.,
Select the budget category.,Seleziona la categoria di budget.,
Select the vendor for this line.,Seleziona il fornitore per questa riga.,
Link to the baseline expense this line is based on.,Collega la spesa di baseline su cui si basa questa riga.,
Describe this budget line.,Descrivi questa riga di budget.,
Enter the budgeted amount; use net or gross per the VAT setting.,Inserisci l'importo di budget; usa netto o lordo secondo l'impostazione IVA.,
Choose whether the cost is CAPEX or OPEX.,Scegli se il costo è CAPEX o OPEX.,
Choose how this amount recurs for annualization.,Scegli come questo importo si ripete per l'annualizzazione.,
Start date of the period used to calculate overlap with the budget year.,Data di inizio del periodo usata per calcolare la sovrapposizione con l'anno di budget.,
End date of the period used to calculate overlap with the budget year.,Data di fine del periodo usata per calcolare la sovrapposizione con l'anno di budget.,
Select the year this expense belongs to.,Seleziona l'anno a cui appartiene questa spesa.,
Date when the baseline expense is recorded.,Data di registrazione della spesa di baseline.,
Select the expense category.,Seleziona la categoria della spesa.,
Select the vendor for this expense.,Seleziona il fornitore per questa spesa.,
Describe the baseline expense.,Descrivi la spesa di baseline.,
Enter the expense amount; use net or gross per the VAT setting.,Inserisci l'importo della spesa; usa netto o lordo secondo l'impostazione IVA.,
Current review status of this expense.,Stato di revisione corrente di questa spesa.,
Choose how this expense recurs for annualization.,Scegli come questa spesa si ripete per l'annualizzazione.,
Number of months per cycle when using a Custom recurrence.,Numero di mesi per ciclo quando si usa una ricorrenza personalizzata.,
Start date of the period used to calculate overlap with the year.,Data di inizio del periodo usata per calcolare la sovrapposizione con l'anno.,
End date of the period used to calculate overlap with the year.,Data di fine del periodo usata per calcolare la sovrapposizione con l'anno.,
Calculated automatically as the annualized net amount.,Calcolato automaticamente come importo netto annualizzato.,
Calculated automatically as the annualized VAT amount.,Calcolato automaticamente come importo IVA annualizzato.,
Calculated automatically as the annualized gross amount.,Calcolato automaticamente come importo lordo annualizzato.,
Enter the contract title.,Inserisci il titolo del contratto.,
Select the vendor for this contract.,Seleziona il fornitore per questo contratto.,
Select the category for this contract.,Seleziona la categoria per questo contratto.,
Choose the billing cycle for this contract.,Scegli il ciclo di fatturazione per questo contratto.,
Date when the contract starts.,Data di inizio del contratto.,
Date when the contract ends.,Data di fine del contratto.,
Next renewal date for this contract.,Prossima data di rinnovo per questo contratto.,
Number of notice days required before renewal.,Numero di giorni di preavviso richiesti prima del rinnovo.,
Enter the current contract amount; use net or gross per the VAT setting.,Inserisci l'importo corrente del contratto; usa netto o lordo secondo l'impostazione IVA.,
Choose the current contract status.,Seleziona lo stato attuale del contratto.,
Select the contract owner.,Seleziona il responsabile del contratto.,
Link to the baseline expense that created this contract.,Collega la spesa di baseline che ha creato questo contratto.,
Add internal notes about the contract.,Aggiungi note interne sul contratto.,
Upload the contract file.,Carica il file del contratto.,
VAT rate applied to the current amount.,Aliquota IVA applicata all'importo corrente.,
Calculated automatically from current amount and VAT settings.,Calcolato automaticamente dall'importo corrente e dalle impostazioni IVA.,
Posting date for the entry; used to derive the MPIT Year.,Data di registrazione; usata per derivare l'anno MPIT.,
Derived MPIT Year based on the posting date.,Anno MPIT derivato in base alla data di registrazione.,
Select the category for this entry.,Seleziona la categoria per questa registrazione.,
Select the vendor involved in this entry.,Seleziona il fornitore coinvolto in questa registrazione.,
Select the budget this entry relates to.,Seleziona il budget a cui si riferisce questa registrazione.,
Enter the actual amount; use net or gross per the VAT setting.,Inserisci l'importo effettivo; usa netto o lordo secondo l'impostazione IVA.,
Describe the actual entry.,Descrivi la registrazione effettiva.,
Choose whether the entry is recorded or verified.,Scegli se la registrazione è registrata o verificata.,
VAT rate applied to the amount.,Aliquota IVA applicata all'importo.,
Calculated automatically from amount and VAT settings.,Calcolato automaticamente dall'importo e dalle impostazioni IVA.,
Calculated automatically as the VAT portion.,Calcolato automaticamente come quota IVA.,
Calculated automatically as the gross amount.,Calcolato automaticamente come importo lordo.,
"If enabled, attachments are shown on print formats.","Se abilitato, gli allegati vengono mostrati nei formati di stampa.",
"If enabled, category can contain child categories.","Se abilitato, la categoria può contenere sottocategorie.",
"If enabled, new amounts default to VAT-inclusive.","Se abilitato, i nuovi importi sono predefiniti come IVA inclusa.",
"If enabled, the adjustment amount includes VAT.","Se abilitato, l'importo di variazione include l'IVA.",
"If enabled, the amount includes VAT.","Se abilitato, l'importo include l'IVA.",
"If enabled, the budget line is active.","Se abilitato, la riga di budget è attiva.",
"If enabled, the category is active for use.","Se abilitato, la categoria è attiva per l'uso.",
"If enabled, the contract renews automatically.","Se abilitato, il contratto si rinnova automaticamente.",
"If enabled, the current amount includes VAT.","Se abilitato, l'importo corrente include l'IVA.",
"If enabled, the planned amount includes VAT.","Se abilitato, l'importo previsto include l'IVA.",
"If enabled, the vendor is active for selection.","Se abilitato, il fornitore è attivo per la selezione.",
"If enabled, the year is active for planning.","Se abilitato, l'anno è attivo per la pianificazione.",
"If enabled, this line acts as a portfolio bucket.","Se abilitato, questa riga funge da contenitore di portafoglio.",
"Add budget lines for categories, vendors, and amounts.","Aggiungi righe di budget con categorie, fornitori e importi.",
"Choose the contract type (contract, subscription, renewal, or maintenance).","Scegli il tipo di contratto (contratto, abbonamento, rinnovo o manutenzione).",
"Choose the expense kind (one-off, subscription, renewal, or contract).","Scegli il tipo di spesa (una tantum, abbonamento, rinnovo annuale o contratto).",
"Contract end date, if relevant.","Data di fine del contratto, se rilevante.",
"Contract start date, if relevant.","Data di inizio del contratto, se rilevante.",
"Default VAT rate for new entries (leave blank for no default, 0 is valid)","Aliquota IVA predefinita per nuove registrazioni (lascia vuoto per nessun valore predefinito, 0 è valido)",
"Reference to the related budget line, if applicable.","Riferimento alla riga di budget collegata, se applicabile.",
"Select the related contract, if applicable.","Seleziona il contratto collegato, se applicabile.",
"Select the related project, if applicable.","Seleziona il progetto collegato, se applicabile.",


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/patches/v0_1_0/backfill_vat_fields.py
================================================================================
# Copyright (c) 2025, DOT and contributors
# For license information, please see license.txt

"""
Backfill VAT fields for existing records created before EPIC MPIT-E01 implementation.

Sets default values for all Currency fields that now have VAT normalization:
- vat_rate = 0 (zero-rated, not null)
- includes_vat = 0 (amount is net by default)
- _net = amount (original amount is treated as net)
- _vat = 0 (no VAT for historical records)
- _gross = amount (gross equals net when VAT is 0)

Affected doctypes (7 total):
- MPIT Baseline Expense (parent, amount field)
- MPIT Actual Entry (parent, amount field)
- MPIT Contract (parent, current_amount field)
- MPIT Budget Line (child, amount field)
- MPIT Amendment Line (child, delta_amount field)
- MPIT Project Allocation (child, planned_amount field)
- MPIT Project Quote (child, amount field)

This patch is idempotent - only updates records where vat_rate is NULL.
"""

import frappe


def execute():
	"""Backfill VAT fields for all existing records."""
	
	frappe.reload_doc("master_plan_it", "doctype", "mpit_baseline_expense", force=True)
	frappe.reload_doc("master_plan_it", "doctype", "mpit_actual_entry", force=True)
	frappe.reload_doc("master_plan_it", "doctype", "mpit_contract", force=True)
	frappe.reload_doc("master_plan_it", "doctype", "mpit_budget_line", force=True)
	frappe.reload_doc("master_plan_it", "doctype", "mpit_amendment_line", force=True)
	frappe.reload_doc("master_plan_it", "doctype", "mpit_project_allocation", force=True)
	frappe.reload_doc("master_plan_it", "doctype", "mpit_project_quote", force=True)
	
	# Parent doctypes with single Currency field
	backfill_parent_doctype("MPIT Baseline Expense", "amount")
	backfill_parent_doctype("MPIT Actual Entry", "amount")
	backfill_parent_doctype("MPIT Contract", "current_amount")
	
	# Child table doctypes
	backfill_child_doctype("MPIT Budget Line", "amount")
	backfill_child_doctype("MPIT Amendment Line", "delta_amount")
	backfill_child_doctype("MPIT Project Allocation", "planned_amount")
	backfill_child_doctype("MPIT Project Quote", "amount")
	
	frappe.db.commit()


def backfill_parent_doctype(doctype, amount_field):
	"""
	Backfill VAT fields for a parent doctype with single Currency field.
	
	Args:
		doctype: Name of the doctype (e.g., "MPIT Baseline Expense")
		amount_field: Name of the Currency field (e.g., "amount")
	"""
	table_name = f"tab{doctype}"
	includes_vat_field = f"{amount_field}_includes_vat"
	net_field = f"{amount_field}_net"
	vat_field = f"{amount_field}_vat"
	gross_field = f"{amount_field}_gross"
	
	# Count records that need backfill
	count = frappe.db.sql(f"""
		SELECT COUNT(*) 
		FROM `{table_name}` 
		WHERE vat_rate IS NULL
	""")[0][0]
	
	if count == 0:
		print(f"[{doctype}] No records to backfill (all have vat_rate)")
		return
	
	print(f"[{doctype}] Backfilling {count} records...")
	
	# Update in single query for performance
	# Idempotent: only update WHERE vat_rate IS NULL
	frappe.db.sql(f"""
		UPDATE `{table_name}`
		SET 
			vat_rate = 0,
			{includes_vat_field} = 0,
			{net_field} = {amount_field},
			{vat_field} = 0,
			{gross_field} = {amount_field}
		WHERE vat_rate IS NULL
	""")
	
	print(f"[{doctype}] ✓ Updated {count} records")


def backfill_child_doctype(doctype, amount_field):
	"""
	Backfill VAT fields for a child table doctype.
	
	Args:
		doctype: Name of the child doctype (e.g., "MPIT Budget Line")
		amount_field: Name of the Currency field (e.g., "amount")
	"""
	table_name = f"tab{doctype}"
	includes_vat_field = f"{amount_field}_includes_vat"
	net_field = f"{amount_field}_net"
	vat_field = f"{amount_field}_vat"
	gross_field = f"{amount_field}_gross"
	
	# Count records that need backfill
	count = frappe.db.sql(f"""
		SELECT COUNT(*) 
		FROM `{table_name}` 
		WHERE vat_rate IS NULL
	""")[0][0]
	
	if count == 0:
		print(f"[{doctype}] No records to backfill (all have vat_rate)")
		return
	
	print(f"[{doctype}] Backfilling {count} records...")
	
	# Update in single query for performance
	# Idempotent: only update WHERE vat_rate IS NULL
	frappe.db.sql(f"""
		UPDATE `{table_name}`
		SET 
			vat_rate = 0,
			{includes_vat_field} = 0,
			{net_field} = {amount_field},
			{vat_field} = 0,
			{gross_field} = {amount_field}
		WHERE vat_rate IS NULL
	""")
	
	print(f"[{doctype}] ✓ Updated {count} records")


================================================================================
 FILE: ./apps/master_plan_it/master_plan_it/patches.txt
================================================================================
# Patches placeholder. Keep empty until a migration is required.
master_plan_it.patches.v0_1_0.backfill_vat_fields


================================================================================
 FILE: ./apps/master_plan_it/setup.py
================================================================================
from setuptools import setup, find_packages

with open("requirements.txt") as f:
    install_requires = f.read().strip().split("\n")

setup(
    name="master_plan_it",
    version="0.1.0",
    description="vCIO multi-tenant budgeting & actuals management (MPIT).",
    author="DOT",
    author_email="n/a",
    packages=find_packages(),
    zip_safe=False,
    include_package_data=True,
    install_requires=install_requires,
)


================================================================================
 FILE: ./config/mpit.Procfile
================================================================================
web: bench serve --port 8000
socketio: node /home/frappe/frappe-bench/apps/frappe/socketio.js
schedule: bench schedule
worker: bench worker --queue default,short,long


================================================================================
 FILE: ./config/mpit-entrypoint.sh
================================================================================
#!/usr/bin/env bash
set -euo pipefail

export DEV_SERVER=1
export PYTHONPATH="/home/frappe/frappe-bench/apps:${PYTHONPATH:-}"

cd /home/frappe/frappe-bench

if [ ! -f sites/common_site_config.json ]; then
  echo "{}" > sites/common_site_config.json
fi

# apps.txt serve spesso in ambienti containerizzati
if [ ! -f sites/apps.txt ]; then
  ls -1 apps > sites/apps.txt
fi
if [ ! -f sites/apps_path.txt ]; then
  for app_dir in apps/*; do
    realpath "$app_dir"
  done > sites/apps_path.txt
fi

# Config bench verso servizi esterni (idempotente)
bench set-config -g db_host db
bench set-config -gp db_port 3306
bench set-config -g redis_cache "redis://redis:6379"
bench set-config -g redis_queue "redis://redis:6379"
bench set-config -g redis_socketio "redis://redis:6379"
bench set-config -gp socketio_port 9000

# Crea site se manca (idempotente)
if [ ! -d "sites/${SITE_NAME}" ]; then
  echo "Creating site ${SITE_NAME}..."
  APPS_ARGS=()
  if [ -n "${INSTALL_APPS:-}" ]; then
    IFS=',' read -ra APPS <<< "${INSTALL_APPS}"
    for app in "${APPS[@]}"; do
      app="$(echo "$app" | xargs)"   # trim
      [ -n "$app" ] && APPS_ARGS+=(--install-app "$app")
    done
  fi

  bench new-site \
    --mariadb-user-host-login-scope='%' \
    --admin-password="${ADMIN_PASSWORD}" \
    --db-root-username=root \
    --db-root-password="${DB_ROOT_PASSWORD}" \
    "${APPS_ARGS[@]}" \
    --set-default \
    "${SITE_NAME}"
else
  echo "Site ${SITE_NAME} already exists"
fi

# Modalità developer per permettere la generazione di DocType standard
bench --site "${SITE_NAME}" set-config developer_mode 1

# Migrazioni (opzionale)
if [ "${RUN_MIGRATE_ON_START:-0}" = "1" ]; then
  bench --site "${SITE_NAME}" migrate
fi

# Avvio processi via Procfile custom
exec honcho start -f config/mpit.Procfile


================================================================================
 FILE: ./Dockerfile.frappe
================================================================================
ARG FRAPPE_IMAGE=frappe/erpnext
ARG FRAPPE_TAG=v15.92.3
FROM ${FRAPPE_IMAGE}:${FRAPPE_TAG}

USER root
RUN apt-get update \
    && apt-get install -y --no-install-recommends nodejs npm \
    && rm -rf /var/lib/apt/lists/*
USER frappe

ENV PYTHONPATH=/home/frappe/frappe-bench/apps:/home/frappe/frappe-bench/apps/frappe:/home/frappe/frappe-bench/apps/erpnext:/home/frappe/frappe-bench/apps/master_plan_it


================================================================================
 FILE: ./CHECKLIST.md
================================================================================
# Implementation checklist (V1)

Use this list to ensure we remain consistent and debt-free.

## Tenant
- [ ] New site created per client
- [ ] App installed
- [ ] `bench migrate` applied
- [ ] MPIT Settings exists + MPIT Year current/next created (install hook handles on migrate)
- [ ] Workspace visible and restricted by roles

## DocTypes
- [ ] Category is Tree DocType
- [ ] Budget and Budget Amendment are Submittable
- [ ] Approved state sets docstatus=1 (immutability)
- [ ] Project allocations are enforced before approval

## Data integrity rules
- [ ] Actual Entry requires Category
- [ ] Contract requires next_renewal_date
- [ ] Contract renewals reports use next_renewal_date
- [ ] Amendments use delta_amount (+/-), never mutate approved budget

## Reports & dashboards
- [ ] Approved vs Actual
- [ ] Current vs Actual
- [ ] Renewals window
- [ ] Projects planned vs actual

## Fixtures (no pollution)
- [ ] Fixtures are filtered to MPIT records only
- [ ] No standard Roles/Workspaces exported
- [ ] Workflows + states/actions are included where needed



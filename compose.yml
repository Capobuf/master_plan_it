name: master_plan_it

services:
  db:
    image: mariadb:11
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --skip-character-set-client-handshake
      - --skip-innodb-read-only-compressed
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
    volumes:
      - ./data/db:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mariadb-admin ping -h 127.0.0.1 -p${DB_ROOT_PASSWORD} || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 30
    restart: unless-stopped

  redis:
    image: redis:6.2-alpine
    volumes:
      - ./data/redis:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 30
    restart: unless-stopped

  # Un solo container che fa: config bench + new-site (se manca) + avvia web/socketio/schedule/worker via Procfile
  frappe:
    build:
      context: .
      dockerfile: Dockerfile.frappe
      args:
        FRAPPE_IMAGE: ${FRAPPE_IMAGE}
        FRAPPE_TAG: ${FRAPPE_TAG}
    image: master_plan_it-frappe:local
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      SITE_NAME: ${SITE_NAME}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}
      DB_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}

      # se vuoi forzare migrate ad ogni start (di default NO)
      RUN_MIGRATE_ON_START: ${RUN_MIGRATE_ON_START:-0}

      # usati da socketio.js / worker
      FRAPPE_REDIS_CACHE: redis://redis:6379
      FRAPPE_REDIS_QUEUE: redis://redis:6379
      FRAPPE_REDIS_SOCKETIO: redis://redis:6379
      INSTALL_APPS: ${INSTALL_APPS}

    command: ["bash", "-lc", "/home/frappe/frappe-bench/config/mpit-entrypoint.sh"]
    volumes:
      - ./data/sites:/home/frappe/frappe-bench/sites
      - ./data/logs:/home/frappe/frappe-bench/logs

      # IMPORTANTISSIMO: NON montare tutta ./data/apps vuota (ti sovrascrive frappe/erpnext).
      # In dev, monta SOLO la tua app:
      - ./apps/master_plan_it:/home/frappe/frappe-bench/apps/master_plan_it
      - ./config/mpit-entrypoint.sh:/home/frappe/frappe-bench/config/mpit-entrypoint.sh:ro
      - ./config/mpit.Procfile:/home/frappe/frappe-bench/config/mpit.Procfile:ro
    restart: unless-stopped

  # Reverse proxy interno (comodo se hai un proxy esterno che punta qui)
  frontend:
    image: master_plan_it-frappe:local
    command: ["nginx-entrypoint.sh"]
    container_name: frappe-web
    environment:
      BACKEND: frappe:8000
      SOCKETIO: frappe:9000
      FRAPPE_SITE_NAME_HEADER: ${FRAPPE_SITE_NAME_HEADER:-$$host}
      PROXY_READ_TIMEOUT: 120
      CLIENT_MAX_BODY_SIZE: 50m
    depends_on:
      - frappe
    networks:
      - proxy
      - default
    ports:
      - "127.0.0.1:${HTTP_PORT}:8080"
    volumes:
      - ./data/sites:/home/frappe/frappe-bench/sites
      - ./data/logs:/home/frappe/frappe-bench/logs
    restart: unless-stopped

networks:
  proxy:
    external: true
